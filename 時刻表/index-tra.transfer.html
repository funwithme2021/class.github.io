<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å°éµåˆ—è»Šæ™‚åˆ»è¡¨æŸ¥è©¢</title>

<!-- Google Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ===== Reset & basics ===== */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:"Noto Sans TC",sans-serif;line-height:1.6;background:#f6f8ff;color:#333;transition:.25s}

/* ===== Color tokens ===== */
:root{
  --primary:#0460fe;--primary-dark:#034ad0;
  --surface:#fff;--surface-dark:#1f1f1f;
  --text-dark:#ddd;--shadow:0 4px 12px rgba(0,0,0,.08)
}

/* prefers-dark */
@media(prefers-color-scheme:dark){
  body{background:#121212;color:var(--text-dark)}
  .card{background:var(--surface-dark);color:var(--text-dark)}
  .navbar{background:#222}.navbar .brand,.navbar a{color:#fff}.navbar button{background:#444}
  th{background:#303030;color:#fff}
}
/* æ‰‹å‹• dark-mode */
body.dark-mode{background:#121212;color:var(--text-dark)}
body.dark-mode .card{background:var(--surface-dark);color:var(--text-dark)}
body.dark-mode .navbar{background:#222}
body.dark-mode .navbar .brand,body.dark-mode .navbar a{color:#fff}
body.dark-mode .navbar button{background:#444}
body.dark-mode th{background:#303030;color:#fff}
body.dark-mode tr{background:#121212}
body.dark-mode tr:hover{background:#1e1e1e}

/* ===== Navbar ===== */
.navbar{position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;background:#333;box-shadow:var(--shadow)}
.navbar .brand{color:#fff;font-weight:700;font-size:1.05rem}
.navbar a{color:#fff;text-decoration:none;font-size:.85rem;margin-left:1rem;white-space:nowrap}
.navbar a:hover{text-decoration:underline}
.navbar button{border:0;border-radius:4px;padding:.35rem .8rem;font-size:.75rem;background:#444;color:#fff;cursor:pointer}
.navbar button:hover{background:#222}
.hamburger{display:none;flex-direction:column;gap:4px;cursor:pointer}
.hamburger span{width:24px;height:2px;background:#fff;transition:.3s}
@media(max-width:767.98px){
  .navbar a{margin-left:0}
  .nav-links{position:absolute;left:0;top:100%;width:100%;background:#333;flex-direction:column;max-height:0;overflow:hidden;transition:max-height .3s}
  .nav-links.open{max-height:320px;padding:.5rem 1rem}
  .hamburger{display:flex}
}

/* ===== Layout ===== */
.container{max-width:900px;margin:auto;padding:1.25rem}
.grid{display:grid;gap:1.25rem}

/* ===== Card ===== */
.card{background:var(--surface);border-radius:12px;box-shadow:var(--shadow);padding:1rem 1.25rem;display:flex;flex-direction:column;gap:.8rem}
.section-title{font-weight:700;font-size:1.05rem;border-left:4px solid #130058;padding-left:.6rem}

/* ===== Form ===== */
label{font-size:.85rem;font-weight:600;margin-right:.15rem}
input,select,button{font-size:.8rem;padding:.42rem .7rem;border:1px solid #ddd;border-radius:4px;outline:none;transition:.2s}
input:focus,select:focus{border-color:var(--primary)}
button{background:var(--primary);color:#fff;border:none;cursor:pointer}
button:hover{background:var(--primary-dark)}
button:active{transform:translateY(1px)}

/* Switch (æ¥å—è½‰ä¹˜) */
.switch{position:relative;display:inline-block;width:42px;height:22px;margin-left:.4rem;margin-right:.6rem;vertical-align:middle}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.3s;border-radius:22px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:2px;bottom:2px;background:white;transition:.3s;border-radius:50%}
input:checked+.slider{background:var(--primary)}
input:checked+.slider:before{transform:translateX(20px)}

/* ===== Table ===== */
.table-wrapper{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.75rem;background:var(--surface)}
th,td{padding:.5rem .7rem;border-bottom:1px solid #e0e0e0;white-space:nowrap}
tr:nth-child(even){background:#f9f9f9}
tr:hover{background:#ececec;cursor:pointer}
body.dark-mode tr:nth-child(even){background:#121212}
@media(max-width:575.98px){table{font-size:.7rem}}

/* badges & etc. */
.badge-sea{display:inline-block;background:#1e80ff;color:#fff;font-size:.65rem;padding:1px 4px;border-radius:3px;margin-left:2px}
.peak-hour{background:#ffe0a0;padding:2px 6px;border-radius:4px;font-weight:700}
body.dark-mode .peak-hour{background:#e09f00;color:#fff}
.toggle-arrow{cursor:pointer;font-weight:700;margin-left:.4rem}

/* ===== Modal ===== */
.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.55);z-index:1050;justify-content:center;align-items:center}
.modal-content{background:var(--surface);border-radius:10px;max-width:500px;width:95%;max-height:85%;overflow-y:auto;position:relative;padding:1rem 1.25rem;animation:slide .25s ease-out}
@keyframes slide{from{transform:translateY(-40px);opacity:0}to{transform:translateY(0);opacity:1}}
body.dark-mode .modal-content{background:var(--surface-dark);color:var(--text-dark)}
.close{position:absolute;right:1rem;top:.6rem;font-size:1.4rem;font-weight:bold;color:#666;cursor:pointer}
body.dark-mode .close{color:#ccc}
.modal-content thead th{background:#303030;color:#fff}
body.dark-mode .modal-content thead th{background:#444;color:#fff}
.transfer-tip{background:#000;color:#fff;padding:10px;border-radius:5px;margin-bottom:.75rem}
</style>
</head>
<body>
<!-- ===== Navbar ===== -->
<nav class="navbar">
  <div class="brand">å°éµåˆ—è»Šæ™‚åˆ»è¡¨æŸ¥è©¢</div>

  <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>

  <div class="nav-links" id="navLinks">
    <a href="index-speed.html">é«˜éµæ™‚åˆ»è¡¨</a>
    <a href="index-thsr.html">é«˜éµæ™‚åˆ»è¡¨(å°ˆç”¨)</a>
    <a href="index.html">æ™‚åˆ»è¡¨</a>
    <a href="index.trainrate-2.html">æ™‚åˆ»è¡¨(å«é‹ç”¨)</a>
    <a href="index-tra.transfer.html">è½‰ä¹˜æ™‚åˆ»è¡¨</a>
    <a href="index-tra.easy.html">ç°¡å¼æ™‚åˆ»è¡¨</a>
    <a href="index-tra.type.html">ä¾è»Šç¨®æ™‚åˆ»è¡¨</a>
    <a href="train-info.html">è»Šç«™è³‡è¨Šæ¿</a>
    <a href="people.html">é‹é‡æŸ¥è©¢</a>
    <a href="index.trainrate.html">é‹ç”¨ç‡æŸ¥è©¢</a>
    <a href="index-tra.book.html">è¨‚ç¥¨ç³»çµ±</a>
    <a href="index-tra.make.html">åˆ—è»Šæ’é»</a>
  </div>

  <button onclick="toggleDarkMode()">Dark&nbsp;Mode</button>
</nav>

<!-- ===== Main ===== -->
<main class="container">
  <div class="grid">

    <!-- === å‡ºç™¼ï¼æŠµé”æŸ¥è©¢ === -->
    <section class="card">
      <h2 class="section-title">å‡ºç™¼ç«™ & æŠµé”ç«™æŸ¥è©¢</h2>
      <datalist id="stationList"></datalist>

      <div style="display:flex;flex-wrap:wrap;gap:.5rem 1rem">
        <label for="startStationInput">å‡ºç™¼ï¼š</label>
        <input id="startStationInput" list="stationList" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
        <label for="endStationInput">æŠµé”ï¼š</label>
        <input id="endStationInput" list="stationList" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
      </div>

      <!-- è»Šç¨®ç¯©é¸ -->
      <div style="display:flex;flex-wrap:wrap;gap:.25rem 1rem">
        <input type="checkbox" id="ttNew"     onclick="toggleTrainTypeFilter('start-end','æ–°è‡ªå¼·')"><label for="ttNew">æ–°è‡ªå¼·</label>
        <input type="checkbox" id="ttPuyuma"  onclick="toggleTrainTypeFilter('start-end','æ™®æ‚ ç‘ª')"><label for="ttPuyuma">æ™®æ‚ ç‘ª</label>
        <input type="checkbox" id="ttZN"      onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ(æ–°)')"><label for="ttZN">è‡ªå¼·è™Ÿ(æ–°)</label>
        <input type="checkbox" id="ttZ"       onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ')"><label for="ttZ">è‡ªå¼·è™Ÿ</label>
        <input type="checkbox" id="ttJ"       onclick="toggleTrainTypeFilter('start-end','è’å…‰è™Ÿ')"><label for="ttJ">è’å…‰è™Ÿ</label>
        <input type="checkbox" id="ttF"       onclick="toggleTrainTypeFilter('start-end','å¾©èˆˆè™Ÿ')"><label for="ttF">å¾©èˆˆè™Ÿ</label>
        <input type="checkbox" id="ttQK"      onclick="toggleTrainTypeFilter('start-end','å€é–“å¿«')"><label for="ttQK">å€é–“å¿«</label>
        <input type="checkbox" id="ttQC"      onclick="toggleTrainTypeFilter('start-end','å€é–“è»Š')"><label for="ttQC">å€é–“è»Š</label>
        <input type="checkbox" id="ttExtra"   onclick="toggleTrainTypeFilter('start-end','åŠ ç­è»Š')"><label for="ttExtra">åŠ ç­è»Š</label>
      </div>

      <div style="display:flex;align-items:center;gap:.5rem;margin-top:.2rem">
        <label for="acceptTransfers">æ¥å—è½‰ä¹˜</label>
        <label class="switch">
          <input type="checkbox" id="acceptTransfers">
          <span class="slider"></span>
        </label>
        <button onclick="filterTrainScheduleByStation()">æŸ¥è©¢</button>
      </div>

      <div class="table-wrapper">
        <table id="scheduleTableByStation">
          <thead><tr id="startEndHeader"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- === è»Šç«™æŸ¥è©¢ === -->
    <section class="card">
      <h2 class="section-title">è»Šç«™æŸ¥è©¢</h2>

      <datalist id="stationList2"></datalist>

      <div style="display:flex;flex-wrap:wrap;gap:.5rem 1rem">
        <label for="stationNameInput">è»Šç«™ï¼š</label>
        <input id="stationNameInput" list="stationList2" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
        <label for="directionSelect">æ–¹å‘ï¼š</label>
        <select id="directionSelect"><option value="northbound">åŒ—ä¸Š</option><option value="southbound">å—ä¸‹</option></select>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:.25rem 1rem">
        <input type="checkbox" id="ttNewSt"   onclick="toggleTrainTypeFilter('station','æ–°è‡ªå¼·')"><label for="ttNewSt">æ–°è‡ªå¼·</label>
        <input type="checkbox" id="ttPuyumaSt"onclick="toggleTrainTypeFilter('station','æ™®æ‚ ç‘ª')"><label for="ttPuyumaSt">æ™®æ‚ ç‘ª</label>
        <input type="checkbox" id="ttZNSt"    onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ(æ–°)')"><label for="ttZNSt">è‡ªå¼·è™Ÿ(æ–°)</label>
        <input type="checkbox" id="ttZSt"     onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ')"><label for="ttZSt">è‡ªå¼·è™Ÿ</label>
        <input type="checkbox" id="ttJSt"     onclick="toggleTrainTypeFilter('station','è’å…‰è™Ÿ')"><label for="ttJSt">è’å…‰è™Ÿ</label>
        <input type="checkbox" id="ttFSt"     onclick="toggleTrainTypeFilter('station','å¾©èˆˆè™Ÿ')"><label for="ttFSt">å¾©èˆˆè™Ÿ</label>
        <input type="checkbox" id="ttQKSt"    onclick="toggleTrainTypeFilter('station','å€é–“å¿«')"><label for="ttQKSt">å€é–“å¿«</label>
        <input type="checkbox" id="ttQCSt"    onclick="toggleTrainTypeFilter('station','å€é–“è»Š')"><label for="ttQCSt">å€é–“è»Š</label>
        <input type="checkbox" id="ttExtraSt" onclick="toggleTrainTypeFilter('station','åŠ ç­è»Š')"><label for="ttExtraSt">åŠ ç­è»Š</label>
        <button onclick="filterTrainScheduleByStationName()">æŸ¥è©¢</button>
      </div>

      <div class="table-wrapper">
        <table id="scheduleTableByStationName">
          <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨®(è¡Œé§›å€é–“)</th><th>æ™‚é–“</th><th>é‹ç”¨ç‡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- === è»Šæ¬¡æŸ¥è©¢ === -->
    <section class="card">
      <h2 class="section-title">è»Šæ¬¡æŸ¥è©¢</h2>

      <div style="display:flex;flex-wrap:wrap;gap:.4rem">
        <label for="trainNumberInput">è»Šæ¬¡ï¼š</label>
        <input id="trainNumberInput" placeholder="è¼¸å…¥è»Šæ¬¡" oninput="filterTrainNumbers()">
        <select id="trainNumbersDropdown" onchange="selectTrainNumber()"><option value="" selected>åƒè€ƒè»Šæ¬¡</option></select>
        <button onclick="filterTrainScheduleByNumber()">æŸ¥è©¢</button>
      </div>

      <div class="table-wrapper">
        <table id="scheduleTableByNumber">
          <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨®(è¡Œé§›å€é–“)</th><th>é‹ç”¨ç‡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>
</main>

<!-- ===== Modal ===== -->
<div id="trainDetailsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeTrainDetailsModal()">&times;</span>
    <h2 id="modalTitle">æ²¿é€”åœé ç«™</h2>
    <div id="transferTip" class="transfer-tip" style="display:none;"></div>
    <div id="modalBody" style="margin-top:.6rem;"></div>
  </div>
</div>

<!-- ===== Script ===== -->
<script src="train-schedule.js"></script>
<script>
/* ---------- Dark Mode ---------- */
function toggleDarkMode(){document.body.classList.toggle('dark-mode')}

/* ---------- Hamburger ---------- */
const hb=document.getElementById('hamburger');
const nav=document.getElementById('navLinks');
hb.addEventListener('click',()=>nav.classList.toggle('open'))
nav.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>nav.classList.remove('open')))

/* ---------- å»ºç«‹ç«™å datalist ---------- */
const stationListEl=document.getElementById('stationList');
const stationList2El=document.getElementById('stationList2');
stations.forEach(s=>{
  const o=document.createElement('option');o.value=s;stationListEl.appendChild(o);
  const o2=document.createElement('option');o2.value=s;stationList2El.appendChild(o2);
});

/* ---------- å…¨åŸŸç¯©é¸é™£åˆ— ---------- */
let selectedTrainTypesStartEnd=[];
let selectedTrainTypesStation=[];

/* ---------- é‹ç”¨ç‡è¨ˆç®—åƒæ•¸ ---------- */
const stationMaxCapacities={
  æ–°è‡ªå¼·:638,æ™®æ‚ ç‘ª:406,'è‡ªå¼·è™Ÿ(æ–°)':906,'è‡ªå¼·è™Ÿ':866,
  è’å…‰è™Ÿ:1000,å¾©èˆˆè™Ÿ:1000,å€é–“å¿«:1700,å€é–“è»Š:1700,åŠ ç­è»Š:638
};
const popularityWeights={
  æ™®æ‚ ç‘ª:1.42,æ–°è‡ªå¼·:2.4,åŠ ç­è»Š:2.4,'è‡ªå¼·è™Ÿ(æ–°)':4.7,'è‡ªå¼·è™Ÿ':3.15,
  è’å…‰è™Ÿ:3.0,å¾©èˆˆè™Ÿ:3.35,å€é–“å¿«:5.85,å€é–“è»Š:5.65
};
const timeWeights={short_peak:5,long_peak:7.5,short_offpeak:3,long_offpeak:3};

/* ---------- ç«™é»å¯†åº¦ ---------- */
const stationDensity={};
for(const n in trainSchedule){
  trainSchedule[n]['è»Šç«™æ™‚é–“'].forEach(s=>{
    stationDensity[s[0]]=(stationDensity[s[0]]||0)+1;
  });
}

/* ---------- å·¥å…·å‡½å¼ ---------- */
function calculateTimeWeight(t){
  const h=parseInt(t.split(':')[0],10);
  const isShortPeak=((h>=6 && h<9.5)||(h>=12&&h<13)||(h>=16&&h<20)||(h>=21&&h<22));
  const isLongPeak=((h>=6.5 && h<10)||(h>=16&&h<20.5)||(h>=0.5&&h<4.5));
  if(isShortPeak) return timeWeights.short_peak;
  if(isLongPeak)  return timeWeights.long_peak;
  return timeWeights.short_offpeak;
}
function randFactor(type){
  return ['æ™®æ‚ ç‘ª','æ–°è‡ªå¼·','è‡ªå¼·è™Ÿ','è‡ªå¼·è™Ÿ(æ–°)','è’å…‰è™Ÿ'].includes(type)
    ? (Math.random()*0.15)-0.1
    : (Math.random()*0.22)-0.1;
}
function calcStationUtil(t,st,time){
  const max=stationMaxCapacities[t['è»Šç¨®']]||110;
  const pop=popularityWeights[t['è»Šç¨®']]||1;
  const tw=calculateTimeWeight(time);
  let load=0;
  for(let i=0;i<3;i++){
    load+=((stationDensity[st]||0)*tw*pop)*(1+randFactor(t['è»Šç¨®']));
  }
  return Math.min(Math.max((load/3)/max*50,0),100).toFixed(2)+'%';
}
function calcTrainUtil(t){
  const max=stationMaxCapacities[t['è»Šç¨®']]||110;
  const pop=popularityWeights[t['è»Šç¨®']]||1;
  const arr=t['è»Šç«™æ™‚é–“'];
  let total=0;
  for(let i=0;i<3;i++){
    let d=0;
    arr.forEach(s=>{
      d+=((stationDensity[s[0]]||0)*calculateTimeWeight(s[1])*pop)*(1+randFactor(t['è»Šç¨®']));
    });
    total+=d/arr.length;
  }
  return Math.min(Math.max(((total/3)/max)*50,0),100).toFixed(2)+'%';
}
function calcSegUtil(t,sub){
  const max=stationMaxCapacities[t['è»Šç¨®']]||110;
  const pop=popularityWeights[t['è»Šç¨®']]||1;
  let total=0;
  for(let i=0;i<3;i++){
    let d=0;
    sub.forEach(s=>{
      d+=((stationDensity[s[0]]||0)*calculateTimeWeight(s[1])*pop)*(1+randFactor(t['è»Šç¨®']));
    });
    total+=d/sub.length;
  }
  return Math.min(Math.max(((total/3)/max)*50,0),100).toFixed(2)+'%';
}
function highlightPeak(t){
  if(!t) return t;
  const h=parseInt(t.split(':')[0],10);
  return ((h>=7&&h<9)||(h>=17&&h<19)) ? `<span class="peak-hour">${t}</span>` : t;
}
function diff(a,b){
  if(!a||!b) return '--';
  let s=new Date(`1970-01-01 ${a}`);
  let e=new Date(`1970-01-01 ${b}`);
  if(e<s) e.setHours(e.getHours()+24);
  const d=new Date(e-s);
  return `${d.getUTCHours()}å°æ™‚${d.getUTCMinutes()}åˆ†`;
}
function colorType(t){
  const dark=document.body.classList.contains('dark-mode');
  const c={
    æ–°è‡ªå¼·:'#8600FF',æ™®æ‚ ç‘ª:'#FF1493','è‡ªå¼·è™Ÿ':'red','è’å…‰è™Ÿ':'orange',
    'å€é–“å¿«':'green','å¾©èˆˆè™Ÿ':'#0080FF','å€é–“è»Š':dark?'#fff':'#000',
    'è‡ªå¼·è™Ÿ(æ–°)':'brown','åŠ ç­è»Š':'teal'
  }[t]||'#333';
  return `<span style="color:${c}">${t}</span>`;
}
const getDirection=num=>num%2===0?'northbound':'southbound';
const getTime=(num,st)=>{const f=trainSchedule[num]['è»Šç«™æ™‚é–“'].find(x=>x[0]===st);return f?f[1]:'';}
function isOvernight(stArr,si,ei){return new Date(`1970-01-01 ${stArr[si][1]}`)>new Date(`1970-01-01 ${stArr[ei][1]}`);}
function earlier(arrNew,arrOld,ovNew,ovOld){
  if(ovNew&&!ovOld) return false;
  if(!ovNew&&ovOld) return true;
  return new Date(`1970-01-01 ${arrNew}`)<new Date(`1970-01-01 ${arrOld}`);
}
function addTimes(...times){
  let total=0;
  times.forEach(t=>{const m=parseInt(t)||0,totalMin=isNaN(m)?0:0;});
}
function timeDiff(a,b){
  if(!a||!b) return '--';
  let s=new Date(`1970-01-01 ${a}`);let e=new Date(`1970-01-01 ${b}`);
  if(e<s) e.setHours(e.getHours()+24);
  const d=new Date(e-s);
  return `${d.getUTCHours()}å°æ™‚${d.getUTCMinutes()}åˆ†`;
}

/* ---------- è»Šç¨®å‹¾é¸ ---------- */
function toggleTrainTypeFilter(ctx,type){
  const arr = ctx==='start-end' ? selectedTrainTypesStartEnd : selectedTrainTypesStation;
  const i   = arr.indexOf(type);
  i>-1 ? arr.splice(i,1) : arr.push(type);
  ctx==='start-end' ? filterTrainScheduleByStation() : filterTrainScheduleByStationName();
}

/* ---------- â–¼ / â–² å±•é–‹æ”¶åˆ ---------- */
function toggleStopsRow(row, start, end, num, arrowEl){
  const next=row.nextElementSibling;
  if(next && next.classList.contains('extra-stops')){
    next.remove();arrowEl.textContent='â–¼';
  }else{
    const arr=trainSchedule[num]['è»Šç«™æ™‚é–“'];
    const si=arr.findIndex(s=>s[0]===start);
    const ei=arr.findIndex(s=>s[0]===end);
    const names=(si>-1 && ei>-1 && ei>si) ? arr.slice(si+1,ei).map(s=>s[0]) : [];
    const extra=document.createElement('tr');
    extra.className='extra-stops';
    const td=document.createElement('td');td.colSpan=7;
    td.textContent='æ²¿é€”åœé ç«™ï¼š'+(names.length?names.join('ï¼Œ'):'ç„¡ä¸­é€”åœé ç«™ï¼ˆç›´é”ï¼‰');
    extra.appendChild(td);row.parentNode.insertBefore(extra,row.nextSibling);
    arrowEl.textContent='â–²';
  }
}

/* ---------- å‡ºç™¼ï¼æŠµé” æŸ¥è©¢ ---------- */
const startEndHeader=document.getElementById('startEndHeader');
function buildStartEndHeader(isTransfer){
  startEndHeader.innerHTML='';
  const cols=isTransfer
    ? ['è»Šæ¬¡','è»Šç¨®(è¡Œé§›å€é–“)','å‡ºç™¼','è½‰ä¹˜ç«™(æ™‚é–“)','æŠµé”','è¡Œé§›']
    : ['è»Šæ¬¡','è»Šç¨®(è¡Œé§›å€é–“)','å‡ºç™¼','æŠµé”','è¡Œé§›','æ²¿é€”','é‹ç”¨ç‡'];
  cols.forEach(t=>{const th=document.createElement('th');th.textContent=t;startEndHeader.appendChild(th);});
}
function filterTrainScheduleByStation(){
  const st=document.getElementById('startStationInput').value.trim();
  const ed=document.getElementById('endStationInput').value.trim();
  const acceptTransfers=document.getElementById('acceptTransfers').checked;
  const tbody=document.querySelector('#scheduleTableByStation tbody');tbody.innerHTML='';
  buildStartEndHeader(acceptTransfers);

  /* === ç›´é” Only === */
  if(!acceptTransfers){
    const list=[];
    for(const num in trainSchedule){
      const t=trainSchedule[num];
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) continue;
      const arr=t['è»Šç«™æ™‚é–“'];
      const si=arr.findIndex(s=>s[0]===st);
      const ei=arr.findIndex(s=>s[0]===ed);
      if(si!==-1 && ei!==-1 && si<ei){
        list.push({
          num,
          type:t['è»Šç¨®'],
          range:`${arr[0][0]} â ${arr[arr.length-1][0]}`,
          sTime:arr[si][1]||'',
          eTime:arr[ei][1]||'',
          travel:diff(arr[si][1],arr[ei][1]),
          stopsCount:ei-si-1,
          usage:calcSegUtil(t,arr.slice(si,ei+1))
        });
      }
    }
    list.sort((a,b)=>(a.sTime||'99:99').localeCompare(b.sTime||'99:99'));
    list.forEach(r=>{
      const tr=tbody.insertRow();
      tr.dataset.start=st;tr.dataset.end=ed;
      tr.insertCell().innerHTML=r.num.includes('A')?`${r.num}<span class="badge-sea">æµ·ç·š</span>`:r.num;
      tr.insertCell().innerHTML=`${colorType(r.type)} (${r.range})`;
      tr.insertCell().innerHTML=highlightPeak(r.sTime);
      tr.insertCell().innerHTML=highlightPeak(r.eTime);
      tr.insertCell().innerHTML=r.travel;
      const stopsCell=tr.insertCell();
      if(r.stopsCount>0){
        stopsCell.innerHTML=`${r.stopsCount}ç«™ <span class="toggle-arrow">â–¼</span>`;
        const arrow=stopsCell.querySelector('.toggle-arrow');
        arrow.addEventListener('click',e=>{
          e.stopPropagation();toggleStopsRow(tr,st,ed,r.num,arrow);
        });
      }else stopsCell.textContent='ç›´é”';
      tr.insertCell().innerHTML=r.usage;
      tr.addEventListener('click',()=>showTrainDetails(r.num));
    });
    return;
  }

  /* === å…è¨±è½‰ä¹˜ === */
  const combos={};              // { trainNo: [ {obj}, ... ] }
  const addCombo=(tn,obj)=>{(combos[tn]=combos[tn]||[]).push(obj);};
  const isBetter=(exist,newObj)=>{
    if(!exist) return true;
    return earlier(newObj.endTime,exist.endTime,newObj.isOv,exist.isOv);
  };
  /* ç›´é”ä¹Ÿæ”¾å…¥ combos ä»¥åˆ©æ¯”è¼ƒ */
  for(const num in trainSchedule){
    const t=trainSchedule[num];
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) continue;
    const arr=t['è»Šç«™æ™‚é–“'];const si=arr.findIndex(x=>x[0]===st);const ei=arr.findIndex(x=>x[0]===ed);
    if(si>-1&&ei>-1&&si<ei){
      addCombo(num,{
        trainNumber:num,trainType:t['è»Šç¨®'],startTime:arr[si][1],endTime:arr[ei][1],
        travelTime:diff(arr[si][1],arr[ei][1]),startStation:st,endStation:ed,
        transferStations:[],isOv:isOvernight(arr,si,ei)
      });
    }
  }
  /* ä¸€æ®µ + è½‰ä¹˜ä¸€æ®µ */
  const findConnecting=(ts,end,after)=>{
    let best=null;
    for(const n in trainSchedule){
      const tr=trainSchedule[n];
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(tr['è»Šç¨®'])) continue;
      const a=tr['è»Šç«™æ™‚é–“'];const si=a.findIndex(x=>x[0]===ts);const ei=a.findIndex(x=>x[0]===end);
      if(si>-1&&ei>-1&&si<ei){
        const stTime=a[si][1];
        if(new Date(`1970-01-01 ${stTime}`)<=new Date(`1970-01-01 ${after}`)) continue;
        const eTime=a[ei][1];const ov=isOvernight(a,si,ei);
        if(!best||earlier(eTime,best.endTime,ov,best.isOv)){
          best={trainNumber:n,trainType:tr['è»Šç¨®'],startTime:stTime,endTime:eTime,isOv:ov,arr:a};
        }
      }
    }
    return best;
  };
  for(const num in trainSchedule){
    const t=trainSchedule[num];
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) continue;
    const arr=t['è»Šç«™æ™‚é–“'];const si=arr.findIndex(x=>x[0]===st);
    if(si===-1) continue;
    for(let i=si+1;i<arr.length;i++){
      const trSt=arr[i][0];const reachTime=arr[i][1];
      const next=findConnecting(trSt,ed,reachTime);
      if(next){
        const firstLeg=diff(arr[si][1],reachTime);
        const wait=diff(reachTime,next.startTime);
        const secondLeg=diff(next.startTime,next.endTime);
        /* ç²—ç•¥ç›¸åŠ  (åˆ†é˜) */
        const toMin=t=>{if(t==='--')return 0;const h=parseInt(t);const m=parseInt(t.split('å°æ™‚')[1]);return h*60+m;};
        const totalMin=toMin(firstLeg)+toMin(wait)+toMin(secondLeg);
        const hh=Math.floor(totalMin/60),mm=totalMin%60;
        const total=`${hh}å°æ™‚${mm}åˆ†`;
        const finOv=isOvernight(arr,si,i)||next.isOv;
        const obj={
          trainNumber:num,trainType:t['è»Šç¨®'],startTime:arr[si][1],endTime:next.endTime,
          travelTime:total,startStation:st,endStation:ed,isOv:finOv,
          transferStations:[{station:trSt,transferTrainNumber:next.trainNumber,transferTrainType:next.trainType,transferStartTime:next.startTime,transferEndTime:next.endTime}]
        };
        const existing=combos[num]?combos[num][0]:null;
        if(isBetter(existing,obj)) combos[num]=[obj];
      }
    }
  }
  /* pick best of each train */
  const best=[];
  for(const n in combos) best.push(combos[n][0]);
  best.sort((a,b)=>a.startTime.localeCompare(b.startTime));

  best.forEach(r=>{
    const tr=tbody.insertRow();
    tr.insertCell().innerHTML=r.trainNumber.includes('A')?`${r.trainNumber}<span class="badge-sea">æµ·ç·š</span>`:r.trainNumber;
    const fr=trainSchedule[r.trainNumber]['è»Šç«™æ™‚é–“'];tr.insertCell().innerHTML=`${colorType(r.trainType)} (${fr[0][0]} â ${fr[fr.length-1][0]})`;
    tr.insertCell().innerHTML=highlightPeak(r.startTime);
    if(r.transferStations.length){
      const tInfo=r.transferStations[0];
      tr.insertCell().innerHTML=`${tInfo.station} (${highlightPeak(tInfo.transferStartTime)}) â†’ ğŸš‰${tInfo.transferTrainNumber} ${colorType(tInfo.transferTrainType)}`;
      tr.addEventListener('click',()=>showTrainDetails(r.trainNumber,tInfo.transferTrainNumber,tInfo.station));
    }else{
      tr.insertCell().innerHTML='-';
      tr.addEventListener('click',()=>showTrainDetails(r.trainNumber));
    }
    tr.insertCell().innerHTML=highlightPeak(r.endTime);
    tr.insertCell().innerHTML=r.travelTime;
  });
}

/* ---------- Modal ---------- */
function showTrainDetails(num,start=null,end=null){
  const modal=document.getElementById('trainDetailsModal');
  const title=document.getElementById('modalTitle');
  const body=document.getElementById('modalBody');body.innerHTML='';
  const tip=document.getElementById('transferTip');tip.style.display='none';

  const mkTable=(list,transferStation)=>{
    let html='<div class="table-wrapper"><table style="width:100%;border-collapse:collapse;font-size:.8rem">';
    html+='<thead><tr><th style="text-align:left;padding:4px 6px;">åœé ç«™</th><th style="text-align:left;padding:4px 6px;">æ™‚é–“</th></tr></thead><tbody>';
    list.forEach(s=>{
      const mark=s[0]===transferStation?`<strong>${s[0]}ğŸš‰</strong>`:s[0];
      html+=`<tr><td style="padding:4px 6px">${mark}</td><td style="padding:4px 6px">${highlightPeak(s[1])||'--'}</td></tr>`;
    });
    html+='</tbody></table></div>';return html;
  };

  /* åªæœ‰ä¸€æ®µ (ç›´é”) */
  if(!start){
    const arr=trainSchedule[num]['è»Šç«™æ™‚é–“'];
    body.innerHTML=mkTable(arr,null);
    title.textContent=`è»Šæ¬¡ ${num} çš„æ²¿é€”åœé ç«™`;
    modal.style.display='flex';
    return;
  }
  /* è½‰ä¹˜ */
  tip.style.display='block';
  tip.innerHTML=`è«‹åœ¨ <strong>${end}</strong> è½‰ä¹˜ <strong>${start}</strong>`;
  const arr1=trainSchedule[num]['è»Šç«™æ™‚é–“'];
  const arr2=trainSchedule[start]['è»Šç«™æ™‚é–“'];
  const secA=arr1.slice(0,arr1.findIndex(x=>x[0]===end)+1);
  const secB=arr2.slice(arr2.findIndex(x=>x[0]===end));
  body.innerHTML=`
    <h3 style="margin:.4rem 0;">ç¬¬ä¸€åˆ—è»Š ${num}</h3>${mkTable(secA,end)}
    <h3 style="margin:.8rem 0 .4rem;">è½‰ä¹˜åˆ—è»Š ${start}</h3>${mkTable(secB,end)}
  `;
  title.textContent=`${num} â†’ ${start} è½‰ä¹˜è©³æƒ…`;
  modal.style.display='flex';
}
function closeTrainDetailsModal(){document.getElementById('trainDetailsModal').style.display='none';}
window.onclick=e=>{if(e.target===document.getElementById('trainDetailsModal')) closeTrainDetailsModal();};

/* ---------- è»Šç«™ æŸ¥è©¢ ---------- */
function filterTrainScheduleByStationName(){
  const station=document.getElementById('stationNameInput').value.trim();
  const dir=document.getElementById('directionSelect').value;
  const tbody=document.querySelector('#scheduleTableByStationName tbody');
  tbody.innerHTML='';

  const nums=Object.keys(trainSchedule).sort((a,b)=>(getTime(a,station)||'99:99').localeCompare(getTime(b,station)||'99:99'));
  nums.forEach(num=>{
    const t=trainSchedule[num];
    if(selectedTrainTypesStation.length && !selectedTrainTypesStation.includes(t['è»Šç¨®'])) return;
    if(!t['è»Šç«™æ™‚é–“'].some(s=>s[0]===station)) return;
    if(getDirection(num)!==dir) return;
    const arr=t['è»Šç«™æ™‚é–“'];const idx=arr.findIndex(s=>s[0]===station);
    const tr=tbody.insertRow();
    tr.insertCell().innerHTML=num.includes('A')?`${num}<span class="badge-sea">æµ·ç·š</span>`:num;
    tr.insertCell().innerHTML=`${colorType(t['è»Šç¨®'])} (${arr[0][0]} â ${arr[arr.length-1][0]})`;
    tr.insertCell().innerHTML=highlightPeak(arr[idx][1]||'--');
    tr.insertCell().innerHTML=calcStationUtil(t,station,arr[idx][1]||'');
    tr.onclick=()=>showTrainDetails(num);
  });
}

/* ---------- è»Šæ¬¡ç¯©é¸ & æŸ¥è©¢ ---------- */
function filterTrainNumbers(){
  const v=document.getElementById('trainNumberInput').value.trim();
  const drop=document.getElementById('trainNumbersDropdown');
  drop.innerHTML='';
  const matched=Object.keys(trainSchedule).filter(k=>k.startsWith(v));
  if(matched.length){
    matched.forEach(n=>{const o=document.createElement('option');o.value=o.text=n;drop.add(o);});
  }else{
    const o=document.createElement('option');o.text='æŸ¥ç„¡æ­¤ç­æ¬¡';drop.add(o);
  }
}
function selectTrainNumber(){document.getElementById('trainNumberInput').value=document.getElementById('trainNumbersDropdown').value;}
function filterTrainScheduleByNumber(){
  const num=document.getElementById('trainNumberInput').value.trim();
  const tbody=document.querySelector('#scheduleTableByNumber tbody');
  tbody.innerHTML='';
  const t=trainSchedule[num];if(!t) return;
  const arr=t['è»Šç«™æ™‚é–“'];
  const tr=tbody.insertRow();
  tr.insertCell().innerHTML=num.includes('A')?`${num}<span class="badge-sea">æµ·ç·š</span>`:num;
  tr.insertCell().innerHTML=`${colorType(t['è»Šç¨®'])} (${arr[0][0]} â ${arr[arr.length-1][0]})`;
  tr.insertCell().innerHTML=calcTrainUtil(t);
  tr.onclick=()=>showTrainDetails(num);
}

/* ---------- é¦–æ¬¡é è¨­è¡¨é ­ ---------- */
buildStartEndHeader(false);
</script>
</body>
</html>
