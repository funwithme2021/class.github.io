<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å°éµæ™‚åˆ»è¡¨ (Liveç‰ˆ)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
  /* ===== 1. æ ¸å¿ƒè®Šæ•¸èˆ‡ Reset ===== */
  :root {
    --font-main: 'Inter', 'Noto Sans TC', sans-serif;
    --bg-body: #f8fafc;
    --bg-surface: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --text-light: #94a3b8;
    --border: #e2e8f0;
    --primary: #2563eb;
    --primary-bg: rgba(37, 99, 235, 0.1);
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --radius: 10px;
  }

  body.dark-mode {
    --bg-body: #0f172a;
    --bg-surface: #1e293b;
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --text-light: #64748b;
    --border: #334155;
    --primary: #60a5fa;
    --primary-bg: rgba(96, 165, 250, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    font-family: var(--font-main);
    background: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    padding-bottom: 40px;
  }

  /* ===== 2. å°èˆªåˆ— ===== */
  .navbar {
    position: sticky; top: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.8rem 1.5rem;
    background: var(--bg-header);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  .navbar .brand { font-weight: 700; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
  .nav-links { display: flex; gap: 4px; align-items: center; }
  .nav-links a {
    color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500;
    padding: 6px 12px; border-radius: 6px; transition: 0.2s;
  }
  .nav-links a:hover { background: var(--bg-body); color: var(--primary); }
  .theme-btn {
    border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-main);
    padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;
  }
  .hamburger { display: none; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; }
  .hamburger span { width: 24px; height: 2px; background: var(--text-main); }

  @media(max-width: 900px) {
    .nav-links {
      position: absolute; top: 100%; left: 0; width: 100%;
      background: var(--bg-surface); border-bottom: 1px solid var(--border);
      flex-direction: column; align-items: flex-start; padding: 0;
      max-height: 0; overflow: hidden; opacity: 0; transition: 0.3s;
    }
    .nav-links.open { max-height: 500px; opacity: 1; padding: 1rem; }
    .nav-links a { width: 100%; padding: 10px; }
    .hamburger { display: flex; }
  }

  /* ===== 3. ä¸»è¦å®¹å™¨ ===== */
  .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
  .grid { display: grid; gap: 24px; }

  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .section-title {
    font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 2px; }

  /* ===== 4. è¡¨å–®èˆ‡ç¯©é¸ ===== */
  .form-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 16px; position: relative; }
  
  .input-group { 
    display: flex; align-items: center; gap: 8px; 
    background: var(--bg-body); padding: 4px 8px; 
    border: 1px solid var(--border); border-radius: 8px; 
    flex: 1; min-width: 120px;
  }
  .input-group label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; white-space: nowrap; }
  input, select {
    border: none; background: transparent; color: var(--text-main); 
    font-size: 0.95rem; padding: 6px; outline: none; width: 100%; 
  }

  /* äº’æ›æŒ‰éˆ• */
  .swap-btn {
    width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--bg-surface); color: var(--primary);
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; transition: 0.2s; font-size: 1.1rem;
  }
  .swap-btn:hover { background: var(--bg-body); transform: rotate(180deg); }

  button.btn-primary {
    background: var(--primary); color: #fff; border: none;
    padding: 8px 16px; border-radius: 8px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }

  /* æ­·å²ç´€éŒ„ Chips */
  .history-chips { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .history-chip {
    font-size: 0.8rem; padding: 4px 10px; border-radius: 12px;
    background: var(--bg-body); color: var(--text-muted);
    border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 4px;
  }
  .history-chip:hover { background: var(--primary-bg); color: var(--primary); border-color: var(--primary); }

  /* æ¨™ç±¤å¼ Checkbox */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .chip-label {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 10px; border-radius: 20px;
    border: 1px solid var(--border); background: var(--bg-surface);
    color: var(--text-muted); font-size: 0.85rem; cursor: pointer;
    user-select: none; transition: 0.2s;
  }
  .chip-label:hover { background: var(--bg-body); }
  .chip-label input { display: none; }
  .chip-label:has(input:checked) {
    background: var(--primary-bg); color: var(--primary); border-color: var(--primary); font-weight: 500;
  }
  .chip-label input:checked + span { color: var(--primary); }

  /* ===== 5. è¡¨æ ¼æ¨£å¼ ===== */
  .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
  
  th {
    background: var(--bg-body); color: var(--text-muted); font-weight: 600; text-align: left;
    padding: 12px 16px; border-bottom: 1px solid var(--border);
  }
  th.sortable { cursor: pointer; }
  td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: var(--bg-body); cursor: pointer; }

  /* æ•¸å­—å°é½Š */
  td { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
  
  /* æ¨™ç±¤ Badge */
  .badge-sea { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #0ea5e9; color: #fff; margin-left: 4px; }
  .peak-hour { color: #d97706; font-weight: 700; background: #fef3c7; padding: 2px 6px; border-radius: 4px; }
  body.dark-mode .peak-hour { background: rgba(217, 119, 6, 0.2); color: #fbbf24; }
  
  .train-route { font-size: 0.85rem; color: var(--text-muted); margin-left: 6px; }
  .progress-bar { width: 100px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
  .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; }

  /* ===== 6. Modal (å½ˆçª—) & æ™‚é–“è»¸ ===== */
  .modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px);
    z-index: 2000; justify-content: center; align-items: center;
    opacity: 0; transition: opacity 0.3s;
  }
  .modal[style*="display: flex"] { opacity: 1; }

  .modal-content {
    background: var(--bg-surface); width: 95%; max-width: 500px; max-height: 85vh;
    border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    overflow: hidden; display: flex; flex-direction: column;
    transform: translateY(20px); transition: transform 0.3s;
  }
  .modal[style*="display: flex"] .modal-content { transform: translateY(0); }

  .modal-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-body);
  }
  .modal-title-main { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
  .modal-title-sub { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }
  .close { font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }

  .modal-body { padding: 0; overflow-y: auto; background: var(--bg-surface); }

  /* æ™‚é–“è»¸æ¨£å¼ */
  .timeline { padding: 10px 20px; }
  .timeline-item { display: flex; position: relative; padding-bottom: 0; }
  
  /* å·¦å´æ™‚é–“ */
  .tl-time {
    width: 50px; text-align: right; font-size: 0.9rem; font-weight: 600; 
    color: var(--text-main); padding-right: 15px; padding-top: 2px;
    font-variant-numeric: tabular-nums;
  }
  
  /* ä¸­é–“ç·šæ¢èˆ‡åœ“é» */
  .tl-marker {
    display: flex; flex-direction: column; align-items: center; width: 20px; position: relative;
  }
  .tl-line {
    width: 2px; background: var(--border); flex-grow: 1; margin-top: 4px; margin-bottom: -4px;
  }
  .timeline-item:last-child .tl-line { display: none; }
  .tl-dot {
    width: 10px; height: 10px; border-radius: 50%; background: var(--border);
    border: 2px solid var(--bg-surface); z-index: 1; flex-shrink: 0; transition: all 0.3s;
  }
  
  /* å³å´ç«™å */
  .tl-content { padding-left: 15px; padding-bottom: 24px; flex-grow: 1; }
  .timeline-item:last-child .tl-content { padding-bottom: 10px; }
  
  .tl-station { font-size: 1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; }
  .tl-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }

  /* --- ç‹€æ…‹æ¨£å¼ --- */
  .timeline-item.passed .tl-time, 
  .timeline-item.passed .tl-station { opacity: 0.4; filter: grayscale(1); }
  .timeline-item.passed .tl-dot { background: var(--border); }

  .timeline-item.next .tl-dot { 
    background: #22c55e; width: 14px; height: 14px; 
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2); 
    border-color: #fff; 
  }
  .timeline-item.next .tl-station { color: #15803d; font-weight: 700; }
  body.dark-mode .timeline-item.next .tl-station { color: #4ade80; }
  
  .timeline-item.transfer .tl-dot { background: #d97706; width: 12px; height: 12px; }
  .timeline-item.transfer .tl-station { color: #b45309; }

  .badge-next {
    display: inline-flex; align-items: center; gap: 4px;
    background: #22c55e; color: #fff; font-size: 0.7rem; 
    padding: 2px 8px; border-radius: 10px; margin-left: 8px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

  .transfer-banner {
    background: var(--bg-body); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
    padding: 10px 20px; display: flex; align-items: center; gap: 10px; margin: 10px -20px 20px -20px;
  }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="brand">å°éµæ™‚åˆ»è¡¨ Pro+</div>
  <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
  <div class="nav-links" id="navLinks">
    <a class="tab" href="index-tra.transfer.html">è½‰ä¹˜æŸ¥è©¢</a>
        <a class="tab" href="index-tra.move.html">åˆ—è»Šå‹•æ…‹</a>
        <a class="tab active">è»Šç«™çœ‹æ¿</a>
        <a class="tab" href="index-tra.table.html">æ™‚åˆ»ç¸½è¡¨</a>
    <a href="index-speed.html">é«˜éµæ™‚åˆ»è¡¨</a>
    <a href="index-thsr.html">é«˜éµæ™‚åˆ»è¡¨(å°ˆç”¨)</a>
    <a href="index.html">æ™‚åˆ»è¡¨</a>
    <a href="index-tra.transfer.html">æ™‚åˆ»è¡¨(å«é‹ç”¨)</a>
    <a href="index-tra.easy.html">ç°¡å¼æ™‚åˆ»è¡¨</a>
    <a href="index-tra.type.html">ä¾è»Šç¨®æ™‚åˆ»è¡¨</a>
    <a href="train-info.html">è»Šç«™è³‡è¨Šæ¿</a>
    <a href="people.html">é‹é‡æŸ¥è©¢</a>
    <a href="stopnumber.html">é‹é‡è®Šå‹•æŸ¥è©¢</a>
    <a href="index.trainrate.html">é‹ç”¨ç‡æŸ¥è©¢</a>
    <a href="index-tra.book.html">è¨‚ç¥¨ç³»çµ±</a>
    <a href="index-tra.make.html">åˆ—è»Šæ’é»</a>
  </div>
  <button class="theme-btn" onclick="toggleDarkMode()">
    <span>â—‘</span> <span>æ¨¡å¼</span>
  </button>
</nav>

<main class="container">
  <div class="grid">

    <section class="card">
      <div class="section-title">é»å°é» / è½‰ä¹˜æŸ¥è©¢</div>
      <datalist id="stationList"></datalist>
      
      <div id="searchHistory" class="history-chips"></div>

      <div class="form-row">
        <div class="input-group">
          <label>å‡ºç™¼</label>
          <input id="startStationInput" list="stationList" placeholder="è«‹é¸æ“‡">
        </div>
        
        <button class="swap-btn" onclick="swapStations()" title="äº¤æ›èµ·è¨–ç«™">â‡„</button>

        <div class="input-group">
          <label>æŠµé”</label>
          <input id="endStationInput" list="stationList" placeholder="è«‹é¸æ“‡">
        </div>
        <button class="btn-primary" onclick="filterTrainScheduleByStation()">ğŸ” æŸ¥è©¢æ™‚åˆ»</button>
      </div>

      <div class="chip-group">
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','æ–°è‡ªå¼·')"> æ–°è‡ªå¼·</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','æ™®æ‚ ç‘ª')"> æ™®æ‚ ç‘ª</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ(æ–°)')"> è‡ªå¼·(æ–°)</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ')"> è‡ªå¼·è™Ÿ</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','è’å…‰è™Ÿ')"> è’å…‰è™Ÿ</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','å¾©èˆˆè™Ÿ')"> å¾©èˆˆè™Ÿ</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','å€é–“å¿«')"> å€é–“å¿«</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','å€é–“è»Š')"> å€é–“è»Š</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('start-end','åŠ ç­è»Š')"> åŠ ç­è»Š</label>
      </div>

      <div class="form-row" style="margin-bottom:0;">
        <label class="chip-label" style="border-radius:6px; padding:8px 12px; background:var(--bg-body);">
          <input type="checkbox" id="acceptTransfers">
          <span>ğŸ”„ åŒ…å«è½‰ä¹˜æ–¹æ¡ˆ (æœ€æ—©æŠµé”)</span>
        </label>
      </div>

      <div class="table-wrapper" style="margin-top:1.5rem;">
        <table id="scheduleTableByStation">
          <thead><tr id="startEndHeader"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-title">è»Šç«™æ™‚åˆ»è¡¨</div>
      <datalist id="stationList2"></datalist>
      
      <div class="form-row">
        <div class="input-group">
          <label>è»Šç«™</label>
          <input id="stationNameInput" list="stationList2" placeholder="è¼¸å…¥ç«™å">
        </div>
        <div class="input-group">
          <label>æ–¹å‘</label>
          <select id="directionSelect">
            <option value="northbound">åŒ—ä¸Š (é †è¡Œ)</option>
            <option value="southbound">å—ä¸‹ (é€†è¡Œ)</option>
          </select>
        </div>
        <button class="btn-primary" onclick="filterTrainScheduleByStationName()">æŸ¥è©¢</button>
      </div>

      <div class="chip-group">
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','æ–°è‡ªå¼·')"> æ–°è‡ªå¼·</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','æ™®æ‚ ç‘ª')"> æ™®æ‚ ç‘ª</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ(æ–°)')"> è‡ªå¼·(æ–°)</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ')"> è‡ªå¼·è™Ÿ</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','è’å…‰è™Ÿ')"> è’å…‰è™Ÿ</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','å¾©èˆˆè™Ÿ')"> å¾©èˆˆè™Ÿ</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','å€é–“å¿«')"> å€é–“å¿«</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','å€é–“è»Š')"> å€é–“è»Š</label>
        <label class="chip-label"><input type="checkbox" onclick="toggleTrainTypeFilter('station','åŠ ç­è»Š')"> åŠ ç­è»Š</label>
      </div>

      <div class="table-wrapper" style="margin-top:1rem;">
        <table id="scheduleTableByStationName">
          <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th><th>æ™‚é–“</th><th>é ä¼°æ··é›œç‡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-title">è»Šæ¬¡æŸ¥è©¢</div>
      <div class="form-row">
        <div class="input-group">
          <label>è»Šæ¬¡</label>
          <input id="trainNumberInput" oninput="filterTrainNumbers()" placeholder="å¦‚ 408">
        </div>
        <div class="input-group">
          <label>åˆ—è¡¨</label>
          <select id="trainNumbersDropdown" onchange="selectTrainNumber()">
            <option>è¼¸å…¥å¾Œé¸æ“‡</option>
          </select>
        </div>
        <button class="btn-primary" onclick="filterTrainScheduleByNumber()">æŸ¥è©¢</button>
      </div>

      <div class="table-wrapper" style="margin-top:1rem;">
        <table id="scheduleTableByNumber">
          <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th><th>é ä¼°æ··é›œç‡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>
</main>

<div id="trainDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <div class="modal-title-main" id="modalTitleMain">è»Šæ¬¡è³‡è¨Š</div>
        <div class="modal-title-sub" id="modalTitleSub">å€é–“è³‡è¨Š</div>
      </div>
      <span class="close" onclick="closeTrainDetailsModal()">&times;</span>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<script src="train-schedule.js"></script>
<script>
// ===== æ ¸å¿ƒå·¥å…·ï¼šæ­£è¦åŒ–ç«™å =====
const normalizeStation = (name) => {
  if (!name) return "";
  return name.replace(/å°/g, "è‡º").trim();
};

// ===== åŸºç¤é‚è¼¯èˆ‡è³‡æ–™è¼‰å…¥ =====
function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
const hb=document.getElementById('hamburger'), nav=document.getElementById('navLinks');
hb.addEventListener('click',()=>nav.classList.toggle('open'));
nav.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>nav.classList.remove('open')));

const stationListEl=document.getElementById('stationList'),
      stationList2El=document.getElementById('stationList2');
if (typeof stations !== 'undefined') {
  stations.forEach(s=>{
    let o1=document.createElement('option'); o1.value=s; stationListEl.appendChild(o1);
    let o2=document.createElement('option'); o2.value=s; stationList2El.appendChild(o2);
  });
}

let selectedTrainTypesStartEnd=[], selectedTrainTypesStation=[];
let currentStartEndList=[], currentTransferList=[];
let sortState={ key:null, asc:true };

function toggleTrainTypeFilter(ctx,type){
  const arr = ctx==='start-end'? selectedTrainTypesStartEnd : selectedTrainTypesStation;
  const idx=arr.indexOf(type);
  if(idx>-1) arr.splice(idx,1); else arr.push(type);
  if(ctx==='start-end') filterTrainScheduleByStation();
  else filterTrainScheduleByStationName();
}

function sortStartEndList(key){
  if(sortState.key===key) sortState.asc=!sortState.asc;
  else{ sortState.key=key; sortState.asc=true; }
  currentStartEndList.sort((a,b)=> sortState.asc? a[key]-b[key] : b[key]-a[key]);
  renderStartEndTable();
}
function sortTransferList(key){
  if(sortState.key===key) sortState.asc=!sortState.asc;
  else{ sortState.key=key; sortState.asc=true; }
  currentTransferList.sort((a,b)=> sortState.asc? a[key]-b[key] : b[key]-a[key]);
  renderTransferTable();
}

function parseTime(t){ const [h,m]=t.split(':').map(v=>parseInt(v)||0); return h*60+m; }
function diff(a,b){
  if(!a||!b) return '--';
  let d=parseTime(b)-parseTime(a);
  if(d<0) d+=1440;
  const hh=Math.floor(d/60), mm=d%60;
  return `${hh}æ™‚${mm}åˆ†`;
}

// ===== æ­·å²æœå°‹ç´€éŒ„ =====
function saveSearchHistory(start, end) {
  let history = JSON.parse(localStorage.getItem('tra_search_history') || '[]');
  history = history.filter(h => !(h.start === start && h.end === end));
  history.unshift({ start, end });
  if(history.length > 5) history.pop();
  localStorage.setItem('tra_search_history', JSON.stringify(history));
  renderSearchHistory();
}

function renderSearchHistory() {
  const container = document.getElementById('searchHistory');
  const history = JSON.parse(localStorage.getItem('tra_search_history') || '[]');
  if (history.length === 0) {
    container.innerHTML = '';
    return;
  }
  let html = '';
  history.forEach(h => {
    html += `<div class="history-chip" onclick="useHistory('${h.start}', '${h.end}')">
              <span>ğŸ•’ ${h.start} â ${h.end}</span>
             </div>`;
  });
  container.innerHTML = html;
}

function useHistory(start, end) {
  document.getElementById('startStationInput').value = start;
  document.getElementById('endStationInput').value = end;
  filterTrainScheduleByStation();
}
renderSearchHistory();

// ===== èµ·è¨–äº’æ› =====
function swapStations() {
  const sInput = document.getElementById('startStationInput');
  const eInput = document.getElementById('endStationInput');
  const temp = sInput.value;
  sInput.value = eInput.value;
  eInput.value = temp;
  if(sInput.value && eInput.value) filterTrainScheduleByStation();
}

// ===== è¡¨é ­ç”Ÿæˆ =====
const startEndHeader=document.getElementById('startEndHeader');
function buildStartEndHeader(isTransfer){
  startEndHeader.innerHTML='';
  if(isTransfer){
    [
      {text:'è»Šæ¬¡',key:null}, {text:'è»Šç¨® (å€é–“)',key:null}, 
      {text:'å‡ºç™¼',key:'startTimeMin'}, {text:'è½‰ä¹˜è³‡è¨Š',key:null}, 
      {text:'æŠµé”',key:'endTimeMin'}, {text:'è€—æ™‚',key:'travelMin'}
    ].forEach(col=>{
      let th=document.createElement('th'); th.textContent=col.text;
      if(col.key){ th.classList.add('sortable'); th.addEventListener('click',()=>sortTransferList(col.key)); }
      startEndHeader.appendChild(th);
    });
  } else {
    [
      {text:'è»Šæ¬¡',key:null}, {text:'è»Šç¨® (å€é–“)',key:null}, 
      {text:'å‡ºç™¼',key:'sTimeMin'}, {text:'æŠµé”',key:'eTimeMin'},
      {text:'è€—æ™‚',key:'travelMin'}, {text:'åœé ',key:null}, {text:'æ··é›œç‡',key:null}
    ].forEach(col=>{
      let th=document.createElement('th'); th.textContent=col.text;
      if(col.key){ th.classList.add('sortable'); th.addEventListener('click',()=>sortStartEndList(col.key)); }
      startEndHeader.appendChild(th);
    });
  }
}

// ===== æ¸²æŸ“ç›´é”è»Š =====
function renderStartEndTable(){
  const tbody=document.querySelector('#scheduleTableByStation tbody');
  tbody.innerHTML='';
  let maxTravel=Math.max(...currentStartEndList.map(r=>r.travelMin),1);
  currentStartEndList.forEach(r=>{
    let tr=tbody.insertRow();
    tr.insertCell().innerHTML=r.num.includes('A')?`<b>${r.num}</b><span class="badge-sea">æµ·</span>`:`<b>${r.num}</b>`;
    tr.insertCell().innerHTML=`${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
    tr.insertCell().innerHTML=highlightPeak(r.sTime);
    tr.insertCell().innerHTML=highlightPeak(r.eTime);
    let cell=tr.insertCell();
    cell.innerHTML=`<div style="font-size:.85rem;font-weight:600">${r.travel}</div><div class="progress-bar"><div class="progress-fill" style="width:${((r.travelMin/maxTravel)*100).toFixed(1)}%"></div></div>`;
    let stopsCell=tr.insertCell();
    if(r.stopsCount>0){
      stopsCell.innerHTML=`${r.stopsCount}ç«™ <span class="toggle-arrow">â–¼</span>`;
      stopsCell.querySelector('.toggle-arrow').addEventListener('click',e=>{ e.stopPropagation(); toggleStopsRow(tr,r.startStation,r.endStation,r.num); });
    } else stopsCell.innerHTML='<span style="color:#16a34a;font-weight:600">ç›´é”</span>';
    tr.insertCell().innerHTML=r.usage;
    tr.addEventListener('click',()=>showTrainDetails(r.num));
  });
}

// ===== æ¸²æŸ“è½‰ä¹˜è»Š (UIå„ªåŒ–) =====
function renderTransferTable(){
  const tbody=document.querySelector('#scheduleTableByStation tbody');
  tbody.innerHTML='';
  let maxTravel=Math.max(...currentTransferList.map(r=>r.travelMin),1);
  currentTransferList.forEach(r=>{
    let tr=tbody.insertRow();
    tr.insertCell().innerHTML=r.trainNumber.includes('A')?`<b>${r.trainNumber}</b><span class="badge-sea">æµ·</span>`: `<b>${r.trainNumber}</b>`;
    
    // [å„ªåŒ–] é¡¯ç¤ºç¬¬ä¸€æ®µè»Šç¨®é¡è‰²
    const full=trainSchedule[r.trainNumber]['è»Šç«™æ™‚é–“'];
    tr.insertCell().innerHTML=`${colorType(r.trainType)} <span class="train-route">(${full[0][0]}â${full.slice(-1)[0][0]})</span>`;
    
    tr.insertCell().innerHTML=highlightPeak(r.startTime);
    let td=tr.insertCell(), t0=r.transferStations[0];
    if(t0){
      // [å„ªåŒ–] é¡¯ç¤ºå€™è»Šæ™‚é–“
      td.innerHTML=`<div style="font-size:0.85rem; line-height:1.4">
        æ–¼ <b>${t0.station}</b> è½‰ <span style="color:#d97706; font-size:0.8rem">(å€™è»Š ${t0.waitTime})</span><br>
        <span style="color:var(--text-muted)">${highlightPeak(t0.transferStartTime)}</span> â <b>${t0.transferTrainNumber}</b> ${colorType(t0.transferTrainType)}
      </div>`;
      tr.addEventListener('click',()=>showTrainDetails(r.trainNumber,t0.transferTrainNumber,t0.station));
    } else {
      td.textContent='-';
      tr.addEventListener('click',()=>showTrainDetails(r.trainNumber));
    }
    tr.insertCell().innerHTML=highlightPeak(r.endTime);
    let cell=tr.insertCell();
    cell.innerHTML=`<div style="font-weight:600;font-size:0.85rem">${r.travelTime}</div><div class="progress-bar"><div class="progress-fill" style="width:${((r.travelMin/maxTravel)*100).toFixed(1)}%"></div></div>`;
  });
}

// æŸ¥è©¢é‚è¼¯
function filterTrainScheduleByStation(){
  let stRaw = document.getElementById('startStationInput').value.trim();
  let edRaw = document.getElementById('endStationInput').value.trim();
  const st = normalizeStation(stRaw);
  const ed = normalizeStation(edRaw);
  
  if(st !== stRaw) document.getElementById('startStationInput').value = st;
  if(ed !== edRaw) document.getElementById('endStationInput').value = ed;

  const acceptTransfers=document.getElementById('acceptTransfers').checked;

  if(st && ed && st !== ed) {
    saveSearchHistory(st, ed);
  }

  if(acceptTransfers){ filterTrainScheduleWithTransfers(st,ed); } else {
    buildStartEndHeader(false);
    let list=[];
    for(let num in trainSchedule){
      let t=trainSchedule[num];
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) continue;
      let arr=t['è»Šç«™æ™‚é–“'], si=arr.findIndex(s=>s[0]===st), ei=arr.findIndex(s=>s[0]===ed);
      if(si>-1&&ei>-1&&si<ei){
        let sTime=arr[si][1], eTime=arr[ei][1], travel=diff(sTime,eTime), travelMin=parseTime(eTime)-parseTime(sTime)+(parseTime(eTime)<parseTime(sTime)?1440:0), stopsCount=ei-si-1, usage=calcSegUtil(t,arr.slice(si,ei+1));
        list.push({ num, type:t['è»Šç¨®'], range:`${arr[0][0]}â${arr[arr.length-1][0]}`, sTime,eTime, sTimeMin:parseTime(sTime), eTimeMin:parseTime(eTime), travel,travelMin,stopsCount, usage,usagePct:parseFloat(usage), startStation:st,endStation:ed });
      }
    }
    list.sort((a,b)=>a.sTimeMin-b.sTimeMin); currentStartEndList=list; sortState={key:null,asc:true}; renderStartEndTable();
  }
}

function filterTrainScheduleWithTransfers(st,ed){
  buildStartEndHeader(true);
  let combos={};
  
  // ç¬¬ä¸€æ®µ
  for(let num in trainSchedule){
    let t=trainSchedule[num], arr=t['è»Šç«™æ™‚é–“'], si=arr.findIndex(x=>x[0]===st), ei=arr.findIndex(x=>x[0]===ed);
    if(si>-1&&ei>-1&&si<ei){ // ç›´é”
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) continue;
      let sTime=arr[si][1], eTime=arr[ei][1], arriveMin=parseTime(eTime), travelTime=diff(sTime,eTime), travelMin=arriveMin-parseTime(sTime)+(arriveMin<parseTime(sTime)?1440:0);
      combos[num]=[{ trainNumber:num, trainType:t['è»Šç¨®'], startTime:sTime, endTime:eTime, startTimeMin:parseTime(sTime), endTimeMin:arriveMin, travelTime, travelMin, transferStations:[] }];
    }
  }

  const minBuffer = 5; // [å„ªåŒ–] è½‰ä¹˜è‡³å°‘éœ€è¦ 5 åˆ†é˜

  function findConnecting(fromSt,toSt,afterTime){
    const afterRaw=parseTime(afterTime); let best=null;
    for(const n in trainSchedule){
      const tr=trainSchedule[n], a=tr['è»Šç«™æ™‚é–“'], si=a.findIndex(x=>x[0]===fromSt), ei=a.findIndex(x=>x[0]===toSt);
      if(si>-1&&ei>-1&&si<ei){
        const departStr=a[si][1], arriveStr=a[ei][1], departRaw=parseTime(departStr);
        const dOff=departRaw<=afterRaw?1:0, departMin=departRaw+dOff*1440;
        
        // [å„ªåŒ–] æª¢æŸ¥ç·©è¡æ™‚é–“
        if(departMin < afterRaw + minBuffer) continue;

        const arriveRaw=parseTime(arriveStr), aOff=dOff+(arriveRaw<departRaw?1:0), arriveMin=arriveRaw+aOff*1440;
        if(!best||arriveMin<best.arriveMin) best={trainNumber:n,transferTrainType:tr['è»Šç¨®'],transferStartTime:departStr,transferEndTime:arriveStr,arriveMin};
      }
    }
    return best;
  }

  for(let num in trainSchedule){
    let t=trainSchedule[num], arr=t['è»Šç«™æ™‚é–“'], si=arr.findIndex(x=>x[0]===st);
    if(si===-1) continue;
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) continue;
    
    // å°‹æ‰¾å¯èƒ½çš„è½‰ä¹˜
    for(let i=si+1;i<arr.length;i++){
      let ts=arr[i][0], reach=arr[i][1];
      let nxt=findConnecting(ts,ed,reach);
      
      if(nxt){
        // [ä¿®æ­£] ç¸½è€—æ™‚è¨ˆç®— logic: çµ‚é»æŠµé” - èµ·é»å‡ºç™¼
        let startMin = parseTime(arr[si][1]);
        let endMin = nxt.arriveMin; // å·²ç¶“æ˜¯çµ•å°æ™‚é–“
        let totalMin = endMin - startMin;
        if (totalMin < 0) totalMin += 1440; // è·¨æ—¥ä¿®æ­£

        let travelTimeStr = `${Math.floor(totalMin/60)}æ™‚${totalMin%60}åˆ†`;

        // [å„ªåŒ–] è¨ˆç®—å€™è»Šæ™‚é–“
        let arrivalAtTransfer = parseTime(reach);
        let departFromTransfer = parseTime(nxt.transferStartTime);
        let waitMin = departFromTransfer - arrivalAtTransfer;
        if(waitMin < 0) waitMin += 1440;
        let waitStr = `${Math.floor(waitMin/60)}æ™‚${waitMin%60}åˆ†`;
        if(Math.floor(waitMin/60)===0) waitStr = `${waitMin}åˆ†`; // å¦‚æœå°æ–¼1å°æ™‚åªé¡¯ç¤ºåˆ†

        let obj={ 
          trainNumber:num, 
          trainType:t['è»Šç¨®'], 
          startTime:arr[si][1], 
          endTime:nxt.transferEndTime, 
          startTimeMin:startMin, 
          endTimeMin:endMin, 
          travelTime:travelTimeStr, 
          travelMin:totalMin, 
          transferStations:[{
            station:ts,
            transferTrainNumber:nxt.trainNumber,
            transferTrainType:nxt.transferTrainType,
            transferStartTime:nxt.transferStartTime,
            waitTime: waitStr
          }] 
        };
        if(!combos[num]||obj.endTimeMin<combos[num][0].endTimeMin) combos[num]=[obj];
      }
    }
  }
  let bestList=Object.values(combos).map(a=>a[0]);
  bestList.sort((a,b)=>a.startTimeMin-b.startTimeMin); currentTransferList=bestList; sortState={key:null,asc:true}; renderTransferTable();
}

function filterTrainScheduleByStationName(){
  let stationRaw = document.getElementById('stationNameInput').value.trim();
  const station = normalizeStation(stationRaw);
  if(station !== stationRaw) document.getElementById('stationNameInput').value = station;

  const dir=document.getElementById('directionSelect').value;
  const tbody=document.querySelector('#scheduleTableByStationName tbody');
  tbody.innerHTML='';
  Object.keys(trainSchedule).sort((a,b)=>(getTime(a,station)||'99:99').localeCompare(getTime(b,station)||'99:99')).forEach(num=>{
    let t=trainSchedule[num];
    if(selectedTrainTypesStation.length && !selectedTrainTypesStation.includes(t['è»Šç¨®'])) return;
    if(!t['è»Šç«™æ™‚é–“'].some(s=>s[0]===station)) return;
    if(getDirection(num)!==dir) return;
    let arr=t['è»Šç«™æ™‚é–“'], idx=arr.findIndex(s=>s[0]===station);
    let tr=tbody.insertRow();
    tr.insertCell().innerHTML=num.includes('A')?`<b>${num}</b><span class="badge-sea">æµ·</span>`:`<b>${num}</b>`;
    tr.insertCell().innerHTML=`${colorType(t['è»Šç¨®'])} <span class="train-route">(${arr[0][0]}â${arr.slice(-1)[0][0]})</span>`;
    tr.insertCell().innerHTML=highlightPeak(arr[idx][1]||'--');
    tr.insertCell().innerHTML=calcStationUtil(t,station,arr[idx][1]||'');
    tr.addEventListener('click',()=>showTrainDetails(num));
  });
}

function filterTrainScheduleByNumber(){
  const num=document.getElementById('trainNumberInput').value.trim(), tbody=document.querySelector('#scheduleTableByNumber tbody');
  tbody.innerHTML='';
  const t=trainSchedule[num];
  if(!t) return;
  let arr=t['è»Šç«™æ™‚é–“'];
  let tr=tbody.insertRow();
  tr.insertCell().innerHTML=num.includes('A')?`<b>${num}</b><span class="badge-sea">æµ·</span>`:`<b>${num}</b>`;
  tr.insertCell().innerHTML=`${colorType(t['è»Šç¨®'])} <span class="train-route">(${arr[0][0]}â${arr.slice(-1)[0][0]})</span>`;
  tr.insertCell().innerHTML=calcTrainUtil(t);
  tr.addEventListener('click',()=>showTrainDetails(num));
}

const stationMaxCapacities={æ–°è‡ªå¼·:638,æ™®æ‚ ç‘ª:406,'è‡ªå¼·è™Ÿ(æ–°)':906,'è‡ªå¼·è™Ÿ':866,è’å…‰è™Ÿ:1000,å¾©èˆˆè™Ÿ:1000,å€é–“å¿«:1700,å€é–“è»Š:1700,åŠ ç­è»Š:638};
const popularityWeights={æ™®æ‚ ç‘ª:1.42,æ–°è‡ªå¼·:2.4,åŠ ç­è»Š:2.4,'è‡ªå¼·è™Ÿ(æ–°)':4.7,'è‡ªå¼·è™Ÿ':3.15,è’å…‰è™Ÿ:3.0,å¾©èˆˆè™Ÿ:3.35,å€é–“å¿«:5.85,å€é–“è»Š:5.65};
const timeWeights={short_peak:5,long_peak:7.5,short_offpeak:3,long_offpeak:3};
const stationDensity={};
for(const n in trainSchedule){ trainSchedule[n]['è»Šç«™æ™‚é–“'].forEach(s=>{ stationDensity[s[0]]=(stationDensity[s[0]]||0)+1; }); }
function calculateTimeWeight(t){ const h=parseInt(t.split(':')[0],10); return ((h>=6&&h<9.5)||(h>=12&&h<13)||(h>=16&&h<20)||(h>=21&&h<22))?timeWeights.short_peak:((h>=6.5&&h<10)||(h>=16&&h<20.5))?timeWeights.long_peak:timeWeights.short_offpeak; }
function randFactor(type){ return ['æ™®æ‚ ç‘ª','æ–°è‡ªå¼·'].includes(type)?(Math.random()*0.15)-0.1:(Math.random()*0.22)-0.1; }
function calcStationUtil(t,st,time){ let max=stationMaxCapacities[t['è»Šç¨®']]||110, pop=popularityWeights[t['è»Šç¨®']]||1, tw=calculateTimeWeight(time), load=0; for(let i=0;i<3;i++) load+=((stationDensity[st]||0)*tw*pop)*(1+randFactor(t['è»Šç¨®'])); return Math.min(Math.max((load/3)/max*50,0),100).toFixed(1)+'%'; }
function calcSegUtil(t,sub){ let max=stationMaxCapacities[t['è»Šç¨®']]||110, pop=popularityWeights[t['è»Šç¨®']]||1, total=0; for(let i=0;i<3;i++){ let d=0; sub.forEach(s=>{ d+=((stationDensity[s[0]]||0)*calculateTimeWeight(s[1])*pop)*(1+randFactor(t['è»Šç¨®'])); }); total+=d/sub.length; } return Math.min(Math.max(((total/3)/max)*50,0),100).toFixed(1)+'%'; }
function calcTrainUtil(t){ return calcSegUtil(t, t['è»Šç«™æ™‚é–“']); }
function highlightPeak(t){ if(!t)return t; const h=parseInt(t.split(':')[0],10); return ((h>=7&&h<9)||(h>=17&&h<19))?`<span class="peak-hour">${t}</span>`:t; }
function colorType(t){ const map={æ–°è‡ªå¼·:'#8600FF',æ™®æ‚ ç‘ª:'#db2777','è‡ªå¼·è™Ÿ':'#e11d48','è’å…‰è™Ÿ':'#ea580c','å€é–“å¿«':'#16a34a','å¾©èˆˆè™Ÿ':'#0284c7','å€é–“è»Š':document.body.classList.contains('dark-mode')?'#fff':'#334155','è‡ªå¼·è™Ÿ(æ–°)':'#b45309','åŠ ç­è»Š':'teal'}; return `<span style="font-weight:600; color:${map[t]||'inherit'}">${t}</span>`; }
const getDirection=num=>num%2===0?'northbound':'southbound';
const getTime=(num,st)=>{ const f=trainSchedule[num]['è»Šç«™æ™‚é–“'].find(x=>x[0]===st); return f?f[1]:''; };
function filterTrainNumbers(){ const v=document.getElementById('trainNumberInput').value.trim(), drop=document.getElementById('trainNumbersDropdown'); drop.innerHTML=''; const matched=Object.keys(trainSchedule).filter(k=>k.startsWith(v)); if(matched.length){ matched.forEach(n=>{let o=document.createElement('option'); o.value=o.text=n; drop.add(o);}); } else { let o=document.createElement('option'); o.text='ç„¡æ­¤ç­æ¬¡'; drop.add(o); } }
function selectTrainNumber(){ document.getElementById('trainNumberInput').value=document.getElementById('trainNumbersDropdown').value; }
function toggleStopsRow(row,start,end,num){
  const next=row.nextElementSibling;
  if(next&&next.classList.contains('extra-stops')){ next.remove(); row.querySelector('.toggle-arrow').textContent='â–¼'; }
  else {
    const arr=trainSchedule[num]['è»Šç«™æ™‚é–“'], si=arr.findIndex(s=>s[0]===start), ei=arr.findIndex(s=>s[0]===end);
    const names=(si>-1&&ei>-1&&ei>si)?arr.slice(si+1,ei).map(s=>s[0]):[];
    const extra=document.createElement('tr'); extra.className='extra-stops';
    const td=document.createElement('td'); td.colSpan=7;
    td.textContent='æ²¿é€”åœé ï¼š'+(names.length?names.join('ã€'):'ç›´é”');
    extra.appendChild(td); row.parentNode.insertBefore(extra,row.nextSibling); row.querySelector('.toggle-arrow').textContent='â–²';
  }
}

// ===== è©³ç´°è³‡è¨Š Modal (Live Status) =====
function showTrainDetails(num,transferNum,transferStation){
  const modal=document.getElementById('trainDetailsModal'),
        titleMain=document.getElementById('modalTitleMain'),
        titleSub=document.getElementById('modalTitleSub'),
        body=document.getElementById('modalBody');
  body.innerHTML='';

  function buildTimeline(arr, type, trainNum, highlightStation=null){
    const now = new Date();
    const curMin = now.getHours() * 60 + now.getMinutes();

    let stops = [];
    let offset = 0, prevM = -1;
    arr.forEach(s => {
      let m = parseTime(s[1]);
      if (prevM !== -1 && m < prevM) offset += 1440;
      stops.push({ name: s[0], timeStr: s[1], min: m + offset });
      prevM = m;
    });

    let adjustedNow = curMin;
    let startMin = stops[0].min;
    if (adjustedNow < startMin - 720) adjustedNow += 1440;
    else if (adjustedNow > startMin + 720) adjustedNow -= 1440;

    let nextStopIdx = -1;
    if (adjustedNow < stops[0].min) nextStopIdx = 0; 
    else if (adjustedNow > stops[stops.length-1].min) nextStopIdx = -1; 
    else {
      for(let i=0; i<stops.length; i++){
        if(stops[i].min > adjustedNow){ nextStopIdx = i; break; }
      }
    }

    let html = `<div class="timeline">`;
    html += `<div style="padding:0 20px 10px; font-weight:700; color:var(--primary); font-size:1rem; border-bottom:1px dashed var(--border); margin-bottom:10px;">
              ${colorType(type)} ${trainNum}æ¬¡ 
              <span style="color:var(--text-muted); font-size:0.85rem; font-weight:normal; float:right;">${arr[0][0]} â ${arr[arr.length-1][0]}</span>
             </div>`;
    
    stops.forEach((s, i) => {
      let isPassed = (nextStopIdx === -1) || (i < nextStopIdx); 
      if (nextStopIdx === 0) isPassed = false;

      let isNext = (i === nextStopIdx);
      let isTransfer = (s.name === highlightStation);
      
      let itemClass = "timeline-item";
      if (isPassed) itemClass += " passed";
      if (isNext) itemClass += " next";
      if (isTransfer) itemClass += " transfer";

      html += `
        <div class="${itemClass}">
          <div class="tl-time">${s.timeStr}</div>
          <div class="tl-marker">
            <div class="tl-dot"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-station">
              ${s.name} 
              ${isNext ? '<span class="badge-next">ğŸš€ ä¸‹ä¸€ç«™</span>' : ''}
            </div>
            ${isTransfer ? '<div class="tl-desc" style="color:#d97706;font-weight:600">ğŸ”„ è«‹åœ¨æ­¤ç«™è½‰ä¹˜</div>' : ''}
          </div>
        </div>
      `;
    });
    html += `</div>`;
    return html;
  }

  if(!transferNum){
    const t=trainSchedule[num], arr=t['è»Šç«™æ™‚é–“'];
    titleMain.textContent = `${num}æ¬¡ åˆ—è»Šè©³æƒ…`;
    titleSub.textContent = `${t['è»Šç¨®']} (${arr[0][0]} â ${arr[arr.length-1][0]})`;
    body.innerHTML = buildTimeline(arr, t['è»Šç¨®'], num);
  } else {
    const t1=trainSchedule[num], arr1=t1['è»Šç«™æ™‚é–“'];
    const t2=trainSchedule[transferNum], arr2=t2['è»Šç«™æ™‚é–“'];
    titleMain.textContent = `è½‰ä¹˜è¡Œç¨‹è¦åŠƒ`;
    titleSub.textContent = `${num}æ¬¡ è½‰ ${transferNum}æ¬¡`;
    const idx1 = arr1.findIndex(x=>x[0]===transferStation);
    const idx2 = arr2.findIndex(x=>x[0]===transferStation);
    const leg1 = arr1.slice(0, idx1+1);
    const leg2 = arr2.slice(idx2);
    let content = ``;
    content += buildTimeline(leg1, t1['è»Šç¨®'], num, transferStation);
    const waitTime = diff(arr1[idx1][1], arr2[idx2][1]);
    content += `
      <div class="transfer-banner">
        <div class="transfer-icon">ğŸƒ</div>
        <div class="transfer-text">
          æ–¼ <strong>${transferStation}</strong> æ›è»Šï¼Œå€™è»Šç´„ <strong>${waitTime}</strong>
        </div>
      </div>
    `;
    content += buildTimeline(leg2, t2['è»Šç¨®'], transferNum, transferStation);
    body.innerHTML = content;
  }
  
  modal.style.display='flex';
}

function closeTrainDetailsModal(){ document.getElementById('trainDetailsModal').style.display='none'; }
window.onclick=e=>{ if(e.target===document.getElementById('trainDetailsModal')) closeTrainDetailsModal(); };

buildStartEndHeader(false);
</script>
</body>
</html>