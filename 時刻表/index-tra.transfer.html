<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°éµåˆ—è»Šæ™‚åˆ»è¡¨æŸ¥è©¢</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /***********************************************
      RESET & BASIC
    ***********************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans TC', sans-serif;
    }
    body {
      background: linear-gradient(to right, #e4ecfa, #f5f8ff);
      color: #333;
      transition: background-color 0.3s ease, color 0.3s ease;
      padding-bottom: 50px;
    }
    /* Dark Mode */
    body.dark-mode {
      background: #121212;
      color: #ddd;
    }

    /***********************************************
      NAVBAR
    ***********************************************/
    .navbar {
      background-color: #333;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
    }
    .navbar .brand {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .navbar .nav-links a {
      color: #fff;
      text-decoration: none;
      margin-right: 15px;
      font-size: 14px;
    }
    .navbar .nav-links a:hover {
      text-decoration: underline;
    }
    .navbar button.toggle-dark-mode {
      background-color: #444;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .navbar button.toggle-dark-mode:hover {
      background-color: #222;
    }

    /***********************************************
      CONTAINER & CARD
    ***********************************************/
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      padding: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark-mode .card {
      background-color: #1f1f1f;
      color: #ddd;
    }
    .card h2 {
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 1.2rem;
      border-left: 5px solid #130058;
      padding-left: 10px;
    }

    /***********************************************
      FORM & INPUT & BUTTON
    ***********************************************/
    label {
      display: inline-block;
      margin: 5px 0;
      font-weight: 600;
    }
    input, select, button {
      margin: 5px 8px 5px 0;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ddd;
      outline: none;
      transition: all 0.3s ease;
    }
    body.dark-mode input,
    body.dark-mode select {
      background-color: #2a2a2a;
      color: #ccc;
      border: 1px solid #555;
    }
    button {
      background-color: #0460fe;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #242424;
    }

    /***********************************************
      TABLE
    ***********************************************/
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    body.dark-mode table {
      background-color: #1f1f1f;
      color: #ccc;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      vertical-align: middle;
      /* ä¸å¯æ›è¡Œ */
      white-space: nowrap;
      transition: background-color 0.3s ease;
    }
    body.dark-mode th,
    body.dark-mode td {
      border-bottom: 1px solid #555;
    }
    th {
      background-color: #333;
      color: #fff;
      font-weight: 500;
    }
    body.dark-mode th {
      background-color: #444;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    body.dark-mode tr:nth-child(even) {
      background-color: #2a2a2a;
    }
    tr:hover {
      background-color: #f1f1f1;
      cursor: pointer;
    }
    body.dark-mode tr:hover {
      background-color: #333;
    }

    /***********************************************
      MODAL (åˆ—è»Šè©³ç´°è³‡è¨Š)
    ***********************************************/
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 4% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 700px;
      position: relative;
      animation: slide-down 0.3s ease-out;
    }
    @keyframes slide-down {
      from { transform: translateY(-50%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    body.dark-mode .modal-content {
      background-color: #2a2a2a;
      color: #ddd;
    }
    .modal-content .close {
      position: absolute;
      top: 10px;
      right: 14px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
    }
    body.dark-mode .modal-content .close {
      color: #ccc;
    }
    .modal-content h2 {
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 1.2rem;
      color: #333;
    }
    body.dark-mode .modal-content h2 {
      color: #ddd;
    }
    .modal-section {
      margin-bottom: 20px;
    }
    .modal-section h3 {
      margin-bottom: 8px;
      font-size: 1rem;
      border-left: 5px solid #4CAF50;
      padding-left: 10px;
    }
    body.dark-mode .modal-section h3 {
      color: #ccc;
    }
    .modal-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .modal-table th, .modal-table td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
    }
    body.dark-mode .modal-table th,
    body.dark-mode .modal-table td {
      border-bottom: 1px solid #555;
    }
    .modal-table th {
      background-color: #333;
      color: #fff;
    }
    body.dark-mode .modal-table th {
      background-color: #444;
    }
    .modal-table tr:nth-child(even) {
      background-color: #fafafa;
    }
    body.dark-mode .modal-table tr:nth-child(even) {
      background-color: #333;
    }

    /* æç¤ºè¨Šæ¯æ¨£å¼: ex. è½‰ä¹˜æç¤º */
    .transfer-tip {
      background-color: #000;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    /***********************************************
      PEAK-HOUR
    ***********************************************/
    .peak-hour {
      background: #ffe0a0;
      padding: 2px 6px;
      border-radius: 4px;
      color: #000;
    }
    body.dark-mode .peak-hour {
      background: #e09f00;
      color: #fff;
    }
  </style>
</head>

<body>
  <!-- === NAVBAR === -->
  <div class="navbar">
    <div class="brand">å°éµåˆ—è»Šæ™‚åˆ»è¡¨æŸ¥è©¢</div>
    <div class="nav-links">
      <!-- æ‚¨åŸæœ¬çš„é€£çµï¼Œå¯æŒ‰éœ€æ±‚ä¿®æ”¹ -->
      <a href="index-speed.html">é«˜éµæ™‚åˆ»è¡¨</a>
      <a href="index-thsr.html">é«˜éµæ™‚åˆ»è¡¨(å°ˆç”¨)</a>
      <a href="index.html">æ™‚åˆ»è¡¨</a>
      <a href="index-tra.easy.html">ç°¡å¼æ™‚åˆ»è¡¨</a>
      <a href="index-tra.type.html">ä¾è»Šç¨®æ™‚åˆ»è¡¨</a>
      <a href="train-info.html">è»Šç«™è³‡è¨Šæ¿</a>
      <a href="people.html">é‹é‡æŸ¥è©¢</a>
      <a href="index.trainrate.html">é‹ç”¨ç‡æŸ¥è©¢</a>
    </div>
    <button class="toggle-dark-mode" onclick="toggleDarkMode()">Dark Mode</button>
  </div>

  <div class="container">
    <!-- === å‡ºç™¼ç«™ & æŠµé”ç«™ æŸ¥è©¢ === -->
    <div class="card">
      <h2>å‡ºç™¼ç«™ & æŠµé”ç«™æŸ¥è©¢</h2>
      <!-- è®“ä½¿ç”¨è€…å¯è¼¸å…¥æˆ–å¾ä¸‹æ‹‰ä¸­é¸æ“‡ï¼Œæ•…ä½¿ç”¨ datalist -->
      <datalist id="stationList"><!-- ç”±JSå‹•æ…‹åŠ å…¥ --></datalist>
      <div style="margin-bottom:10px;">
        <label>å‡ºç™¼ç«™ï¼š</label>
        <input type="text" id="startStationInput" list="stationList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡" />
        <label>æŠµé”ç«™ï¼š</label>
        <input type="text" id="endStationInput" list="stationList" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡" />
        <label for="acceptTransfers">æ¥å—è½‰ä¹˜ï¼š</label>
        <input type="checkbox" id="acceptTransfers" />
      </div>

      <div style="margin-bottom:10px;">
        <!-- è»Šç¨®è¤‡é¸ -->
        <input type="checkbox" id="trainTypeNew" onclick="toggleTrainTypeFilter('start-end','æ–°è‡ªå¼·')">
        <label for="trainTypeNew">æ–°è‡ªå¼·</label>
        <input type="checkbox" id="trainTypePuyuma" onclick="toggleTrainTypeFilter('start-end','æ™®æ‚ ç‘ª')">
        <label for="trainTypePuyuma">æ™®æ‚ ç‘ª</label>
        <input type="checkbox" id="trainTypeZiqiangNew" onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ(æ–°)')">
        <label for="trainTypeZiqiangNew">è‡ªå¼·è™Ÿ(æ–°)</label>
        <input type="checkbox" id="trainTypeZiqiang" onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ')">
        <label for="trainTypeZiqiang">è‡ªå¼·è™Ÿ</label>
        <input type="checkbox" id="trainTypeJuguang" onclick="toggleTrainTypeFilter('start-end','è’å…‰è™Ÿ')">
        <label for="trainTypeJuguang">è’å…‰è™Ÿ</label>
        <input type="checkbox" id="trainTypeFuxing" onclick="toggleTrainTypeFilter('start-end','å¾©èˆˆè™Ÿ')">
        <label for="trainTypeFuxing">å¾©èˆˆè™Ÿ</label>
        <input type="checkbox" id="trainTypeQujiankuai" onclick="toggleTrainTypeFilter('start-end','å€é–“å¿«')">
        <label for="trainTypeQujiankuai">å€é–“å¿«</label>
        <input type="checkbox" id="trainTypeQujianche" onclick="toggleTrainTypeFilter('start-end','å€é–“è»Š')">
        <label for="trainTypeQujianche">å€é–“è»Š</label>
        <input type="checkbox" id="trainTypeJiabanche" onclick="toggleTrainTypeFilter('start-end','åŠ ç­è»Š')">
        <label for="trainTypeJiabanche">åŠ ç­è»Š</label>

        <button onclick="filterTrainScheduleByStation()">æŸ¥è©¢</button>
      </div>
      <table id="scheduleTableByStation">
        <thead>
          <tr>
            <th>è»Šæ¬¡</th>
            <th>è»Šç¨® (è¡Œé§›å€é–“)</th>
            <th>å‡ºç™¼ç«™(æ™‚é–“)</th>
            <th>è½‰ä¹˜ç«™(æ™‚é–“)</th>
            <th>æŠµé”ç«™(æ™‚é–“)</th>
            <th>è¡Œé§›æ™‚é–“</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- === è»Šç«™æŸ¥è©¢ === -->
    <div class="card">
      <h2>è»Šç«™æŸ¥è©¢</h2>
      <datalist id="stationList2"><!-- ç”±JSå‹•æ…‹ç”Ÿæˆ --></datalist>
      <div style="margin-bottom:10px;">
        <label for="stationNameInput">é¸æ“‡è»Šç«™ï¼š</label>
        <input type="text" id="stationNameInput" list="stationList2" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡" />
        <label for="directionSelect">æ–¹å‘ï¼š</label>
        <select id="directionSelect">
          <option value="northbound">åŒ—ä¸Š</option>
          <option value="southbound">å—ä¸‹</option>
        </select>
      </div>
      <div style="margin-bottom:10px;">
        <input type="checkbox" id="trainTypeNewStation" onclick="toggleTrainTypeFilter('station','æ–°è‡ªå¼·')">
        <label for="trainTypeNewStation">æ–°è‡ªå¼·</label>
        <input type="checkbox" id="trainTypePuyumaStation" onclick="toggleTrainTypeFilter('station','æ™®æ‚ ç‘ª')">
        <label for="trainTypePuyumaStation">æ™®æ‚ ç‘ª</label>
        <input type="checkbox" id="trainTypeZiqiangNewStation" onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ(æ–°)')">
        <label for="trainTypeZiqiangNewStation">è‡ªå¼·è™Ÿ(æ–°)</label>
        <input type="checkbox" id="trainTypeZiqiangStation" onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ')">
        <label for="trainTypeZiqiangStation">è‡ªå¼·è™Ÿ</label>
        <input type="checkbox" id="trainTypeJuguangStation" onclick="toggleTrainTypeFilter('station','è’å…‰è™Ÿ')">
        <label for="trainTypeJuguangStation">è’å…‰è™Ÿ</label>
        <input type="checkbox" id="trainTypeFuxingStation" onclick="toggleTrainTypeFilter('station','å¾©èˆˆè™Ÿ')">
        <label for="trainTypeFuxingStation">å¾©èˆˆè™Ÿ</label>
        <input type="checkbox" id="trainTypeQujiankuaiStation" onclick="toggleTrainTypeFilter('station','å€é–“å¿«')">
        <label for="trainTypeQujiankuaiStation">å€é–“å¿«</label>
        <input type="checkbox" id="trainTypeQujiancheStation" onclick="toggleTrainTypeFilter('station','å€é–“è»Š')">
        <label for="trainTypeQujiancheStation">å€é–“è»Š</label>
        <input type="checkbox" id="trainTypeJiabancheStation" onclick="toggleTrainTypeFilter('station','åŠ ç­è»Š')">
        <label for="trainTypeJiabancheStation">åŠ ç­è»Š</label>

        <button onclick="filterTrainScheduleByStationName()">æŸ¥è©¢</button>
      </div>
      <table id="scheduleTableByStationName">
        <thead>
          <tr>
            <th>è»Šæ¬¡</th>
            <th>è»Šç¨® (è¡Œé§›å€é–“)</th>
            <th>é–‹è»Šæ™‚é–“</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- === è»Šæ¬¡æŸ¥è©¢ === -->
    <div class="card">
      <h2>è»Šæ¬¡æŸ¥è©¢</h2>
      <div style="margin-bottom:10px;">
        <label for="trainNumberInput">è»Šæ¬¡ï¼š</label>
        <input type="text" id="trainNumberInput" placeholder="è«‹è¼¸å…¥è»Šæ¬¡" oninput="filterTrainNumbers()" />
        <select id="trainNumbersDropdown" onchange="selectTrainNumber()">
          <option value="" selected>åƒè€ƒè»Šæ¬¡</option>
        </select>
        <button onclick="filterTrainScheduleByNumber()">æŸ¥è©¢</button>
      </div>
      <table id="scheduleTableByNumber">
        <thead>
          <tr>
            <th>è»Šæ¬¡</th>
            <th>è»Šç¨® (è¡Œé§›å€é–“)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- === Modal: åˆ—è»Šè©³ç´°è³‡è¨Š === -->
  <div id="trainDetailsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTrainDetailsModal()">&times;</span>
      <h2 id="modalTitle">åˆ—è»Šè©³ç´°è³‡è¨Š</h2>
      <!-- è½‰ä¹˜æç¤º -->
      <div id="transferTip" class="transfer-tip" style="display:none;"></div>

      <div class="modal-section" id="originTrainSection">
        <h3>ç¬¬ä¸€åˆ—è»Šè³‡è¨Š</h3>
        <table class="modal-table" id="originTrainTable">
          <thead>
            <tr>
              <th>åœé ç«™</th>
              <th>æ™‚é–“</th>
            </tr>
          </thead>
          <tbody>
            <!-- ç”±JSå‹•æ…‹æ’å…¥ -->
          </tbody>
        </table>
      </div>

      <div class="modal-section" id="transferTrainSection" style="display:none;">
        <h3>è½‰ä¹˜åˆ—è»Šè³‡è¨Š</h3>
        <table class="modal-table" id="transferTrainTable">
          <thead>
            <tr>
              <th>åœé ç«™</th>
              <th>æ™‚é–“</th>
            </tr>
          </thead>
          <tbody>
            <!-- ç”±JSå‹•æ…‹æ’å…¥ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- train-schedule.js (è‡ªè¡Œå»ºç«‹) -->
  <script src="train-schedule.js"></script>
  <script>
    /************************************
      DARK MODE TOGGLE
    ************************************/
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    /************************************
      å…¨åŸŸè®Šæ•¸
    ************************************/
    var selectedTrainTypesStartEnd = [];
    var selectedTrainTypesStation = [];

    // ç”Ÿæˆ datalist (å‡ºç™¼/æŠµé”)
    var stationList = document.getElementById('stationList');
    stations.forEach(st => {
      let opt = document.createElement('option');
      opt.value = st;
      stationList.appendChild(opt);
    });
    // ç”Ÿæˆ datalist (è»Šç«™æŸ¥è©¢)
    var stationList2 = document.getElementById('stationList2');
    stations.forEach(st  => {
      let opt2 = document.createElement('option');
      opt2.value = st;
      stationList2.appendChild(opt2);
    });

    /************************************
      å·¥å…·å‡½å¼
    ************************************/
    // é«˜å³°æ™‚æ®µ (07:00ï½09:00, 17:00ï½19:00)
    function highlightPeakHour(timeStr) {
      if (!timeStr) return timeStr;
      var hour = parseInt(timeStr.split(':')[0],10);
      if ((hour>=7 && hour<9) || (hour>=17 && hour<19)) {
        return `<span class="peak-hour">${timeStr}</span>`;
      }
      return timeStr;
    }
    // è¨ˆç®—å…©å€‹ HH:MM é–“çš„æ™‚é–“å·® (ç°¡åŒ–)
    function calculateTimeDifference(startTime, endTime) {
      if (!startTime || !endTime) return '--';
      let s = new Date("1970-01-01 "+startTime);
      let e = new Date("1970-01-01 "+endTime);
      if (isNaN(s) || isNaN(e)) return '--';
      let diff = e - s;
      if (diff<0) { diff += 24*60*60*1000; }
      let d = new Date(diff);
      let hh = d.getUTCHours();
      let mm = d.getUTCMinutes();
      return hh+"å°æ™‚"+mm+"åˆ†";
    }
    // åˆ¤æ–·æ˜¯å¦è·¨æ—¥
    function isOvernightTrain(stationTimes, startIndex, endIndex) {
      return ( new Date("1970-01-01 "+stationTimes[startIndex][1]) >
               new Date("1970-01-01 "+stationTimes[endIndex][1]) );
    }
    // åˆ¤æ–·æ˜¯å¦æ›´æ—©åˆ° (è·¨æ—¥è€ƒé‡)
    function isEarlierArrivalTime(newArr, existArr, newOv, existOv) {
      // ex: newOv=true, existOv=false => new is later
      if (newOv && !existOv) return false;
      if (!newOv && existOv) return true;
      let newDate = new Date("1970-01-01 "+newArr);
      let oldDate = new Date("1970-01-01 "+existArr);
      return (newDate < oldDate);
    }
    // å°‡ "2å°æ™‚10åˆ†" + "1å°æ™‚5åˆ†" => "3å°æ™‚15åˆ†"
    function addTimes(...times) {
      let totalMin=0;
      times.forEach(tStr => {
        totalMin += parseTimeToMin(tStr);
      });
      let hh = Math.floor(totalMin/60);
      let mm = totalMin%60;
      return hh+"å°æ™‚"+mm+"åˆ†";
    }
    function parseTimeToMin(tStr) {
      // "2å°æ™‚10åˆ†"
      let [hPart, mPart] = tStr.split("å°æ™‚");
      let h = parseInt(hPart)||0;
      let m = parseInt(mPart.replace("åˆ†",""))||0;
      return h*60+m;
    }
    // é¡¯ç¤ºå½©è‰²è»Šç¨®
    function getTrainTypeWithColor(trainType) {
  // æª¢æŸ¥ç›®å‰æ˜¯å¦ç‚ºã€Œæš—è‰²æ¨¡å¼ã€(ç¯„ä¾‹ç”¨æ³•ï¼šè‹¥æ‚¨æœ‰å…¶ä»–å¤œé–“æ¨¡å¼æª¢æ¸¬æ–¹å¼ï¼Œè«‹è‡ªè¡Œæ›¿æ›)
  const isDarkMode = document.body.classList.contains('dark-mode');

  let color = '#333'; // é è¨­

  switch (trainType) {
    case 'æ–°è‡ªå¼·': color = '#8600FF'; break;
    case 'æ™®æ‚ ç‘ª': color = '#FF1493'; break;
    case 'è‡ªå¼·è™Ÿ': color = 'red';     break;
    case 'è’å…‰è™Ÿ': color = 'orange';  break;
    case 'å€é–“å¿«': color = 'green';   break;
    case 'å¾©èˆˆè™Ÿ': color = '#0080FF'; break;
    case 'å€é–“è»Š': 
      // è‹¥ç‚ºæš—è‰²æ¨¡å¼ï¼Œæ”¹æˆç™½è‰²ï¼›å¦å‰‡ç”¨é»‘è‰²
      color = isDarkMode ? '#fff' : 'black'; 
      break;
    case 'è‡ªå¼·è™Ÿ(æ–°)': color = 'brown'; break;
    case 'åŠ ç­è»Š':      color = 'teal';  break;
    default:            color = '#333';  break;
  }

  return `<span style="color: ${color};">${trainType}</span>`;
}


    /************************************
      è»Šç¨®è¤‡é¸
    ************************************/
    function toggleTrainTypeFilter(context, trainType) {
      let arr = (context==='start-end') ? selectedTrainTypesStartEnd : selectedTrainTypesStation;
      let idx = arr.indexOf(trainType);
      if (idx>-1) arr.splice(idx,1);
      else arr.push(trainType);

      if (context==='start-end') filterTrainScheduleByStation();
      else filterTrainScheduleByStationName();
    }

    /************************************
      1) å‡ºç™¼ç«™ & æŠµé”ç«™æŸ¥è©¢
    ************************************/
    function filterTrainScheduleByStation() {
      let startStation = document.getElementById('startStationInput').value.trim();
      let endStation = document.getElementById('endStationInput').value.trim();
      let acceptTransfers = document.getElementById('acceptTransfers').checked;
      let tableBody = document.getElementById('scheduleTableByStation').getElementsByTagName('tbody')[0];
      tableBody.innerHTML='';

      let trainCombinations={};

      // å…ˆæ‰¾ç›´é”
      for (let trainNo in trainSchedule) {
        let trObj = trainSchedule[trainNo];
        let stationTimes = trObj['è»Šç«™æ™‚é–“']||[];
        let tType = trObj['è»Šç¨®'];
        // è»Šç¨®éæ¿¾
        if (selectedTrainTypesStartEnd.length>0 && !selectedTrainTypesStartEnd.includes(tType)) {
          continue;
        }
        let startIdx = stationTimes.findIndex(s=> s[0]===startStation);
        let endIdx = stationTimes.findIndex(s=> s[0]===endStation);
        if (startIdx!==-1 && endIdx!==-1 && startIdx<endIdx) {
          let sTime = stationTimes[startIdx][1];
          let eTime = stationTimes[endIdx][1];
          let isOv = isOvernightTrain(stationTimes, startIdx, endIdx);
          let trTime = calculateTimeDifference(sTime, eTime);
          addTrainComb(trainCombinations, trainNo, tType, startStation, endStation, sTime, eTime, trTime, [], isOv);
        }
      }

      // å…è¨±è½‰ä¹˜
      if (acceptTransfers) {
        for (let trainNo in trainSchedule) {
          let trObj = trainSchedule[trainNo];
          let stationTimes = trObj['è»Šç«™æ™‚é–“']||[];
          let tType = trObj['è»Šç¨®'];
          // è»Šç¨®éæ¿¾
          if (selectedTrainTypesStartEnd.length>0 && !selectedTrainTypesStartEnd.includes(tType)) {
            continue;
          }
          let startIdx = stationTimes.findIndex(s=> s[0]===startStation);
          if (startIdx!==-1) {
            for (let i=startIdx+1; i<stationTimes.length; i++) {
              let potentialTransferSt = stationTimes[i][0];
              let depToTrTime = stationTimes[i][1]; // åˆ°é”è½‰ä¹˜ç«™æ™‚é–“
              let secondTrain = findBestConnectingTrain(potentialTransferSt, endStation, depToTrTime);
              if (secondTrain) {
                // åˆä½µæ™‚é–“
                let firstLeg = calculateTimeDifference(stationTimes[startIdx][1], depToTrTime);
                let waitTime = calculateTimeDifference(depToTrTime, secondTrain.startTime);
                let secondLeg = calculateTimeDifference(secondTrain.startTime, secondTrain.endTime);
                let totalTime = addTimes(firstLeg, waitTime, secondLeg);

                let finalArrivalTime = secondTrain.endTime;
                let isOvernight = isOvernightTrain(stationTimes, startIdx, i) || secondTrain.isOvernight;

                if (isBetterComb(trainCombinations[trainNo], totalTime, finalArrivalTime, isOvernight)) {
                  addTrainComb(trainCombinations, trainNo, tType, startStation, endStation, stationTimes[startIdx][1], finalArrivalTime, totalTime, [{
                    station: potentialTransferSt,
                    transferTrainNumber: secondTrain.trainNumber,
                    transferTrainType: secondTrain.trainType,
                    transferStartTime: secondTrain.startTime,
                    transferEndTime: secondTrain.endTime
                  }], isOvernight);
                }
              }
            }
          }
        }
      }

      // å–å¾—æœ€ä½³çµ„åˆ
      let bestCombos = getBestCombinations(trainCombinations);
      // ä¾å‡ºç™¼æ™‚é–“æ’åº
      bestCombos.sort((a,b)=> a.startTime.localeCompare(b.startTime));

      // é¡¯ç¤º
      bestCombos.forEach(item => {
        let row = tableBody.insertRow();
        row.insertCell(0).innerHTML = item.trainNumber;
        // ç¬¬ä¸€ç«™ã€æœ€å¾Œç«™
        let firstStop = trainSchedule[item.trainNumber]['è»Šç«™æ™‚é–“'][0][0];
        let lastStop = trainSchedule[item.trainNumber]['è»Šç«™æ™‚é–“'][ trainSchedule[item.trainNumber]['è»Šç«™æ™‚é–“'].length-1][0];
        row.insertCell(1).innerHTML = `${getTrainTypeWithColor(item.trainType)} (${firstStop} â ${lastStop})`;
        row.insertCell(2).innerHTML = `${item.startStation} (${highlightPeakHour(item.startTime)})`;

        if (item.transferStations.length>0) {
          // è½‰ä¹˜è³‡è¨Š
          let tInfo = item.transferStations[0];
          row.insertCell(3).innerHTML = `
            ${tInfo.station} (${highlightPeakHour(tInfo.transferStartTime)})
            =>ğŸš‰${tInfo.transferTrainNumber}
            ${getTrainTypeWithColor(tInfo.transferTrainType)}
          `;
          row.onclick = ()=> showTrainDetails(item.trainNumber, tInfo.transferTrainNumber, tInfo.station);
        } else {
          row.insertCell(3).innerHTML = '-';
          row.onclick = ()=> showTrainDetails(item.trainNumber);
        }
        row.insertCell(4).innerHTML = `${item.endStation} (${highlightPeakHour(item.endTime)})`;
        row.insertCell(5).innerHTML = item.travelTime;
      });
    }
    // æ–°å¢ä¸€ç­†çµ„åˆ
    function addTrainComb(storage, trainNo, trainType, stSt, edSt, stTime, edTime, tvTime, tStations, isOv) {
      if (!storage[trainNo]) storage[trainNo]=[];
      storage[trainNo].push({
        trainType, startStation:stSt, endStation:edSt,
        startTime:stTime, endTime:edTime, travelTime:tvTime,
        transferStations:tStations, isOvernight:isOv
      });
    }
    // åˆ¤æ–·æ˜¯å¦æ›´ä½³
    function isBetterComb(existList, newTvTime, newArrTime, newOv) {
      if (!existList || existList.length===0) return true;
      let old = existList[0]; 
      // åªæ¯”è¼ƒæœ€å„ª
      return isEarlierArrivalTime(newArrTime, old.endTime, newOv, old.isOvernight);
    }
    // æ•´ç†å‡ºå„è»Šæ¬¡æœ€ä½³çµ„åˆ
    function getBestCombinations(storage) {
      let result=[];
      for (let trainNo in storage) {
        let combos = storage[trainNo];
        let best = combos[0];
        combos.forEach(c => {
          if (isEarlierArrivalTime(c.endTime, best.endTime, c.isOvernight, best.isOvernight)) {
            best=c;
          }
        });
        result.push({
          trainNumber: trainNo,
          trainType: best.trainType,
          startStation: best.startStation,
          endStation: best.endStation,
          startTime: best.startTime,
          endTime: best.endTime,
          travelTime: best.travelTime,
          transferStations: best.transferStations,
          isOvernight: best.isOvernight
        });
      }
      return result;
    }
    // æ‰¾æœ€é©åˆè½‰ä¹˜åˆ—è»Š
    function findBestConnectingTrain(transferStation, endStation, depToTrTime) {
      let best=null;
      for (let tn in trainSchedule) {
        let trObj = trainSchedule[tn];
        // è»Šç¨®éæ¿¾
        if (selectedTrainTypesStartEnd.length>0 && !selectedTrainTypesStartEnd.includes(trObj['è»Šç¨®'])) {
          continue;
        }
        let stTimes = trObj['è»Šç«™æ™‚é–“']||[];
        let startIdx = stTimes.findIndex(s=> s[0]===transferStation);
        let endIdx = stTimes.findIndex(s=> s[0]===endStation);
        if (startIdx!==-1 && endIdx!==-1 && startIdx<endIdx) {
          let stTime = stTimes[startIdx][1];
          // å¿…é ˆåœ¨ depToTrTime ä¹‹å¾Œ
          if (new Date("1970-01-01 "+stTime) > new Date("1970-01-01 "+depToTrTime)) {
            let eTime = stTimes[endIdx][1];
            let isOv = isOvernightTrain(stTimes, startIdx, endIdx);
            if (!best || isEarlierArrivalTime(eTime, best.endTime, isOv, best.isOvernight)) {
              best={
                trainNumber: tn,
                trainType: trObj['è»Šç¨®'],
                startTime: stTime,
                endTime: eTime,
                isOvernight: isOv,
                stationTimes: stTimes
              };
            }
          }
        }
      }
      return best;
    }

    /************************************
      Modal: é¡¯ç¤ºåˆ—è»Šè©³ç´°è³‡è¨Š
    ************************************/
    function showTrainDetails(trainNumber, transferTrainNumber=null, transferStation=null) {
      let modal = document.getElementById('trainDetailsModal');
      let modalTitle = document.getElementById('modalTitle');
      let transferTip = document.getElementById('transferTip');
      let originTrainTableBody = document.getElementById('originTrainTable').getElementsByTagName('tbody')[0];
      let transferTrainTableBody = document.getElementById('transferTrainTable').getElementsByTagName('tbody')[0];
      let transferTrainSection = document.getElementById('transferTrainSection');

      // æ¸…ç†
      originTrainTableBody.innerHTML='';
      transferTrainTableBody.innerHTML='';
      transferTip.style.display='none';
      transferTip.innerHTML='';
      transferTrainSection.style.display='none';

      // åŸåˆ—è»Š
      let stationTimes = trainSchedule[trainNumber]['è»Šç«™æ™‚é–“']||[];
      stationTimes.forEach(st => {
        let row = originTrainTableBody.insertRow();
        row.insertCell(0).innerHTML = (st[0]===transferStation) ? `${st[0]}(ğŸš‰è½‰ä¹˜ç«™)` : st[0];
        row.insertCell(1).innerHTML = highlightPeakHour(st[1]) || '--';
      });

      // è‹¥æœ‰è½‰ä¹˜
      if (transferTrainNumber && transferStation) {
        transferTip.style.display='block';
        transferTip.innerHTML = `è«‹åœ¨ <strong>${transferStation}</strong> è½‰ä¹˜ <strong>${transferTrainNumber}</strong> è»Šæ¬¡ ${getTrainTypeWithColor(trainSchedule[transferTrainNumber]['è»Šç¨®'])}`;
        transferTrainSection.style.display='block';
        let stationTimes2 = trainSchedule[transferTrainNumber]['è»Šç«™æ™‚é–“']||[];
        stationTimes2.forEach(st2 => {
          let row2 = transferTrainTableBody.insertRow();
          row2.insertCell(0).innerHTML = (st2[0]===transferStation) ? `${st2[0]}(ğŸš‰è½‰ä¹˜ç«™)` : st2[0];
          row2.insertCell(1).innerHTML = highlightPeakHour(st2[1]) || '--';
        });
      }

      modalTitle.textContent = `åˆ—è»Šè©³ç´°è³‡è¨Š - ( ${trainNumber}${transferTrainNumber? ' è½‰ä¹˜ '+transferTrainNumber:''} )`;
      modal.style.display='block';
    }
    function closeTrainDetailsModal() {
      document.getElementById('trainDetailsModal').style.display='none';
    }
    window.onclick = function(e) {
      let modal = document.getElementById('trainDetailsModal');
      if (e.target===modal) {
        modal.style.display='none';
      }
    };

    /************************************
      2) è»Šç«™æŸ¥è©¢
    ************************************/
    function filterTrainScheduleByStationName() {
      let stationName = document.getElementById('stationNameInput').value.trim();
      let direction = document.getElementById('directionSelect').value;
      let tableBody = document.getElementById('scheduleTableByStationName').getElementsByTagName('tbody')[0];
      tableBody.innerHTML='';

      let sortedTrainNos = Object.keys(trainSchedule).sort((a,b)=>{
        let tA = getDepTimeForStation(a, stationName);
        let tB = getDepTimeForStation(b, stationName);
        return tA.localeCompare(tB);
      });

      sortedTrainNos.forEach(tNo => {
        let trObj = trainSchedule[tNo];
        let stTimes = trObj['è»Šç«™æ™‚é–“']||[];
        let idx = stTimes.findIndex(s=> s[0]===stationName);
        if (idx!==-1) {
          let dir = getDirection(tNo);
          if (dir===direction) {
            // è»Šç¨®éæ¿¾
            if (selectedTrainTypesStation.length>0 && !selectedTrainTypesStation.includes(trObj['è»Šç¨®'])) {
              return;
            }
            let row=tableBody.insertRow();
            row.insertCell(0).innerHTML=tNo;
            let firstStop = stTimes[0][0];
            let lastStop = stTimes[stTimes.length-1][0];
            row.insertCell(1).innerHTML= `${getTrainTypeWithColor(trObj['è»Šç¨®'])} (${firstStop} â ${lastStop})`;
            row.insertCell(2).innerHTML= highlightPeakHour(stTimes[idx][1])||'--';
            row.onclick=()=> showTrainDetails(tNo);
          }
        }
      });
    }
    function getDepTimeForStation(trainNo, stationName) {
      let stTimes = trainSchedule[trainNo]['è»Šç«™æ™‚é–“']||[];
      let f= stTimes.find(s=> s[0]===stationName);
      if (!f) return "99:99";
      return f[1];
    }
    // å‡: å¶æ•¸è»Šæ¬¡=åŒ—ä¸Š, å¥‡æ•¸=å—ä¸‹
    function getDirection(trainNo) {
      return (trainNo % 2===0)? "northbound":"southbound";
    }

    /************************************
      3) è»Šæ¬¡æŸ¥è©¢
    ************************************/
    function filterTrainNumbers() {
      let val = document.getElementById('trainNumberInput').value.trim();
      let dropdown = document.getElementById('trainNumbersDropdown');
      dropdown.innerHTML='';
      let matched=[];
      for (let k in trainSchedule) {
        if (k.startsWith(val)) matched.push(k);
      }
      if (matched.length>0) {
        matched.forEach(m => {
          let opt = document.createElement('option');
          opt.value=m;
          opt.text=m;
          dropdown.add(opt);
        });
      } else {
        let opt2 = document.createElement('option');
        opt2.text='No matching train numbers found.';
        dropdown.add(opt2);
      }
    }
    function selectTrainNumber() {
      let val = document.getElementById('trainNumbersDropdown').value;
      document.getElementById('trainNumberInput').value=val;
    }
    function filterTrainScheduleByNumber() {
      let trainNo = document.getElementById('trainNumberInput').value.trim();
      let tbody = document.getElementById('scheduleTableByNumber').getElementsByTagName('tbody')[0];
      tbody.innerHTML='';
      if (trainSchedule[trainNo]) {
        let row= tbody.insertRow();
        row.insertCell(0).innerHTML= trainNo;
        let tObj = trainSchedule[trainNo];
        let stTimes= tObj['è»Šç«™æ™‚é–“']||[];
        if (stTimes.length>0) {
          let firstStop = stTimes[0][0];
          let lastStop = stTimes[stTimes.length-1][0];
          row.insertCell(1).innerHTML= `${getTrainTypeWithColor(tObj['è»Šç¨®'])} (${firstStop} â ${lastStop})`;
        } else {
          row.insertCell(1).innerHTML= `${getTrainTypeWithColor(tObj['è»Šç¨®'])} (Unknown â Unknown)`;
        }
        row.onclick=()=> showTrainDetails(trainNo);
      }
    }
  </script>
</body>
</html>