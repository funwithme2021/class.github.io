<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <title>BINGO BINGO 權重式分析 (微調版)</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: #f4f4f4; color: #333;
    }
    header {
      background: #3A6073; color: #fff;
      text-align: center; padding: 1rem;
    }
    h1, h2, h3 {
      margin: 0; padding: 0.5rem 0;
    }
    .container {
      max-width: 1200px; margin: 1rem auto;
      padding: 0 1rem;
    }

    /* ----- 點選 80 顆球 ----- */
    .input-section {
      background: #fff; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem; margin-bottom: 1rem;
    }
    .number-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .ball {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: #ddd; color: #333;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-weight: bold; user-select: none;
    }
    .ball.selected {
      background: #FFA726; color: #fff;
    }
    .ball.super {
      background: #ba68c8; color: #fff;
    }
    .btn {
      background: #3A6073; color: #fff;
      border: none; padding: 0.6rem 1.2rem; font-size: 1rem;
      border-radius: 4px; cursor: pointer; margin-right: 0.5rem;
    }
    .btn:hover {
      background: #2f495c;
    }

    /* ----- 分析區 (上方) ----- */
    .analysis-section {
      background: #fff; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem; margin-bottom: 1rem;
    }
    select {
      padding: 0.4rem; border-radius: 4px;
      margin-right: 1rem; font-size: 1rem;
    }
    .analysis-box {
      border: 1px solid #ddd; border-radius: 6px;
      padding: 0.8rem; margin-bottom: 1rem;
      background: #fafafa;
    }
    .analysis-box h3 { margin-top: 0; }

    /* badge 樣式 */
    .badge {
      display: inline-block;
      padding: 0.3rem 0.5rem;
      margin: 2px; border-radius: 4px;
      color: #fff; font-size: 0.8rem;
      vertical-align: middle;
    }
    .badge-hot {
      background: #ef6c00; /* 橘 */
    }
    .badge-cold {
      background: #6c757d; /* 灰 */
    }
    .badge-zone {
      background: #5bc0de; /* 藍 */
    }
    .badge-final {
      background: #d9534f; /* 紅 */
    }

    /* ----- 分布表 (在分析結果下方) ----- */
    .distribution-section {
      background: #fff; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem; margin-bottom: 1rem;
      overflow: auto;
    }
    table {
      border-collapse: collapse; width: 100%;
      min-width: 1200px; text-align: center;
      margin-bottom: 1rem;
    }
    th, td {
      border: 1px solid #ddd; padding: 0.4rem; font-size: 0.8rem;
    }
    thead th {
      background: #607D8B; color: #fff;
      position: sticky; top: 0; z-index: 1;
    }
    .hit {
      background: #c8e6c9; /* 淺綠 */
    }
    .hit.super {
      background: #b39ddb; /* 淺紫 */
      color: #000;
    }
    .delete-btn {
      background: #d9534f !important;
    }

    .footer {
      text-align: center; font-size: 0.85rem; color: #777;
      margin: 2rem 0;
    }
  </style>
</head>

<body>
<header>
  <h1>BINGO BINGO - 權重式分析 (微調版)</h1>
</header>

<div class="container">

  <!-- (A) 點選輸入 -->
  <div class="input-section">
    <h2>選擇 20 顆 (最後1顆視為超級號碼)</h2>
    <div class="number-grid" id="numberGrid"></div>
    <button class="btn" id="addDrawBtn">新增開獎紀錄</button>
    <button class="btn" id="exportBtn">匯出</button>
    <input type="file" id="importFile" style="display:none" accept=".json"/>
    <button class="btn" id="importBtn">匯入</button>
  </div>

  <!-- (B) 分析區 (在分布表上方) -->
  <div class="analysis-section">
    <h2>分析與預測</h2>
    <div style="margin-bottom:0.5rem;">
      <select id="starSelect">
        <option value="1">1星</option>
        <option value="2">2星</option>
        <option value="3">3星</option>
        <option value="4">4星</option>
        <option value="5">5星</option>
        <option value="6">6星</option>
        <option value="7">7星</option>
        <option value="8">8星</option>
        <option value="9">9星</option>
        <option value="10">10星</option>
      </select>
      <select id="futureSelect">
        <option value="5">預測未來5期</option>
        <option value="10">預測未來10期</option>
      </select>
      <button class="btn" id="analyzeBtn">開始分析</button>
    </div>
    <div id="analysisOutput"></div>
    <p style="color:#888; font-size:0.85rem;">
      (建議依近期實際觀察，不斷微調參數；此範例僅供參考)
    </p>
  </div>

  <!-- (C) 分布表 -->
  <div class="distribution-section">
    <h2>分布表 (可刪除任一期資料)</h2>
    <table>
      <thead id="distTableHead"></thead>
      <tbody id="distTableBody"></tbody>
    </table>
  </div>

</div>

<div class="footer">
  ※此範例僅作參考示範，實際數據以官方開獎為準。
</div>

<script>
let draws = [];

/* ========== 1. 產生 80 顆球 ========== */
const numberGrid = document.getElementById("numberGrid");
for(let i=1; i<=80; i++){
  const ball = document.createElement("div");
  ball.classList.add("ball");
  ball.textContent = i<10 ? ("0"+i) : i;
  ball.dataset.num = i;
  ball.addEventListener("click", ()=>toggleBall(ball));
  numberGrid.appendChild(ball);
}
function toggleBall(ball){
  const selected = document.querySelectorAll(".ball.selected, .ball.super");
  if(ball.classList.contains("selected") || ball.classList.contains("super")){
    // 取消選取
    ball.classList.remove("selected");
    ball.classList.remove("super");
  } else {
    if(selected.length>=20){
      alert("已選滿20顆");
      return;
    }
    ball.classList.add("selected");
  }
  // 若剛好20顆 => 最後1顆為super
  const reCheck = document.querySelectorAll(".ball.selected, .ball.super");
  if(reCheck.length===20){
    reCheck.forEach(b=> b.classList.remove("super"));
    ball.classList.remove("selected");
    ball.classList.add("super");
  }
}

/* ========== 2. 新增開獎紀錄 + 渲染表格 ========== */
const addDrawBtn = document.getElementById("addDrawBtn");
addDrawBtn.addEventListener("click", addDraw);

function addDraw(){
  const selected = document.querySelectorAll(".ball.selected, .ball.super");
  if(selected.length!==20){
    alert("需要正好20顆(含超級號)");
    return;
  }
  let superBall = Array.from(selected).find(b=> b.classList.contains("super"));
  if(!superBall){
    alert("找不到超級號");
    return;
  }
  let superNum = parseInt(superBall.dataset.num,10);
  let normalBalls = Array.from(selected).filter(b=> b!==superBall);
  let normalNums = normalBalls.map(b=> parseInt(b.dataset.num,10)).sort((a,b)=>a-b);

  draws.push({
    index: draws.length+1,
    normal: normalNums,
    superNum: superNum
  });

  // 清除選中
  selected.forEach(b=>{
    b.classList.remove("selected");
    b.classList.remove("super");
  });

  renderDistributionTable();
}

/* ========== 3. 分布表 (可刪除) ========== */
const distTableHead = document.getElementById("distTableHead");
const distTableBody = document.getElementById("distTableBody");

function renderDistributionTable(){
  distTableHead.innerHTML="";
  distTableBody.innerHTML="";

  if(draws.length===0){
    distTableHead.innerHTML = `<tr><th>尚無資料</th></tr>`;
    return;
  }

  let headRow = document.createElement("tr");
  headRow.innerHTML="<th>期數</th>";
  for(let i=1; i<=80; i++){
    let th=document.createElement("th");
    th.textContent=(i<10?"0":"")+i;
    headRow.appendChild(th);
  }
  // 刪除欄
  let thDel=document.createElement("th");
  thDel.textContent="刪除";
  headRow.appendChild(thDel);

  distTableHead.appendChild(headRow);

  draws.forEach((d,idx)=>{
    let tr=document.createElement("tr");
    let tdIssue=document.createElement("td");
    tdIssue.textContent=d.index;
    tr.appendChild(tdIssue);

    for(let n=1;n<=80;n++){
      let td=document.createElement("td");
      if(d.normal.includes(n) || d.superNum===n){
        td.classList.add("hit");
        if(d.superNum===n) td.classList.add("super");
        td.textContent=(n<10?"0":"")+n;
      } else {
        td.textContent="";
      }
      tr.appendChild(td);
    }

    // 刪除btn
    let tdBtn=document.createElement("td");
    let btnDel=document.createElement("button");
    btnDel.classList.add("btn","delete-btn");
    btnDel.textContent="刪除";
    btnDel.addEventListener("click",()=>{
      draws.splice(idx,1);
      draws.forEach((item,i2)=>{
        item.index=i2+1;
      });
      renderDistributionTable();
    });
    tdBtn.appendChild(btnDel);
    tr.appendChild(tdBtn);
    distTableBody.appendChild(tr);
  });
}

/* ========== 4. 分數權重分析 ========== */
const analyzeBtn = document.getElementById("analyzeBtn");
const analysisOutput = document.getElementById("analysisOutput");
const starSelect = document.getElementById("starSelect");
const futureSelect = document.getElementById("futureSelect");

// ★可依觀察改動：
let freqWeight = 12;     // 出現次數比重(比原先 10 更高)
let lineWeight = 5;      // 連號比原先(3)更高
let diagonalWeight = 2;  // 斜線若不常出現，可稍低
let zoneWeight = 3;      // 若最近顯示某區特別旺 => 提高
let lineThresholdFactor = 0.5; // 連號門檻(如≥ draws.length * 0.5)

analyzeBtn.addEventListener("click", ()=>{
  if(draws.length===0){
    analysisOutput.innerHTML=`<p style="color:red;">尚無資料無法分析</p>`;
    return;
  }
  // hits[] + freq[]
  let hits=[];
  let freq=new Array(81).fill(0);
  for(let i=0; i<draws.length;i++){
    let row=new Array(81).fill(false);
    draws[i].normal.forEach(n=>{
      row[n]=true; freq[n]++;
    });
    row[draws[i].superNum]=true;
    freq[draws[i].superNum]++;
    hits.push(row);
  }

  // 直線≥3 & 斜線≥3
  let totalLine=calcLineScore(hits);
  let totalDiagonal=calcDiagonalScore(hits);
  let lineFactor=totalLine+totalDiagonal;

  // 8區
  let sumFreq=freq.reduce((a,b)=>a+b,0);
  let zoneCount=new Array(8).fill(0);
  for(let n=1;n<=80;n++){
    let z=Math.floor((n-1)/10);
    zoneCount[z]+=freq[n];
  }
  // 找最旺區
  let maxZ=0;
  for(let z=1; z<8; z++){
    if(zoneCount[z]>zoneCount[maxZ]) maxZ=z;
  }
  let concentrated=(zoneCount[maxZ]/sumFreq>=0.3);

  // 熱門/冷門(可顯示用)
  let avgFreq=sumFreq/80;
  let hotThreshold=Math.floor(avgFreq+1);
  let hotNumbers=[];
  let coldNumbers=[];
  for(let n=1;n<=80;n++){
    if(freq[n]>=hotThreshold) hotNumbers.push(n);
    else if(freq[n]<=1) coldNumbers.push(n);
  }

  // ------ 分數計算 ------
  let scores=new Array(81).fill(0);

  // (A) freq => freqWeight
  for(let n=1;n<=80;n++){
    scores[n]= freq[n]*freqWeight;
  }

  // (B) 若連號現象( lineFactor ) >= draws.length * lineThresholdFactor => 加分
  if(lineFactor>= draws.length * lineThresholdFactor){
    // 對構成連號的號碼加 lineWeight
    // 對構成斜線連號的號碼加 diagonalWeight
    for(let i=0;i<hits.length;i++){
      let row=hits[i];
      // 直線 群組
      let groups = getConsecutiveGroups(row);
      groups.forEach(g=>{
        g.forEach(num=>{
          scores[num]+= lineWeight;
        });
      });
      // 斜線(可再寫 getDiagonalGroups(row) 或 simpler check) => 範例略
      // 若要更細緻可擴充
    }
  }

  // (C) 若集中 => 對最旺區加 zoneWeight
  if(concentrated){
    let start=maxZ*10+1, end=maxZ*10+10;
    for(let n=start; n<=end; n++){
      if(freq[n]>0){
        scores[n]+= zoneWeight;
      }
    }
  }

  // 收集 {num, score} => 排序 => 取 starNum => 最後用小到大顯示
  let arrScores=[];
  for(let n=1;n<=80;n++){
    if(scores[n]>0){
      arrScores.push({num:n, score:scores[n]});
    }
  }
  // 依分數由大到小
  arrScores.sort((a,b)=> b.score - a.score);

  let starNum=parseInt(starSelect.value,10);
  let picks=arrScores.slice(0, starNum).map(obj=> obj.num);
  // 顯示 => 由小到大
  picks.sort((a,b)=>a-b);

  // ------ 顯示分析結果 ------
  let html="";

  // 熱門 / 冷門
  html += `<div class="analysis-box">
    <h3>熱門 / 冷門</h3>
    <p>平均出現次數: ${avgFreq.toFixed(2)}, 熱門門檻: ≥${hotThreshold}</p>
    <p>熱門號碼: ${
      hotNumbers.map(n=>`<span class="badge badge-hot">${fmt(n)}</span>`).join(" ")
    }</p>
    <p>冷門號碼: ${
      coldNumbers.map(n=>`<span class="badge badge-cold">${fmt(n)}</span>`).join(" ")
    }</p>
  </div>`;

  // 連號/斜線
  html += `<div class="analysis-box">
    <h3>連號 / 斜線</h3>
    <p>直線(連號≥3)次數: ${totalLine}</p>
    <p>斜線(連續≥3)次數: ${totalDiagonal}</p>
  </div>`;

  // 8區
  html += `<div class="analysis-box">
    <h3>8區分析</h3>
    <p>`;
  zoneCount.forEach((val,z)=>{
    let st=z*10+1, ed=z*10+10;
    html += `<span class="badge badge-zone">${st}~${ed}:${val}</span> `;
  });
  html += `</p>
    <p>最旺區: ${maxZ+1} (${zoneCount[maxZ]}), 集中度: ${concentrated?">=30%":"<30%"} </p>
  </div>`;

  // 最終推薦
  html += `<div class="analysis-box">
    <h3>最終推薦 (星數 ${starNum}, 預測${futureSelect.value}期)</h3>
    <p>${
      picks.map(n=>`<span class="badge badge-final">${fmt(n)}</span>`).join(" ")
    }</p>
    <p style="color:#999; font-size:0.85rem;">(分數加權後結果, 僅供參考)</p>
  </div>`;

  analysisOutput.innerHTML=html;
});

// ---- 小函式: calcLineScore, calcDiagonalScore, getConsecutiveGroups, fmt ----
function calcLineScore(hits){
  let total=0;
  hits.forEach(row=>{
    let c=1;
    for(let n=2;n<=80;n++){
      if(row[n] && row[n-1]){
        c++;
      } else {
        if(c>=3) total++;
        c=1;
      }
    }
    if(c>=3) total++;
  });
  return total;
}

function calcDiagonalScore(hits){
  let count=0;
  for(let i=0; i<hits.length;i++){
    for(let n=1;n<=80;n++){
      if(!hits[i][n]) continue;
      let consecutive=true;
      for(let step=1; step<=2; step++){
        if(i+step>=hits.length || n+step>80 || !hits[i+step][n+step]){
          consecutive=false; break;
        }
      }
      if(consecutive) count++;
    }
  }
  return count;
}

// 找出 row 裡連續≥3 的群組
function getConsecutiveGroups(row){
  let groups=[];
  let temp=[];
  for(let n=1;n<=80;n++){
    if(row[n]){
      temp.push(n);
    } else {
      if(temp.length>=3){
        groups.push([...temp]);
      }
      temp=[];
    }
  }
  if(temp.length>=3) groups.push([...temp]);
  return groups;
}

function fmt(n){
  return (n<10?"0"+n:n);
}

/* ========== 5. 匯出 / 匯入 ========== */
const exportBtn=document.getElementById("exportBtn");
const importBtn=document.getElementById("importBtn");
const importFile=document.getElementById("importFile");

// 匯出
exportBtn.addEventListener("click",()=>{
  if(draws.length===0){
    alert("尚無資料可匯出");
    return;
  }
  let dataStr=JSON.stringify(draws,null,2);
  let blob=new Blob([dataStr],{type:"application/json"});
  let url=URL.createObjectURL(blob);

  let a=document.createElement("a");
  a.href=url;
  a.download="BingoDraws.json";
  a.click();
  URL.revokeObjectURL(url);
});

// 匯入
importBtn.addEventListener("click",()=>{
  importFile.click();
});
importFile.addEventListener("change",()=>{
  let file=importFile.files[0];
  if(!file)return;
  let reader=new FileReader();
  reader.onload=function(e){
    try{
      let imported=JSON.parse(e.target.result);
      if(!Array.isArray(imported)){
        alert("JSON 格式錯誤(需為陣列)");
        return;
      }
      draws=imported;
      draws.forEach((d,i2)=> d.index=i2+1 );
      renderDistributionTable();
      alert("匯入成功！");
    }catch(err){
      alert("無法解析 JSON: "+err);
    }
  };
  reader.readAsText(file);
  importFile.value="";
});
</script>
</body>
</html>
