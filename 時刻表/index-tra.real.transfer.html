<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>台鐵時刻表 (真實數據即時版)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style> 
  /* ===== 1. 核心變數與 Reset ===== */
  :root {
    --font-main: 'Inter', 'Noto Sans TC', sans-serif;
    --bg-body: #f8fafc;
    --bg-surface: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --text-light: #94a3b8;
    --border: #e2e8f0;
    --primary: #2563eb;
    --primary-bg: rgba(37, 99, 235, 0.1);
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --radius: 10px;
  }

  body.dark-mode {
    --bg-body: #0f172a;
    --bg-surface: #1e293b;
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --text-light: #64748b;
    --border: #334155;
    --primary: #60a5fa;
    --primary-bg: rgba(96, 165, 250, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    font-family: var(--font-main);
    background: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    padding-bottom: 40px;
  }

  /* ===== 2. 導航列 ===== */
  .navbar {
    position: sticky; top: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.8rem 1.5rem;
    background: var(--bg-header);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  .navbar .brand { font-weight: 700; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
  .nav-links { display: flex; gap: 4px; align-items: center; }
  .nav-links a {
    color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500;
    padding: 6px 12px; border-radius: 6px; transition: 0.2s;
  }
  .nav-links a:hover { background: var(--bg-body); color: var(--primary); }
  .theme-btn {
    border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-main);
    padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;
  }
  .hamburger { display: none; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; }
  .hamburger span { width: 24px; height: 2px; background: var(--text-main); }

  @media(max-width: 900px) {
    .nav-links {
      position: absolute; top: 100%; left: 0; width: 100%;
      background: var(--bg-surface); border-bottom: 1px solid var(--border);
      flex-direction: column; align-items: flex-start; padding: 0;
      max-height: 0; overflow: hidden; opacity: 0; transition: 0.3s;
    }
    .nav-links.open { max-height: 500px; opacity: 1; padding: 1rem; }
    .nav-links a { width: 100%; padding: 10px; }
    .hamburger { display: flex; }
  }

  /* ===== 3. 主要容器 ===== */
  .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
  .grid { display: grid; gap: 24px; }

  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .section-title {
    font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 2px; }

  /* ===== 4. 表單與篩選 ===== */
  .form-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 16px; position: relative; }
  
  .input-group { 
    display: flex; align-items: center; gap: 8px; 
    background: var(--bg-body); padding: 4px 8px; 
    border: 1px solid var(--border); border-radius: 8px; 
    flex: 1; min-width: 120px;
  }
  .input-group label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; white-space: nowrap; }
  input, select {
    border: none; background: transparent; color: var(--text-main); 
    font-size: 0.95rem; padding: 6px; outline: none; width: 100%; 
  }

  /* 互換按鈕 */
  .swap-btn {
    width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--bg-surface); color: var(--primary);
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; transition: 0.2s; font-size: 1.1rem;
  }
  .swap-btn:hover { background: var(--bg-body); transform: rotate(180deg); }

  button.btn-primary {
    background: var(--primary); color: #fff; border: none;
    padding: 8px 16px; border-radius: 8px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }

  /* 歷史紀錄 Chips */
  .history-chips { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .history-chip {
    font-size: 0.8rem; padding: 4px 10px; border-radius: 12px;
    background: var(--bg-body); color: var(--text-muted);
    border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 4px;
  }
  .history-chip:hover { background: var(--primary-bg); color: var(--primary); border-color: var(--primary); }

  /* 標籤式 Checkbox */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .chip-label {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 10px; border-radius: 20px;
    border: 1px solid var(--border); background: var(--bg-surface);
    color: var(--text-muted); font-size: 0.85rem; cursor: pointer;
    user-select: none; transition: 0.2s;
  }
  .chip-label:hover { background: var(--bg-body); }
  .chip-label input { display: none; }
  .chip-label:has(input:checked) {
    background: var(--primary-bg); color: var(--primary); border-color: var(--primary); font-weight: 500;
  }
  .chip-label input:checked + span { color: var(--primary); }

  /* ===== 5. 表格樣式 ===== */
  .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
  
  th {
    background: var(--bg-body); color: var(--text-muted); font-weight: 600; text-align: left;
    padding: 12px 16px; border-bottom: 1px solid var(--border);
  }
  th.sortable { cursor: pointer; }
  td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: var(--bg-body); cursor: pointer; }

  /* 數字對齊 */
  td { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
  
  /* 標籤 Badge */
  .badge-sea { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #0ea5e9; color: #fff; margin-left: 4px; }
  
  .train-route { font-size: 0.85rem; color: var(--text-muted); margin-left: 6px; }
  .progress-bar { width: 100px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
  .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; }

  /* ===== 6. Modal (彈窗) & 時間軸 ===== */
  .modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px);
    z-index: 2000; justify-content: center; align-items: center;
    opacity: 0; transition: opacity 0.3s;
  }
  .modal[style*="display: flex"] { opacity: 1; }

  .modal-content {
    background: var(--bg-surface); width: 95%; max-width: 500px; max-height: 85vh;
    border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    overflow: hidden; display: flex; flex-direction: column;
    transform: translateY(20px); transition: transform 0.3s;
  }
  .modal[style*="display: flex"] .modal-content { transform: translateY(0); }

  .modal-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-body);
  }
  .modal-title-main { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
  .modal-title-sub { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }
  .close { font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }

  .modal-body { padding: 0; overflow-y: auto; background: var(--bg-surface); }

  /* 時間軸樣式 */
  .timeline { padding: 10px 20px; }
  .timeline-item { display: flex; position: relative; padding-bottom: 0; }
  
  /* 左側時間 */
  .tl-time {
    width: 50px; text-align: right; font-size: 0.9rem; font-weight: 600; 
    color: var(--text-main); padding-right: 15px; padding-top: 2px;
    font-variant-numeric: tabular-nums;
  }
  
  /* 中間線條與圓點 */
  .tl-marker {
    display: flex; flex-direction: column; align-items: center; width: 20px; position: relative;
  }
  .tl-line {
    width: 2px; background: var(--border); flex-grow: 1; margin-top: 4px; margin-bottom: -4px;
  }
  .timeline-item:last-child .tl-line { display: none; }
  .tl-dot {
    width: 10px; height: 10px; border-radius: 50%; background: var(--border);
    border: 2px solid var(--bg-surface); z-index: 1; flex-shrink: 0; transition: all 0.3s;
  }
  
  /* 右側站名 */
  .tl-content { padding-left: 15px; padding-bottom: 24px; flex-grow: 1; }
  .timeline-item:last-child .tl-content { padding-bottom: 10px; }
  
  .tl-station { font-size: 1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; }
  .tl-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }

  /* --- 狀態樣式 --- */
  .timeline-item.passed .tl-time, 
  .timeline-item.passed .tl-station { opacity: 0.4; filter: grayscale(1); }
  .timeline-item.passed .tl-dot { background: var(--border); }

  .timeline-item.next .tl-dot { 
    background: #22c55e; width: 14px; height: 14px; 
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2); 
    border-color: #fff; 
  }
  .timeline-item.next .tl-station { color: #15803d; font-weight: 700; }
  body.dark-mode .timeline-item.next .tl-station { color: #4ade80; }
  
  .timeline-item.transfer .tl-dot { background: #d97706; width: 12px; height: 12px; }
  .timeline-item.transfer .tl-station { color: #b45309; }

  .badge-next {
    display: inline-flex; align-items: center; gap: 4px;
    background: #22c55e; color: #fff; font-size: 0.7rem; 
    padding: 2px 8px; border-radius: 10px; margin-left: 8px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

  .transfer-banner {
    background: var(--bg-body); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
    padding: 10px 20px; display: flex; align-items: center; gap: 10px; margin: 10px -20px 20px -20px;
  }
  </style>

  <style>
    /* loading overlay（原本就有） */
    #loading-overlay{
      position: fixed; inset: 0; background: rgba(15, 23, 42, 0.35);
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    .spinner{
      width: 44px; height: 44px; border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.35);
      border-top-color: rgba(255,255,255,0.95);
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to{ transform: rotate(360deg);} }

    /* header（原本就有） */
    .header{
      position: sticky; top:0; z-index: 120;
      background: var(--bg-header);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
    }
    .header-content{
      max-width: 1200px; margin: 0 auto;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
    }
    .logo{
      font-weight: 800; letter-spacing: .5px;
      color: var(--primary);
      display:flex; align-items: baseline; gap: 6px;
    }
    .logo span{ font-weight: 600; color: var(--text-muted); font-size: .85rem; }
    .date-picker{ display:flex; align-items:center; gap: 8px; }
    .input-field{
      border:1px solid var(--border);
      background: var(--bg-surface);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 8px;
      outline: none;
      font-family: var(--font-main);
    }

    /* stops 展開箭頭（原本就有） */
    .toggle-arrow{ color: var(--text-muted); margin-left: 6px; font-size: .85rem; cursor:pointer; }
    .stops-row td{ background: var(--bg-body); color: var(--text-muted); font-size: .85rem; }
  </style>

</head>

<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text">正在初始化台鐵真實數據...</div>
</div>

<header class="header">
  <div class="header-content">
    <div class="logo">TRA <span>Real-time</span></div>

    <div class="date-picker">
      <label style="font-size: 0.8em; color: var(--text-muted);">選擇查詢日期：</label>
      <input type="date" id="mainQueryDate" class="input-field" style="width: auto; display: inline-block;">
      <button class="btn-primary" id="refreshBtn" style="padding: 6px 12px;">更新資料</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid">

    <section class="card">
      <div class="section-title">起訖站 / 轉乘查詢</div>

      <!-- 單一 datalist：動態依輸入/focus 改內容 -->
      <datalist id="stationList"></datalist>

      <div id="searchHistory" class="history-chips"></div>

      <div class="form-row">
        <div class="input-group">
          <label>出發</label>
          <input list="stationList" id="startStation" placeholder="請輸入站名或站碼">
        </div>

        <button class="swap-btn" id="swapBtn" title="互換">⇄</button>

        <div class="input-group">
          <label>到達</label>
          <input list="stationList" id="endStation" placeholder="請輸入站名或站碼">
        </div>

        <label class="chip-label" style="flex:0 0 auto;">
          <input type="checkbox" id="acceptTransfers">
          <span>接受轉乘</span>
        </label>

        <button class="btn-primary" id="searchBtn">查詢</button>
      </div>

      <div class="chip-group" id="trainTypeChipsStartEnd"></div>

      <div class="table-wrapper">
        <table id="scheduleTableByStation">
          <thead>
            <tr>
              <th>車次</th><th>車種 (區間)</th><th>出發 <span id="sortDepIcon">↕</span></th><th>抵達 <span id="sortArrIcon">↕</span></th><th>耗時 <span id="sortDurIcon">↕</span></th><th>停靠</th><th>狀態</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-title">車站時刻表</div>
      <div class="form-row">
        <div class="input-group">
          <label>車站</label>
          <input list="stationList" id="stationNameInput" placeholder="請輸入站名或站碼">
        </div>

        <div class="input-group" style="max-width: 220px;">
          <label>方向</label>
          <select id="directionSelect">
            <option value="even">順行（偶數車次）</option>
            <option value="odd">逆行（奇數車次）</option>
          </select>
        </div>

        <button class="btn-primary" id="stationSearchBtn">查詢</button>
      </div>

      <div class="chip-group" id="trainTypeChipsStation"></div>

      <div class="table-wrapper">
        <table id="scheduleTableByStationName">
          <thead>
            <tr><th>車次</th><th>車種 (區間)</th><th>時間</th><th>狀態</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-title">車次查詢</div>

      <!-- 車次候選清單：同樣動態依輸入/focus 改內容 -->
      <datalist id="trainNumberList"></datalist>

      <div class="form-row">
        <div class="input-group">
          <label>車次</label>
          <input id="trainNumberInput" list="trainNumberList" placeholder="請輸入車次">
        </div>
        <button class="btn-primary" id="trainNumberBtn">查詢</button>
      </div>

      <div class="table-wrapper">
        <table id="scheduleTableByNumber">
          <thead>
            <tr><th>車次</th><th>車種 (區間)</th><th>狀態</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>
</main>

<!-- Modal -->
<div id="trainModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <div class="modal-title-main" id="modalTitleMain">列車資訊</div>
        <div class="modal-title-sub" id="modalTitleSub">—</div>
      </div>
      <div class="close" id="modalClose">×</div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script src="./train.real-schedule.js"></script>
<script>
  // ===== 全域 =====
  let nameToId = {};
  let stationListSorted = []; // [{id,name}]
  let currentQueryDateStr = ''; // 使用者選的「顯示日期」（站別顯示要用）
  let baseSchedule = {};       // 發車日 = currentQueryDateStr
  let prevSchedule = {};       // 發車日 = currentQueryDateStr - 1（用來補跨日到今天的站）
  let originDateByKey = {};    // key -> originDate (YYYY-MM-DD)
  let scheduleKeyList = [];    // [{key, trainNo, originDate, data}]
  // ===== 自動更新：記住最後一次查詢 =====
let lastStartEndQuery = null;   // {st, ed, accept}
let lastStationQuery  = null;   // {station, dir}
let lastTrainQuery    = null;   // {trainNo}
let modalCtx = null;            // {trainNo, originDate}


  // ===== 日期工具 =====
  function fmtDate(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function addDays(dateStr, delta){
    const [y,m,d] = dateStr.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    dt.setDate(dt.getDate()+delta);
    return fmtDate(dt);
  }

  // ===== 日期：昨天 ~ 未來 60 天（預設今天） =====
  function initDatePickerWindow(){
    const el = document.getElementById('mainQueryDate');
    if(!el) return;
    const today = new Date();
    const minD = new Date(today); minD.setDate(minD.getDate()-1);
    const maxD = new Date(today); maxD.setDate(maxD.getDate()+59);
    el.min = fmtDate(minD);
    el.max = fmtDate(maxD);
    el.value = fmtDate(today);
    el.addEventListener('change', ()=>refreshData(el.value));
  }

  // ===== 台/臺 正規化 =====
  function normTW(s){ return String(s||'').trim().replace(/台/g,'臺'); }
  function normLoose(s){
    const t = String(s||'').trim();
    return { raw:t, asTai:t.replace(/台/g,'臺'), asTai2:t.replace(/臺/g,'台') };
  }

  // ===== datalist 動態填入：站名 =====
  function fillStationDatalist(keyword){
    const dl = document.getElementById('stationList');
    if(!dl) return;
    const k = normLoose(keyword||'');
    dl.innerHTML='';

    const filtered = stationListSorted.filter(s=>{
      if(!k.raw) return true;
      const id = String(s.id);
      const name = String(s.name);
      const name2 = name.replace(/臺/g,'台');
      return id.includes(k.raw) || id.includes(k.asTai) || id.includes(k.asTai2) ||
             name.includes(k.raw) || name.includes(k.asTai) || name.includes(k.asTai2) ||
             name2.includes(k.raw) || name2.includes(k.asTai) || name2.includes(k.asTai2);
    });

    filtered.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = `${s.id}-${s.name}`;
      dl.appendChild(opt);
    });
  }

  // ===== datalist 動態填入：車次 =====
  function fillTrainDatalist(keyword){
    const dl = document.getElementById('trainNumberList');
    if(!dl) return;
    const k = String(keyword||'').trim();
    dl.innerHTML='';

    const nums = Object.keys(baseSchedule||{}).sort((a,b)=>String(a).localeCompare(String(b),'en'));
    const filtered = nums.filter(n => !k || String(n).includes(k));

    filtered.forEach(n=>{
      const t = baseSchedule[n];
      const arr = t?.['車站時間']||[];
      const range = (arr.length>=2)?`${arr[0][0]}➝${arr.slice(-1)[0][0]}`:'';
      const opt = document.createElement('option');
      opt.value = `${n}-${t?.['車種']||''}-${range}`;
      dl.appendChild(opt);
    });
  }

  function extractStationNameFromInput(raw){
    const v = String(raw||'').trim();
    if(!v) return '';
    // 允許 1000-臺北
    const m = v.match(/^(\d{3,6})\s*-\s*(.+)$/);
    if(m && window.stationMap && window.stationMap[m[1]]) return window.stationMap[m[1]];
    // 允許只輸入站碼
    if(window.stationMap && window.stationMap[v]) return window.stationMap[v];
    // 允許站名台/臺
    const asTai = normTW(v);
    if(nameToId[asTai]) return asTai;
    const asTai2 = v.replace(/臺/g,'台');
    if(nameToId[normTW(asTai2)]) return normTW(asTai2);
    return normTW(v);
  }

  function extractTrainNoFromInput(raw){
    const v = String(raw||'').trim();
    if(!v) return '';
    const m = v.match(/^([0-9A-Za-z]+)\s*-\s*/);
    if(m) return m[1];
    return v;
  }

  // ===== 建 station index =====
  function buildStationIndex(){
    nameToId = {};
    stationListSorted = [];
    if(!window.stationMap) return;

    Object.entries(window.stationMap).forEach(([id, name])=>{
      if(!id || !name) return;
      const nameNorm = normTW(name);
      nameToId[nameNorm] = id;
      stationListSorted.push({id, name:nameNorm});
    });

    stationListSorted.sort((a,b)=>String(a.id).localeCompare(String(b.id),'en'));
  }

  // ===== 工具：時間處理 =====
  function parseTime(t){
    if(!t || !/\d{1,2}:\d{2}/.test(t)) return null;
    let [h,m]=t.split(':').map(x=>parseInt(x,10));
    return h*60+m;
  }

  // 取得某列車某站「到達/開車」
  function getArrDepFromSchedule(schedule, trainNo, station){
    const t = schedule?.[trainNo];
    if(!t) return null;
    const row = (t['車站時間']||[]).find(s=>s[0]===station);
    if(!row) return null;
    // row: [station, ArrivalTime, DepartureTime]
    const arr = row[1] || '';
    const dep = row[2] || '';
    return { arr, dep };
  }

  // 建立每站 absMin（處理跨日：時間變小就 +1day）
  function buildAbsMinutes(stops){
    // stops: [[station, arr, dep], ...] 以「開車」優先做排序基準（沒有就用到達）
    const out = [];
    let day = 0;
    let prev = null;

    for(let i=0;i<stops.length;i++){
      const arr = stops[i][1]||'';
      const dep = stops[i][2]||'';
      const tStr = dep || arr;           // 用開車為主，缺才用到達
      const m = parseTime(tStr);
      if(m === null){
        out.push({abs:null, day:day});
        continue;
      }
      if(prev !== null && m < prev) day += 1;  // 跨日
      const abs = day*1440 + m;
      out.push({abs, day});
      prev = m;
    }
    return out;
  }

  function getStopDateStr(originDateStr, absMin){
    if(absMin === null || absMin === undefined) return originDateStr;
    const dayOffset = Math.floor(absMin/1440);
    return addDays(originDateStr, dayOffset);
  }

  // ===== 狀態：用「發車日」判斷（不是站別跨日後的日期） =====
  function getTrainStatusLabel(trainNo, originDateStr, firstTimeStr, lastTimeStr, passedStationTimeStr){
    const todayStr = fmtDate(new Date());

    // 未來發車日：一律未發車
    if(originDateStr && originDateStr > todayStr) return '未發車';
    // 過去發車日：一律已到終點
    if(originDateStr && originDateStr < todayStr) return '已到終點';

    // 只有「今天發車」才抓即時
    let raw='';
    try{ if(typeof getDelayStatus==='function') raw = getDelayStatus(String(trainNo)) || ''; }catch(e){ raw=''; }

    // 停駛/截短等優先顯示（比已過站更重要）
    if(raw && /停駛|取消|暫停|終止|運轉整理|截短|折返|部分停駛/i.test(raw)) return raw;

    // 已過站：以「查詢的站（出發站 / 指定車站）」的「開車時間」判斷
    if(passedStationTimeStr && originDateStr === todayStr){
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();
      const passMin = parseTime(passedStationTimeStr);
      if(passMin !== null && nowMin > passMin) return '已過站';
    }

    // 即時準點/誤點
    if(raw){
      if(/準點/.test(raw)) return '準點';
      const m = raw.match(/晚\s*([\-\d]+)\s*分/);
      if(m){
        const d = parseInt(m[1],10);
        if(Number.isFinite(d) && d>0) return `誤點 ${d} 分`;
        if(Number.isFinite(d) && d<0) return `提早 ${Math.abs(d)} 分`;
        return '準點';
      }
      return raw || '即時';
    }

    // 沒即時資訊：用時間粗判
    const f = parseTime(firstTimeStr);
    const l = parseTime(lastTimeStr);
    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();

    if(f !== null && nowMin < f) return '未發車';
    if(f !== null && l !== null){
      const crosses = l < f;
      const endMin = crosses ? l+1440 : l;
      const nowAdj = crosses && nowMin < f ? nowMin+1440 : nowMin;
      if(nowAdj > endMin + 10) return '已到終點';
    }
    return '無即時資訊';
  }

  // ===== 狀態顏色：黑 / 綠 / 紅 / 灰(已過站) =====
  function colorStatus(label){
    const s = String(label||'');
    if(s === '準點') return `<span style="color:#16a34a;font-weight:700">${s}</span>`;
    if(s === '已過站') return `<span style="color:#94a3b8;font-weight:700">${s}</span>`;
    if(s === '未發車' || s === '已到終點') return `<span style="color:var(--text-main);font-weight:700">${s}</span>`;
    return `<span style="color:#dc2626;font-weight:700">${s}</span>`;
  }

  // ===== 取消尖峰時間特別顏色 =====
  function highlightPeak(t){ return t || '--'; }

  // ===== 車種顏色：太魯閣藍、莒光橘 =====
  function colorType(t){
    const map={
      太魯閣:'#2563eb',
      莒光號:'#ea580c',
      新自強:'#8600FF',
      普悠瑪:'#db2777',
      '自強號(新)':'#e11d48',
      '自強號':'#e11d48',
      區間快:'#16a34a',
      復興號:'#0284c7',
      區間車:document.body.classList.contains('dark-mode')?'#a3a3a3':'#475569',
      加班車:'#0ea5e9'
    };
    const c=map[t]||'#64748b';
    return `<span style="color:${c};font-weight:700">${t}</span>`;
  }

  // ===== UI：搜尋歷史 =====
  const HISTORY_KEY='tra_search_history_v2';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); }catch(e){ return []; } }
  function saveHistory(list){ localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,10))); }
  function renderHistory(){
    const box=document.getElementById('searchHistory');
    if(!box) return;
    const list=loadHistory();
    box.innerHTML='';
    list.forEach(item=>{
      const chip=document.createElement('div');
      chip.className='history-chip';
      chip.textContent=`${item.s} → ${item.e}`;
      chip.addEventListener('click',()=>{
        document.getElementById('startStation').value=item.s;
        document.getElementById('endStation').value=item.e;
        document.getElementById('acceptTransfers').checked=!!item.t;
        runStartEndSearch();
      });
      box.appendChild(chip);
    });
  }

  // ===== 車種篩選 Chips =====
  let selectedTrainTypesStartEnd=[];
  let selectedTrainTypesStation=[];
  function buildTrainTypeChips(containerId, onChange){
    const box=document.getElementById(containerId);
    if(!box) return;
    box.innerHTML='';
    const types=new Set(Object.keys(baseSchedule||{}).map(k=>baseSchedule[k]['車種']).filter(Boolean));
    Array.from(types).sort().forEach(type=>{
      const lab=document.createElement('label');
      lab.className='chip-label';
      lab.innerHTML=`<input type="checkbox" value="${type}"><span>${type}</span>`;
      const cb=lab.querySelector('input');
      cb.addEventListener('change',()=>onChange());
      box.appendChild(lab);
    });
  }
  function getSelectedTypes(containerId){
    return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)).map(x=>x.value);
  }

  // ===== 資料刷新：同時抓查詢日 + 前一天（補跨日站別） =====
  async function refreshData(dateStr){
    currentQueryDateStr = dateStr || '';

    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('loading-text').textContent = `正在獲取 ${dateStr} 真實時刻表...`;

    // 先抓當天（發車日 = dateStr）
    await fetchRealData(dateStr);
    baseSchedule = (typeof structuredClone==='function') ? structuredClone(window.trainSchedule) : JSON.parse(JSON.stringify(window.trainSchedule||{}));

    // 再抓前一天（發車日 = dateStr-1）
    const prevDate = addDays(dateStr, -1);
    await fetchRealData(prevDate);
    prevSchedule = (typeof structuredClone==='function') ? structuredClone(window.trainSchedule) : JSON.parse(JSON.stringify(window.trainSchedule||{}));

    // 抓完再抓回當天（避免 UI 其他功能誤用到 prev）
    await fetchRealData(dateStr);
    window.trainSchedule = baseSchedule;

    // 只有查「今天」才抓即時誤點（而且只對「今天發車」有效）
    const todayStr = fmtDate(new Date());
    if(dateStr === todayStr) await updateLiveDelay();

    buildStationIndex();

    // 建 train instance list（避免同車次跨日 key 覆蓋）
    originDateByKey = {};
    scheduleKeyList = [];

    Object.keys(baseSchedule||{}).forEach(trainNo=>{
      const key = `${trainNo}@${dateStr}`;
      originDateByKey[key] = dateStr;
      scheduleKeyList.push({ key, trainNo, originDate: dateStr, data: baseSchedule[trainNo] });
    });
    Object.keys(prevSchedule||{}).forEach(trainNo=>{
      const key = `${trainNo}@${prevDate}`;
      originDateByKey[key] = prevDate;
      scheduleKeyList.push({ key, trainNo, originDate: prevDate, data: prevSchedule[trainNo] });
    });

    fillStationDatalist('');
    fillTrainDatalist('');

    buildTrainTypeChips('trainTypeChipsStartEnd', ()=>{});
    buildTrainTypeChips('trainTypeChipsStation', ()=>{});
    renderHistory();

    document.getElementById('loading-overlay').style.display = 'none';
  }

  // ===== 初始化 =====
  window.addEventListener('load', async ()=>{
    initDatePickerWindow();

    const dateInput = document.getElementById('mainQueryDate');
    await refreshData(dateInput?.value);

    // 你原本的更新資料按鈕：保持存在
    const refreshBtn = document.getElementById('refreshBtn');
    if(refreshBtn){
      refreshBtn.addEventListener('click', async ()=>{
        await refreshData(document.getElementById('mainQueryDate')?.value);
      });
    }

    // 只在「查詢日=今天」每分鐘更新即時誤點
    async function rerenderVisibleResults(){
  // 依照最後一次查詢條件，把畫面「用同樣條件」重跑一次
  if(lastStartEndQuery){
    selectedTrainTypesStartEnd = getSelectedTypes('trainTypeChipsStartEnd');
    if(lastStartEndQuery.accept){
      buildTransferList(lastStartEndQuery.st, lastStartEndQuery.ed);
      renderTransferTable();
    }else{
      buildDirectList(lastStartEndQuery.st, lastStartEndQuery.ed);
      renderStartEndTable();
    }
  }

  if(lastStationQuery){
    // 站名查詢本身會讀 input / dir / chips，直接呼叫即可
    filterTrainScheduleByStationName();
  }

  if(lastTrainQuery && lastTrainQuery.trainNo){
    filterTrainScheduleByNumber();
  }

  // 如果 Modal 正在開著，也更新它的標題狀態（不顯示已過站）
  if(modalCtx && modal && modal.style.display === 'flex'){
    // 重新渲染一次詳細資訊（它會用同一車次與 originDate）
    showTrainDetails(modalCtx.trainNo, modalCtx.originDate);
  }
}

// 每分鐘自動更新：只在「查今天」才有意義
setInterval(async ()=>{
  const cur = document.getElementById('mainQueryDate')?.value;
  const todayStr = fmtDate(new Date());
  if(cur !== todayStr) return;

  if(typeof updateLiveDelay === 'function'){
    await updateLiveDelay();      // 抓最新即時誤點
    await rerenderVisibleResults(); // 立刻把畫面狀態更新成最新
  }
}, 60000);


    // 站名輸入：focus 全顯示；input 過濾；blur 正規化
    bindStationInput('startStation');
    bindStationInput('endStation');
    bindStationInput('stationNameInput');

    // 車次輸入
    bindTrainInput('trainNumberInput');
  });

  function bindStationInput(inputId){
    const input = document.getElementById(inputId);
    if(!input) return;

    input.addEventListener('focus', ()=>{
      fillStationDatalist(input.value); // 空白會顯示全站
    });
    input.addEventListener('input', ()=>{
      fillStationDatalist(input.value);
    });
    input.addEventListener('blur', ()=>{
      const resolved = extractStationNameFromInput(input.value);
      if(resolved) input.value = resolved;
      fillStationDatalist('');
    });
  }

  function bindTrainInput(inputId){
    const input = document.getElementById(inputId);
    if(!input) return;

    input.addEventListener('focus', ()=> fillTrainDatalist(input.value));
    input.addEventListener('input', ()=> fillTrainDatalist(input.value));
    input.addEventListener('blur', ()=>{
      const no = extractTrainNoFromInput(input.value);
      if(no) input.value = no;
      fillTrainDatalist('');
    });
  }

  // ===== 點對點 / 轉乘 =====
  let currentStartEndList=[];
  let currentTransferList=[];

  function runStartEndSearch(){
    const st = extractStationNameFromInput(document.getElementById('startStation').value);
    const ed = extractStationNameFromInput(document.getElementById('endStation').value);
    document.getElementById('startStation').value=st;
    document.getElementById('endStation').value=ed;
    if(!st || !ed) return;

    const accept=document.getElementById('acceptTransfers').checked;
    lastStartEndQuery = { st, ed, accept };
    const h=loadHistory().filter(x=>!(x.s===st && x.e===ed && x.t===accept));
    h.unshift({s:st,e:ed,t:accept});
    saveHistory(h);
    renderHistory();

    selectedTrainTypesStartEnd=getSelectedTypes('trainTypeChipsStartEnd');

    if(accept){
      buildTransferList(st, ed);
      renderTransferTable();
    }else{
      buildDirectList(st, ed);
      renderStartEndTable();
    }
  }

  function buildDirectList(st, ed){
  const list = [];

  Object.keys(baseSchedule||{}).forEach(num=>{
    const t = baseSchedule[num];
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['車種'])) return;

    const arr = t['車站時間'] || [];
    const si = arr.findIndex(x=>x[0]===st);
    const ei = arr.findIndex(x=>x[0]===ed);
    if(si<0 || ei<0 || ei<=si) return;

    const abs = buildAbsMinutes(arr);
    const stAbs = abs[si]?.abs;
    const edAbs = abs[ei]?.abs;
    if(stAbs === null || edAbs === null) return;

    const depSched = arr[si][2] || arr[si][1] || '--'; // 出發：開車
    const arrSched = arr[ei][1] || arr[ei][2] || '--'; // 抵達：到達

    // ★★ 核心：套用誤點時間 ★★
    const depAdj = getAdjustedTime(num, depSched, currentQueryDateStr);
    const arrAdj = getAdjustedTime(num, arrSched, currentQueryDateStr);

    const travelMin = edAbs - stAbs;
    const travel = `${Math.floor(travelMin/60)}h ${travelMin%60}m`;
    const stopsCount = ei - si - 1;

    const originDate = currentQueryDateStr;
    const status = getTrainStatusLabel(
      num,
      originDate,
      (arr[0]?.[2]||arr[0]?.[1]||''),
      (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||''),
      depSched
    );

    list.push({
      num,
      type: t['車種'],
      range: `${arr[0][0]}➝${arr[arr.length-1][0]}`,
      depHTML: renderTimeWithDelay(num, depSched, currentQueryDateStr),
      arrHTML: renderTimeWithDelay(num, arrSched, currentQueryDateStr),
      depSortMin: depAdj.adjMin ?? 9999, // ★ 排序用：誤點後時間
      travel,
      travelMin,
      stopsCount,
      status,
      startStation: st,
      endStation: ed
    });
  });

  // ★ 用「誤點後時間」排序
  list.sort((a,b)=>a.depSortMin - b.depSortMin);
  currentStartEndList = list;
}


  // ===== 即時誤點：取分鐘數（晚到/提早） =====
function getDelayMinutes(trainNo){
  let raw = '';
  try { raw = (typeof getDelayStatus === 'function') ? (getDelayStatus(String(trainNo)) || '') : ''; } catch(e){ raw=''; }
  if(!raw) return 0;

  // 常見格式：晚 5 分、晚5分
  let m = raw.match(/晚\s*([\-]?\d+)\s*分/);
  if(m) return parseInt(m[1], 10) || 0;

  // 也支援你 UI 轉成的字串：誤點 5 分 / 提早 3 分
  m = raw.match(/誤點\s*([\-]?\d+)\s*分/);
  if(m) return parseInt(m[1], 10) || 0;

  m = raw.match(/提早\s*([\-]?\d+)\s*分/);
  if(m) return -(parseInt(m[1], 10) || 0);

  return 0;
}

function addMinutesToHHMM(hhmm, deltaMin){
  if(!hhmm || !/^\d{1,2}:\d{2}$/.test(hhmm)) return hhmm;
  const [h, m] = hhmm.split(':').map(x=>parseInt(x,10));
  let t = h*60 + m + deltaMin;
  // 允許跨日：限制在 0..1439 內
  t = ((t % 1440) + 1440) % 1440;
  const nh = String(Math.floor(t/60)).padStart(2,'0');
  const nm = String(t%60).padStart(2,'0');
  return `${nh}:${nm}`;
}

// 只在「查今天」才套用誤點時間
function isQueryToday(dateStr){
  const todayStr = fmtDate(new Date());
  return !!dateStr && dateStr === todayStr;
}

// 回傳：{sched, adj, adjMin, hasDelay}
function getAdjustedTime(trainNo, schedHHMM, queryDateStr){
  const sched = schedHHMM || '--';
  if(!isQueryToday(queryDateStr)) {
    return { sched, adj: sched, adjMin: parseTime(sched), hasDelay: false };
  }
  const dmin = getDelayMinutes(trainNo);
  // 只有「真的有誤點/提早」才顯示雙時間；0 就保持單時間
  if(!dmin) return { sched, adj: sched, adjMin: parseTime(sched), hasDelay: false };
  const adj = addMinutesToHHMM(sched, dmin);
  return { sched, adj, adjMin: parseTime(adj), hasDelay: true };
}

// UI：把時間顯示成「原時間刪線 + 新時間」
function renderTimeWithDelay(trainNo, schedHHMM, queryDateStr){
  const t = getAdjustedTime(trainNo, schedHHMM, queryDateStr);
  if(!t.hasDelay) return (schedHHMM || '--');

  // 不動你原本 CSS：用 inline style
  return `
    <span style="text-decoration:line-through;color:var(--text-muted);margin-right:6px;">
      ${t.sched}
    </span>
    <span style="font-weight:800;color:var(--text-main);">
      ${t.adj}
    </span>
  `;
}

  function renderStartEndTable(){
    const tbody=document.querySelector('#scheduleTableByStation tbody');
    tbody.innerHTML='';
    let maxTravel=Math.max(...currentStartEndList.map(r=>r.travelMin),1);

    currentStartEndList.forEach(r=>{
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=String(r.num).includes('A')?`<b>${r.num}</b><span class="badge-sea">海</span>`:`<b>${r.num}</b>`;
      tr.insertCell().innerHTML=`${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
      tr.insertCell().innerHTML = r.depHTML; // 出發：開車（含誤點顯示）
tr.insertCell().innerHTML = r.arrHTML; // 抵達：到達（含誤點顯示）


      let cell=tr.insertCell();
      cell.innerHTML=`<div style="font-size:.85rem;font-weight:600">${r.travel}</div><div class="progress-bar"><div class="progress-fill" style="width:${((r.travelMin/maxTravel)*100).toFixed(1)}%"></div></div>`;

      let stopsCell=tr.insertCell();
      if(r.stopsCount>0){
        stopsCell.innerHTML=`${r.stopsCount}站 <span class="toggle-arrow">▼</span>`;
        stopsCell.querySelector('.toggle-arrow').addEventListener('click',e=>{
          e.stopPropagation();
          toggleStopsRow(tr,r.startStation,r.endStation,r.num);
        });
      } else stopsCell.innerHTML='<span style="color:#16a34a;font-weight:600">直達</span>';

      tr.insertCell().innerHTML=colorStatus(r.status);
      tr.addEventListener('click',()=>showTrainDetails(r.num, currentQueryDateStr));
    });
  }

  function toggleStopsRow(tr, st, ed, num){
    const next=tr.nextElementSibling;
    if(next && next.classList.contains('stops-row')){
      next.remove();
      return;
    }
    const t=baseSchedule[num]; if(!t) return;
    const arr=t['車站時間']||[];
    const si=arr.findIndex(x=>x[0]===st);
    const ei=arr.findIndex(x=>x[0]===ed);
    if(si<0 || ei<0 || ei<=si) return;

    const stops=arr.slice(si+1, ei).map(x=>{
      const dep = x[2] || x[1] || '--';
      return `${x[0]}(${dep})`;
    }).join('、');

    const row=document.createElement('tr');
    row.className='stops-row';
    const td=document.createElement('td');
    td.colSpan=7;
    td.textContent=stops?`沿途停靠：${stops}`:'（無中途停靠）';
    row.appendChild(td);
    tr.parentNode.insertBefore(row, tr.nextSibling);
  }

  // ===== 轉乘（中途站：到達/開車分開） =====
  function buildTransferList(st, ed){
  const list = [];

  buildDirectList(st, ed);
  const bestDirectMin = currentStartEndList.length
    ? Math.min(...currentStartEndList.map(x=>x.travelMin))
    : Infinity;

  const allNums = Object.keys(baseSchedule||{});

  allNums.forEach(n1=>{
    const t1 = baseSchedule[n1];
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t1['車種'])) return;

    const a1 = t1['車站時間']||[];
    const sIdx = a1.findIndex(x=>x[0]===st);
    if(sIdx<0) return;

    const abs1 = buildAbsMinutes(a1);

    allNums.forEach(n2=>{
      const t2 = baseSchedule[n2];
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t2['車種'])) return;

      const a2 = t2['車站時間']||[];
      const eIdx = a2.findIndex(x=>x[0]===ed);
      if(eIdx<0) return;

      const abs2 = buildAbsMinutes(a2);

      for(let i=sIdx+1;i<a1.length;i++){
        const mid = a1[i][0];
        const midArr = a1[i][1]||a1[i][2];
        if(!midArr) continue;

        const midIdx = a2.findIndex(x=>x[0]===mid);
        if(midIdx<0) continue;

        const midDep = a2[midIdx][2]||a2[midIdx][1];
        if(!midDep) continue;

        const wait = parseTime(midDep) - parseTime(midArr);
        if(wait<0 || wait>90) continue;

        const sTime = a1[sIdx][2]||a1[sIdx][1];
        const eTime = a2[eIdx][1]||a2[eIdx][2];

        const sAdj = getAdjustedTime(n1, sTime, currentQueryDateStr);
        const eAdj = getAdjustedTime(n2, eTime, currentQueryDateStr);

        const travelMin =
          (abs2[eIdx]?.abs ?? 0) - (abs1[sIdx]?.abs ?? 0);

        if(travelMin >= bestDirectMin) continue;

        list.push({
          trainNumber: `${n1}+${n2}`,
          n1, n2,
          type1: t1['車種'],
          type2: t2['車種'],
          startStation: st,
          endStation: ed,
          transferStation: mid,

          // ✅ 新增：保留原始時間（給狀態判斷 & 排序）
  depSched: sTime,
  arrSched: eTime,
  depSortMin: sAdj.adjMin ?? 9999,

          depHTML: renderTimeWithDelay(n1, sTime, currentQueryDateStr),
          arrHTML: renderTimeWithDelay(n2, eTime, currentQueryDateStr),

          midArr,
          midDep,

          travelMin,
          travel: `${Math.floor(travelMin/60)}h ${travelMin%60}m`
        });

        break;
      }
    });
  });

  // 只保留每組最短的一筆
  const bestMap = new Map();
  list.forEach(r=>{
    if(!bestMap.has(r.trainNumber) || r.travelMin < bestMap.get(r.trainNumber).travelMin){
      bestMap.set(r.trainNumber, r);
    }
  });

  currentTransferList = Array.from(bestMap.values())
  .sort((a,b)=> (a.depSortMin ?? 9999) - (b.depSortMin ?? 9999));

}


  function renderTransferTable(){
    const tbody=document.querySelector('#scheduleTableByStation tbody');
    tbody.innerHTML='';
    let maxTravel=Math.max(...currentTransferList.map(r=>r.travelMin),1);

    currentTransferList.forEach(r=>{
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=String(r.trainNumber).includes('A')?`<b>${r.trainNumber}</b><span class="badge-sea">海</span>`:`<b>${r.trainNumber}</b>`;

      tr.insertCell().innerHTML=
        `${colorType(r.type1)}<span class="train-route">(${r.startStation}➝${r.transferStation})</span><br>`+
        `${colorType(r.type2)}<span class="train-route">(${r.transferStation}➝${r.endStation})</span>`;

      tr.insertCell().innerHTML = r.depHTML; // 出發：開車

      tr.insertCell().innerHTML=
        `<div style="font-weight:700">${r.transferStation}</div>`+
        `<div class="train-route">抵達 ${highlightPeak(r.midArr)} / 發車 ${highlightPeak(r.midDep)}</div>`+
        `<div class="train-route">${r.n1} → ${r.n2}</div>`;

      tr.insertCell().innerHTML = r.arrHTML; // 抵達：到達

      let cell=tr.insertCell();
      cell.innerHTML=`<div style="font-size:.85rem;font-weight:600">${r.travel}</div><div class="progress-bar"><div class="progress-fill" style="width:${((r.travelMin/maxTravel)*100).toFixed(1)}%"></div></div>`;

      tr.insertCell().innerHTML='—';

      const status = getTrainStatusLabel(
  r.n1,
  currentQueryDateStr,
  r.depSched,
  r.arrSched,
  r.depSched // 用出發站開車判斷已過站
);
      tr.insertCell().innerHTML=colorStatus(status);

      tr.addEventListener('click',()=>showTrainDetails(r.n1, currentQueryDateStr));
    });
  }

  // ===== 車站時刻表：順行=偶數車次 / 逆行=奇數車次 =====
  function isEvenTrainNo(num){
    const m = String(num).match(/\d+/);
    if(!m) return null;
    const n = parseInt(m[0],10);
    if(!Number.isFinite(n)) return null;
    return (n % 2 === 0);
  }

  // 車站時刻表：顯示日 = currentQueryDateStr
  // 但列車來源可能是：發車日 = currentQueryDateStr 或 currentQueryDateStr-1
  function filterTrainScheduleByStationName(){
    const station = extractStationNameFromInput(document.getElementById('stationNameInput').value);
    document.getElementById('stationNameInput').value = station;
    if(!station) return;

    const dir=document.getElementById('directionSelect').value; // even / odd
    lastStationQuery = { station, dir };

    const tbody=document.querySelector('#scheduleTableByStationName tbody');
    tbody.innerHTML='';

    selectedTrainTypesStation=getSelectedTypes('trainTypeChipsStation');

    const rows = [];
    scheduleKeyList.forEach(item=>{
      const {key, trainNo, originDate, data} = item;
      if(!data) return;
      if(selectedTrainTypesStation.length && !selectedTrainTypesStation.includes(data['車種'])) return;

      const arr = data['車站時間']||[];
      const idx = arr.findIndex(s=>s[0]===station);
      if(idx<0) return;

      const ev = isEvenTrainNo(trainNo);
      if(dir === 'even' && ev !== true) return;
      if(dir === 'odd'  && ev !== false) return;

      // 本站一律用「開車時間」
      const dep = arr[idx][2] || arr[idx][1] || '--';

      // 判斷這站實際是哪一天（跨日要落到隔天）
      const abs = buildAbsMinutes(arr);
      const absMin = abs[idx]?.abs;
      if(absMin === null) return;

      const stopDate = getStopDateStr(originDate, absMin);
      if(stopDate !== currentQueryDateStr) return; // 只顯示「選的那天」

      const status = getTrainStatusLabel(
        trainNo,
        originDate, // 狀態永遠用發車日
        (arr[0]?.[2]||arr[0]?.[1]||''),
        (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||''),
        dep // 用本站開車判斷已過站
      );

      rows.push({
        trainNo, originDate,
        type: data['車種'],
        range: `${arr[0][0]}➝${arr.slice(-1)[0][0]}`,
        dep,
        depMin: parseTime(dep) ?? 9999,
        status
      });
    });

    rows.sort((a,b)=>a.depMin-b.depMin);

    rows.forEach(r=>{
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=String(r.trainNo).includes('A')?`<b>${r.trainNo}</b><span class="badge-sea">海</span>`:`<b>${r.trainNo}</b>`;
      tr.insertCell().innerHTML=`${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
      tr.insertCell().innerHTML=highlightPeak(r.dep);
      tr.insertCell().innerHTML=colorStatus(r.status);
      tr.addEventListener('click',()=>showTrainDetails(r.trainNo, r.originDate));
    });
  }

  // ===== 車次查詢（以查詢日 currentQueryDateStr 的發車資料為主） =====
  function filterTrainScheduleByNumber(){
    const num = extractTrainNoFromInput(document.getElementById('trainNumberInput').value);
    lastTrainQuery = { trainNo: num };

    document.getElementById('trainNumberInput').value = num;

    const tbody=document.querySelector('#scheduleTableByNumber tbody');
    tbody.innerHTML='';
    const t=baseSchedule[num];
    if(!t) return;

    const arr=t['車站時間']||[];
    const status = getTrainStatusLabel(
  num,
  currentQueryDateStr,
  (arr[0]?.[2]||arr[0]?.[1]||''),
  (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||'')
);


    let tr=tbody.insertRow();
    tr.insertCell().innerHTML=String(num).includes('A')?`<b>${num}</b><span class="badge-sea">海</span>`:`<b>${num}</b>`;
    tr.insertCell().innerHTML=`${colorType(t['車種'])} <span class="train-route">(${arr[0][0]}➝${arr.slice(-1)[0][0]})</span>`;
    tr.insertCell().innerHTML=colorStatus(status);
    tr.addEventListener('click',()=>showTrainDetails(num, currentQueryDateStr));
  }

  // ===== Modal: 列車詳情（顯示站別用開車優先，並且跨日顯示正確日期） =====
  const modal=document.getElementById('trainModal');
  const modalClose=document.getElementById('modalClose');
  modalClose.addEventListener('click',()=>{ modal.style.display='none'; modalCtx=null; });
modal.addEventListener('click',(e)=>{ if(e.target===modal){ modal.style.display='none'; modalCtx=null; } });


  function showTrainDetails(trainNo, originDateStr){
    modalCtx = { trainNo, originDate: originDateStr };
    

    const t = (originDateStr === currentQueryDateStr) ? baseSchedule[trainNo] : (prevSchedule[trainNo] || baseSchedule[trainNo]);
    if(!t) return;

    const arr=t['車站時間']||[];
    const status = getTrainStatusLabel(
  trainNo,
  originDateStr,
  (arr[0]?.[2]||arr[0]?.[1]||''),
  (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||'')
);


    document.getElementById('modalTitleMain').textContent=`${trainNo}｜${t['車種']}`;
    document.getElementById('modalTitleSub').textContent=`${arr[0]?.[0]||''} ➝ ${arr.slice(-1)[0]?.[0]||''} ｜狀態：${status}`;

    const body=document.getElementById('modalBody');
    body.innerHTML='';
    const timeline=document.createElement('div');
    timeline.className='timeline';

    const abs = buildAbsMinutes(arr);

    const todayStr = fmtDate(new Date());
    const isTodayOrigin = (originDateStr === todayStr);

    // 下一站只在「今天發車」且「使用者查今天」才標（避免誤導）
    const isTodayUI = (currentQueryDateStr === todayStr);
    const canNext = isTodayOrigin && isTodayUI;

    const now=new Date();
    const nowMin=now.getHours()*60+now.getMinutes();
    let nextIndex=-1;

    if(canNext){
      for(let i=0;i<arr.length;i++){
        const tStr = arr[i][2] || arr[i][1] || '';
        const m=parseTime(tStr);
        if(m!==null && m>=nowMin){ nextIndex=i; break; }
      }
    }

    arr.forEach((s, i)=>{
      const item=document.createElement('div');
      item.className='timeline-item';

      const dep = s[2] || s[1] || '--';
      const dateStr = getStopDateStr(originDateStr, abs[i]?.abs);

      item.innerHTML=`
        <div class="tl-time">${dep}</div>
        <div class="tl-marker">
          <div class="tl-dot"></div>
          <div class="tl-line"></div>
        </div>
        <div class="tl-content">
          <div class="tl-station">${s[0]}${(canNext && i===nextIndex)?` <span class="badge-next">下一站</span>`:''}</div>
          <div class="tl-desc">${dateStr} ${i===0?'｜起站':(i===arr.length-1?'｜終點':'')}</div>
        </div>
      `;

      if(canNext){
        if(i<nextIndex) item.classList.add('passed');
        if(i===nextIndex) item.classList.add('next');
      }

      timeline.appendChild(item);
    });

    body.appendChild(timeline);
    modal.style.display='flex';
  }

  // ===== 事件綁定 =====
  document.getElementById('searchBtn').addEventListener('click', runStartEndSearch);
  document.getElementById('stationSearchBtn').addEventListener('click', filterTrainScheduleByStationName);
  document.getElementById('trainNumberBtn').addEventListener('click', filterTrainScheduleByNumber);

  document.getElementById('swapBtn').addEventListener('click', ()=>{
    const a=document.getElementById('startStation');
    const b=document.getElementById('endStation');
    const t=a.value; a.value=b.value; b.value=t;
  });
</script>


</body>
</html>
