<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è¡Œå‹•æ¢ç¢¼æƒæçµå¸³å™¨ â€” å°ˆæ¥­ç‰ˆï¼ˆAndroid & iPhone æ”¯æ´ï¼‰</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --soft:#101a2e; --text:#e6ecff; --muted:#9fb2d1; --accent:#5eead4; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 60%,#0b1528);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,"PingFang TC","Heiti TC","Microsoft JhengHei",sans-serif}
    header{position:sticky;top:0;z-index:20;background:rgba(15,23,42,.8);backdrop-filter: blur(8px);border-bottom:1px solid #1e2a44}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:0.5px}
    .layout{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;align-items:start}
    .panel{background:var(--panel);border:1px solid #1c2a45;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .panel h2{margin:0;padding:14px 16px;border-bottom:1px solid #1c2a45;font-size:15px;color:#bcd0ef}
    .content{padding:14px 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{border:0;border-radius:12px;padding:10px 14px;background:#1a2540;color:var(--text);cursor:pointer}
    button.primary{background:linear-gradient(135deg,#10b981,#0ea5e9);color:#08202a;font-weight:700}
    button.warn{background:#2a1a1a;color:#ffd1d1;border:1px solid #412323}
    button.ghost{background:#111827;color:#bcd0ef}
    button:disabled{opacity:.5;cursor:not-allowed}
    select,input,textarea{background:#0c1324;color:var(--text);border:1px solid #223251;border-radius:12px;padding:10px 12px}
    input[type="number"]{width:110px}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
    .video-wrap{position:relative;border-radius:14px;overflow:hidden;background:#030712;border:1px solid #1c2a45;min-height:240px}
    .scan-overlay{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    .scan-box{width:min(80%,480px);aspect-ratio:1/1;border:2px solid rgba(94,234,212,.9);border-radius:18px;box-shadow:0 0 20px rgba(94,234,212,.25) inset, 0 0 30px rgba(94,234,212,.15)}
    .scan-line{position:absolute;left:50%;transform:translateX(-50%);width:70%;height:2px;background:linear-gradient(90deg,transparent,rgba(94,234,212,.95),transparent);animation:scan 2.2s linear infinite}
    @keyframes scan{0%{top:20%}50%{top:80%}100%{top:20%}}
    .flash{position:absolute;inset:0;background:white;opacity:0;pointer-events:none}
    .flash.active{animation:flash .12s ease}
    @keyframes flash{from{opacity:.9}to{opacity:0}}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0b1a33;border:1px solid #1d2f52;color:#9fc4ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .total{font-size:40px;font-weight:800;letter-spacing:1px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #1c2a45;text-align:left}
    th{color:#96b3df;font-weight:600;font-size:13px}
    td.small{font-size:12px;color:#9fb2d1}
    .qtybtn{padding:6px 10px;border-radius:10px;background:#13203b;border:1px solid #223251}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:var(--muted)}
    details summary{cursor:pointer;color:#9fc4ff}
    .footer{padding:12px 16px;border-top:1px solid #1c2a45;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .chip{padding:6px 10px;border-radius:10px;background:#11203a;border:1px solid #20416e;color:#a4c8ff;font-size:12px}
    .hidden{display:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0b1a33;border:1px solid #1d2f52;color:#cfe4ff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.4);z-index:100}
    @media (max-width: 900px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row" style="gap:10px">
        <h1>ğŸ“· è¡Œå‹•æ¢ç¢¼æƒæçµå¸³å™¨ â€” å°ˆæ¥­ç‰ˆ</h1>
        <span class="badge">Android & iPhone Safari çš†å¯ç”¨ï¼ˆhtml5-qrcodeï¼‰</span>
      </div>
      <div class="row">
        <button id="btnReset" class="ghost" title="æ¸…ç©ºè³¼ç‰©è»Š">æ¸…ç©º</button>
        <button id="btnCheckout" class="primary" title="ç”¢ç”Ÿæ”¶æ“š">çµå¸³</button>
      </div>
    </div>
  </header>

  <main class="wrap layout" style="padding-top:16px; padding-bottom:90px">
    <!-- å·¦å´ï¼šæƒæå€ -->
    <section class="panel" id="scanPanel">
      <h2>æƒæå™¨</h2>
      <div class="content">
        <div class="grid-2">
          <label class="kv">
            <span>é¡é ­</span>
            <select id="cameraSelect"></select>
          </label>
          <label class="kv">
            <span>è§£æåº¦</span>
            <select id="resolution">
              <option value="1280x720">1280Ã—720</option>
              <option value="1920x1080">1920Ã—1080</option>
              <option value="640x480">640Ã—480</option>
            </select>
          </label>
          <label class="kv">
            <span>é‡è¤‡æƒæé–ç§’</span>
            <input id="dedupSec" type="number" min="0" step="0.5" value="2"/>
          </label>
          <label class="kv">
            <span>ç¨…ç‡(%)</span>
            <input id="taxRate" type="number" min="0" step="0.1" value="0" />
          </label>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnStart" class="primary">é–‹å§‹æƒæ</button>
          <button id="btnStop" class="ghost" disabled>åœæ­¢</button>
          <button id="btnTorch" class="ghost" disabled>æ‰‹é›»ç­’</button>
          <button id="btnFlip" class="ghost" disabled>åˆ‡æ›å‰/å¾Œé¡</button>
        </div>

        <div class="video-wrap" style="margin-top:12px">
          <div id="scanner" style="width:100%"></div>
          <div class="scan-overlay">
            <div class="scan-box"></div>
            <div class="scan-line"></div>
          </div>
          <div class="flash" id="flash"></div>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div>
            <div class="chip">ä¸Šæ¬¡æƒæï¼š<span id="lastCode" class="mono">â€”</span></div>
          </div>
          <div class="row">
            <input id="manualCode" placeholder="æ‰‹å‹•è¼¸å…¥æ¢ç¢¼æˆ–é‡‘é¡" class="mono" style="min-width:220px"/>
            <button id="btnManualAdd" class="ghost">åŠ å…¥</button>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>ä¸Šå‚³å•†å“æ¸…å–®ï¼ˆCSVï¼‰</summary>
          <p class="muted">æ ¼å¼ï¼š<code class="mono">barcode,name,price</code>ï¼ˆæ¯è¡Œä¸€ç­†ï¼Œåƒ¹æ ¼ç‚ºæ–°å°å¹£ï¼‰ã€‚</p>
          <textarea id="csvInput" rows="5" style="width:100%" placeholder="ä¾‹å¦‚ï¼š
4712345678901,ç¤¦æ³‰æ°´600ml,20
4901234567894,æ´‹èŠ‹ç‰‡,45"></textarea>
          <div class="right" style="margin-top:8px"><button id="btnImportCsv">åŒ¯å…¥/è¦†è“‹å•†å“åº«</button></div>
        </details>
      </div>
      <div class="footer">
        <span class="muted">æç¤ºï¼šéœ€åœ¨ HTTPS æˆ–æœ¬æ©Ÿ (localhost) é–‹å•Ÿä»¥å•Ÿç”¨ç›¸æ©Ÿã€‚iPhone Safari ä¹Ÿå¯ç”¨ã€‚</span>
        <span class="chip">å•†å“æ•¸ï¼š<span id="skuCount">0</span></span>
      </div>
    </section>

    <!-- å³å´ï¼šè³¼ç‰©è»Š -->
    <section class="panel">
      <h2>è³¼ç‰©è»Š</h2>
      <div class="content">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div class="muted">å°è¨ˆ</div>
            <div class="total" id="subtotal">$0</div>
          </div>
          <div>
            <div class="muted">å«ç¨…ç¸½è¨ˆ</div>
            <div class="total" id="grand">$0</div>
          </div>
        </div>

        <table style="margin-top:12px" id="cartTable">
          <thead>
            <tr>
              <th style="width:36px">#</th>
              <th>å“å</th>
              <th>æ¢ç¢¼</th>
              <th style="width:110px">å–®åƒ¹</th>
              <th style="width:130px">æ•¸é‡</th>
              <th style="width:110px">å°è¨ˆ</th>
              <th style="width:120px">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
      </div>
      <div class="footer">
        <div class="muted">é•·æŒ‰åˆ—å¯å¿«é€Ÿåˆªé™¤ã€‚é‡è¤‡æƒæåŒæ¢ç¢¼æœƒè‡ªå‹• +1ã€‚</div>
        <div class="row">
          <button id="btnExport" class="ghost">åŒ¯å‡ºæ”¶æ“š (TXT)</button>
          <button id="btnCopy" class="ghost">è¤‡è£½æ”¶æ“š</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <!-- html5-qrcodeï¼šè·¨å¹³å°æƒæå™¨ï¼ˆé moduleï¼Œç¢ºä¿ Safari å•Ÿå‹•é¡é ­ï¼‰ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <script>
    // ========= ç‹€æ…‹ =========
    const state = {
      skuMap: loadSkuMap(), // { barcode: {name, price} }
      cart: loadCart(),
      lastScanAt: 0,
      currentCameraId: null,
      torchOn: false,
    };

    // ========= å…ƒç´  =========
    const els = {
      cameraSelect: document.getElementById('cameraSelect'),
      resolution: document.getElementById('resolution'),
      dedupSec: document.getElementById('dedupSec'),
      taxRate: document.getElementById('taxRate'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      btnTorch: document.getElementById('btnTorch'),
      btnFlip: document.getElementById('btnFlip'),
      lastCode: document.getElementById('lastCode'),
      manualCode: document.getElementById('manualCode'),
      btnManualAdd: document.getElementById('btnManualAdd'),
      csvInput: document.getElementById('csvInput'),
      btnImportCsv: document.getElementById('btnImportCsv'),
      skuCount: document.getElementById('skuCount'),
      subtotal: document.getElementById('subtotal'),
      grand: document.getElementById('grand'),
      cartBody: document.getElementById('cartBody'),
      btnReset: document.getElementById('btnReset'),
      btnCheckout: document.getElementById('btnCheckout'),
      btnExport: document.getElementById('btnExport'),
      btnCopy: document.getElementById('btnCopy'),
      toast: document.getElementById('toast'),
      flash: document.getElementById('flash'),
    };

    // åˆå§‹ç¤ºç¯„å•†å“ï¼ˆå¯åˆªï¼‰
    if (Object.keys(state.skuMap).length === 0) {
      state.skuMap = {
        '4712345678901': { name: 'ç¤¦æ³‰æ°´ 600ml', price: 20 },
        '4901234567894': { name: 'æ´‹èŠ‹ç‰‡(åŸå‘³)', price: 45 },
        '4710000000001': { name: 'å¯æ¨‚ 330ml', price: 25 },
      };
      saveSkuMap();
    }

    // ========= å·¥å…· =========
    function saveSkuMap(){ localStorage.setItem('skuMap', JSON.stringify(state.skuMap)); renderSkuCount(); }
    function loadSkuMap(){ try{ return JSON.parse(localStorage.getItem('skuMap')||'{}') }catch{ return {} } }
    function saveCart(){ localStorage.setItem('cart', JSON.stringify(state.cart)); renderCart(); }
    function loadCart(){ try{ return JSON.parse(localStorage.getItem('cart')||'[]') }catch{ return [] } }

    function nt$(n){ return 'NT$ ' + Number(n).toLocaleString('zh-TW', { maximumFractionDigits: 0 }); }
    function showToast(msg){ els.toast.textContent = msg; els.toast.classList.remove('hidden'); setTimeout(()=>els.toast.classList.add('hidden'), 1400); }
    function vibrate(ms=50){ try{ navigator.vibrate && navigator.vibrate(ms) }catch{} }
    function flash(){ els.flash.classList.remove('active'); void els.flash.offsetWidth; els.flash.classList.add('active') }

    // å—¶è²ï¼ˆWeb Audioï¼‰
    let audioCtx;
    function beep(freq=880, dur=80){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.value = freq;
        gain.gain.value = 0.08;
        osc.connect(gain).connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        osc.start(t);
        osc.stop(t + dur/1000);
      }catch{}
    }

    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const out = {};
      for(const l of lines){
        const parts = l.split(',');
        if(parts.length < 3) continue;
        const [barcode,name,priceStr] = parts;
        const price = Number(priceStr);
        if(!barcode || !name || isNaN(price)) continue;
        out[barcode] = { name: name.trim(), price: Math.round(price) };
      }
      return out;
    }

    // ========= æƒæå™¨ï¼ˆhtml5-qrcodeï¼‰ =========
    let html5Qrcode = null;
    let running = false;
    let facing = 'environment';

    async function listCameras(){
      const devices = await Html5Qrcode.getCameras();  // ä¹Ÿå¯è§¸ç™¼æ¬Šé™è©¢å•
      els.cameraSelect.innerHTML = '';
      devices.forEach((d,i)=>{
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = d.label || `é¡é ­ ${i+1}`; els.cameraSelect.appendChild(opt);
      });
      if(devices.length){
        // å˜—è©¦é¸æ“‡å¾Œé¡é ­
        const back = devices.find(d => /back|å¾Œ|rear|environment/i.test(d.label || ''));
        state.currentCameraId = (back && back.id) || devices[0].id;
      }
      els.btnFlip.disabled = devices.length < 2;
    }

    function desiredResolution(){
      const [w,h] = els.resolution.value.split('x').map(Number);
      return { width: { ideal: w }, height: { ideal: h } };
    }

    async function start(){
      if(running) return;
      const config = {
        fps: 18,
        qrbox: (viewfinderWidth, viewfinderHeight) => {
          const size = Math.min(viewfinderWidth, viewfinderHeight) * 0.72;
          return { width: size, height: size };
        },
        showTorchButtonIfSupported: true,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        videoConstraints: { ...desiredResolution(), facingMode: facing, aspectRatio: 1.777 },
        formatsToSupport: [
          Html5QrcodeSupportedFormats.QR_CODE,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E
        ]
      };

      if(!html5Qrcode) html5Qrcode = new Html5Qrcode("scanner", { verbose: false });

      // å…ˆå˜—è©¦ç”¨å¾Œé¡é ­ facingModeï¼Œå¤±æ•—å†ç”¨ deviceId
      let cameraSelection = { facingMode: "environment" };
      if(state.currentCameraId) cameraSelection = state.currentCameraId;

      try{
        await html5Qrcode.start(cameraSelection, config, onDecoded, onDecodeFailure);
        running = true; toggleBtns();

        // å•Ÿå‹•å¾Œæª¢æŸ¥ torch èƒ½åŠ›ï¼Œæ±ºå®šæ˜¯å¦å•Ÿç”¨è‡ªè¨‚æ‰‹é›»ç­’æŒ‰éˆ•
        try{
          if(typeof html5Qrcode.getRunningTrackCapabilities === 'function'){
            const caps = html5Qrcode.getRunningTrackCapabilities();
            els.btnTorch.disabled = !(caps && caps.torch);
          } else {
            els.btnTorch.disabled = true;
          }
        }catch{ els.btnTorch.disabled = true; }
      }catch(err){
        alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š' + (err?.message || err) + '\nè«‹ç¢ºèªç¶²é ç‚º HTTPSï¼Œä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚');
      }
    }

    async function stop(){
      if(!running) return;
      try{
        await html5Qrcode.stop();
      }catch(e){
        console.warn(e);
      }finally{
        running = false;
        toggleBtns();
      }
    }

    function toggleBtns(){
      els.btnStart.disabled = running; els.btnStop.disabled = !running; els.btnTorch.disabled = !running;
    }

    async function toggleTorch(){
      // å…§å»º API å„ªå…ˆ
      try{
        if(html5Qrcode && typeof html5Qrcode.turnOnTorch === 'function' && typeof html5Qrcode.turnOffTorch === 'function'){
          state.torchOn = !state.torchOn;
          if(state.torchOn) await html5Qrcode.turnOnTorch(); else await html5Qrcode.turnOffTorch();
          showToast(state.torchOn ? 'æ‰‹é›»ç­’å·²é–‹' : 'æ‰‹é›»ç­’å·²é—œ');
          return;
        }
      }catch(e){}
      // å¾Œå‚™ï¼šç´„æŸå¥—ç”¨
      try{
        if(html5Qrcode && typeof html5Qrcode.applyVideoConstraints === 'function'){
          state.torchOn = !state.torchOn;
          await html5Qrcode.applyVideoConstraints({ advanced: [{ torch: state.torchOn }] });
          showToast(state.torchOn ? 'æ‰‹é›»ç­’å·²é–‹' : 'æ‰‹é›»ç­’å·²é—œ');
        } else {
          showToast('æ­¤é¡é ­ä¸æ”¯æ´æ‰‹é›»ç­’');
        }
      }catch(e){ showToast('ç„¡æ³•åˆ‡æ›æ‰‹é›»ç­’'); }
    }

    async function flip(){
      facing = (facing === 'environment') ? 'user' : 'environment';
      await stop(); await start();
    }

    function onDecoded(text, result){
      const now = Date.now();
      const dedup = Number(els.dedupSec.value) * 1000;
      if(now - state.lastScanAt < dedup && els.lastCode.textContent === text){ return; }
      state.lastScanAt = now; els.lastCode.textContent = text; flash(); vibrate(30); beep(1244, 70);

      let item = state.skuMap[text];
      if(item){ // å·²å­˜åœ¨ â†’ ç›´æ¥åŠ å…¥
        addToCart(text, item.name, item.price, 1);
        return;
      }
      // å…è¨±æ¢ç¢¼ç›´æ¥ç•¶é‡‘é¡ï¼ˆåƒ…çŸ­æ•¸å­—ï¼‰
      const isNumeric = /^\d+$/.test(text);
      const number = Number(text);
      if(isNumeric && text.length <= 6 && number > 0){
        addToCart('â€”', 'è‡¨æ™‚å“', Math.round(number), 1);
        return;
      }
      // ä¸å­˜åœ¨ â†’ è©¢å•å»ºç«‹
      const name = prompt(`æ‰¾ä¸åˆ°æ¢ç¢¼ï¼š${text}\nè«‹è¼¸å…¥å“åï¼ˆç•™ç©ºå‰‡å–æ¶ˆï¼‰`);
      if(name && name.trim()){
        const priceStr = prompt('è«‹è¼¸å…¥å–®åƒ¹ï¼ˆæ–°å°å¹£ï¼Œæ•´æ•¸ï¼‰');
        const price = Math.round(Number(priceStr||0));
        if(price > 0){
          item = { name: name.trim(), price };
          state.skuMap[text] = item; saveSkuMap();
          addToCart(text, item.name, item.price, 1);
        }
      }
    }

    function onDecodeFailure(err){ /* éœé»˜å¿½ç•¥ä»¥ç¶­æŒæµæš¢æ€§ */ }

    // ========= è³¼ç‰©è»Š =========
    function addToCart(barcode, name, price, qty=1){
      const i = state.cart.findIndex(x=>x.barcode===barcode && x.price===price);
      if(i>=0){ state.cart[i].qty += qty }
      else{ state.cart.push({ barcode, name, price, qty }) }
      saveCart();
      showToast(`${name} +${qty}`);
    }

    function removeAt(idx){ state.cart.splice(idx,1); saveCart(); }
    function changeQty(idx, delta){ state.cart[idx].qty = Math.max(1, state.cart[idx].qty + delta); saveCart(); }

    function calc(){
      const sub = state.cart.reduce((s,i)=> s + i.price * i.qty, 0);
      const tax = sub * (Number(els.taxRate.value||0)/100);
      const grand = Math.round(sub + tax);
      return { sub, tax, grand };
    }

    function renderCart(){
      const tbody = els.cartBody; tbody.innerHTML='';
      state.cart.forEach((it,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${esc(it.name)}</td>
          <td class="small mono">${esc(it.barcode)}</td>
          <td class="mono">${nt$(it.price)}</td>
          <td>
            <div class="row">
              <button class="qtybtn" data-act="dec" data-i="${idx}">-</button>
              <span class="mono" style="min-width:32px;text-align:center">${it.qty}</span>
              <button class="qtybtn" data-act="inc" data-i="${idx}">+</button>
            </div>
          </td>
          <td class="mono">${nt$(it.price * it.qty)}</td>
          <td>
            <div class="row">
              <button class="ghost" data-act="rm" data-i="${idx}">åˆªé™¤</button>
            </div>
          </td>`;
        tr.addEventListener('contextmenu', e=>{ e.preventDefault(); removeAt(idx) });
        tbody.appendChild(tr);
      });
      const { sub, grand } = calc();
      els.subtotal.textContent = nt$(sub);
      els.grand.textContent = nt$(grand);
    }

    function esc(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }
    function renderSkuCount(){ els.skuCount.textContent = Object.keys(state.skuMap).length }

    // ========= æ”¶æ“š =========
    function buildReceipt(){
      const t = new Date();
      const lines = [];
      lines.push('â€” æ”¶æ“š â€”');
      lines.push('æ™‚é–“ï¼š' + t.toLocaleString('zh-TW'));
      lines.push('-----------------------------');
      state.cart.forEach((it,i)=>{
        lines.push(`${i+1}. ${it.name}  x${it.qty}`);
        lines.push(`   ${it.barcode}  @${it.price}  å°è¨ˆ=${it.price*it.qty}`);
      })
      const { sub, tax, grand } = calc();
      lines.push('-----------------------------');
      lines.push(`å°è¨ˆï¼š${sub}`);
      lines.push(`ç¨…é¡ï¼š${Math.round(tax)}`);
      lines.push(`ç¸½è¨ˆï¼š${grand}`);
      lines.push('æ„Ÿè¬æƒ é¡§ï¼');
      return lines.join('\n');
    }

    function downloadTxtFile(filename, content){
      const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // ========= äº‹ä»¶ =========
    els.btnStart.addEventListener('click', start);
    els.btnStop.addEventListener('click', stop);
    els.btnTorch.addEventListener('click', toggleTorch);
    els.btnFlip.addEventListener('click', flip);

    els.cameraSelect.addEventListener('change', async ()=>{ state.currentCameraId = els.cameraSelect.value; if(running){ await stop(); await start(); } });
    els.resolution.addEventListener('change', async ()=>{ if(running){ await stop(); await start(); } });

    els.cartBody.addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return; const i = Number(btn.dataset.i);
      if(btn.dataset.act==='inc') changeQty(i, +1);
      else if(btn.dataset.act==='dec') changeQty(i, -1);
      else if(btn.dataset.act==='rm') removeAt(i);
    });

    // æ‰‹å‹•è¼¸å…¥æ¢ç¢¼/é‡‘é¡ï¼šå·²å­˜åœ¨æ¢ç¢¼ç›´æ¥åŠ å…¥ï¼›çŸ­æ•¸å­—ï¼ˆâ‰¤6ï¼‰è¦–ç‚ºé‡‘é¡
    els.btnManualAdd.addEventListener('click', ()=>{
      const v = (els.manualCode.value||'').trim(); if(!v) return;

      const isNumeric = /^\d+$/.test(v);
      const number = Number(v);

      // 1) å·²å­˜åœ¨æ¢ç¢¼ â†’ ç›´æ¥åŠ å…¥
      const found = state.skuMap[v];
      if(found){
        addToCart(v, found.name, found.price, 1);
        els.manualCode.value=''; showToast(`å·²åŠ å…¥ ${found.name}`);
        return;
      }

      // 2) çŸ­æ•¸å­— â†’ é‡‘é¡
      if(isNumeric && v.length <= 6 && number > 0){
        addToCart('â€”', 'è‡¨æ™‚å“', Math.round(number), 1);
        els.manualCode.value=''; return;
      }

      // 3) æ–°æ¢ç¢¼ â†’ æ–°å¢å•†å“
      const name = prompt(`æ–°æ¢ç¢¼ï¼š${v}\nè«‹è¼¸å…¥å“å`);
      if(name && name.trim()){
        const priceStr = prompt('è«‹è¼¸å…¥å–®åƒ¹ï¼ˆæ–°å°å¹£ï¼Œæ•´æ•¸ï¼‰');
        const price = Math.round(Number(priceStr||0));
        if(price>0){
          state.skuMap[v] = { name: name.trim(), price };
          saveSkuMap();
          addToCart(v, name.trim(), price, 1);
          showToast(`å·²æ–°å¢ ${name.trim()}`);
        }
      }
      els.manualCode.value='';
    });

    els.btnImportCsv.addEventListener('click', ()=>{
      const text = els.csvInput.value.trim();
      if(!text){ showToast('æ²’æœ‰å…§å®¹'); return }
      const obj = parseCSV(text); if(Object.keys(obj).length===0){ showToast('è§£æå¤±æ•—'); return }
      state.skuMap = obj; saveSkuMap(); showToast('å·²åŒ¯å…¥å•†å“åº«');
    });

    els.taxRate.addEventListener('input', ()=> renderCart());

    document.getElementById('btnReset').addEventListener('click', ()=>{
      if(confirm('ç¢ºå®šæ¸…ç©ºè³¼ç‰©è»Šï¼Ÿ')){ state.cart = []; saveCart(); }
    });

    document.getElementById('btnCheckout').addEventListener('click', ()=>{
      if(state.cart.length===0){ showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return }
      const txt = buildReceipt();
      alert(txt);
    });

    els.btnExport.addEventListener('click', ()=>{ const txt = buildReceipt(); downloadTxtFile('receipt_'+Date.now()+'.txt', txt); });
    els.btnCopy.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(buildReceipt()); showToast('å·²è¤‡è£½æ”¶æ“š'); }
      catch{ showToast('ç„¡æ³•è¤‡è£½ï¼Œè«‹ç”¨åŒ¯å‡º') }
    });

    // ========= å•Ÿå‹•æµç¨‹ï¼šé–‹é è‡ªå‹•å•Ÿå‹•ç›¸æ©Ÿ =========
    (async function boot(){
      try{
        await listCameras();               // å–å¾—å¯ç”¨é¡é ­ï¼ˆä¹Ÿæœ‰åŠ©æ–¼è§¸ç™¼æ¬Šé™ï¼‰
        renderSkuCount();
        renderCart();

        // å˜—è©¦è‡ªå‹•å•Ÿå‹•å¾Œé¡é ­
        await start();
      }catch(e){
        console.warn(e);
        showToast('è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™ä»¥å•Ÿå‹•æƒæåŠŸèƒ½');
        toggleBtns(); // è®“ä½¿ç”¨è€…å¯æ‰‹å‹•æŒ‰ã€Œé–‹å§‹æƒæã€
      }
    })();
  </script>
</body>
</html>
