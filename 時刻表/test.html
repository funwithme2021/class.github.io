<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>颱風預測路徑繪圖系統</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <style>
        #map {
            height: 800px;
            width: 100%;
        }
        .form-container {
            margin: 20px;
        }
        .form-container div {
            margin-bottom: 10px;
        }
        .points-list {
            margin-top: 10px;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .point-item {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="form-container">
        <h2>輸入路徑數據</h2>
        <form id="typhoon-form">
            <div>
                <h3>過去位置</h3>
                <label>經度：</label>
                <input type="number" step="0.000001" id="past-longitude">
                <label>緯度：</label>
                <input type="number" step="0.000001" id="past-latitude">
                <button type="button" onclick="addPastPoint()">添加過去位置</button>
                <div id="past-points" class="points-list"></div>
            </div>
            
            <div>
                <h3>預測位置</h3>
                <div id="future-points">
                    <!-- Future points input fields will be generated dynamically -->
                </div>
                <button type="button" onclick="generateFutureInputs()">生成預測位置輸入框</button>
            </div>
        </form>
    </div>

    <button onclick="toggleDrawPolygonMode()">進入繪製颱風範圍模式</button>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <script>
        var map = L.map('map').setView([23.5, 121], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var pastPath = [];
        var futurePath = [];
        var currentMarker = null;
        var currentRadiusCircle7 = null;
        var currentRadiusCircle10 = null;
        var futureMarkers = [];

        var drawnPolygon = null;
        var editablePolygon = null;
        var drawPolygonMode = false;

        function toggleDrawPolygonMode() {
            drawPolygonMode = !drawPolygonMode;
            if (drawPolygonMode) {
                map.getContainer().style.cursor = 'crosshair';
                initEditablePolygon();
                alert('點擊地圖以繪製颱風範圍，完成後再點擊此按鈕退出繪製模式。');
            } else {
                map.getContainer().style.cursor = 'auto';
                map.off('click', handleMapClick);
                map.off('mousemove', handleMouseMove);
                if (drawnPolygon) {
                    map.addLayer(drawnPolygon);
                    drawnPolygon = null;
                }
                if (editablePolygon) {
                    map.removeLayer(editablePolygon);
                    editablePolygon = null;
                }
            }
        }

        function initEditablePolygon() {
            drawnPolygon = L.polygon([], {
                color: 'blue',
                fillColor: 'lightblue',
                fillOpacity: 0.5,
                smoothFactor: 1.0,
            }).addTo(map);

            editablePolygon = L.editable(drawnPolygon).addTo(map);
            editablePolygon.enable();

            map.on('click', handleMapClick);
            map.on('mousemove', handleMouseMove);
        }

        function handleMapClick(e) {
            if (drawnPolygon) {
                drawnPolygon.addLatLng(e.latlng);
            }
        }

        function handleMouseMove(e) {
            if (editablePolygon) {
                editablePolygon.editor.drawing.moveTooltip(e.latlng);
            }
        }

        // Add past point
        function addPastPoint() {
            var lat = parseFloat(document.getElementById('past-latitude').value);
            var lng = parseFloat(document.getElementById('past-longitude').value);

            var point = [lat, lng];
            pastPath.push(point);

            addPastPointToList(lat, lng);
            redrawPaths();
        }

        function addPastPointToList(lat, lng) {
            var pastPointsDiv = document.getElementById('past-points');
            var pointItem = document.createElement('div');
            pointItem.className = 'point-item';
            pointItem.innerHTML = `經度: ${lng}, 緯度: ${lat} <button onclick="removePastPoint(${pastPath.length - 1}, this)">刪除</button>`;
            pastPointsDiv.appendChild(pointItem);
        }

        function removePastPoint(index, btn) {
            pastPath.splice(index, 1);
            var pointItem = btn.parentNode;
            pointItem.parentNode.removeChild(pointItem);
            redrawPaths();
        }

        // Set or update current point
        function setOrUpdateCurrentPoint() {
            var lat = parseFloat(document.getElementById('current-latitude').value);
            var lng = parseFloat(document.getElementById('current-longitude').value);
            var intensity = document.getElementById('current-intensity').value;
            var radius7 = parseFloat(document.getElementById('current-radius-7').value) || 0;
            var radius10 = parseFloat(document.getElementById('current-radius-10').value) || 0;

            // Remove previous circle and marker
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            if (currentRadiusCircle7) {
                map.removeLayer(currentRadiusCircle7);
                currentRadiusCircle7 = null;
            }
            if (currentRadiusCircle10) {
                map.removeLayer(currentRadiusCircle10);
                currentRadiusCircle10 = null;
            }

            // Add radius 7 circle
            if (radius7 > 0) {
                currentRadiusCircle7 = L.circle([lat, lng], {
                    color: 'yellow',
                    fillColor: 'none',
                    fillOpacity: 0.5,
                    radius: radius7 * 1000,
                    dashArray: '5, 5',
                }).addTo(map);
            }

            // Add radius 10 circle
            if (radius10 > 0) {
                currentRadiusCircle10 = L.circle([lat, lng], {
                    color: 'red',
                    fillColor: 'none',
                    fillOpacity: 0.5,
                    radius: radius10 * 1000,
                    dashArray: '5, 5',
                }).addTo(map);
            }

            // Add current marker
            currentMarker = addMarker(lat, lng, intensity);

            // Redraw the map
            redrawPaths();
        }

        // Add future point
        function addFuturePoint(index) {
            var lat = parseFloat(document.getElementById(`future-latitude-${index}`).value);
            var lng = parseFloat(document.getElementById(`future-longitude-${index}`).value);
            var intensity = document.getElementById(`future-intensity-${index}`).value || 'TD';
            var radius7 = parseFloat(document.getElementById(`future-radius-7-${index}`).value) || 0;
            var radius10 = parseFloat(document.getElementById(`future-radius-10-${index}`).value) || 0;
            var errorRadius = parseFloat(document.getElementById(`future-error-radius-${index}`).value) || 0;
            var showIcon = document.getElementById(`future-show-icon-${index}`).checked;

            var point = { coords: [lat, lng], radius7: radius7, radius10: radius10, errorRadius: errorRadius, showIcon: showIcon, intensity: intensity };
            futurePath[index] = point;

            if (showIcon) {
                var marker = addMarker(lat, lng, intensity);
                if (futureMarkers[index] && futureMarkers[index].marker) {
                    map.removeLayer(futureMarkers[index].marker);
                }
                futureMarkers[index] = { marker: marker, circle7: null, circle10: null };
            } else {
                delete futureMarkers[index];
            }

            addCircle(lat, lng, radius7, 'yellow', 'dashed', radius7 > 0);
            addCircle(lat, lng, radius10, 'red', 'dashed', radius10 > 0);
            addCircle(lat, lng, errorRadius, 'blue', 'dashed', errorRadius > 0); // Display error radius circle

            redrawPaths();
        }

        // Update future point
        function updateFuturePoint(index) {
            var lat = parseFloat(document.getElementById(`future-latitude-${index}`).value);
            var lng = parseFloat(document.getElementById(`future-longitude-${index}`).value);
            var intensity = document.getElementById(`future-intensity-${index}`).value || 'TD';
            var radius7 = parseFloat(document.getElementById(`future-radius-7-${index}`).value) || 0;
            var radius10 = parseFloat(document.getElementById(`future-radius-10-${index}`).value) || 0;
            var errorRadius = parseFloat(document.getElementById(`future-error-radius-${index}`).value) || 0;
            var showIcon = document.getElementById(`future-show-icon-${index}`).checked;

            var point = { coords: [lat, lng], radius7: radius7, radius10: radius10, errorRadius: errorRadius, showIcon: showIcon, intensity: intensity };
            futurePath[index] = point;

            if (showIcon) {
                var marker = addMarker(lat, lng, intensity);
                if (futureMarkers[index] && futureMarkers[index].marker) {
                    map.removeLayer(futureMarkers[index].marker);
                }
                futureMarkers[index] = { marker: marker, circle7: null, circle10: null };
            } else {
                if (futureMarkers[index] && futureMarkers[index].marker) {
                    map.removeLayer(futureMarkers[index].marker);
                }
                delete futureMarkers[index];
            }

            // Remove previous circles and add new ones
            removeCircle(lat, lng, radius7);
            removeCircle(lat, lng, radius10);
            removeCircle(lat, lng, errorRadius);

            addCircle(lat, lng, radius7, 'yellow', 'dashed', radius7 > 0);
            addCircle(lat, lng, radius10, 'red', 'dashed', radius10 > 0);
            addCircle(lat, lng, errorRadius, 'blue', 'dashed', errorRadius > 0); // Display error radius circle

            redrawPaths();
        }

        // Remove future point
        function removeFuturePoint(index) {
            delete futurePath[index];

            if (futureMarkers[index] && futureMarkers[index].marker) {
                map.removeLayer(futureMarkers[index].marker);
            }
            delete futureMarkers[index];

            redrawPaths();
        }

        // Generate inputs for future points
        function generateFutureInputs() {
            var futurePointsDiv = document.getElementById('future-points');
            var index = futurePath.length;

            var div = document.createElement('div');
            div.id = `future-point-${index}`;
            div.className = 'point-item';

            div.innerHTML = `
                <label>緯度：</label>
                <input type="number" step="0.000001" id="future-latitude-${index}" required>
                <label>經度：</label>
                <input type="number" step="0.000001" id="future-longitude-${index}" required>
                <label>強度：</label>
                <select id="future-intensity-${index}">
                    <option value="TD">熱帶低壓</option>
                    <option value="TS">熱帶風暴</option>
                    <option value="TY">颱風</option>
                    <option value="STY">強颱</option>
                    <option value="SUPER">超強颱</option>
                </select>
                <label>半徑7：</label>
                <input type="number" step="0.1" id="future-radius-7-${index}">
                <label>半徑10：</label>
                <input type="number" step="0.1" id="future-radius-10-${index}">
                <label>誤差半徑：</label>
                <input type="number" step="0.1" id="future-error-radius-${index}">
                <label>顯示圖示：</label>
                <input type="checkbox" id="future-show-icon-${index}" checked>
                <button type="button" onclick="addFuturePoint(${index})">添加</button>
                <button type="button" onclick="updateFuturePoint(${index})">更新</button>
                <button type="button" onclick="removeFuturePoint(${index})">刪除</button>
            `;

            futurePointsDiv.appendChild(div);
        }

        // Helper functions to add/remove markers and circles
        function addMarker(lat, lng, intensity) {
            var markerColor = 'black';
            switch (intensity) {
                case 'TS':
                    markerColor = 'blue';
                    break;
                case 'TY':
                    markerColor = 'orange';
                    break;
                case 'STY':
                    markerColor = 'red';
                    break;
                case 'SUPER':
                    markerColor = 'purple';
                    break;
                default:
                    markerColor = 'black';
                    break;
            }

            var markerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color:${markerColor};" class="marker-pin"></div><span class="marker-label">${intensity}</span>`
            });

            var marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);
            return marker;
        }

        function addCircle(lat, lng, radius, color, dashArray, show) {
            if (show && radius > 0) {
                var circle = L.circle([lat, lng], {
                    color: color,
                    fillColor: 'none',
                    fillOpacity: 0.5,
                    radius: radius * 1000,
                    dashArray: dashArray,
                }).addTo(map);
                return circle;
            }
            return null;
        }

        function removeCircle(lat, lng, radius) {
            if (radius > 0) {
                map.eachLayer(function (layer) {
                    if (layer instanceof L.Circle) {
                        var layerLatLng = layer.getLatLng();
                        if (layerLatLng.lat === lat && layerLatLng.lng === lng && layer.getRadius() === radius * 1000) {
                            map.removeLayer(layer);
                        }
                    }
                });
            }
        }

        // Redraw past and future paths
        function redrawPaths() {
            // Remove previous paths
            map.eachLayer(function (layer) {
                if (layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Draw past path
            if (pastPath.length > 0) {
                var pastPolyline = L.polyline(pastPath, { color: 'gray' }).addTo(map);
                map.fitBounds(pastPolyline.getBounds());
            }

            // Draw future path
            var futureCoords = futurePath.map(point => point.coords);
            if (futureCoords.length > 1) {
                var futurePolyline = L.polyline(futureCoords, { color: 'blue' }).addTo(map);
                map.fitBounds(futurePolyline.getBounds());
            }
        }
    </script>
</body>
</html>
