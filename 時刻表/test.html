<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°éµè¨‚ç¥¨ç³»çµ± Pro</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --font-main: 'Inter', 'Noto Sans TC', sans-serif;
      --radius: 12px;
      --transition: 0.2s ease;
      
      /* Colors */
      --bg-body: #f0f2f5;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode {
      --bg-body: #111827;
      --bg-card: #1f2937;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border: #374151;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: var(--font-main);
      background: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 0.3s, color 0.3s;
    }

    /* Navbar */
    .navbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0.8rem 1.5rem;
      position: sticky; top: 0; z-index: 50;
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .nav-tabs { display: flex; gap: 4px; background: var(--bg-body); padding: 4px; border-radius: 8px; }
    .nav-tab {
      padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;
      color: var(--text-muted); transition: var(--transition);
    }
    .nav-tab.active { background: var(--bg-card); color: var(--primary); font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    .theme-btn {
      background: transparent; border: 1px solid var(--border); color: var(--text-main);
      padding: 6px 12px; border-radius: 8px; cursor: pointer;
    }

    /* Layout */
    .container { max-width: 1100px; margin: 20px auto; padding: 0 16px; flex: 1; }
    .grid-layout { display: grid; grid-template-columns: 320px 1fr; gap: 24px; align-items: start; }
    
    /* Card Styles */
    .card {
      background: var(--bg-card); border-radius: var(--radius);
      box-shadow: var(--shadow); border: 1px solid var(--border);
      padding: 24px;
    }
    .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    
    /* Form Elements */
    .form-group { margin-bottom: 16px; }
    .form-row { display: flex; gap: 12px; }
    label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
    
    input, select {
      width: 100%; padding: 10px; border-radius: 8px;
      border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main);
      font-size: 0.95rem; outline: none; transition: var(--transition);
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
    
    .radio-group { display: flex; gap: 4px; background: var(--bg-body); padding: 4px; border-radius: 8px; }
    .radio-option { flex: 1; text-align: center; }
    .radio-option input { display: none; }
    .radio-option span {
      display: block; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); transition: var(--transition);
    }
    .radio-option input:checked + span { background: var(--bg-card); color: var(--primary); font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    button.btn-primary {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 12px; border-radius: 8px; font-weight: 600; font-size: 1rem;
      cursor: pointer; transition: var(--transition);
    }
    button.btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

    /* --- Ticket Results (Cards) --- */
    .ticket-list { display: flex; flex-direction: column; gap: 16px; }
    .ticket-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 0; display: flex; transition: var(--transition); position: relative; overflow: hidden; flex-direction: column;
    }
    .ticket-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
    
    .ticket-main { flex: 1; padding: 20px; display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .ticket-action { 
      width: 140px; background: var(--bg-body); border-left: 1px dashed var(--border);
      display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px;
    }

    .t-info { display: flex; flex-direction: column; gap: 4px; }
    .t-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .t-no { font-weight: 800; font-size: 1.1rem; color: var(--primary); }
    .t-route { font-size: 0.9rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
    
    .t-times { display: flex; align-items: center; gap: 15px; margin-top: 8px; }
    .t-time { font-size: 1.4rem; font-weight: 800; color: var(--text-main); font-family: monospace; letter-spacing: -0.5px; }
    .t-arrow { color: var(--text-muted); font-size: 1.2rem; }
    .t-duration { 
      font-size: 0.85rem; color: var(--text-muted); background: var(--bg-body); 
      padding: 2px 8px; border-radius: 4px; margin-left: 10px; font-weight: 500;
    }

    .t-tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .tag-fast { background: #dcfce7; color: #166534; }
    .tag-rec { background: #fff7ed; color: #9a3412; }

    /* Utilization Bar */
    .util-container { width: 100%; margin-bottom: 10px; }
    .util-label { font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .util-bar-bg { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
    .util-bar-fill { height: 100%; border-radius: 3px; }

    /* --- Availability List (é¤˜ç¥¨æŸ¥è©¢) --- */
    .avail-row {
      padding: 15px 20px; border-top: 1px solid var(--border); background: var(--bg-body);
      overflow-x: auto; display: flex; gap: 10px; align-items: center;
    }
    .avail-title { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); white-space: nowrap; margin-right: 10px; }
    
    .avail-item {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px;
      padding: 6px 12px; display: flex; align-items: center; gap: 8px; white-space: nowrap;
      cursor: pointer; transition: var(--transition);
    }
    .avail-item:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    /* ä¿®æ­£ï¼šç„¡ç¥¨æ™‚æ¨£å¼ */
    .avail-item.disabled { opacity: 0.6; cursor: not-allowed; border-color: transparent; background: rgba(0,0,0,0.05); }
    .avail-item.disabled:hover { transform: none; box-shadow: none; }
    
    .av-st { font-size: 0.9rem; font-weight: 600; }
    .av-status { font-size: 0.9rem; font-weight: 800; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; color: #fff; }
    
    .status-o { background: var(--success); } /* O */
    .status-t { background: var(--accent); }  /* Triangle */
    .status-x { background: var(--danger); }  /* X */

    /* --- My Tickets (Wallet Style) --- */
    .wallet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
    .my-ticket {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
      position: relative; overflow: hidden; box-shadow: var(--shadow);
      display: flex; flex-direction: column;
    }
    .mt-top {
      background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
      padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center;
    }
    .mt-top h3 { margin: 0; font-size: 1.1rem; }
    .mt-code { font-family: monospace; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; }
    .mt-body { padding: 20px; }
    .mt-route { font-size: 1.2rem; font-weight: 800; display: flex; justify-content: space-between; margin-bottom: 10px; }
    .mt-time-row { display: flex; justify-content: space-between; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 15px; }
    .mt-seats { background: var(--bg-body); padding: 10px; border-radius: 8px; font-size: 0.9rem; font-weight: 500; color: var(--text-main); }
    .mt-actions { padding: 10px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; }
    .btn-danger-ghost { background: transparent; color: var(--danger); border: none; font-size: 0.85rem; font-weight: 600; cursor: pointer; }

    /* Badge Styles */
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: #fff; background: #6b7280; margin-right: 5px; }
    .badge.zq { background: #ef4444; } .badge.pym { background: #db2777; } .badge.xzq { background: #8b5cf6; }

    /* Modal */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1000;
      justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
    }
    .modal.show { opacity: 1; }
    .modal-content {
      background: var(--bg-card); padding: 30px; border-radius: 16px; width: 90%; max-width: 400px;
      transform: translateY(20px); transition: transform 0.3s; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .modal.show .modal-content { transform: translateY(0); }

    /* Toast */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: var(--bg-card); color: var(--text-main); padding: 12px 20px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid var(--primary);
      transform: translateX(100%); transition: transform 0.3s; font-weight: 500;
    }
    .toast.show { transform: translateX(0); }
    .toast.error { border-left-color: var(--danger); }
    .toast.success { border-left-color: var(--success); }

    @media (max-width: 768px) {
      .grid-layout { grid-template-columns: 1fr; }
      .ticket-main { flex-direction: column; align-items: flex-start; }
      .ticket-action { width: 100%; border-left: none; border-top: 1px dashed var(--border); flex-direction: row; justify-content: space-between; }
      .util-container { width: 60%; margin-bottom: 0; }
      .ticket-right { width: 100%; margin-top: 10px; }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="brand">ğŸš„ å°éµè¨‚ç¥¨ç³»çµ± Pro+</div>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('booking')">ç·šä¸Šè¨‚ç¥¨</div>
    <div class="nav-tab" onclick="switchTab('availability')">é¤˜ç¥¨æŸ¥è©¢</div>
    <div class="nav-tab" onclick="switchTab('wallet')">æˆ‘çš„è»Šç¥¨</div>
  </div>
  <button class="theme-btn" onclick="toggleDarkMode()">â—‘</button>
</nav>

<div class="container">
  
  <div id="view-booking" class="grid-layout">
    <div class="card">
      <h2 class="section-title">è¡Œç¨‹æœå°‹</h2>
      <form id="booking-form">
        <div class="form-row">
          <div class="form-group" style="flex:1">
            <label>å‡ºç™¼ç«™</label>
            <select id="departure-station" required></select>
          </div>
          <div class="form-group" style="flex:1">
            <label>æŠµé”ç«™</label>
            <select id="arrival-station" required></select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="flex:1">
            <label>æ—¥æœŸ</label>
            <input type="date" id="date" required />
          </div>
          <div class="form-group" style="width: 80px;">
            <label>å¼µæ•¸</label>
            <input type="number" id="ticket-quantity" min="1" max="6" value="1" required />
          </div>
        </div>

        <div class="form-group">
          <label>æŸ¥è©¢æ–¹å¼</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="booking-method" value="train-number" checked>
              <span>ä¾è»Šæ¬¡</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="booking-method" value="time-slot">
              <span>ä¾æ™‚æ®µ</span>
            </label>
          </div>
        </div>

        <div id="train-number-section">
          <div class="form-group">
            <label>è»Šæ¬¡è™Ÿç¢¼</label>
            <input type="text" id="train-number" placeholder="ä¾‹å¦‚: 408" />
          </div>
        </div>

        <div id="time-slot-section" style="display:none">
          <div class="form-row">
            <div class="form-group" style="flex:1">
              <label>èµ·å§‹æ™‚é–“</label>
              <input type="time" id="start-time" value="06:00" />
            </div>
            <div class="form-group" style="flex:1">
              <label>çµæŸæ™‚é–“</label>
              <input type="time" id="end-time" value="23:59" />
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary">ğŸ” æŸ¥è©¢åˆ—è»Š</button>
      </form>
    </div>

    <div class="ticket-list" id="results-list">
      <div style="text-align:center; padding: 60px; color: var(--text-muted);">
        <div style="font-size:3rem; margin-bottom:10px">ğŸ«</div>
        è«‹è¼¸å…¥å·¦å´è¡Œç¨‹è³‡è¨Šé€²è¡ŒæŸ¥è©¢
      </div>
    </div>
  </div>

  <div id="view-availability" class="hidden" style="display:none">
    <div class="card" style="margin-bottom:20px">
      <h2 class="section-title">é¤˜ç¥¨æŸ¥è©¢ (å„ç«™ç‹€æ…‹)</h2>
      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label>å‡ºç™¼ç«™</label>
          <select id="av-departure" onchange="updateAvResults()"></select>
        </div>
        <div class="form-group" style="flex:1">
          <label>æŠµé”ç«™ (å€é–“çµ‚é»)</label>
          <select id="av-arrival" onchange="updateAvResults()"></select>
        </div>
        <div class="form-group">
          <label>æ—¥æœŸ</label>
          <input type="date" id="av-date" value="" onchange="updateAvResults()">
        </div>
      </div>
      <p style="color:var(--text-muted); font-size:0.9rem">ğŸ’¡ ç¬¦è™Ÿèªªæ˜ï¼š <span style="color:var(--success)">â—</span> åº§ä½å……è£• <span style="color:var(--accent)">â–²</span> åº§ä½ç·Šå¼µ <span style="color:var(--danger)">âœ–</span> å·²ç„¡åº§ä½</p>
    </div>
    
    <div class="ticket-list" id="av-results-list"></div>
  </div>

  <div id="view-wallet" style="display:none">
    <h2 class="section-title">æˆ‘çš„è»Šç¥¨å¤¾</h2>
    <div id="wallet-list" class="wallet-grid"></div>
  </div>

</div>

<div id="seatModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-bottom:15px; color:var(--text-main)">åº§ä½åå¥½è¨­å®š</h3>
    <p id="modal-train-info" style="color:var(--text-muted); margin-bottom:20px; font-size:0.9rem"></p>
    
    <div class="form-group">
      <label>åº§ä½ä½ç½®</label>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="seat-pref" value="window" checked>
          <span>é çª—</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="seat-pref" value="aisle">
          <span>èµ°é“</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="seat-pref" value="any">
          <span>ä¸æ‹˜</span>
        </label>
      </div>
    </div>

    <button class="btn-primary" onclick="processBooking()">ç¢ºèªè¨‚ç¥¨</button>
    <button style="width:100%; margin-top:10px; background:transparent; border:none; color:var(--text-muted); cursor:pointer; padding:10px" onclick="closeModal()">å–æ¶ˆ</button>
  </div>
</div>

<div id="successModal" class="modal">
  <div class="modal-content" style="text-align:center">
    <div style="font-size:3rem; margin-bottom:10px">ğŸ‰</div>
    <h3 style="color:var(--text-main)">è¨‚ç¥¨æˆåŠŸï¼</h3>
    <p style="color:var(--text-muted); margin: 10px 0 20px;">è»Šç¥¨å·²å­˜å…¥æ‚¨çš„ç¥¨å¤¾ã€‚</p>
    <div id="success-ticket-preview" style="background:var(--bg-body); padding:15px; border-radius:8px; margin-bottom:20px; text-align:left; font-size:0.9rem; border-left: 4px solid var(--success);">
      </div>
    <button class="btn-primary" onclick="closeSuccessModal()">å‰å¾€æŸ¥çœ‹è»Šç¥¨</button>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script src="train-schedule.js"></script>

<script>
  /***** 1. æ ¸å¿ƒé‚è¼¯ (ä¿ç•™ä¸è®Š) *****/
  var stationMaxCapacities = {
    'æ–°è‡ªå¼·': 638, 'æ™®æ‚ ç‘ª': 406, 'è‡ªå¼·è™Ÿ(æ–°)': 906, 'è‡ªå¼·è™Ÿ': 866,
    'è’å…‰è™Ÿ': 1000, 'å¾©èˆˆè™Ÿ': 1000, 'å€é–“å¿«': 1700, 'å€é–“è»Š': 1700, 'åŠ ç­è»Š': 638
  };
  var popularityWeights = {
    'æ™®æ‚ ç‘ª': 2.35, 'æ–°è‡ªå¼·': 2.2, 'åŠ ç­è»Š': 2.4, 'è‡ªå¼·è™Ÿ(æ–°)': 4.3,
    'è‡ªå¼·è™Ÿ': 3.2, 'è’å…‰è™Ÿ': 3.0, 'å¾©èˆˆè™Ÿ': 3.35, 'å€é–“å¿«': 5.85, 'å€é–“è»Š': 5.65
  };
  var timeWeights = {
    'short_peak': 4.0, 'short_offpeak': 2.0, 'long_peak': 6.0, 'long_offpeak': 2.0
  };
  var stationDensity = {
    'åŸºéš†': 110, 'å—æ¸¯': 110, 'æ¾å±±': 120, 'è‡ºåŒ—': 130, 'è¬è¯': 130, 'æ¿æ©‹': 135,
    'æ¡ƒåœ’': 140, 'ä¸­å£¢': 140, 'æ–°ç«¹': 140, 'è‹—æ —': 60, 'è±åŸ': 110, 'è‡ºä¸­': 160,
    'å½°åŒ–': 100, 'å“¡æ—': 90, 'æ–—å…­': 70, 'å˜‰ç¾©': 130, 'æ–°ç‡Ÿ': 80, 'è‡ºå—': 135,
    'æ–°å·¦ç‡Ÿ': 120, 'é«˜é›„': 150, 'é³³å±±': 95, 'å±æ±': 70, 'æ½®å·': 70, 'å®œè˜­': 110,
    'ç¾…æ±': 110, 'èŠ±è“®': 150, 'ç‰é‡Œ': 100, 'è‡ºæ±': 150,
  };

  function normalizeStationName(name) { return name; }

  function calculateTimeWeight(time) {
    var hour = parseInt(time.split(':')[0], 10);
    if ((hour >= 6 && hour < 9.5) || (hour >= 12 && hour < 13) ||
        (hour >= 16 && hour < 20) || (hour >= 21 && hour < 22)) return timeWeights['short_peak'];
    if ((hour >= 6.5 && hour < 10) || (hour >= 16 && hour < 20.5) ||
        (hour >= 0.5 && hour < 4.5)) return timeWeights['long_peak'];
    return timeWeights['short_offpeak'];
  }

  function getRandomFactor(trainType) {
    if (['æ™®æ‚ ç‘ª', 'æ–°è‡ªå¼·', 'è‡ªå¼·è™Ÿ', 'è‡ªå¼·è™Ÿ(æ–°)', 'è’å…‰è™Ÿ'].includes(trainType)) {
      return (Math.random() * 0.15) - 0.1;
    } else {
      return (Math.random() * 0.22) - 0.1;
    }
  }

  function calculateStationUtilizationRate(train, station, time) {
    var maxCapacityPerTrain = stationMaxCapacities[train['è»Šç¨®']] || 110; 
    var popularityWeight = popularityWeights[train['è»Šç¨®']] || 1;
    var timeWeight = calculateTimeWeight(time);
    var baseDensity = stationDensity[station] || 50;
    var load = 0;
    for (var i = 0; i < 3; i++) {
      load += baseDensity * timeWeight * popularityWeight * (1 + getRandomFactor(train['è»Šç¨®']));
    }
    var averageLoad = load / 3;
    var utilizationRate = Math.min(Math.max((averageLoad / maxCapacityPerTrain) * 50, 0), 100);
    return utilizationRate.toFixed(2) + '%';
  }

  function getStopTime(train, station) {
    const stop = train['è»Šç«™æ™‚é–“'].find(s => normalizeStationName(s[0]) === station);
    return stop ? stop[1] : '';
  }

  function isAvailable(train, departure, arrival, quantity) {
    const stops = train['è»Šç«™æ™‚é–“'];
    const departureStop = stops.find(stop => normalizeStationName(stop[0]) === departure);
    const arrivalStop = stops.find(stop => normalizeStationName(stop[0]) === arrival);
    if (!departureStop || !arrivalStop) return false;
    const departureTime = departureStop[1];
    const utilizationRate = calculateStationUtilizationRate(train, departure, departureTime);
    const utilizationValue = parseFloat(utilizationRate.replace('%', ''));
    const maxCapacity = stationMaxCapacities[train['è»Šç¨®']] || 110;
    const extraLoad = (quantity / maxCapacity) * 100;
    return (utilizationValue + extraLoad) <= 100;
  }

  /***** 2. UI äº’å‹•èˆ‡è¼”åŠ©å‡½å¼ *****/
  function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
  document.getElementById('date').valueAsDate = new Date();
  document.getElementById('av-date').valueAsDate = new Date();

  // è¼‰å…¥è»Šç«™
  const depSel = document.getElementById('departure-station');
  const arrSel = document.getElementById('arrival-station');
  const avDepSel = document.getElementById('av-departure');
  const avArrSel = document.getElementById('av-arrival');

  if(typeof stations !== 'undefined') {
    stations.forEach(s => {
      depSel.add(new Option(s, s));
      arrSel.add(new Option(s, s));
      avDepSel.add(new Option(s, s));
      avArrSel.add(new Option(s, s));
    });
    if(stations.includes('è‡ºåŒ—')) { depSel.value='è‡ºåŒ—'; avDepSel.value='è‡ºåŒ—'; }
    if(stations.includes('é«˜é›„')) { arrSel.value='é«˜é›„'; avArrSel.value='é«˜é›„'; }
  }

  // åˆ†é åˆ‡æ›
  function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    // active state needs index finding or just manual setting
    const tabs = ['booking', 'availability', 'wallet'];
    document.querySelectorAll('.nav-tab')[tabs.indexOf(tab)].classList.add('active');
    
    document.getElementById('view-booking').style.display = tab==='booking'?'grid':'none';
    document.getElementById('view-availability').style.display = tab==='availability'?'block':'none';
    document.getElementById('view-wallet').style.display = tab==='wallet'?'block':'none';
    
    if(tab === 'wallet') renderWallet();
    if(tab === 'availability') updateAvResults();
  }

  // è¡¨å–®åˆ‡æ›
  const form = document.getElementById('booking-form');
  form.addEventListener('change', e => {
    if(e.target.name === 'booking-method') {
      const isNum = e.target.value === 'train-number';
      document.getElementById('train-number-section').style.display = isNum ? 'block' : 'none';
      document.getElementById('time-slot-section').style.display = isNum ? 'none' : 'block';
    }
  });

  function getDurationMinutes(t1, t2) {
    const [h1, m1] = t1.split(':').map(Number);
    const [h2, m2] = t2.split(':').map(Number);
    let min1 = h1*60 + m1;
    let min2 = h2*60 + m2;
    if(min2 < min1) min2 += 1440;
    return min2 - min1;
  }
  function formatDuration(minutes) {
    const h = Math.floor(minutes/60);
    const m = minutes%60;
    return h > 0 ? `${h}å°æ™‚${m}åˆ†` : `${m}åˆ†`;
  }

  // æ¸²æŸ“æœå°‹çµæœ
  function renderResults(list, dept, arrv) {
    const container = document.getElementById('results-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åˆ—è»Š</div>';
      return;
    }

    const minDuration = Math.min(...list.map(i => i.duration));

    list.forEach(item => {
      const { no, data, dTime, aTime, duration, utilVal, utilStr } = item;
      
      let barColor = '#10b981';
      let btnText = 'é è¨‚';
      let btnDisabled = false;
      
      if(utilVal >= 100) { barColor = '#ef4444'; btnText = 'å·²æ»¿'; btnDisabled = true; }
      else if(utilVal > 80) { barColor = '#f59e0b'; }

      let badgeClass = 'qj';
      if (data['è»Šç¨®'].includes('è‡ªå¼·')) badgeClass = 'zq';
      if (data['è»Šç¨®'].includes('æ™®æ‚ ç‘ª')) badgeClass = 'pym';
      if (data['è»Šç¨®'].includes('æ–°è‡ªå¼·')) badgeClass = 'xzq';

      let tagsHtml = '';
      if(duration === minDuration) tagsHtml += `<span class="t-tag tag-fast">âš¡ æœ€å¿«</span> `;
      if(utilVal < 50 && duration <= minDuration + 15) tagsHtml += `<span class="t-tag tag-rec">â˜… æ¨è–¦</span>`;

      const el = document.createElement('div');
      el.className = 'ticket-card';
      el.innerHTML = `
        <div class="ticket-main" style="flex-direction:row">
          <div class="t-info">
            <div class="t-header">
              <span class="badge ${badgeClass}">${data['è»Šç¨®']}</span>
              <span class="t-no">${no} æ¬¡</span>
              ${tagsHtml}
            </div>
            <div class="t-times">
              <div class="t-time">${dTime}</div>
              <div class="t-arrow">â</div>
              <div class="t-time">${aTime}</div>
              <div class="t-duration">${formatDuration(duration)}</div>
            </div>
            <div class="t-route">${dept} åˆ° ${arrv}</div>
          </div>
          <div class="ticket-action">
            <div class="util-container">
              <div class="util-label">
                <span>åº§ä½é‹ç”¨ç‡</span>
                <span>${utilVal.toFixed(0)}%</span>
              </div>
              <div class="util-bar-bg">
                <div class="util-bar-fill" style="width:${Math.min(utilVal, 100)}%; background:${barColor}"></div>
              </div>
            </div>
            <button class="btn-primary" style="width:100%; padding:8px; opacity:${btnDisabled?0.5:1}" 
              onclick="openBookingModal('${no}', '${data['è»Šç¨®']}', '${dept}', '${arrv}', '${dTime}', '${aTime}')">
              ${btnText}
            </button>
          </div>
        </div>
      `;
      container.appendChild(el);
    });
  }

  // æœå°‹æŒ‰éˆ•
  form.onsubmit = (e) => {
    e.preventDefault();
    const dept = depSel.value;
    const arrv = arrSel.value;
    if(dept === arrv) { showToast('å‡ºç™¼èˆ‡æŠµé”ç«™ä¸èƒ½ç›¸åŒ', 'error'); return; }

    const method = document.querySelector('input[name="booking-method"]:checked').value;
    let results = [];

    if(method === 'train-number') {
      const no = document.getElementById('train-number').value.trim();
      if(trainSchedule[no]) {
        const train = trainSchedule[no];
        const stops = train['è»Šç«™æ™‚é–“'];
        const departureStop = stops.find(stop => normalizeStationName(stop[0]) === dept);
        const arrivalStop = stops.find(stop => normalizeStationName(stop[0]) === arrv);

        if(departureStop && arrivalStop && stops.indexOf(departureStop) < stops.indexOf(arrivalStop)) {
           const depTime = departureStop[1];
           const arrTime = arrivalStop[1];
           const utilStr = calculateStationUtilizationRate(train, dept, depTime);
           const utilVal = parseFloat(utilStr.replace('%', ''));
           results.push({ no, data: train, dTime: depTime, aTime: arrTime, duration: getDurationMinutes(depTime, arrTime), utilVal, utilStr });
        }
      }
    } else {
      const tStart = document.getElementById('start-time').value;
      const tEnd = document.getElementById('end-time').value;
      
      Object.keys(trainSchedule).forEach(no => {
        const train = trainSchedule[no];
        if(['å€é–“è»Š','å€é–“å¿«'].includes(train['è»Šç¨®'])) return;
        const stops = train['è»Šç«™æ™‚é–“'];
        const departureStop = stops.find(stop => normalizeStationName(stop[0]) === dept);
        if (!departureStop) return;
        const depTime = departureStop[1];
        if(depTime >= tStart && depTime <= tEnd) {
           const arrivalStop = stops.find(stop => normalizeStationName(stop[0]) === arrv);
           if(arrivalStop && stops.indexOf(departureStop) < stops.indexOf(arrivalStop)) {
             const arrTime = arrivalStop[1];
             const utilStr = calculateStationUtilizationRate(train, dept, depTime);
             const utilVal = parseFloat(utilStr.replace('%', ''));
             results.push({ no, data: train, dTime: depTime, aTime: arrTime, duration: getDurationMinutes(depTime, arrTime), utilVal, utilStr });
           }
        }
      });
      results.sort((a,b) => a.dTime.localeCompare(b.dTime));
    }
    renderResults(results, dept, arrv);
  };

  // === NEW: Availability View ===
  function updateAvResults() {
    const dept = avDepSel.value;
    const arrv = avArrSel.value;
    const list = document.getElementById('av-results-list');
    list.innerHTML = '';

    if(dept === arrv) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">è«‹é¸æ“‡ä¸åŒçš„èµ·è¨–ç«™</div>';
        return;
    }

    const results = [];
    Object.keys(trainSchedule).forEach(no => {
        const train = trainSchedule[no];
        if(['å€é–“è»Š','å€é–“å¿«'].includes(train['è»Šç¨®'])) return;
        
        const stops = train['è»Šç«™æ™‚é–“'];
        const sIdx = stops.findIndex(s => s[0] === dept);
        const eIdx = stops.findIndex(s => s[0] === arrv);

        if(sIdx !== -1 && eIdx !== -1 && sIdx < eIdx) {
            const segmentStatuses = [];
            for(let i = sIdx + 1; i <= eIdx; i++) {
                const stopName = stops[i][0];
                const stopTime = stops[i][1];
                
                // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šæª¢æŸ¥æ˜¯å¦æœ‰ä½ â˜…â˜…â˜…
                const hasSeat = isAvailable(train, dept, stopName, 1);
                
                // Visual util for color (optional)
                const utilStr = calculateStationUtilizationRate(train, dept, stops[sIdx][1]); 
                const utilVal = parseFloat(utilStr.replace('%', ''));
                const variance = (Math.random() * 20) - 10; 
                let finalUtil = utilVal + variance;
                finalUtil = Math.max(0, Math.min(100, finalUtil));

                let status = 'o';
                if(!hasSeat) status = 'x'; // å„ªå…ˆä½¿ç”¨ isAvailable åˆ¤æ–·
                else if(finalUtil > 90) status = 'x'; 
                else if(finalUtil > 60) status = 't';

                segmentStatuses.push({ name: stopName, status: status, time: stopTime });
            }
            results.push({ no, data: train, dTime: stops[sIdx][1], segments: segmentStatuses });
        }
    });

    results.sort((a,b) => a.dTime.localeCompare(b.dTime));

    results.forEach(r => {
        const el = document.createElement('div');
        el.className = 'ticket-card';
        el.style.flexDirection = 'column';
        el.style.alignItems = 'flex-start';
        
        let badgeClass = 'qj';
        if (r.data['è»Šç¨®'].includes('è‡ªå¼·')) badgeClass = 'zq';
        if (r.data['è»Šç¨®'].includes('æ™®æ‚ ç‘ª')) badgeClass = 'pym';
        
        // Segments HTML
        let segHtml = r.segments.map(s => {
            const icon = s.status === 'o' ? 'â—' : (s.status === 't' ? 'â–²' : 'âœ–');
            const cls = `status-${s.status}`;
            const disabledClass = s.status === 'x' ? 'disabled' : '';
            return `
                <div class="avail-item ${disabledClass}" onclick="openBookingModal('${r.no}', '${r.data['è»Šç¨®']}', '${dept}', '${s.name}', '${r.dTime}', '${s.time}')">
                    <span class="av-st">${s.name}</span>
                    <span class="av-status ${cls}">${icon}</span>
                </div>
            `;
        }).join('');

        el.innerHTML = `
            <div style="padding:15px 20px; width:100%; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:700; font-size:1.1rem; color:var(--primary)">
                    <span class="badge ${badgeClass}">${r.data['è»Šç¨®']}</span> ${r.no} æ¬¡
                </div>
                <div style="font-weight:700; font-family:monospace; font-size:1.2rem;">${r.dTime} å‡ºç™¼</div>
            </div>
            <div class="avail-row" style="width:100%">
                <div class="avail-title">åˆ°å„ç«™é¤˜ç¥¨ï¼š</div>
                ${segHtml}
            </div>
        `;
        list.appendChild(el);
    });
  }

  // === 3. è¨‚ç¥¨æµç¨‹ ===
  let pendingBooking = null;

  function openBookingModal(no, type, dept, arrv, dTime, aTime) {
    const qty = 1; // é è¨­æª¢æŸ¥1å¼µ
    const train = trainSchedule[no];
    
    // â˜…â˜…â˜… æ–°å¢æª¢æŸ¥ï¼šé»æ“Šæ™‚å†æ¬¡ç¢ºèªæ˜¯å¦æœ‰ä½ â˜…â˜…â˜…
    if(!isAvailable(train, dept, arrv, qty)) {
      showToast('å¾ˆæŠ±æ­‰ï¼Œè©²å€é–“å·²ç„¡é¤˜ç¥¨ (åº§ä½å·²æ»¿)', 'error');
      return;
    }

    pendingBooking = { no, type, dept, arrv, dTime, aTime, qty };
    document.getElementById('modal-train-info').innerText = `${type} ${no}æ¬¡ ï½œ ${dept} ${dTime} â ${arrv} ${aTime}`;
    const modal = document.getElementById('seatModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
  }

  function closeModal() {
    const modal = document.getElementById('seatModal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
    pendingBooking = null;
  }

  function processBooking() {
    if(!pendingBooking) return;
    
    // å¦‚æœæ˜¯å¾ä¸»é é€²ä¾†ï¼Œé€™è£¡æœƒæŠ“åˆ° quantityï¼›å¦‚æœæ˜¯é¤˜ç¥¨é ï¼Œå°±æ˜¯ 1
    const formQty = parseInt(document.getElementById('ticket-quantity').value);
    const qty = pendingBooking.qty > 1 ? pendingBooking.qty : (formQty || 1);

    const pref = document.querySelector('input[name="seat-pref"]:checked').value;
    const seats = [];
    for(let i=0; i<qty; i++) {
      const car = Math.floor(Math.random()*8)+1;
      const seatNum = Math.floor(Math.random()*50)+1;
      const pos = pref==='window' ? 'é çª—' : (pref==='aisle'?'èµ°é“':'');
      seats.push(`${car}è»Š ${seatNum}è™Ÿ ${pos}`);
    }

    const ticket = {
      id: Date.now(),
      ...pendingBooking,
      qty: qty,
      date: document.getElementById('date').value,
      seats: seats,
      code: Math.floor(Math.random()*900000)+100000
    };

    const wallet = JSON.parse(localStorage.getItem('myTickets') || '[]');
    wallet.push(ticket);
    localStorage.setItem('myTickets', JSON.stringify(wallet));

    closeModal();
    
    document.getElementById('success-ticket-preview').innerHTML = `
      <div style="font-size:1.1rem; font-weight:bold; margin-bottom:5px">${ticket.date}</div>
      <div>${ticket.no}æ¬¡ ${ticket.type}</div>
      <div style="margin:5px 0; color:var(--primary); font-weight:bold;">${ticket.dept} ${ticket.dTime} â ${ticket.arrv} ${ticket.aTime}</div>
      <div>å¼µæ•¸ï¼š${qty} å¼µ</div>
      <div style="margin-top:5px; font-family:monospace; background:rgba(0,0,0,0.05); padding:4px;">è¨‚ä½ä»£ç¢¼ï¼š${ticket.code}</div>
    `;
    const sm = document.getElementById('successModal');
    sm.style.display = 'flex';
    setTimeout(() => sm.classList.add('show'), 10);
  }

  function closeSuccessModal() {
    const sm = document.getElementById('successModal');
    sm.classList.remove('show');
    setTimeout(() => sm.style.display = 'none', 300);
    switchTab('wallet');
  }

  function renderWallet() {
    const container = document.getElementById('wallet-list');
    const wallet = JSON.parse(localStorage.getItem('myTickets') || '[]');
    
    if(wallet.length === 0) {
      container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted)">ç›®å‰æ²’æœ‰æœ‰æ•ˆè»Šç¥¨</div>';
      return;
    }
    wallet.sort((a,b) => b.id - a.id);

    container.innerHTML = wallet.map(t => `
      <div class="my-ticket">
        <div class="mt-top">
          <h3>${t.type} ${t.no}æ¬¡</h3>
          <span class="mt-code">#${t.code}</span>
        </div>
        <div class="mt-body">
          <div class="mt-route">
            <span>${t.dept}</span>
            <span style="color:var(--text-muted); font-size:1rem">â</span>
            <span>${t.arrv}</span>
          </div>
          <div class="mt-time-row">
            <span>${t.date}</span>
            <span>${t.dTime} é–‹ / ${t.aTime} åˆ°</span>
          </div>
          <div class="mt-seats">
            ${t.seats.join('<br>')}
          </div>
        </div>
        <div class="mt-actions">
          <button class="btn-danger-ghost" onclick="removeTicket(${t.id})">é€€ç¥¨</button>
        </div>
      </div>
    `).join('');
  }

  window.removeTicket = function(id) {
    if(!confirm('ç¢ºå®šè¦é€€ç¥¨å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
    let wallet = JSON.parse(localStorage.getItem('myTickets') || '[]');
    wallet = wallet.filter(t => t.id !== id);
    localStorage.setItem('myTickets', JSON.stringify(wallet));
    renderWallet();
    showToast('é€€ç¥¨æˆåŠŸ', 'success');
  }

  function showToast(msg, type='info') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    document.getElementById('toastContainer').appendChild(t);
    setTimeout(() => t.classList.add('show'), 10);
    setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
  }
</script>
</body>
</html>