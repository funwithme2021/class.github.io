<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å°éµåˆ—è»Šæ™‚åˆ»è¡¨æŸ¥è©¢</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* ===== Reset & basics ===== */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      line-height: 1.6;
      background: #f6f8ff;
      color: #333;
      transition: .25s
    }

    /* ===== Color tokens ===== */
    :root {
      --primary: #0460fe;
      --primary-dark: #034ad0;
      --surface: #fff;
      --surface-dark: #1f1f1f;
      --text-dark: #ddd;
      --shadow: 0 4px 12px rgba(0, 0, 0, .08)
    }

    /* prefers-dark */
    @media (prefers-color-scheme: dark) {
      body {
        background: #121212;
        color: var(--text-dark)
      }

      .card {
        background: var(--surface-dark);
        color: var(--text-dark)
      }

      .navbar {
        background: #222
      }

      .navbar .brand,
      .navbar a {
        color: #fff
      }

      .navbar button {
        background: #444
      }

      th {
        background: #303030;
        color: #fff
      }
    }

    /* æ‰‹å‹• dark-mode */
    body.dark-mode {
      background: #121212;
      color: var(--text-dark)
    }

    body.dark-mode .card {
      background: var(--surface-dark);
      color: var(--text-dark)
    }

    body.dark-mode .navbar {
      background: #222
    }

    body.dark-mode .navbar .brand,
    body.dark-mode .navbar a {
      color: #fff
    }

    body.dark-mode .navbar button {
      background: #444
    }

    body.dark-mode th {
      background: #303030;
      color: #fff
    }

    body.dark-mode tr {
      background: #121212
    }

    body.dark-mode tr:hover {
      background: #1e1e1e
    }

    /* ===== Navbar ===== */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .75rem 1rem;
      background: #333;
      box-shadow: var(--shadow)
    }

    .navbar .brand {
      color: #fff;
      font-weight: 700;
      font-size: 1.05rem
    }

    .navbar a {
      color: #fff;
      text-decoration: none;
      font-size: .85rem;
      margin-left: 1rem;
      white-space: nowrap
    }

    .navbar a:hover {
      text-decoration: underline
    }

    .navbar button {
      border: 0;
      border-radius: 4px;
      padding: .35rem .8rem;
      font-size: .75rem;
      background: #444;
      color: #fff;
      cursor: pointer
    }

    .navbar button:hover {
      background: #222
    }

    .hamburger {
      display: none;
      flex-direction: column;
      gap: 4px;
      cursor: pointer
    }

    .hamburger span {
      width: 24px;
      height: 2px;
      background: #fff;
      transition: .3s
    }

    @media (max-width: 767.98px) {
      .navbar a {
        margin-left: 0
      }

      .nav-links {
        position: absolute;
        left: 0;
        top: 100%;
        width: 100%;
        background: #333;
        flex-direction: column;
        max-height: 0;
        overflow: hidden;
        transition: max-height .3s
      }

      .nav-links.open {
        max-height: 320px;
        padding: .5rem 1rem
      }

      .hamburger {
        display: flex
      }
    }

    /* ===== Layout ===== */
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1.25rem
    }

    .grid {
      display: grid;
      gap: 1.25rem
    }

    /* ===== Card ===== */
    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 1rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: .8rem
    }

    .section-title {
      font-weight: 700;
      font-size: 1.05rem;
      border-left: 4px solid #130058;
      padding-left: .6rem
    }

    /* ===== Form ===== */
    label {
      font-size: .85rem;
      font-weight: 600;
      margin-right: .15rem
    }

    input,
    select,
    button {
      font-size: .8rem;
      padding: .42rem .7rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      outline: none;
      transition: .2s
    }

    select {
      appearance: none;
      background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='10' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>") no-repeat right .5rem center/10px
    }

    input:focus,
    select:focus {
      border-color: var(--primary)
    }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer
    }

    button:hover {
      background: var(--primary-dark)
    }

    button:active {
      transform: translateY(1px)
    }

    /* Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 22px;
      margin-left: .4rem;
      margin-right: .6rem;
      vertical-align: middle
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ccc;
      transition: .3s;
      border-radius: 22px
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background: #fff;
      transition: .3s;
      border-radius: 50%
    }

    input:checked+.slider {
      background: var(--primary)
    }

    input:checked+.slider:before {
      transform: translateX(20px)
    }

    /* ===== Table ===== */
    .table-wrapper {
      overflow-x: auto
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .75rem;
      background: var(--surface)
    }

    th,
    td {
      padding: .5rem .7rem;
      border-bottom: 1px solid #e0e0e0;
      white-space: nowrap
    }

    tr:nth-child(even) {
      background: #f9f9f9
    }

    tr:hover {
      background: #ececec;
      cursor: pointer
    }

    body.dark-mode tr:nth-child(even) {
      background: #121212
    }

    @media (max-width: 575.98px) {
      table {
        font-size: .7rem
      }
    }

    /* badges & etc. */
    .badge-sea {
      display: inline-block;
      background: #1e80ff;
      color: #fff;
      font-size: .65rem;
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 2px
    }

    .peak-hour {
      background: #ffe0a0;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700
    }

    body.dark-mode .peak-hour {
      background: #e09f00;
      color: #fff
    }

    .toggle-arrow {
      cursor: pointer;
      font-weight: 700;
      margin-left: .4rem
    }

    /* wait & duration bar */
    .wait-wrapper {
      width: 90px
    }

    .wait-bar,
    .duration-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      position: relative
    }

    .wait-bar-inner,
    .duration-inner {
      height: 100%;
      border-radius: 3px
    }

    .wait-label,
    .duration-label {
      font-size: .66rem;
      text-align: center;
      margin-top: 2px
    }

    .duration-wrapper {
      width: 110px
    }

    .duration-inner {
      background: #2196f3
    }

    /* ===== Modal ===== */
    .modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .55);
      z-index: 1050;
      justify-content: center;
      align-items: center
    }

    .modal-content {
      background: var(--surface);
      border-radius: 10px;
      max-width: 500px;
      width: 95%;
      max-height: 85%;
      overflow-y: auto;
      position: relative;
      padding: 1rem 1.25rem;
      animation: slide .25s ease-out
    }

    @keyframes slide {
      from {
        transform: translateY(-40px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    body.dark-mode .modal-content {
      background: var(--surface-dark);
      color: var(--text-dark)
    }

    .close {
      position: absolute;
      right: 1rem;
      top: .6rem;
      font-size: 1.4rem;
      font-weight: bold;
      color: #666;
      cursor: pointer
    }

    body.dark-mode .close {
      color: #ccc
    }

    .modal-content thead th {
      background: #303030;
      color: #fff
    }

    body.dark-mode .modal-content thead th {
      background: #444;
      color: #fff
    }

    .transfer-tip {
      background: #000;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: .75rem
    }
  </style>
</head>

<body>
  <!-- ===== Navbar ===== -->
  <nav class="navbar">
    <div class="brand">å°éµåˆ—è»Šæ™‚åˆ»è¡¨æŸ¥è©¢</div>
    <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>

    <div class="nav-links" id="navLinks">
      <a href="index-speed.html">é«˜éµæ™‚åˆ»è¡¨</a>
      <a href="index-thsr.html">é«˜éµæ™‚åˆ»è¡¨(å°ˆç”¨)</a>
      <a href="index.html">æ™‚åˆ»è¡¨</a>
      <a href="index.trainrate-2.html">æ™‚åˆ»è¡¨(å«é‹ç”¨)</a>
      <a href="index-tra.transfer.html">è½‰ä¹˜æ™‚åˆ»è¡¨</a>
      <a href="index-tra.easy.html">ç°¡å¼æ™‚åˆ»è¡¨</a>
      <a href="index-tra.type.html">ä¾è»Šç¨®æ™‚åˆ»è¡¨</a>
      <a href="train-info.html">è»Šç«™è³‡è¨Šæ¿</a>
      <a href="people.html">é‹é‡æŸ¥è©¢</a>
      <a href="index.trainrate.html">é‹ç”¨ç‡æŸ¥è©¢</a>
      <a href="index-tra.book.html">è¨‚ç¥¨ç³»çµ±</a>
      <a href="index-tra.make.html">åˆ—è»Šæ’é»</a>
    </div>

    <button onclick="toggleDarkMode()">Dark&nbsp;Mode</button>
  </nav>

  <!-- ===== Main ===== -->
  <main class="container">
    <div class="grid">

      <!-- === å‡ºç™¼ï¼æŠµé”æŸ¥è©¢ === -->
      <section class="card">
        <h2 class="section-title">å‡ºç™¼ç«™ &amp; æŠµé”ç«™æŸ¥è©¢</h2>

        <div style="display:flex;flex-wrap:wrap;gap:.5rem 1rem">
          <label for="startStationSelect">å‡ºç™¼ï¼š</label>
          <select id="startStationSelect"><option disabled selected value="">è«‹é¸æ“‡</option></select>

          <label for="endStationSelect">æŠµé”ï¼š</label>
          <select id="endStationSelect"><option disabled selected value="">è«‹é¸æ“‡</option></select>
        </div>

        <!-- === è»Šç¨®ç¯©é¸ === -->
        <div style="display:flex;flex-wrap:wrap;gap:.25rem 1rem">
          <input type="checkbox" id="ttNew" onclick="toggleTrainTypeFilter('start-end','æ–°è‡ªå¼·')"><label for="ttNew">æ–°è‡ªå¼·</label>
          <input type="checkbox" id="ttPuyuma" onclick="toggleTrainTypeFilter('start-end','æ™®æ‚ ç‘ª')"><label for="ttPuyuma">æ™®æ‚ ç‘ª</label>
          <input type="checkbox" id="ttZN" onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ(æ–°)')"><label for="ttZN">è‡ªå¼·è™Ÿ(æ–°)</label>
          <input type="checkbox" id="ttZ" onclick="toggleTrainTypeFilter('start-end','è‡ªå¼·è™Ÿ')"><label for="ttZ">è‡ªå¼·è™Ÿ</label>
          <input type="checkbox" id="ttJ" onclick="toggleTrainTypeFilter('start-end','è’å…‰è™Ÿ')"><label for="ttJ">è’å…‰è™Ÿ</label>
          <input type="checkbox" id="ttF" onclick="toggleTrainTypeFilter('start-end','å¾©èˆˆè™Ÿ')"><label for="ttF">å¾©èˆˆè™Ÿ</label>
          <input type="checkbox" id="ttQK" onclick="toggleTrainTypeFilter('start-end','å€é–“å¿«')"><label for="ttQK">å€é–“å¿«</label>
          <input type="checkbox" id="ttQC" onclick="toggleTrainTypeFilter('start-end','å€é–“è»Š')"><label for="ttQC">å€é–“è»Š</label>
          <input type="checkbox" id="ttExtra" onclick="toggleTrainTypeFilter('start-end','åŠ ç­è»Š')"><label for="ttExtra">åŠ ç­è»Š</label>
        </div>

        <div style="display:flex;align-items:center;gap:.5rem">
          <label for="acceptTransfers">æ¥å—è½‰ä¹˜</label>
          <label class="switch"><input type="checkbox" id="acceptTransfers"><span class="slider"></span></label>
          <button onclick="filterTrainScheduleByStation()">æŸ¥è©¢</button>
        </div>

        <div class="table-wrapper">
          <table id="scheduleTableByStation">
            <thead><tr id="startEndHeader"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- === è»Šç«™æŸ¥è©¢ === -->
      <section class="card">
        <h2 class="section-title">è»Šç«™æŸ¥è©¢</h2>

        <div style="display:flex;flex-wrap:wrap;gap:.5rem 1rem">
          <label for="stationSelect">è»Šç«™ï¼š</label>
          <select id="stationSelect"><option disabled selected value="">è«‹é¸æ“‡</option></select>

          <label for="directionSelect">æ–¹å‘ï¼š</label>
          <select id="directionSelect">
            <option value="northbound">åŒ—ä¸Š</option>
            <option value="southbound">å—ä¸‹</option>
          </select>
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:.25rem 1rem">
          <input type="checkbox" id="ttNewSt" onclick="toggleTrainTypeFilter('station','æ–°è‡ªå¼·')"><label for="ttNewSt">æ–°è‡ªå¼·</label>
          <input type="checkbox" id="ttPuyumaSt" onclick="toggleTrainTypeFilter('station','æ™®æ‚ ç‘ª')"><label for="ttPuyumaSt">æ™®æ‚ ç‘ª</label>
          <input type="checkbox" id="ttZNSt" onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ(æ–°)')"><label for="ttZNSt">è‡ªå¼·è™Ÿ(æ–°)</label>
          <input type="checkbox" id="ttZSt" onclick="toggleTrainTypeFilter('station','è‡ªå¼·è™Ÿ')"><label for="ttZSt">è‡ªå¼·è™Ÿ</label>
          <input type="checkbox" id="ttJSt" onclick="toggleTrainTypeFilter('station','è’å…‰è™Ÿ')"><label for="ttJSt">è’å…‰è™Ÿ</label>
          <input type="checkbox" id="ttFSt" onclick="toggleTrainTypeFilter('station','å¾©èˆˆè™Ÿ')"><label for="ttFSt">å¾©èˆˆè™Ÿ</label>
          <input type="checkbox" id="ttQKSt" onclick="toggleTrainTypeFilter('station','å€é–“å¿«')"><label for="ttQKSt">å€é–“å¿«</label>
          <input type="checkbox" id="ttQCSt" onclick="toggleTrainTypeFilter('station','å€é–“è»Š')"><label for="ttQCSt">å€é–“è»Š</label>
          <input type="checkbox" id="ttExtraSt" onclick="toggleTrainTypeFilter('station','åŠ ç­è»Š')"><label for="ttExtraSt">åŠ ç­è»Š</label>
          <button onclick="filterTrainScheduleByStationName()">æŸ¥è©¢</button>
        </div>

        <div class="table-wrapper">
          <table id="scheduleTableByStationName">
            <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨®(è¡Œé§›å€é–“)</th><th>æ™‚é–“</th><th>é‹ç”¨ç‡</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- === è»Šæ¬¡æŸ¥è©¢ === -->
      <section class="card">
        <h2 class="section-title">è»Šæ¬¡æŸ¥è©¢</h2>

        <div style="display:flex;flex-wrap:wrap;gap:.4rem">
          <label for="trainNumberInput">è»Šæ¬¡ï¼š</label>
          <input id="trainNumberInput" placeholder="è¼¸å…¥è»Šæ¬¡" oninput="filterTrainNumbers()">
          <select id="trainNumbersDropdown"><option value="" selected>åƒè€ƒè»Šæ¬¡</option></select>
          <button onclick="filterTrainScheduleByNumber()">æŸ¥è©¢</button>
        </div>

        <div class="table-wrapper">
          <table id="scheduleTableByNumber">
            <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨®(è¡Œé§›å€é–“)</th><th>é‹ç”¨ç‡</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <!-- ===== Modal ===== -->
  <div id="trainDetailsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTrainDetailsModal()">&times;</span>
      <h2 id="modalTitle"></h2>
      <div id="transferTip" class="transfer-tip" style="display:none;"></div>
      <div id="modalBody" style="margin-top:.6rem;"></div>
    </div>
  </div>

  <!-- ===== Script ===== -->
  <script src="train-schedule.js"></script>
  <script>
    /* ----------------- åŸºæœ¬ UI è¡Œç‚º ----------------- */
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode')
    }
    document.getElementById('hamburger').addEventListener('click', () => {
      document.getElementById('navLinks').classList.toggle('open')
    });

    /* ----------------- æŠŠç«™åå¡é€²ä¸‰å€‹ select ----------------- */
    var startSel = document.getElementById('startStationSelect');
    var endSel = document.getElementById('endStationSelect');
    var stationSel = document.getElementById('stationSelect');
    stations.forEach(st => {
      startSel.add(new Option(st, st));
      endSel.add(new Option(st, st));
      stationSel.add(new Option(st, st));
    });

    /* ----------------- è»Šç¨®å‹¾é¸ç‹€æ…‹ ----------------- */
    var selectedTrainTypesStartEnd = [];
    var selectedTrainTypesStation = [];
    function toggleTrainTypeFilter(ctx, type) {
      var arr = (ctx === 'start-end') ? selectedTrainTypesStartEnd : selectedTrainTypesStation;
      var idx = arr.indexOf(type);
      idx > -1 ? arr.splice(idx, 1) : arr.push(type);
      if (ctx === 'start-end') filterTrainScheduleByStation();
      else filterTrainScheduleByStationName();
    }

    /* ----------------- å°å·¥å…·å‡½å¼ï¼ˆåŒ…å«é€²åº¦æ¢ï¼‰ ----------------- */
    function highlightPeak(t) {
      if (!t) return t;
      var h = parseInt(t.slice(0, 2), 10);
      return (h >= 7 && h < 9) || (h >= 17 && h < 19) ? '<span class="peak-hour">' + t + '</span>' : t;
    }
    function minuteDiff(a, b) {
      var s = new Date("1970-01-01 " + a), e = new Date("1970-01-01 " + b);
      if (e < s) e.setHours(e.getHours() + 24);
      return Math.round((e - s) / 60000);
    }
    function waitBar(min) {
      var pct = Math.min(min / 90, 1) * 100;
      var color = min <= 10 ? '#2e7d32' : (min > 45 ? '#c62828' : '#f9a825');
      return '<div class="wait-wrapper"><div class="wait-bar"><div class="wait-bar-inner" style="width:' + pct + '%;background:' + color + '"></div></div><div class="wait-label">' +
        Math.floor(min / 60) + 'å°æ™‚' + (min % 60) + 'åˆ†</div></div>';
    }
    function durBar(min, max) {
      return '<div class="duration-wrapper"><div class="duration-bar"><div class="duration-inner" style="width:' + (min / max * 100) + '%"></div></div><div class="duration-label">' +
        Math.floor(min / 60) + 'h' + (min % 60) + 'm</div></div>';
    }
    function colorType(t) {
      var dark = document.body.classList.contains('dark-mode');
      var map = { 'æ–°è‡ªå¼·': '#8600FF', 'æ™®æ‚ ç‘ª': '#FF1493', 'è‡ªå¼·è™Ÿ': 'red', 'è’å…‰è™Ÿ': 'orange', 'å€é–“å¿«': 'green', 'å¾©èˆˆè™Ÿ': '#0080FF', 'å€é–“è»Š': (dark ? '#fff' : '#000'), 'è‡ªå¼·è™Ÿ(æ–°)': 'brown', 'åŠ ç­è»Š': 'teal' };
      return '<span style="color:' + (map[t] || '#333') + '">' + t + '</span>';
    }
    var startEndHeader = document.getElementById('startEndHeader');
    function buildHeader(trans) {
      startEndHeader.innerHTML = '';
      ['è»Šæ¬¡', 'è»Šç¨®(è¡Œé§›å€é–“)', 'å‡ºç™¼'].concat(trans ? ['è½‰ä¹˜ç«™', 'ç­‰å¾…'] : []).concat(['æŠµé”', 'è¡Œé§›']).concat(trans ? ['è½‰ä¹˜'] : ['æ²¿é€”', 'é‹ç”¨ç‡'])
        .forEach(t => startEndHeader.appendChild(Object.assign(document.createElement('th'), { textContent: t })));
    }
    function getDirection(num) { return num % 2 === 0 ? 'northbound' : 'southbound'; }
    function getTime(num, st) {
      var f = trainSchedule[num]['è»Šç«™æ™‚é–“'].find(x => x[0] === st);
      return f ? f[1] : '';
    }

    /* ----------------- å‡ºç™¼ï¼æŠµé”æŸ¥è©¢ ----------------- */
    function filterTrainScheduleByStation() {
      var st = startSel.value.trim();
      var ed = endSel.value.trim();
      if (!st || !ed || st === ed) return;
      var trans = document.getElementById('acceptTransfers').checked;
      buildHeader(trans);
      var tbody = document.querySelector('#scheduleTableByStation tbody');
      tbody.innerHTML = '';

      /* === collect æ‰€æœ‰æ–¹æ¡ˆ === */
      var results = [];

      /* ç›´é” */
      Object.keys(trainSchedule).forEach(num => {
        var t = trainSchedule[num];
        if (selectedTrainTypesStartEnd.length && selectedTrainTypesStartEnd.indexOf(t['è»Šç¨®']) === -1) return;
        var arr = t['è»Šç«™æ™‚é–“'];
        var si = arr.findIndex(x => x[0] === st), ei = arr.findIndex(x => x[0] === ed);
        if (si > -1 && ei > -1 && si < ei) {
          results.push({
            type: 'direct', trainNumber: num, trainType: t['è»Šç¨®'],
            startTime: arr[si][1], endTime: arr[ei][1],
            travelMin: minuteDiff(arr[si][1], arr[ei][1]),
            startStation: st, endStation: ed,
            stopsCount: ei - si - 1,
            usage: '--' /* çœç•¥é‹ç”¨ç‡è¨ˆç®—ä»¥ç²¾ç°¡ */
          });
        }
      });

      /* å…è¨±è½‰ä¹˜ -> æ‰¾ä¸€æ®µ+è½‰ä¸€æ¬¡ */
      if (trans) {
        Object.keys(trainSchedule).forEach(num => {
          var t = trainSchedule[num];
          if (selectedTrainTypesStartEnd.length && selectedTrainTypesStartEnd.indexOf(t['è»Šç¨®']) === -1) return;
          var arr = t['è»Šç«™æ™‚é–“'];
          var si = arr.findIndex(x => x[0] === st);
          if (si === -1) return;
          for (var i = si + 1; i < arr.length; i++) {
            var ts = arr[i][0], reach = arr[i][1];
            Object.keys(trainSchedule).forEach(n2 => {
              var t2 = trainSchedule[n2];
              if (selectedTrainTypesStartEnd.length && selectedTrainTypesStartEnd.indexOf(t2['è»Šç¨®']) === -1) return;
              var a2 = t2['è»Šç«™æ™‚é–“'], si2 = a2.findIndex(x => x[0] === ts), ei2 = a2.findIndex(x => x[0] === ed);
              if (si2 > -1 && ei2 > -1 && si2 < ei2) {
                var dep = a2[si2][1];
                if (new Date("1970-01-01 " + dep) <= new Date("1970-01-01 " + reach)) return;
                var endT = a2[ei2][1];
                var wait = minuteDiff(reach, dep);
                var travel = minuteDiff(arr[si][1], endT);
                results.push({
                  type: 'transfer', trainNumber: num, trainType: t['è»Šç¨®'],
                  startTime: arr[si][1], endTime: endT, travelMin: travel,
                  waitMin: wait,
                  transferStations: [{
                    station: ts, transferTrainNumber: n2, transferTrainType: t2['è»Šç¨®'],
                    transferStartTime: dep
                  }]
                });
              }
            });
          }
        });
      }

      /* render */
      results.sort((a, b) => a.startTime.localeCompare(b.startTime));
      var maxDur = Math.max.apply(Math, results.map(r => r.travelMin));
      results.forEach(r => {
        var tr = tbody.insertRow();
        tr.insertCell().innerHTML = r.trainNumber.includes('A') ? r.trainNumber + '<span class="badge-sea">æµ·ç·š</span>' : r.trainNumber;
        var arrFull = trainSchedule[r.trainNumber]['è»Šç«™æ™‚é–“'];
        tr.insertCell().innerHTML = colorType(r.trainType) + ' (' + arrFull[0][0] + ' â ' + arrFull[arrFull.length - 1][0] + ')';
        tr.insertCell().innerHTML = highlightPeak(r.startTime);

        if (trans) {
          var tInfo = (r.type === 'transfer') ? r.transferStations[0] : null;
          tr.insertCell().innerHTML = tInfo ? tInfo.station + ' (' + highlightPeak(tInfo.transferStartTime) + ')<br>ğŸš‰' + tInfo.transferTrainNumber + ' ' + colorType(tInfo.transferTrainType) : 'â€”';
          tr.insertCell().innerHTML = r.type === 'transfer' ? waitBar(r.waitMin) : 'â€”';
        }

        tr.insertCell().innerHTML = highlightPeak(r.endTime);
        tr.insertCell().innerHTML = durBar(r.travelMin, maxDur);

        if (trans) {
          tr.insertCell().innerHTML = (r.type === 'transfer') ? 'ğŸ”1' : 'ğŸ”0';
        } else {
          if (r.stopsCount > 0) {
            var cell = tr.insertCell();
            cell.innerHTML = r.stopsCount + 'ç«™ <span class="toggle-arrow">â–¼</span>';
          } else tr.insertCell().textContent = 'ç›´é”';
          tr.insertCell().textContent = r.usage;
        }

        tr.onclick = function (r) {
          return function () {
            if (r.type === 'transfer') {
              var t = r.transferStations[0];
              showTrainDetails(r.trainNumber, t.transferTrainNumber, t.station);
            } else showTrainDetails(r.trainNumber);
          }
        }(r);
      });
    }

    /* ----------------- è»Šç«™æŸ¥è©¢ ----------------- */
    function filterTrainScheduleByStationName() {
      var station = stationSel.value.trim();
      if (!station) return;
      var dir = document.getElementById('directionSelect').value;
      var tbody = document.querySelector('#scheduleTableByStationName tbody');
      tbody.innerHTML = '';
      Object.keys(trainSchedule).sort((a, b) => (getTime(a, station) || '99:99').localeCompare(getTime(b, station) || '99:99')).forEach(num => {
        var t = trainSchedule[num];
        if (selectedTrainTypesStation.length && selectedTrainTypesStation.indexOf(t['è»Šç¨®']) === -1) return;
        if (!t['è»Šç«™æ™‚é–“'].some(s => s[0] === station)) return;
        if (getDirection(num) !== dir) return;
        var arr = t['è»Šç«™æ™‚é–“'], idx = arr.findIndex(s => s[0] === station);
        var tr = tbody.insertRow();
        tr.insertCell().innerHTML = num.includes('A') ? num + '<span class="badge-sea">æµ·ç·š</span>' : num;
        tr.insertCell().innerHTML = colorType(t['è»Šç¨®']) + ' (' + arr[0][0] + ' â ' + arr[arr.length - 1][0] + ')';
        tr.insertCell().innerHTML = highlightPeak(arr[idx][1] || '--');
        tr.insertCell().textContent = '--';
        tr.onclick = () => showTrainDetails(num);
      });
    }

    /* ----------------- è»Šæ¬¡æŸ¥è©¢ ----------------- */
    function filterTrainNumbers() {
      var v = document.getElementById('trainNumberInput').value.trim();
      var drop = document.getElementById('trainNumbersDropdown');
      drop.innerHTML = '';
      var matched = Object.keys(trainSchedule).filter(k => k.startsWith(v));
      (matched.length ? matched : ['æŸ¥ç„¡æ­¤ç­æ¬¡']).forEach(n => {
        var o = new Option(n, n);
        drop.add(o);
      });
    }
    function selectTrainNumber() {
      document.getElementById('trainNumberInput').value = document.getElementById('trainNumbersDropdown').value;
    }
    function filterTrainScheduleByNumber() {
      var num = document.getElementById('trainNumberInput').value.trim();
      var tbody = document.querySelector('#scheduleTableByNumber tbody');
      tbody.innerHTML = '';
      var t = trainSchedule[num];
      if (!t) return;
      var arr = t['è»Šç«™æ™‚é–“'];
      var tr = tbody.insertRow();
      tr.insertCell().innerHTML = num.includes('A') ? num + '<span class="badge-sea">æµ·ç·š</span>' : num;
      tr.insertCell().innerHTML = colorType(t['è»Šç¨®']) + ' (' + arr[0][0] + ' â ' + arr[arr.length - 1][0] + ')';
      tr.insertCell().textContent = '--';
      tr.onclick = () => showTrainDetails(num);
    }

    /* ----------------- Modal ----------------- */
    function mkTable(list, mark) {
      var h = '<div class="table-wrapper"><table style="width:100%;border-collapse:collapse;font-size:.8rem"><thead><tr><th>åœé ç«™</th><th>æ™‚é–“</th></tr></thead><tbody>';
      list.forEach(s => {
        var name = (mark && s[0] === mark) ? '<strong>' + s[0] + 'ğŸš‰</strong>' : s[0];
        h += '<tr><td>' + name + '</td><td>' + highlightPeak(s[1]) + '</td></tr>';
      });
      return h + '</tbody></table></div>';
    }
    function showTrainDetails(num, transNum = null, transSt = null) {
      var modal = document.getElementById('trainDetailsModal');
      var tip = document.getElementById('transferTip');
      var body = document.getElementById('modalBody');
      var title = document.getElementById('modalTitle');
      tip.style.display = 'none';
      body.innerHTML = '';
      if (!transNum) {
        title.textContent = 'è»Šæ¬¡ ' + num + ' çš„æ²¿é€”åœé ç«™';
        body.innerHTML = mkTable(trainSchedule[num]['è»Šç«™æ™‚é–“']);
      } else {
        tip.style.display = 'block';
        tip.innerHTML = 'è«‹åœ¨ <strong>' + transSt + '</strong> è½‰ä¹˜ <strong>' + transNum + '</strong>';
        var first = trainSchedule[num]['è»Šç«™æ™‚é–“'];
        var second = trainSchedule[transNum]['è»Šç«™æ™‚é–“'];
        body.innerHTML = '<h3 style="margin:.4rem 0;">ç¬¬ä¸€åˆ—è»Š ' + num + '</h3>' +
          mkTable(first, transSt) +
          '<h3 style="margin:.8rem 0 .4rem;">è½‰ä¹˜åˆ—è»Š ' + transNum + '</h3>' +
          mkTable(second, transSt);
        title.textContent = num + ' â†’ ' + transNum + ' è½‰ä¹˜è©³æƒ…';
      }
      modal.style.display = 'flex';
    }
    function closeTrainDetailsModal() {
      document.getElementById('trainDetailsModal').style.display = 'none';
    }
    window.onclick = e => {
      if (e.target === document.getElementById('trainDetailsModal')) closeTrainDetailsModal();
    };

    /* ------- åˆå§‹åŒ– ------- */
    buildHeader(false);
  </script>
</body>

</html>
