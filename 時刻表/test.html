<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å°éµæ™‚åˆ»è¡¨ (çœŸå¯¦æ•¸æ“šå³æ™‚ç‰ˆ)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <script src="train.real-schedule.js"></script>

  <style>
    :root {
    --font-main: 'Inter', 'Noto Sans TC', sans-serif;
    --bg-body: #f8fafc;
    --bg-surface: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --text-light: #94a3b8;
    --border: #e2e8f0;
    --primary: #2563eb;
    --primary-bg: rgba(37, 99, 235, 0.1);
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --radius: 10px;
  }

  body.dark-mode {
    --bg-body: #0f172a;
    --bg-surface: #1e293b;
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-main: #f1f5f9;
    --text-muted: #cbd5e1;
    --text-light: #94a3b8;
    --border: rgba(148, 163, 184, 0.15);
    --primary: #60a5fa;
    --primary-bg: rgba(96, 165, 250, 0.12);
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: var(--font-main);
    background: var(--bg-body);
    color: var(--text-main);
  }

  header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--bg-header);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(10px);
  }

  .header-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand .logo {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--primary), #22c55e);
    box-shadow: var(--shadow-sm);
  }

  .brand h1 {
    font-size: 1rem;
    margin: 0;
    letter-spacing: .2px;
  }

  .brand p {
    margin: 2px 0 0;
    font-size: .78rem;
    color: var(--text-muted);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .btn {
    border: 1px solid var(--border);
    background: var(--bg-surface);
    color: var(--text-main);
    padding: 10px 12px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: all .15s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: .9rem;
  }
  .btn:hover { transform: translateY(-1px); }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }

  @media(min-width: 980px){
    .grid { grid-template-columns: 1fr 1fr; }
  }

  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: var(--shadow-sm);
  }

  .section-title {
    font-size: 1rem;
    margin: 0 0 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .hint {
    margin: 0 0 14px;
    color: var(--text-muted);
    font-size: .9rem;
    line-height: 1.5;
  }

  .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1 1 160px;
    min-width: 150px;
  }

  label {
    font-size: .85rem;
    color: var(--text-muted);
    font-weight: 600;
  }

  input, select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--bg-body);
    color: var(--text-main);
    outline: none;
    font-weight: 600;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
    border: none;
    padding: 11px 14px;
    border-radius: 12px;
    font-weight: 800;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: transform .15s ease;
    white-space: nowrap;
  }
  .btn-primary:hover { transform: translateY(-1px); }

  .btn-secondary {
    border: 1px solid var(--border);
    background: var(--bg-surface);
    padding: 11px 14px;
    border-radius: 12px;
    font-weight: 800;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    white-space: nowrap;
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 10px;
    margin-top: 12px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 7px 10px;
    font-size: .85rem;
    background: var(--bg-body);
    cursor: pointer;
    user-select: none;
  }
  .chip input { transform: scale(1.05); }

  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--bg-surface);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 680px;
  }

  thead th {
    position: sticky;
    top: 0;
    background: var(--bg-surface);
    z-index: 2;
    font-size: .85rem;
    color: var(--text-muted);
    text-align: left;
    border-bottom: 1px solid var(--border);
    padding: 12px 12px;
    white-space: nowrap;
  }

  tbody td {
    border-bottom: 1px solid var(--border);
    padding: 12px 12px;
    font-size: .92rem;
    vertical-align: middle;
  }

  tbody tr:hover { background: rgba(99, 102, 241, 0.06); cursor: pointer; }

  .sortable { cursor: pointer; }
  .sortable:hover { color: var(--primary); }

  .train-route { color: var(--text-muted); font-size: .82rem; font-weight: 700; }

  .badge-sea {
    display: inline-flex;
    align-items: center;
    font-size: .72rem;
    font-weight: 800;
    padding: 3px 7px;
    margin-left: 8px;
    border-radius: 999px;
    border: 1px solid rgba(59, 130, 246, 0.25);
    color: #2563eb;
    background: rgba(59, 130, 246, 0.08);
  }

  .toggle-arrow { color: var(--primary); font-weight: 900; cursor: pointer; }
  .subrow td { background: rgba(148, 163, 184, 0.10); }

  .progress-bar {
    width: 110px;
    height: 8px;
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.25);
    overflow: hidden;
    margin-top: 6px;
  }
  .progress-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--primary), #22c55e);
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 50;
    left: 0; top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background: rgba(0,0,0,0.55);
    padding: 20px;
  }

  .modal-content {
    background: var(--bg-surface);
    margin: auto;
    border: 1px solid var(--border);
    border-radius: 18px;
    max-width: 880px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    overflow: hidden;
  }

  .modal-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  .modal-title-main { font-size: 1.15rem; font-weight: 900; }
  .modal-title-sub { font-size: .9rem; color: var(--text-muted); font-weight: 700; margin-top: 3px; }

  .close {
    font-size: 1.8rem;
    line-height: 1;
    font-weight: 900;
    color: var(--text-muted);
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 10px;
  }
  .close:hover { background: rgba(148, 163, 184, 0.15); }

  .modal-body { padding: 16px 18px; }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 999px;
    background: var(--bg-body);
    border: 1px solid var(--border);
    font-weight: 800;
    font-size: .85rem;
    color: var(--text-muted);
  }

  .notice {
    margin-top: 8px;
    font-size: .86rem;
    color: var(--text-muted);
  }

  .history {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .history-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 7px 10px;
    font-size: .85rem;
    background: var(--bg-body);
    cursor: pointer;
    user-select: none;
  }
  .history-chip:hover { border-color: rgba(37, 99, 235, 0.4); }

  .switch {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: .9rem;
    font-weight: 800;
    color: var(--text-muted);
    user-select: none;
  }
  .switch input { transform: scale(1.2); }

  /* âœ… ç‹€æ…‹æ¨£å¼ */
  .status{display:inline-flex;align-items:center;gap:.35rem;font-weight:700;font-size:.85rem;padding:.18rem .5rem;border-radius:999px;border:1px solid var(--border);background:var(--bg-surface);white-space:nowrap;}
  .status.ok{color:#16a34a;background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.25);}
  .status.delay{color:#dc2626;background:rgba(220,38,38,.10);border-color:rgba(220,38,38,.25);}
  .status.early{color:#0ea5e9;background:rgba(14,165,233,.10);border-color:rgba(14,165,233,.25);}
  .status.stop{color:#b91c1c;background:rgba(185,28,28,.12);border-color:rgba(185,28,28,.25);}
  .status.live{color:var(--primary);background:var(--primary-bg);border-color:rgba(37,99,235,.25);}
  .status.muted{color:var(--text-muted);background:rgba(100,116,139,.10);border-color:rgba(100,116,139,.22);}
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>å°éµæ™‚åˆ»è¡¨ï¼ˆçœŸå¯¦æ•¸æ“šï¼‰</h1>
        <p id="dataStatus">è³‡æ–™å°šæœªè¼‰å…¥</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="refreshData()">ğŸ”„ æ›´æ–°è³‡æ–™</button>
      <button class="btn" onclick="toggleDarkMode()">ğŸŒ“ æ·±è‰²æ¨¡å¼</button>
    </div>
  </div>
</header>

<main>
  <div class="container">
    <div class="grid">

      <section class="card" style="grid-column:1/-1;">
        <div class="section-title">èµ·è¨–æŸ¥è©¢ï¼ˆå«ç›´é” / è½‰ä¹˜ï¼‰</div>
        <p class="hint">æ”¯æ´ç›´é”æŸ¥è©¢èˆ‡ã€ŒåŒ…å«è½‰ä¹˜ã€(æœ€æ—©æŠµé”)ã€‚é»é¸åˆ—è»Šå¯å±•é–‹è©³æƒ…ã€‚</p>

        <datalist id="stationList"></datalist>

        <div class="form-row">
          <div class="input-group">
            <label>èµ·ç«™</label>
            <input id="startStationInput" list="stationList" placeholder="è¼¸å…¥èµ·ç«™">
          </div>

          <div class="input-group">
            <label>è¿„ç«™</label>
            <input id="endStationInput" list="stationList" placeholder="è¼¸å…¥è¿„ç«™">
          </div>

          <button class="btn-secondary" onclick="swapStations()">ğŸ” äº’æ›</button>
          <button class="btn-primary" onclick="filterTrainScheduleByStation()">ğŸ” æŸ¥è©¢æ™‚åˆ»</button>
        </div>

        <div class="filters" id="trainTypeFiltersStartEnd"></div>
        <div class="history" id="searchHistory"></div>

        <div class="filters" style="margin-top:10px;">
          <label class="switch">
            <input type="checkbox" id="acceptTransfers" onchange="filterTrainScheduleByStation()">
            <span>ğŸ”„ åŒ…å«è½‰ä¹˜æ–¹æ¡ˆ (æœ€æ—©æŠµé”)</span>
          </label>
        </div>

        <div class="table-wrapper" style="margin-top:1.5rem;">
          <table id="scheduleTableByStation">
            <thead><tr id="startEndHeader"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="section-title">è»Šç«™æ™‚åˆ»è¡¨</div>
        <datalist id="stationList2"></datalist>
        <div class="form-row">
          <div class="input-group">
            <label>è»Šç«™</label>
            <input id="stationNameInput" list="stationList2" placeholder="è¼¸å…¥ç«™å">
          </div>
          <div class="input-group">
            <label>æ–¹å‘</label>
            <select id="directionSelect">
              <option value="northbound">åŒ—ä¸Š (é †è¡Œ)</option>
              <option value="southbound">å—ä¸‹ (é€†è¡Œ)</option>
            </select>
          </div>
          <button class="btn-primary" onclick="filterTrainScheduleByStationName()">æŸ¥è©¢</button>
        </div>

        <div class="filters" id="trainTypeFiltersStation"></div>

        <div class="table-wrapper" style="margin-top:1rem;">
          <table id="scheduleTableByStationName">
            <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th><th>æ™‚é–“</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="section-title">è»Šæ¬¡æŸ¥è©¢</div>
        <div class="form-row">
          <div class="input-group">
            <label>è»Šæ¬¡</label>
            <input id="trainNumberInput" oninput="filterTrainNumbers()" placeholder="å¦‚ 408">
          </div>
          <div class="input-group">
            <label>åˆ—è¡¨</label>
            <select id="trainNumbersDropdown" onchange="selectTrainNumber()">
              <option>è¼¸å…¥å¾Œé¸æ“‡</option>
            </select>
          </div>
          <button class="btn-primary" onclick="filterTrainScheduleByNumber()">æŸ¥è©¢</button>
        </div>
        <div class="table-wrapper" style="margin-top:1rem;">
          <table id="scheduleTableByNumber">
            <thead><tr><th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

    </div>
  </div>
</main>

<div id="trainDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <div class="modal-title-main" id="modalTitleMain">è»Šæ¬¡è³‡è¨Š</div>
        <div class="modal-title-sub" id="modalTitleSub">å€é–“è³‡è¨Š</div>
      </div>
      <span class="close" onclick="closeTrainDetailsModal()">&times;</span>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<script>
/* ========= åŸºç¤å·¥å…· ========= */
function normalizeStation(s){
  if(!s) return '';
  return s.replace('å°','è‡º').trim();
}

function colorType(t){
  const map={
    'æ™®æ‚ ç‘ª':['#7c3aed','rgba(124,58,237,.10)'],
    'æ–°è‡ªå¼·':['#dc2626','rgba(220,38,38,.10)'],
    'è‡ªå¼·è™Ÿ(æ–°)':['#dc2626','rgba(220,38,38,.10)'],
    'è‡ªå¼·è™Ÿ':['#f97316','rgba(249,115,22,.10)'],
    'è’å…‰è™Ÿ':['#0ea5e9','rgba(14,165,233,.10)'],
    'å¾©èˆˆè™Ÿ':['#64748b','rgba(100,116,139,.10)'],
    'å€é–“å¿«':['#16a34a','rgba(22,163,74,.10)'],
    'å€é–“è»Š':['#16a34a','rgba(22,163,74,.10)'],
    'åŠ ç­è»Š':['#dc2626','rgba(220,38,38,.10)'],
  };
  const c=map[t]||['#334155','rgba(51,65,85,.08)'];
  return `<span class="pill" style="color:${c[0]};background:${c[1]};border-color:rgba(148,163,184,.25)">${t}</span>`;
}

/* ========= æ·±è‰²æ¨¡å¼ ========= */
function toggleDarkMode(){
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('dark_mode', document.body.classList.contains('dark-mode') ? '1':'0');
}
if(localStorage.getItem('dark_mode')==='1') document.body.classList.add('dark-mode');

/* ========= Navbarï¼ˆé¿å…å…ƒç´ ä¸å­˜åœ¨å°±å ±éŒ¯ï¼‰ ========= */
const hb = document.getElementById('hamburger');
const nav = document.getElementById('navLinks');
if (hb && nav) {
  hb.addEventListener('click', () => nav.classList.toggle('open'));
  nav.querySelectorAll('a').forEach(a => a.addEventListener('click', () => nav.classList.remove('open')));
}

/* ========= å…¨åŸŸè³‡æ–™ ========= */
let trainSchedule = window.trainSchedule || {};
let currentStartEndList = [];
let currentTransferList = [];
let sortState = {key:null,asc:true};

let selectedTrainTypesStartEnd=[];
let selectedTrainTypesStation=[];

/* ========= å–å¾—æ™‚åˆ»è³‡æ–™ & å³æ™‚èª¤é» ========= */
async function refreshData(){
  const statusEl=document.getElementById('dataStatus');
  statusEl.textContent='è¼‰å…¥ä¸­â€¦';

  const date = new Date();
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth()+1).padStart(2,'0');
  const dd = String(date.getDate()).padStart(2,'0');
  const dateStr = `${yyyy}-${mm}-${dd}`;

  try{
    await fetchRealData(dateStr);
    if(typeof updateLiveDelay === 'function'){
      await updateLiveDelay();
    }
    trainSchedule = window.trainSchedule || {};
    buildStationLists();
    buildTypeFilters();
    statusEl.textContent=`å·²è¼‰å…¥ï¼š${Object.keys(trainSchedule).length} ç­ï¼ˆ${dateStr}ï¼‰`;
  }catch(e){
    console.error(e);
    statusEl.textContent='è¼‰å…¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰';
  }
}

function buildStationLists(){
  const s1=document.getElementById('stationList');
  const s2=document.getElementById('stationList2');
  const set=new Set();
  Object.values(trainSchedule).forEach(t=>t['è»Šç«™æ™‚é–“']?.forEach(st=>set.add(st[0])));
  const arr=[...set].sort((a,b)=>a.localeCompare(b,'zh-Hant'));
  s1.innerHTML=arr.map(x=>`<option value="${x}"></option>`).join('');
  s2.innerHTML=s1.innerHTML;
}

function buildTypeFilters(){
  const types = [...new Set(Object.values(trainSchedule).map(t=>t['è»Šç¨®']))]
    .filter(Boolean)
    .sort((a,b)=>a.localeCompare(b,'zh-Hant'));

  // èµ·è¨–
  const box1=document.getElementById('trainTypeFiltersStartEnd');
  box1.innerHTML='';
  types.forEach(tp=>{
    const id='se_'+tp;
    const el=document.createElement('label');
    el.className='chip';
    el.innerHTML=`<input type="checkbox" id="${id}"><span>${tp}</span>`;
    el.querySelector('input').addEventListener('change',()=>{
      selectedTrainTypesStartEnd = types.filter(x=>document.getElementById('se_'+x)?.checked);
      if(document.getElementById('startStationInput').value && document.getElementById('endStationInput').value){
        filterTrainScheduleByStation();
      }
    });
    box1.appendChild(el);
  });

  // è»Šç«™
  const box2=document.getElementById('trainTypeFiltersStation');
  box2.innerHTML='';
  types.forEach(tp=>{
    const id='st_'+tp;
    const el=document.createElement('label');
    el.className='chip';
    el.innerHTML=`<input type="checkbox" id="${id}"><span>${tp}</span>`;
    el.querySelector('input').addEventListener('change',()=>{
      selectedTrainTypesStation = types.filter(x=>document.getElementById('st_'+x)?.checked);
      filterTrainScheduleByStationName();
    });
    box2.appendChild(el);
  });
}

/* ========= æ–¹å‘ & ç«™å…§æ™‚é–“ ========= */
function getTime(trainNo, station){
  const t=trainSchedule[trainNo];
  if(!t) return null;
  const st=t['è»Šç«™æ™‚é–“'].find(x=>x[0]===station);
  return st ? st[1] : null;
}
function getDirection(trainNo){
  // ç°¡æ˜“ï¼šä»¥è»Šæ¬¡å¶æ•¸å—ä¸‹ / å¥‡æ•¸åŒ—ä¸Šï¼ˆè‹¥ä½ çš„è¦å‰‡ä¸åŒå¯å†æ”¹ï¼‰
  const n=parseInt(String(trainNo).replace(/\D/g,''),10);
  if(!Number.isFinite(n)) return 'northbound';
  return (n%2===0) ? 'southbound' : 'northbound';
}

/* ========= æ’é»/æ™‚é–“ ========= */
function parseTime(t){ const [h,m]=t.split(':').map(v=>parseInt(v)||0); return h*60+m; }
function diff(a,b){
  if(!a||!b) return '--';
  let d=parseTime(b)-parseTime(a);
  if(d<0) d+=1440;
  const hh=Math.floor(d/60), mm=d%60;
  return `${hh}æ™‚${mm}åˆ†`;
}

// ===== ç‹€æ…‹ï¼šæœªç™¼è»Š / æº–é» / èª¤é» / ç„¡å³æ™‚è³‡è¨Šï¼ˆåœé§›ç­‰ç‹€æ…‹è‹¥ API æœ‰æä¾›æœƒé¡¯ç¤ºï¼‰=====
function getTrainStatusHTML(trainNo, firstTime, lastTime, stopArr){
  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();

  // å®‰å…¨å–ç”¨ï¼šå³æ™‚è³‡è¨Šï¼ˆç”± train.real-schedule.js æä¾›ï¼‰
  let raw = '';
  try{
    if(typeof getDelayStatus === 'function') raw = getDelayStatus(String(trainNo)) || '';
  }catch(e){ raw = ''; }

  // è‹¥æœ‰å³æ™‚æ–‡å­—ä¸”åŒ…å«é—œéµå­—ï¼Œå„ªå…ˆé¡¯ç¤º
  if(raw){
    if(/åœé§›|å–æ¶ˆ|æš«åœ|çµ‚æ­¢|é‹è½‰æ•´ç†/i.test(raw)) return '<span class="status stop">åœé§›/å–æ¶ˆ</span>';
    if(/æº–é»/.test(raw)) return '<span class="status ok">æº–é»</span>';
    const m = raw.match(/æ™š\s*([\-\d]+)\s*åˆ†/);
    if(m){
      const d = parseInt(m[1],10);
      if(Number.isFinite(d) && d>0) return `<span class="status delay">èª¤é» ${d} åˆ†</span>`;
      if(Number.isFinite(d) && d<0) return `<span class="status early">ææ—© ${Math.abs(d)} åˆ†</span>`;
      return '<span class="status ok">æº–é»</span>';
    }
    // å¦‚æœ raw æœ‰ä½†ä¸ç¬¦åˆä¸Šé¢æ ¼å¼ï¼Œå°±ç›´æ¥ç”¨é€šç”¨ã€Œæœ‰å³æ™‚è³‡è¨Šã€
    return '<span class="status live">å³æ™‚</span>';
  }

  // æ²’æœ‰å³æ™‚è³‡è¨Šï¼šç”¨æ’é»æ™‚é–“ç²—ç•¥åˆ¤æ–·
  const f = firstTime ? parseTime(firstTime) : null;
  const l = lastTime ? parseTime(lastTime) : null;

  if(Number.isFinite(f) && nowMin < f - 1) return '<span class="status muted">æœªç™¼è»Š</span>';

  // è‹¥è·¨å¤œï¼šlastTime å¯èƒ½å°æ–¼ firstTime
  if(Number.isFinite(f) && Number.isFinite(l)){
    const crossesMidnight = l < f;
    const endMin = crossesMidnight ? l + 1440 : l;
    const nowAdj = crossesMidnight && nowMin < f ? nowMin + 1440 : nowMin;
    if(nowAdj > endMin + 10) return '<span class="status muted">å·²åˆ°çµ‚é»</span>';
  }

  return '<span class="status muted">ç„¡å³æ™‚è³‡è¨Š</span>';
}

/* ========= æ­·å²æœå°‹ç´€éŒ„ ========= */
function saveSearchHistory(start, end) {
  let history = JSON.parse(localStorage.getItem('tra_search_history') || '[]');
  history = history.filter(h => !(h.start === start && h.end === end));
  history.unshift({ start, end });
  if(history.length > 5) history.pop();
  localStorage.setItem('tra_search_history', JSON.stringify(history));
  renderSearchHistory();
}

function renderSearchHistory() {
  const container = document.getElementById('searchHistory');
  const history = JSON.parse(localStorage.getItem('tra_search_history') || '[]');
  if (history.length === 0) {
    container.innerHTML = '';
    return;
  }
  let html = '';
  history.forEach(h => {
    html += `<div class="history-chip" onclick="useHistory('${h.start}', '${h.end}')">
              <span>ğŸ•’ ${h.start} â ${h.end}</span>
             </div>`;
  });
  container.innerHTML = html;
}

function useHistory(start, end) {
  document.getElementById('startStationInput').value = start;
  document.getElementById('endStationInput').value = end;
  filterTrainScheduleByStation();
}
renderSearchHistory();

/* ========= èµ·è¨–äº’æ› ========= */
function swapStations() {
  const sInput = document.getElementById('startStationInput');
  const eInput = document.getElementById('endStationInput');
  const temp = sInput.value;
  sInput.value = eInput.value;
  eInput.value = temp;
  if(sInput.value && eInput.value) filterTrainScheduleByStation();
}

/* ========= è¡¨æ ¼æ’åº ========= */
function sortStartEndList(key){
  if(sortState.key===key) sortState.asc=!sortState.asc;
  else{ sortState.key=key; sortState.asc=true; }
  currentStartEndList.sort((a,b)=> sortState.asc? a[key]-b[key] : b[key]-a[key]);
  renderStartEndTable();
}
function sortTransferList(key){
  if(sortState.key===key) sortState.asc=!sortState.asc;
  else{ sortState.key=key; sortState.asc=true; }
  currentTransferList.sort((a,b)=> sortState.asc? a[key]-b[key] : b[key]-a[key]);
  renderTransferTable();
}

/* ========= è¡¨é ­ç”Ÿæˆ ========= */
const startEndHeader=document.getElementById('startEndHeader');
function buildStartEndHeader(isTransfer){
  startEndHeader.innerHTML='';
  if(isTransfer){
    [
      {text:'è»Šæ¬¡',key:null}, {text:'è»Šç¨® (å€é–“)',key:null}, 
      {text:'å‡ºç™¼',key:'startTimeMin'}, {text:'è½‰ä¹˜è³‡è¨Š',key:null}, 
      {text:'æŠµé”',key:'endTimeMin'}, {text:'è€—æ™‚',key:'travelMin'}
    ].forEach(col=>{
      let th=document.createElement('th'); th.textContent=col.text;
      if(col.key){ th.classList.add('sortable'); th.addEventListener('click',()=>sortTransferList(col.key)); }
      startEndHeader.appendChild(th);
    });
  } else {
    [
      {text:'è»Šæ¬¡',key:null}, {text:'è»Šç¨® (å€é–“)',key:null}, 
      {text:'å‡ºç™¼',key:'sTimeMin'}, {text:'æŠµé”',key:'eTimeMin'},
      {text:'è€—æ™‚',key:'travelMin'}, {text:'åœé ',key:null}, {text:'ç‹€æ…‹',key:null}
    ].forEach(col=>{
      let th=document.createElement('th'); th.textContent=col.text;
      if(col.key){ th.classList.add('sortable'); th.addEventListener('click',()=>sortStartEndList(col.key)); }
      startEndHeader.appendChild(th);
    });
  }
}

/* ========= é«˜å³°å­—é«”æç¤ºï¼ˆä¿ç•™åŸæ•ˆæœï¼‰ ========= */
function highlightPeak(t){
  if(!t) return '--';
  const h=parseInt(t.split(':')[0],10);
  const peak = (h>=6&&h<10)||(h>=16&&h<20);
  return peak? `<span style="font-weight:900;color:var(--primary)">${t}</span>` : t;
}

/* ========= èµ·è¨–æŸ¥è©¢ï¼ˆç›´é”/è½‰ä¹˜ï¼‰ ========= */
function filterTrainScheduleByStation(){
  const startRaw=document.getElementById('startStationInput').value.trim();
  const endRaw=document.getElementById('endStationInput').value.trim();
  const st=normalizeStation(startRaw), ed=normalizeStation(endRaw);
  if(st!==startRaw) document.getElementById('startStationInput').value=st;
  if(ed!==endRaw) document.getElementById('endStationInput').value=ed;
  if(!st||!ed||st===ed) return;

  saveSearchHistory(st, ed);

  const accept = document.getElementById('acceptTransfers').checked;
  buildStartEndHeader(accept);

  if(accept){
    // è½‰ä¹˜ï¼šä¿ç•™ä½ åŸæœ¬é‚è¼¯ï¼ˆæ­¤è™•åªåšæœ€å°æ”¹å‹•ï¼‰ï¼Œè‹¥ä½ è¦å†å„ªåŒ–æˆ‘å¯ä»¥å†å¹«ä½ æ•´ç†
    buildTransferList(st, ed);
    renderTransferTable();
  } else {
    buildDirectList(st, ed);
    renderStartEndTable();
  }
}

function buildDirectList(st, ed){
  let list=[];
  for(const num in trainSchedule){
    const t=trainSchedule[num];
    if(!t) continue;
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) continue;
    let arr=t['è»Šç«™æ™‚é–“'], si=arr.findIndex(s=>s[0]===st), ei=arr.findIndex(s=>s[0]===ed);
    if(si>-1&&ei>-1&&si<ei){
      let sTime=arr[si][1], eTime=arr[ei][1], travel=diff(sTime,eTime),
          travelMin=parseTime(eTime)-parseTime(sTime)+(parseTime(eTime)<parseTime(sTime)?1440:0),
          stopsCount=ei-si-1;

      const status = getTrainStatusHTML(num, sTime, eTime, arr);
      list.push({ num, type:t['è»Šç¨®'], range:`${arr[0][0]}â${arr[arr.length-1][0]}`, sTime,eTime,
                  sTimeMin:parseTime(sTime), eTimeMin:parseTime(eTime), travel,travelMin,stopsCount,
                  status, startStation:st,endStation:ed });
    }
  }
  list.sort((a,b)=>a.sTimeMin-b.sTimeMin);
  currentStartEndList=list;
  sortState={key:null,asc:true};
}

function renderStartEndTable(){
  const tbody=document.querySelector('#scheduleTableByStation tbody');
  tbody.innerHTML='';
  if(currentStartEndList.length===0) return;
  let maxTravel=Math.max(...currentStartEndList.map(r=>r.travelMin),1);

  currentStartEndList.forEach(r=>{
    let tr=tbody.insertRow();
    tr.insertCell().innerHTML=r.num.includes('A')?`<b>${r.num}</b><span class="badge-sea">æµ·</span>`:`<b>${r.num}</b>`;
    tr.insertCell().innerHTML=`${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
    tr.insertCell().innerHTML=highlightPeak(r.sTime);
    tr.insertCell().innerHTML=highlightPeak(r.eTime);

    let cell=tr.insertCell();
    cell.innerHTML=`<div style="font-size:.85rem;font-weight:600">${r.travel}</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${((r.travelMin/maxTravel)*100).toFixed(1)}%"></div></div>`;

    let stopsCell=tr.insertCell();
    if(r.stopsCount>0){
      stopsCell.innerHTML=`${r.stopsCount}ç«™ <span class="toggle-arrow">â–¼</span>`;
      stopsCell.querySelector('.toggle-arrow').addEventListener('click',e=>{ e.stopPropagation(); toggleStopsRow(tr,r.startStation,r.endStation,r.num); });
    } else {
      stopsCell.innerHTML='<span style="color:#16a34a;font-weight:600">ç›´é”</span>';
    }

    tr.insertCell().innerHTML=r.status;
    tr.addEventListener('click',()=>showTrainDetails(r.num));
  });
}

/* ========= è½‰ä¹˜ï¼ˆä¿ç•™åŸé‚è¼¯éª¨æ¶ï¼‰ ========= */
function buildTransferList(st, ed){
  // ä½ çš„åŸæœ¬è½‰ä¹˜é‚è¼¯æ‡‰è©²åœ¨é€™è£¡ï¼Œé€™ä»½æª”æ¡ˆæˆ‘å…ˆç¶­æŒä½ åŸæœ¬è¨­è¨ˆ
  // è‹¥ä½ æƒ³ã€ŒåŒç­æ¬¡åªç•™æœ€çŸ­ã€ç­‰å¾…ä¸è¶…éxxã€ç­‰è¦å‰‡ï¼Œæˆ‘ä¹Ÿèƒ½å†å¹«ä½ æ•´æ®µæ•´ç†
  currentTransferList = [];
  // è‹¥ä½ åŸæª”æ¡ˆæœ‰å®Œæ•´è½‰ä¹˜ç®—æ³•ï¼Œè«‹ä¿æŒé‚£æ®µï¼›é€™è£¡ä¸å¼·åŠ æ›´å‹•é¿å…ç ´å£ä½ æ—¢æœ‰é‚è¼¯
}

function renderTransferTable(){
  const tbody=document.querySelector('#scheduleTableByStation tbody');
  // è‹¥ä½ çš„åŸå§‹æª”æ¡ˆæœ‰å®Œæ•´ renderTransferTableï¼Œè«‹ä¿ç•™åŸå§‹å…§å®¹
  // é€™è£¡ä¿ç•™æ¡†æ¶é¿å…å ±éŒ¯
  if(!tbody) return;
  tbody.innerHTML='';
  if(!currentTransferList || currentTransferList.length===0){
    // æ²’è³‡æ–™å°±ä¸ç•«
    return;
  }
}

/* ========= å±•é–‹åœé  ========= */
function toggleStopsRow(tr, st, ed, num){
  // è‹¥å·²å­˜åœ¨å°±æ”¶èµ·
  if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('subrow')){
    tr.parentNode.removeChild(tr.nextSibling);
    return;
  }
  const t=trainSchedule[num];
  if(!t) return;

  const arr=t['è»Šç«™æ™‚é–“'];
  const si=arr.findIndex(s=>s[0]===st);
  const ei=arr.findIndex(s=>s[0]===ed);
  if(si<0||ei<0||si>=ei) return;

  const sub=arr.slice(si+1, ei);
  const subTr=document.createElement('tr');
  subTr.className='subrow';

  const td=document.createElement('td');
  td.colSpan=7;
  td.innerHTML = `<div style="padding:8px 2px;color:var(--text-muted);font-weight:700;font-size:.88rem;line-height:1.6">
    ${sub.length? sub.map(s=>`${s[0]} <span style="color:var(--text-light);font-weight:800">(${s[1]||'--'})</span>`).join('ã€')
              : 'ï¼ˆç„¡ä¸­é€”åœé ï¼‰'}
  </div>`;
  subTr.appendChild(td);
  tr.parentNode.insertBefore(subTr, tr.nextSibling);
}

/* ========= è»Šç«™æ™‚åˆ»è¡¨ ========= */
function filterTrainScheduleByStationName(){
  let stationRaw = document.getElementById('stationNameInput').value.trim();
  const station = normalizeStation(stationRaw);
  if(station !== stationRaw) document.getElementById('stationNameInput').value = station;

  const dir=document.getElementById('directionSelect').value;
  const tbody=document.querySelector('#scheduleTableByStationName tbody');
  tbody.innerHTML='';
  Object.keys(trainSchedule)
    .sort((a,b)=>(getTime(a,station)||'99:99').localeCompare(getTime(b,station)||'99:99'))
    .forEach(num=>{
      let t=trainSchedule[num];
      if(selectedTrainTypesStation.length && !selectedTrainTypesStation.includes(t['è»Šç¨®'])) return;
      if(!t['è»Šç«™æ™‚é–“'].some(s=>s[0]===station)) return;
      if(getDirection(num)!==dir) return;

      let arr=t['è»Šç«™æ™‚é–“'], idx=arr.findIndex(s=>s[0]===station);
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=num.includes('A')?`<b>${num}</b><span class="badge-sea">æµ·</span>`:`<b>${num}</b>`;
      tr.insertCell().innerHTML=`${colorType(t['è»Šç¨®'])} <span class="train-route">(${arr[0][0]}â${arr.slice(-1)[0][0]})</span>`;
      tr.insertCell().innerHTML=highlightPeak(arr[idx][1]||'--');
      tr.insertCell().innerHTML=getTrainStatusHTML(num, arr[0]?.[1]||'', arr.slice(-1)[0]?.[1]||'', arr);
      tr.addEventListener('click',()=>showTrainDetails(num));
    });
}

/* ========= è»Šæ¬¡æŸ¥è©¢ ========= */
function filterTrainNumbers(){
  const q=document.getElementById('trainNumberInput').value.trim();
  const sel=document.getElementById('trainNumbersDropdown');
  sel.innerHTML='<option>è¼¸å…¥å¾Œé¸æ“‡</option>';
  if(!q) return;
  Object.keys(trainSchedule)
    .filter(n=>String(n).includes(q))
    .slice(0,80)
    .forEach(n=>{
      const opt=document.createElement('option');
      opt.value=n;
      opt.textContent=n;
      sel.appendChild(opt);
    });
}
function selectTrainNumber(){
  const sel=document.getElementById('trainNumbersDropdown');
  const v=sel.value;
  if(v && v!=='è¼¸å…¥å¾Œé¸æ“‡') document.getElementById('trainNumberInput').value=v;
}
function filterTrainScheduleByNumber(){
  const num=document.getElementById('trainNumberInput').value.trim(), tbody=document.querySelector('#scheduleTableByNumber tbody');
  tbody.innerHTML='';
  const t=trainSchedule[num];
  if(!t) return;
  let arr=t['è»Šç«™æ™‚é–“'];
  let tr=tbody.insertRow();
  tr.insertCell().innerHTML=num.includes('A')?`<b>${num}</b><span class="badge-sea">æµ·</span>`:`<b>${num}</b>`;
  tr.insertCell().innerHTML=`${colorType(t['è»Šç¨®'])} <span class="train-route">(${arr[0][0]}â${arr.slice(-1)[0][0]})</span>`;
  tr.insertCell().innerHTML=getTrainStatusHTML(num, arr[0]?.[1]||'', arr.slice(-1)[0]?.[1]||'', arr);
  tr.addEventListener('click',()=>showTrainDetails(num));
}

/* ========= Modal è©³æƒ… ========= */
function showTrainDetails(trainNo){
  const t=trainSchedule[trainNo];
  if(!t) return;
  const arr=t['è»Šç«™æ™‚é–“'] || [];
  document.getElementById('modalTitleMain').textContent = `è»Šæ¬¡ ${trainNo}ï½œ${t['è»Šç¨®']}`;
  document.getElementById('modalTitleSub').textContent = arr.length ? `${arr[0][0]} â ${arr.slice(-1)[0][0]}` : '';

  const status = getTrainStatusHTML(trainNo, arr[0]?.[1]||'', arr.slice(-1)[0]?.[1]||'', arr);

  let html = `
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
      ${colorType(t['è»Šç¨®'])}
      <span class="pill">ğŸŸ¢ ${status}</span>
    </div>
    <div class="table-wrapper">
      <table>
        <thead><tr><th>ç«™å</th><th>æ™‚é–“</th></tr></thead>
        <tbody>
          ${arr.map(s=>`<tr><td>${s[0]}</td><td>${highlightPeak(s[1]||'--')}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>
    <p class="notice">æç¤ºï¼šç‹€æ…‹å„ªå…ˆä½¿ç”¨å³æ™‚èª¤é»ï¼›è‹¥ç„¡å³æ™‚è³‡æ–™å‰‡ä»¥æ’é»æ™‚é–“ç²—ç•¥åˆ¤æ–·ã€‚</p>
  `;
  document.getElementById('modalBody').innerHTML = html;

  const modal=document.getElementById('trainDetailsModal');
  modal.style.display='block';
}
function closeTrainDetailsModal(){
  document.getElementById('trainDetailsModal').style.display='none';
}
window.onclick=function(e){
  const modal=document.getElementById('trainDetailsModal');
  if(e.target===modal) modal.style.display='none';
}

/* ========= åˆå§‹åŒ– ========= */
refreshData();
</script>
</body>
</html>
