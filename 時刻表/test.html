<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å°éµæ™‚åˆ»è¡¨ (çœŸå¯¦æ•¸æ“šå³æ™‚ç‰ˆ)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style> 
  /* ===== 1. æ ¸å¿ƒè®Šæ•¸èˆ‡ Reset ===== */
  :root {
    --font-main: 'Inter', 'Noto Sans TC', sans-serif;
    --bg-body: #f8fafc;
    --bg-surface: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --text-light: #94a3b8;
    --border: #e2e8f0;
    --primary: #2563eb;
    --primary-bg: rgba(37, 99, 235, 0.1);
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --radius: 10px;
  }

  body.dark-mode {
    --bg-body: #0f172a;
    --bg-surface: #1e293b;
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --text-light: #64748b;
    --border: #334155;
    --primary: #60a5fa;
    --primary-bg: rgba(96, 165, 250, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    font-family: var(--font-main);
    background: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    padding-bottom: 40px;
  }

  /* ===== 2. å°èˆªåˆ— ===== */
  .navbar {
    position: sticky; top: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.8rem 1.5rem;
    background: var(--bg-header);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  .navbar .brand { font-weight: 700; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
  .nav-links { display: flex; gap: 4px; align-items: center; }
  .nav-links a {
    color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500;
    padding: 6px 12px; border-radius: 6px; transition: 0.2s;
  }
  .nav-links a:hover { background: var(--bg-body); color: var(--primary); }
  .theme-btn {
    border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-main);
    padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;
  }
  .hamburger { display: none; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; }
  .hamburger span { width: 24px; height: 2px; background: var(--text-main); }

  @media(max-width: 900px) {
    .nav-links {
      position: absolute; top: 100%; left: 0; width: 100%;
      background: var(--bg-surface); border-bottom: 1px solid var(--border);
      flex-direction: column; align-items: flex-start; padding: 0;
      max-height: 0; overflow: hidden; opacity: 0; transition: 0.3s;
    }
    .nav-links.open { max-height: 500px; opacity: 1; padding: 1rem; }
    .nav-links a { width: 100%; padding: 10px; }
    .hamburger { display: flex; }
  }

  /* ===== 3. ä¸»è¦å®¹å™¨ ===== */
  .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
  .grid { display: grid; gap: 24px; }

  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .section-title {
    font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 2px; }

  /* ===== 4. è¡¨å–®èˆ‡ç¯©é¸ ===== */
  .form-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 16px; position: relative; }
  
  .input-group { 
    display: flex; align-items: center; gap: 8px; 
    background: var(--bg-body); padding: 4px 8px; 
    border: 1px solid var(--border); border-radius: 8px; 
    flex: 1; min-width: 120px;
  }
  .input-group label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; white-space: nowrap; }
  input, select {
    border: none; background: transparent; color: var(--text-main); 
    font-size: 0.95rem; padding: 6px; outline: none; width: 100%; 
  }

  /* äº’æ›æŒ‰éˆ• */
  .swap-btn {
    width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--bg-surface); color: var(--primary);
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; transition: 0.2s; font-size: 1.1rem;
  }
  .swap-btn:hover { background: var(--bg-body); transform: rotate(180deg); }

  button.btn-primary {
    background: var(--primary); color: #fff; border: none;
    padding: 8px 16px; border-radius: 8px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }

  /* æ­·å²ç´€éŒ„ Chips */
  .history-chips { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .history-chip {
    font-size: 0.8rem; padding: 4px 10px; border-radius: 12px;
    background: var(--bg-body); color: var(--text-muted);
    border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 4px;
  }
  .history-chip:hover { background: var(--primary-bg); color: var(--primary); border-color: var(--primary); }

  /* æ¨™ç±¤å¼ Checkbox */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .chip-label {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 10px; border-radius: 20px;
    border: 1px solid var(--border); background: var(--bg-surface);
    color: var(--text-muted); font-size: 0.85rem; cursor: pointer;
    user-select: none; transition: 0.2s;
  }
  .chip-label:hover { background: var(--bg-body); }
  .chip-label input { display: none; }
  .chip-label:has(input:checked) {
    background: var(--primary-bg); color: var(--primary); border-color: var(--primary); font-weight: 500;
  }
  .chip-label input:checked + span { color: var(--primary); }

  /* ===== 5. è¡¨æ ¼æ¨£å¼ ===== */
  .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
  
  th {
    background: var(--bg-body); color: var(--text-muted); font-weight: 600; text-align: left;
    padding: 12px 16px; border-bottom: 1px solid var(--border);
  }
  th.sortable { cursor: pointer; }
  td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: var(--bg-body); cursor: pointer; }

  /* æ•¸å­—å°é½Š */
  td { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
  
  /* æ¨™ç±¤ Badge */
  .badge-sea { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #0ea5e9; color: #fff; margin-left: 4px; }
  
  .train-route { font-size: 0.85rem; color: var(--text-muted); margin-left: 6px; }
  .progress-bar { width: 100px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
  .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; }

  /* ===== 6. Modal (å½ˆçª—) & æ™‚é–“è»¸ ===== */
  .modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px);
    z-index: 2000; justify-content: center; align-items: center;
    opacity: 0; transition: opacity 0.3s;
  }
  .modal[style*="display: flex"] { opacity: 1; }

  .modal-content {
    background: var(--bg-surface); width: 95%; max-width: 500px; max-height: 85vh;
    border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    overflow: hidden; display: flex; flex-direction: column;
    transform: translateY(20px); transition: transform 0.3s;
  }
  .modal[style*="display: flex"] .modal-content { transform: translateY(0); }

  .modal-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-body);
  }
  .modal-title-main { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
  .modal-title-sub { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }
  .close{font-size:26px;color:var(--text-muted);background:transparent;width:auto;height:auto;display:flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;user-select:none;flex:0 0 auto;padding:6px 10px;line-height:1;}
.close:hover{background:rgba(148,163,184,0.18);color:var(--text-main);}

  .modal-body { padding: 0; overflow-y: auto; background: var(--bg-surface); }

  /* æ™‚é–“è»¸æ¨£å¼ */
  .timeline { padding: 10px 20px; }
  .timeline-item { display: flex; position: relative; padding-bottom: 0; }
  
  /* å·¦å´æ™‚é–“ */
  .tl-time {
    width: 50px; text-align: right; font-size: 0.9rem; font-weight: 600; 
    color: var(--text-main); padding-right: 15px; padding-top: 2px;
    font-variant-numeric: tabular-nums;
  }
  
  /* ä¸­é–“ç·šæ¢èˆ‡åœ“é» */
  .tl-marker {
    display: flex; flex-direction: column; align-items: center; width: 20px; position: relative;
  }
  .tl-line {
    width: 2px; background: var(--border); flex-grow: 1; margin-top: 4px; margin-bottom: -4px;
  }
  .timeline-item:last-child .tl-line { display: none; }
  .tl-dot {
    width: 10px; height: 10px; border-radius: 50%; background: var(--border);
    border: 2px solid var(--bg-surface); z-index: 1; flex-shrink: 0; transition: all 0.3s;
  }
  
  /* å³å´ç«™å */
  .tl-content { padding-left: 15px; padding-bottom: 24px; flex-grow: 1; }
  .timeline-item:last-child .tl-content { padding-bottom: 10px; }
  
  .tl-station { font-size: 1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; }
  .st-arr{ font-size:0.55em; font-weight:600; color:var(--text-muted); margin-left:8px; font-variant-numeric: tabular-nums; }
  .tl-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }

  /* --- ç‹€æ…‹æ¨£å¼ --- */
  .timeline-item.passed .tl-time, 
  .timeline-item.passed .tl-station { opacity: 0.4; filter: grayscale(1); }
  .timeline-item.passed .tl-dot { background: var(--border); }

  .timeline-item.next .tl-dot { 
    background: #22c55e; width: 14px; height: 14px; 
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2); 
    border-color: #fff; 
  }
  .timeline-item.next .tl-station { color: #15803d; font-weight: 700; }
  body.dark-mode .timeline-item.next .tl-station { color: #4ade80; }
  
  .timeline-item.transfer .tl-dot { background: #d97706; width: 12px; height: 12px; }
  .timeline-item.transfer .tl-station { color: #b45309; }

  .badge-next {
    display: inline-flex; align-items: center; gap: 4px;
    background: #22c55e; color: #fff; font-size: 0.7rem; 
    padding: 2px 8px; border-radius: 10px; margin-left: 8px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

  .transfer-banner {
    background: var(--bg-body); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
    padding: 10px 20px; display: flex; align-items: center; gap: 10px; margin: 10px -20px 20px -20px;
  }

  /* ===== è½‰ä¹˜è©³æƒ…ï¼šæ‘˜è¦å¡ç‰‡ ===== */
  .transfer-summary{
    padding: 14px 20px 6px 20px;
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
  }
  .transfer-card{
    border: 1px solid var(--border);
    background: var(--bg-body);
    border-radius: 14px;
    padding: 12px 12px;
    box-shadow: var(--shadow-sm);
  }
  .transfer-card-title{
    font-size: .78rem;
    color: var(--text-muted);
    font-weight: 800;
    letter-spacing: .02em;
    margin-bottom: 6px;
  }
  .transfer-card-main{
    font-size: .95rem;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .kv-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 10px;
  }
  .kv{
    display:flex; flex-direction:column; gap:2px;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--bg-surface);
  }
  .kv span{ font-size:.75rem; color: var(--text-muted); font-weight:700; }
  .kv b{ font-size:.92rem; font-variant-numeric: tabular-nums; }
  .transfer-section{ padding: 0 0 6px 0; }
  .transfer-sec-title{
    padding: 10px 20px 0 20px;
    font-weight: 900;
    font-size: 1rem;
  }

  @media (max-width: 760px){
    .transfer-summary{ grid-template-columns: 1fr; }
    .kv-grid{ grid-template-columns: 1fr 1fr; }
  }
  
  /* ===== Query Tabs ===== */
  .query-tabs{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 14px 0}
  .query-tab{appearance:none;border:1px solid var(--border);background:var(--card-bg);color:var(--text-main);
    padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;transition:.15s}
  .query-tab:hover{transform:translateY(-1px)}
  .query-tab.active{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border-color:transparent}
  .query-panel.hidden{display:none}


  .ticket-btn{
    border:1px solid var(--border);
    background:var(--bg-body);
    color:var(--text-main);
    border-radius:10px;
    padding:6px 10px;
    cursor:pointer;
    font-size:16px;
    line-height:1;
  }
  .ticket-btn:active{ transform:scale(.98); }
  .ticket-btn[disabled]{
    opacity:.45;
    cursor:not-allowed;
    transform:none;
  }
  .ticket-btn[disabled]:active{ transform:none; }
</style>

  <style>
    /* loading overlayï¼ˆåŸæœ¬å°±æœ‰ï¼‰ */
    #loading-overlay{
      position: fixed; inset: 0; background: rgba(15, 23, 42, 0.35);
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    .spinner{
      width: 44px; height: 44px; border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.35);
      border-top-color: rgba(255,255,255,0.95);
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to{ transform: rotate(360deg);} }

    /* headerï¼ˆåŸæœ¬å°±æœ‰ï¼‰ */
    .header{
      position: sticky; top:0; z-index: 120;
      background: var(--bg-header);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
    }
    .header-content{
      max-width: 1200px; margin: 0 auto;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
    }
    .logo{
      font-weight: 800; letter-spacing: .5px;
      color: var(--primary);
      display:flex; align-items: baseline; gap: 6px;
    }
    .logo span{ font-weight: 600; color: var(--text-muted); font-size: .85rem; }
    .date-picker{ display:flex; align-items:center; gap: 8px; }
    .btn-ghost{
      border:1px solid var(--border);
      background: transparent;
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:700;
    }
    .btn-ghost:hover{ background: rgba(148,163,184,0.14); }

    .input-field{
      border:1px solid var(--border);
      background: var(--bg-surface);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 8px;
      outline: none;
      font-family: var(--font-main);
    }

    /* stops å±•é–‹ç®­é ­ï¼ˆåŸæœ¬å°±æœ‰ï¼‰ */
    .toggle-arrow{ color: var(--text-muted); margin-left: 6px; font-size: .85rem; cursor:pointer; }
    .stops-row td{ background: var(--bg-body); color: var(--text-muted); font-size: .85rem; }
  </style>

</head>

<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text">æ­£åœ¨åˆå§‹åŒ–å°éµçœŸå¯¦æ•¸æ“š...</div>
</div>

<header class="header">
  <div class="header-content">
    <div class="logo">TRA <span>Real-time</span></div>

    <div class="date-picker">
      <label style="font-size: 0.8em; color: var(--text-muted);">é¸æ“‡æŸ¥è©¢æ—¥æœŸï¼š</label>
      <input type="date" id="mainQueryDate" class="input-field" style="width: auto; display: inline-block;">
      <button class="btn-primary" id="refreshBtn" style="padding: 6px 12px;">æ›´æ–°è³‡æ–™</button>
      <button class="btn-ghost" id="themeToggle" type="button" title="åˆ‡æ›æ·±å¤œæ¨¡å¼">ğŸŒ™ æ·±å¤œæ¨¡å¼</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid">

    <div class="query-tabs" role="tablist" aria-label="æŸ¥è©¢æ¨¡å¼">
      <button class="query-tab active" id="tab-startend" type="button" data-target="panel-startend">èµ·è¨–ç«™ / è½‰ä¹˜</button>
      <button class="query-tab" id="tab-station" type="button" data-target="panel-station">è»Šç«™æ™‚åˆ»è¡¨</button>
      <button class="query-tab" id="tab-trainno" type="button" data-target="panel-trainno">è»Šæ¬¡æŸ¥è©¢</button>
    </div>


    <section id="panel-startend" class="card query-panel">
      <div class="section-title">èµ·è¨–ç«™ / è½‰ä¹˜æŸ¥è©¢</div>

      <!-- å–®ä¸€ datalistï¼šå‹•æ…‹ä¾è¼¸å…¥/focus æ”¹å…§å®¹ -->
      <datalist id="stationList"></datalist>

      <div id="searchHistory" class="history-chips"></div>

      <div class="form-row">
        <div class="input-group">
          <label>å‡ºç™¼</label>
          <input list="stationList" id="startStation" placeholder="è«‹è¼¸å…¥ç«™åæˆ–ç«™ç¢¼">
        </div>

        <button class="swap-btn" id="swapBtn" title="äº’æ›">â‡„</button>

        <div class="input-group">
          <label>åˆ°é”</label>
          <input list="stationList" id="endStation" placeholder="è«‹è¼¸å…¥ç«™åæˆ–ç«™ç¢¼">
        </div>

        <label class="chip-label" style="flex:0 0 auto;">
          <input type="checkbox" id="acceptTransfers">
          <span>æ¥å—è½‰ä¹˜</span>
        </label>

        <button class="btn-primary" id="searchBtn">æŸ¥è©¢</button>
      </div>

      <div class="chip-group" id="trainTypeChipsStartEnd"></div>

      <div class="table-wrapper">
        <table id="scheduleTableByStation">
          <thead>
            <tr>
              <th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th><th>å‡ºç™¼ <span id="sortDepIcon">â†•</span></th><th>æŠµé” <span id="sortArrIcon">â†•</span></th><th>è€—æ™‚ <span id="sortDurIcon">â†•</span></th><th>åœé </th><th>ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="panel-station" class="card query-panel hidden">
      <div class="section-title">è»Šç«™æ™‚åˆ»è¡¨</div>
      <div class="form-row">
        <div class="input-group">
          <label>è»Šç«™</label>
          <input list="stationList" id="stationNameInput" placeholder="è«‹è¼¸å…¥ç«™åæˆ–ç«™ç¢¼">
        </div>

        <div class="input-group" style="max-width: 220px;">
          <label>æ–¹å‘</label>
          <select id="directionSelect">
            <option value="even">é †è¡Œï¼ˆå¶æ•¸è»Šæ¬¡ï¼‰</option>
            <option value="odd">é€†è¡Œï¼ˆå¥‡æ•¸è»Šæ¬¡ï¼‰</option>
          </select>
        </div>

        <button class="btn-primary" id="stationSearchBtn">æŸ¥è©¢</button>
      </div>

      <div class="chip-group" id="trainTypeChipsStation"></div>

      <div class="table-wrapper">
        <table id="scheduleTableByStationName">
          <thead>
            <tr><th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th><th>æ™‚é–“</th><th>ç‹€æ…‹</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="panel-trainno" class="card query-panel hidden">
      <div class="section-title">è»Šæ¬¡æŸ¥è©¢</div>

      <!-- è»Šæ¬¡å€™é¸æ¸…å–®ï¼šåŒæ¨£å‹•æ…‹ä¾è¼¸å…¥/focus æ”¹å…§å®¹ -->
      <datalist id="trainNumberList"></datalist>

      <div class="form-row">
        <div class="input-group">
          <label>è»Šæ¬¡</label>
          <input id="trainNumberInput" list="trainNumberList" placeholder="è«‹è¼¸å…¥è»Šæ¬¡">
        </div>
        <button class="btn-primary" id="trainNumberBtn">æŸ¥è©¢</button>
      </div>

      <div class="table-wrapper">
        <table id="scheduleTableByNumber">
          <thead>
            <tr><th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th><th>ç‹€æ…‹</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>
</main>

<!-- Modal -->
<div id="trainModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <div class="modal-title-main" id="modalTitleMain">åˆ—è»Šè³‡è¨Š</div>
        <div class="modal-title-sub" id="modalTitleSub">â€”</div>
      </div>
      <div class="close" id="modalClose">âœ•</div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script src="./train.real-schedule.js"></script>
<script>
  // ===== å…¨åŸŸ =====
  let nameToId = {};
  let stationListSorted = []; // [{id,name}]
  let currentQueryDateStr = ''; // ä½¿ç”¨è€…é¸çš„ã€Œé¡¯ç¤ºæ—¥æœŸã€ï¼ˆç«™åˆ¥é¡¯ç¤ºè¦ç”¨ï¼‰
  let baseSchedule = {};       // ç™¼è»Šæ—¥ = currentQueryDateStr
  let prevSchedule = {};       // ç™¼è»Šæ—¥ = currentQueryDateStr - 1ï¼ˆç”¨ä¾†è£œè·¨æ—¥åˆ°ä»Šå¤©çš„ç«™ï¼‰
  let originDateByKey = {};    // key -> originDate (YYYY-MM-DD)
  let scheduleKeyList = [];    // [{key, trainNo, originDate, data}]
  // ===== è‡ªå‹•æ›´æ–°ï¼šè¨˜ä½æœ€å¾Œä¸€æ¬¡æŸ¥è©¢ =====
let lastStartEndQuery = null;   // {st, ed, accept}
let lastStationQuery  = null;   // {station, dir}
let lastTrainQuery    = null;   // {trainNo}
let modalCtx = null;            // {trainNo, originDate}


  // ===== æ—¥æœŸå·¥å…· =====
  function fmtDate(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function addDays(dateStr, delta){
    const [y,m,d] = dateStr.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    dt.setDate(dt.getDate()+delta);
    return fmtDate(dt);
  }

  // ===== æ—¥æœŸï¼šæ˜¨å¤© ~ æœªä¾† 60 å¤©ï¼ˆé è¨­ä»Šå¤©ï¼‰ =====
  function initDatePickerWindow(){
    const el = document.getElementById('mainQueryDate');
    if(!el) return;
    const today = new Date();
    const minD = new Date(today); minD.setDate(minD.getDate()-1);
    const maxD = new Date(today); maxD.setDate(maxD.getDate()+59);
    el.min = fmtDate(minD);
    el.max = fmtDate(maxD);
    el.value = fmtDate(today);
    el.addEventListener('change', ()=>refreshData(el.value));
  }

  // ===== å°/è‡º æ­£è¦åŒ– =====
  function normTW(s){ return String(s||'').trim().replace(/å°/g,'è‡º'); }
  function normLoose(s){
    const t = String(s||'').trim();
    return { raw:t, asTai:t.replace(/å°/g,'è‡º'), asTai2:t.replace(/è‡º/g,'å°') };
  }

  // ===== datalist å‹•æ…‹å¡«å…¥ï¼šç«™å =====
  function fillStationDatalist(keyword){
    const dl = document.getElementById('stationList');
    if(!dl) return;

    const k = normLoose(keyword||'');
    // â˜… æ‰‹æ©Ÿæ•ˆèƒ½ï¼šæœ€å¤šåªé¡¯ç¤ºå‰ 30 ç­†ï¼Œä¸”ä¸€æ¬¡ innerHTML å¯«å…¥ï¼ˆé¿å…å¤§é‡ DOM appendï¼‰
    const limit = 30;
    let out = '';
    let count = 0;

    for(let i=0;i<stationListSorted.length;i++){
      const s = stationListSorted[i];
      if(!s) continue;

      if(k.raw){
        const id = String(s.id);
        const name = String(s.name);
        const name2 = name.replace(/è‡º/g,'å°');
        const hit = id.includes(k.raw) || id.includes(k.asTai) || id.includes(k.asTai2) ||
                    name.includes(k.raw) || name.includes(k.asTai) || name.includes(k.asTai2) ||
                    name2.includes(k.raw) || name2.includes(k.asTai) || name2.includes(k.asTai2);
        if(!hit) continue;
      }

      out += `<option value="${s.id}-${s.name}"></option>`;
      count++;
      if(count >= limit) break;
    }

    dl.innerHTML = out;
  }

  // ===== datalist å‹•æ…‹å¡«å…¥ï¼šè»Šæ¬¡ =====
  function fillTrainDatalist(keyword){
    const dl = document.getElementById('trainNumberList');
    if(!dl) return;

    const k = String(keyword||'').trim();
    // â˜… æ‰‹æ©Ÿæ•ˆèƒ½ï¼šæœ€å¤šåªé¡¯ç¤ºå‰ 50 ç­†ï¼Œä¸”ä¸€æ¬¡ innerHTML å¯«å…¥
    const limit = 50;
    let out = '';
    let count = 0;

    const nums = Object.keys(baseSchedule||{}).sort((a,b)=>String(a).localeCompare(String(b),'en'));
    for(let i=0;i<nums.length;i++){
      const n = nums[i];
      if(k && !String(n).includes(k)) continue;

      const t = baseSchedule[n];
      const arr = t?.['è»Šç«™æ™‚é–“']||[];
      const range = (arr.length>=2)?`${arr[0][0]}â${arr.slice(-1)[0][0]}`:'';
      out += `<option value="${n}-${t?.['è»Šç¨®']||''}-${range}"></option>`;
      count++;
      if(count >= limit) break;
    }

    dl.innerHTML = out;
  }

  function extractStationNameFromInput(raw){
    const v = String(raw||'').trim();
    if(!v) return '';
    // å…è¨± 1000-è‡ºåŒ—
    const m = v.match(/^(\d{3,6})\s*-\s*(.+)$/);
    if(m && window.stationMap && window.stationMap[m[1]]) return window.stationMap[m[1]];
    // å…è¨±åªè¼¸å…¥ç«™ç¢¼
    if(window.stationMap && window.stationMap[v]) return window.stationMap[v];
    // å…è¨±ç«™åå°/è‡º
    const asTai = normTW(v);
    if(nameToId[asTai]) return asTai;
    const asTai2 = v.replace(/è‡º/g,'å°');
    if(nameToId[normTW(asTai2)]) return normTW(asTai2);
    return normTW(v);
  }

  function extractTrainNoFromInput(raw){
    const v = String(raw||'').trim();
    if(!v) return '';
    const m = v.match(/^([0-9A-Za-z]+)\s*-\s*/);
    if(m) return m[1];
    return v;
  }

  // ===== å»º station index =====
  function buildStationIndex(){
    nameToId = {};
    stationListSorted = [];
    if(!window.stationMap) return;

    Object.entries(window.stationMap).forEach(([id, name])=>{
      if(!id || !name) return;
      const nameNorm = normTW(name);
      nameToId[nameNorm] = id;
      stationListSorted.push({id, name:nameNorm});
    });

    stationListSorted.sort((a,b)=>String(a.id).localeCompare(String(b.id),'en'));
  }

  // ===== å·¥å…·ï¼šæ™‚é–“è™•ç† =====
  function parseTime(t){
    if(!t || !/\d{1,2}:\d{2}/.test(t)) return null;
    let [h,m]=t.split(':').map(x=>parseInt(x,10));
    return h*60+m;
  }

// å°‡ä¸€ç«™è³‡æ–™æ‹†æˆ {arr, dep}ï¼Œå…¼å®¹å…©ç¨®è³‡æ–™æ ¼å¼ï¼š
// A) [ç«™, åˆ°é”, é–‹è»Š]  æˆ–  B) [ç«™, é–‹è»Š, åˆ°é”]
// è¦å‰‡ï¼šè‹¥å…©å€‹æ™‚é–“éƒ½å­˜åœ¨ï¼Œä¸”ã€Œè¼ƒæ™šã€æ‡‰è¦–ç‚ºé–‹è»Š(>=åˆ°é”)
function splitArrDep(stopRow){
  const t1 = stopRow?.[1] || '';
  const t2 = stopRow?.[2] || '';
  if(!t2) return { arr: t1, dep: t1 }; // åªæœ‰ä¸€å€‹æ™‚é–“æ™‚è¦–ç‚ºåˆ°é”=é–‹è»Š
  if(!t1) return { arr: t2, dep: t2 };
  const m1 = parseTime(t1);
  const m2 = parseTime(t2);
  if(m1===null || m2===null) return { arr: t1, dep: t2 };

  // dep æ‡‰ >= arrï¼›è‹¥ t2 <= t1ï¼Œä»£è¡¨ t1è¼ƒæ™š â†’ t1=dep, t2=arr
  if(m2 <= m1) return { arr: t2, dep: t1 };
  // å¦å‰‡ t2è¼ƒæ™š â†’ t2=dep, t1=arr
  return { arr: t1, dep: t2 };
}


  // å–å¾—æŸåˆ—è»ŠæŸç«™ã€Œåˆ°é”/é–‹è»Šã€
  function getArrDepFromSchedule(schedule, trainNo, station){
    const t = schedule?.[trainNo];
    if(!t) return null;
    const row = (t['è»Šç«™æ™‚é–“']||[]).find(s=>s[0]===station);
    if(!row) return null;
    // row: å¯èƒ½æ˜¯ [station, åˆ°é”, é–‹è»Š] æˆ– [station, é–‹è»Š, åˆ°é”]
    const ad = splitArrDep(row);
    return { arr: ad.arr || '', dep: ad.dep || '' };
  }

  // å»ºç«‹æ¯ç«™ absMinï¼ˆè™•ç†è·¨æ—¥ï¼šæ™‚é–“è®Šå°å°± +1dayï¼‰
  function buildAbsMinutes(stops){
    // stops: [[station, arr, dep], ...] ä»¥ã€Œé–‹è»Šã€å„ªå…ˆåšæ’åºåŸºæº–ï¼ˆæ²’æœ‰å°±ç”¨åˆ°é”ï¼‰
    const out = [];
    let day = 0;
    let prev = null;

    for(let i=0;i<stops.length;i++){
      const ad = splitArrDep(stops[i]);
      const arr = ad.arr || '';
      const dep = ad.dep || '';
      const tStr = dep || arr;           // ç”¨é–‹è»Šç‚ºä¸»ï¼Œç¼ºæ‰ç”¨åˆ°é”
      const m = parseTime(tStr);
      if(m === null){
        out.push({abs:null, day:day});
        continue;
      }
      if(prev !== null && m < prev) day += 1;  // è·¨æ—¥
      const abs = day*1440 + m;
      out.push({abs, day});
      prev = m;
    }
    return out;
  }

  // é€²éšï¼šåŒæ™‚å»ºç«‹ã€Œåˆ°é”/é–‹è»Šã€çš„ absMinï¼ˆç”¨é–‹è»Š/åˆ°é”çš„è¼ƒæ™šè€…ä½œç‚ºè·¨æ—¥åˆ¤æ–·åŸºæº–ï¼‰
  // å›å‚³ï¼š{ absArr: number[]|null[], absDep: number[]|null[], day: number[] }
  function buildAbsArrDep(stops){
    const absArr = [];
    const absDep = [];
    const dayArr = [];
    let day = 0;
    let prevKey = null;

    for(let i=0;i<stops.length;i++){
      const arrStr = stops[i][1] || '';
      const depStr = stops[i][2] || '';

      const arrMin = parseTime(arrStr);
      const depMin = parseTime(depStr);

      // ç”¨ã€Œè¼ƒæ™šè€…ã€ç•¶ä½œè·¨æ—¥åˆ¤æ–· keyï¼ˆé¿å…åŒç«™åˆ°/é–‹å·® 1-2 åˆ†é€ æˆèª¤åˆ¤ï¼‰
      let keyMin = null;
      if(depMin !== null && arrMin !== null) keyMin = Math.max(depMin, arrMin);
      else keyMin = (depMin !== null) ? depMin : ((arrMin !== null) ? arrMin : null);

      if(keyMin === null){
        absArr.push(null); absDep.push(null); dayArr.push(day);
        continue;
      }

      if(prevKey !== null && keyMin < prevKey) day += 1; // è·¨æ—¥
      const base = day*1440;

      absArr.push(arrMin === null ? null : base + arrMin);
      absDep.push(depMin === null ? null : base + depMin);
      dayArr.push(day);
      prevKey = keyMin;
    }

    return { absArr, absDep, day: dayArr };
  }


  function getStopDateStr(originDateStr, absMin){
    if(absMin === null || absMin === undefined) return originDateStr;
    const dayOffset = Math.floor(absMin/1440);
    return addDays(originDateStr, dayOffset);
  }

  // ===== ç‹€æ…‹ï¼šç”¨ã€Œç™¼è»Šæ—¥ã€åˆ¤æ–·ï¼ˆä¸æ˜¯ç«™åˆ¥è·¨æ—¥å¾Œçš„æ—¥æœŸï¼‰ =====
  function getTrainStatusLabel(trainNo, originDateStr, firstTimeStr, lastTimeStr, passedStationTimeStr){
    const todayStr = fmtDate(new Date());

    // æœªä¾†ç™¼è»Šæ—¥ï¼šä¸€å¾‹æœªç™¼è»Š
    if(originDateStr && originDateStr > todayStr) return 'æœªç™¼è»Š';
    // éå»ç™¼è»Šæ—¥ï¼šä¸€å¾‹å·²åˆ°çµ‚é»
    if(originDateStr && originDateStr < todayStr) return 'å·²åˆ°çµ‚é»';

    // åªæœ‰ã€Œä»Šå¤©ç™¼è»Šã€æ‰æŠ“å³æ™‚
    let raw='';
    try{ if(typeof getDelayStatus==='function') raw = getDelayStatus(String(trainNo)) || ''; }catch(e){ raw=''; }

    // åœé§›/æˆªçŸ­ç­‰å„ªå…ˆé¡¯ç¤ºï¼ˆæ¯”å·²éç«™æ›´é‡è¦ï¼‰
    if(raw && /åœé§›|å–æ¶ˆ|æš«åœ|çµ‚æ­¢|é‹è½‰æ•´ç†|æˆªçŸ­|æŠ˜è¿”|éƒ¨åˆ†åœé§›/i.test(raw)) return raw;

    // å·²éç«™ï¼šä»¥ã€ŒæŸ¥è©¢çš„ç«™ï¼ˆå‡ºç™¼ç«™ / æŒ‡å®šè»Šç«™ï¼‰ã€çš„ã€Œé–‹è»Šæ™‚é–“ã€åˆ¤æ–·
    if(passedStationTimeStr && originDateStr === todayStr){
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();
      const passMin = parseTime(passedStationTimeStr);
      if(passMin !== null && nowMin > passMin) return 'å·²éç«™';
    }

    // å³æ™‚æº–é»/èª¤é»
    if(raw){
      if(/æº–é»/.test(raw)) return 'æº–é»';
      const m = raw.match(/æ™š\s*([\-\d]+)\s*åˆ†/);
      if(m){
        const d = parseInt(m[1],10);
        if(Number.isFinite(d) && d>0) return `èª¤é» ${d} åˆ†`;
        if(Number.isFinite(d) && d<0) return `ææ—© ${Math.abs(d)} åˆ†`;
        return 'æº–é»';
      }
      return raw || 'å³æ™‚';
    }

    // æ²’å³æ™‚è³‡è¨Šï¼šç”¨æ™‚é–“ç²—åˆ¤
    const f = parseTime(firstTimeStr);
    const l = parseTime(lastTimeStr);
    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();

    if(f !== null && nowMin < f) return 'æœªç™¼è»Š';
    if(f !== null && l !== null){
      const crosses = l < f;
      const endMin = crosses ? l+1440 : l;
      const nowAdj = crosses && nowMin < f ? nowMin+1440 : nowMin;
      if(nowAdj > endMin + 10) return 'å·²åˆ°çµ‚é»';
    }
    return 'ç„¡å³æ™‚è³‡è¨Š';
  }

  // ===== ç‹€æ…‹é¡è‰²ï¼šé»‘ / ç¶  / ç´… / ç°(å·²éç«™) =====
  function colorStatus(label){
    const s = String(label||'');
    if(s === 'æº–é»') return `<span style="color:#16a34a;font-weight:700">${s}</span>`;
    if(s === 'å·²éç«™') return `<span style="color:#94a3b8;font-weight:700">${s}</span>`;
    if(s === 'æœªç™¼è»Š' || s === 'å·²åˆ°çµ‚é»' || s === 'å·²åˆ°çµ‚é»ç«™') return `<span style="color:var(--text-main);font-weight:700">${s}</span>`;
    return `<span style="color:#dc2626;font-weight:700">${s}</span>`;
  }

  // ===== è©³ç´°è¦–çª—ç”¨ç‹€æ…‹ï¼ˆä¸é¡¯ç¤ºã€Œå·²éç«™ã€ï¼‰ =====
  function getStatusForModal(trainNo, originDateStr, stopsArr){
    const todayStr = fmtDate(new Date());

    // æœªä¾†/éå»ï¼šç›´æ¥å›ºå®š
    if(originDateStr && originDateStr > todayStr) return 'æœªç™¼è»Š';
    if(originDateStr && originDateStr < todayStr) return 'å·²åˆ°çµ‚é»ç«™';

    // åªæœ‰æŸ¥ä»Šå¤©æ‰æœ‰å³æ™‚æ„ç¾©
    let raw = '';
    try{ if(typeof getDelayStatus==='function') raw = getDelayStatus(String(trainNo)) || ''; }catch(e){ raw=''; }

    if(raw && /åœé§›|å–æ¶ˆ|æš«åœ|çµ‚æ­¢|é‹è½‰æ•´ç†|æˆªçŸ­|æŠ˜è¿”|éƒ¨åˆ†åœé§›/i.test(raw)) return 'åœé§›';

    const first = (splitArrDep(stopsArr?.[0]||[]).dep || splitArrDep(stopsArr?.[0]||[]).arr || '');
    const last  = (splitArrDep(stopsArr?.[stopsArr.length-1]||[]).arr || splitArrDep(stopsArr?.[stopsArr.length-1]||[]).dep || '');

    const f = parseTime(first);
    const l = parseTime(last);
    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();

    // è‹¥å·²è¶…éçµ‚é»æŠµé”æ™‚é–“ï¼ˆå«è·¨æ—¥ï¼‰ï¼Œå„ªå…ˆé¡¯ç¤ºã€Œå·²åˆ°çµ‚é»ç«™ã€ï¼ˆä¸è¦å†é¡¯ç¤ºæº–é»ï¼‰
    if(f !== null && l !== null){
      const crosses = l < f;
      const endMin = crosses ? l+1440 : l;
      const nowAdj = crosses && nowMin < f ? nowMin+1440 : nowMin;
      if(nowAdj > endMin + 10) return 'å·²åˆ°çµ‚é»ç«™';
      if(nowAdj < f) return 'æœªç™¼è»Š';
    }else{
      if(f !== null && nowMin < f) return 'æœªç™¼è»Š';
    }

    // å…ˆç”¨å³æ™‚èª¤é»é¡¯ç¤ºï¼ˆè‹¥æœ‰ï¼‰
    if(raw){
      if(/æº–é»/.test(raw)) return 'æº–é»';
      const m = raw.match(/æ™š\s*([\-\d]+)\s*åˆ†/);
      if(m){
        const d = parseInt(m[1],10);
        if(Number.isFinite(d) && d>0) return `èª¤é» ${d} åˆ†`;
        if(Number.isFinite(d) && d<0) return `ææ—© ${Math.abs(d)} åˆ†`;
        return 'æº–é»';
      }
    }else{
      const d = isQueryToday(originDateStr) ? getDelayMinutes(trainNo) : 0;
      if(d>0) return `èª¤é» ${d} åˆ†`;
      if(d<0) return `ææ—© ${Math.abs(d)} åˆ†`;
      if(isQueryToday(originDateStr)) return 'æº–é»';
    }

    return 'æº–é»';
  }

  function statusBadge(label){
    const s = String(label||'');
    // èƒŒæ™¯è‰²å¡Šï¼ˆæ¯”å–®ç´”å­—è‰²æ›´å¥½è®€ï¼‰
    let bg = 'rgba(15,23,42,.08)';
    let fg = 'var(--text-main)';
    if(s === 'æº–é»'){ bg = 'rgba(22,163,74,.12)'; fg = '#166534'; }
    else if(s === 'æœªç™¼è»Š'){ bg = 'rgba(100,116,139,.10)'; fg = '#334155'; }
    else if(s === 'å·²åˆ°çµ‚é»' || s === 'å·²åˆ°çµ‚é»ç«™'){ bg = 'rgba(37,99,235,.12)'; fg = '#1d4ed8'; }
    else if(s === 'åœé§›'){ bg = 'rgba(15,23,42,.85)'; fg = '#fff'; }
    else if(/èª¤é»/.test(s)){ bg = 'rgba(220,38,38,.12)'; fg = '#b91c1c'; }
    else if(/ææ—©/.test(s)){ bg = 'rgba(14,165,233,.14)'; fg = '#0369a1'; }

    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:${bg};color:${fg};font-weight:900;font-size:.85rem;white-space:nowrap;">${s}</span>`;
  }

  // ===== èµ·è¨–ç«™ç›´é”ï¼šå°éµeè¨‚é€š æ·±åº¦é€£çµï¼ˆTDXï¼‰=====
  
// =============================
// TDX OAuth2 (client credentials)
// âš ï¸ æ³¨æ„ï¼šæŠŠ clientSecret æ”¾åœ¨å‰ç«¯æ˜¯ä¸å®‰å…¨çš„ï¼›æ­£å¼ä¸Šç·šå»ºè­°æ”¹ç”±å¾Œç«¯ä»£å– tokenã€‚
// =============================


let _tdxTokenCache = { token: '', exp: 0 }; // exp: ms epoch
let _deeplinkInFlight = false;
let _deeplinkCooldownUntil = 0; // ms epoch
function _getDeeplinkCooldownMs(resp){
  const ra = resp?.headers?.get?.('retry-after');
  const sec = ra ? parseInt(ra,10) : NaN;
  if(Number.isFinite(sec) && sec>0) return sec*1000;
  return 12000; // default 12s
}

async function getTDXAccessToken(force=false){
  const now = Date.now();
  if(!force && _tdxTokenCache.token && now < _tdxTokenCache.exp - 30_000){
    return _tdxTokenCache.token;
  }
  const tokenUrl = 'https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token';
  const body = new URLSearchParams({
    grant_type: 'client_credentials',
    client_id: TDX_CONFIG.clientId,
    client_secret: TDX_CONFIG.clientSecret
  });

  let res;
  try{
    res = await fetch(tokenUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body
    });
  }catch(err){
    // å¤šæ•¸æƒ…æ³æ˜¯ç€è¦½å™¨ CORS / Mixed content / ç¶²è·¯é˜»æ“‹
    console.error(err);
    throw new Error('ç„¡æ³•é€£ç·šåˆ° TDX Token ç«¯é»ï¼ˆå¯èƒ½æ˜¯ç€è¦½å™¨ CORS é™åˆ¶æˆ–ç¶²è·¯é˜»æ“‹ï¼‰ã€‚');
  }

  if(!res.ok){
    const t = await res.text().catch(()=> '');
    console.error('TDX token error', res.status, t);
    throw new Error('TDX Token å–å¾—å¤±æ•—ï¼ˆHTTP ' + res.status + 'ï¼‰ã€‚');
  }
  const data = await res.json();
  const token = data.access_token || '';
  const expiresIn = Number(data.expires_in || 0);
  if(!token) throw new Error('TDX Token å›å‚³æ ¼å¼ç•°å¸¸ï¼ˆæ²’æœ‰ access_tokenï¼‰ã€‚');

  _tdxTokenCache = {
    token,
    exp: Date.now() + Math.max(60, expiresIn) * 1000
  };
  return token;
}

async function openTraBookingDeepLink(trainNo, startStationName, endStationName, dateStr) {
    if (_deeplinkInFlight) return;
    _deeplinkInFlight = true;

    try {
        const token = await getTDXAccessToken();
        const sName = normTW(startStationName);
        const eName = normTW(endStationName);

        // å»ºç«‹è«‹æ±‚é€£çµ
        const url = `https://tdx.transportdata.tw/api/maas-tra/booking/deeplink/direct/tra?start_station=${encodeURIComponent(sName)}&end_station=${encodeURIComponent(eName)}&train_date=${encodeURIComponent(dateStr)}&train_number=${encodeURIComponent(String(trainNo))}`;

        // 1. å…ˆç”¨ fetch å–å¾—è·³è½‰å¾Œçš„çœŸæ­£é€£çµ (Deeplink)
        const res = await fetch(url, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            const data = await res.json();
            // TDX API é€šå¸¸æœƒå›å‚³ä¸€å€‹åŒ…å« URL çš„ JSON æˆ–ç›´æ¥è·³è½‰
            const deepLinkUrl = data.DeepLinkUrl || data.url || data.Deeplink;
            
            if (deepLinkUrl) {
                // 2. çœŸæ­£è§¸ç™¼æ‰‹æ©Ÿ App çš„å‹•ä½œ
                window.location.href = deepLinkUrl;
            } else {
                // å¦‚æœ API æ˜¯ç›´æ¥åš 302 è·³è½‰ï¼Œä¸Šé¢çš„ fetch å¯èƒ½æœƒæ‹¿ä¸åˆ° JSON
                // é€™ç¨®æƒ…æ³æœ€ç°¡å–®çš„æ–¹æ³•æ˜¯ç›´æ¥åœ¨æ–°è¦–çª—æ‰“é–‹ API URLï¼Œè®“ç€è¦½å™¨è™•ç†è·³è½‰
                window.open(url + `&access_token=${token}`, '_blank');
            }
        } else if (res.status === 429) {
            alert("è«‹æ±‚å¤ªé »ç¹ï¼Œè«‹ç¨å€™å†è©¦");
        }
    } catch (err) {
        console.error("è¨‚ç¥¨è·³è½‰å¤±æ•—:", err);
        alert("ç„¡æ³•é–‹å•Ÿè¨‚ç¥¨é€£çµï¼Œè«‹ç¢ºèªæ˜¯å¦å·²å®‰è£ã€å°éµeè¨‚é€šã€App");
    } finally {
        _deeplinkInFlight = false;
    }
}


  // ===== å–æ¶ˆå°–å³°æ™‚é–“ç‰¹åˆ¥é¡è‰² =====
  function highlightPeak(t){ return t || '--'; }

  // ===== è€—æ™‚æ¢ï¼šæ¥µç«¯å€¼è™•ç†ï¼ˆP95 capï¼‰+ æ¼¸å±¤è‰² =====
  function percentile(sortedArr, p){
    if(!sortedArr || !sortedArr.length) return 1;
    const idx = (sortedArr.length - 1) * p;
    const lo = Math.floor(idx), hi = Math.ceil(idx);
    if(lo === hi) return sortedArr[lo];
    const w = idx - lo;
    return sortedArr[lo] * (1 - w) + sortedArr[hi] * w;
  }
  function travelColor(norm01){
    const t = Math.max(0, Math.min(1, norm01));
    const hue = 120 + (10 - 120) * t; // ç¶  -> ç´…
    return {
      a: `hsl(${hue.toFixed(1)}, 85%, 52%)`,
      b: `hsl(${hue.toFixed(1)}, 85%, 40%)`
    };
  }
  function getTravelBarStyle(travelMin, capMin){
    const cap = Math.max(1, capMin || 1);
    const isExtreme = travelMin >= cap;
    const norm = isExtreme ? 1 : (travelMin / cap);
    const widthPct = Math.max(0, Math.min(1, norm)) * 100;
    const {a,b} = travelColor(norm);
    const fillBg = `linear-gradient(90deg, ${a}, ${b})`;
    return { widthPct, isExtreme, fillBg };
  }


  // ===== è»Šç¨®é¡è‰²ï¼šå¤ªé­¯é–£è—ã€è’å…‰æ©˜ =====
  function colorType(t){
    const map={
      å¤ªé­¯é–£:'#2563eb',
      è’å…‰è™Ÿ:'#ea580c',
      æ–°è‡ªå¼·:'#8600FF',
      æ™®æ‚ ç‘ª:'#db2777',
      'è‡ªå¼·è™Ÿ(æ–°)':'#e11d48',
      'è‡ªå¼·è™Ÿ':'#e11d48',
      å€é–“å¿«:'#16a34a',
      å¾©èˆˆè™Ÿ:'#0284c7',
      å€é–“è»Š:document.body.classList.contains('dark-mode')?'#a3a3a3':'#475569',
      åŠ ç­è»Š:'#0ea5e9'
    };
    const c=map[t]||'#64748b';
    return `<span style="color:${c};font-weight:700">${t}</span>`;
  }

  // ===== UIï¼šæœå°‹æ­·å² =====
  const HISTORY_KEY='tra_search_history_v2';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); }catch(e){ return []; } }
  function saveHistory(list){ localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,10))); }
  
  // ===== æ·±å¤œæ¨¡å¼ï¼ˆdark-modeï¼‰ =====
  function setupThemeToggle(){
    const btn = document.getElementById('themeToggle');
    if(!btn) return;

    // init from storage
    const saved = localStorage.getItem('tra_theme') || '';
    if(saved === 'dark'){
      document.body.classList.add('dark-mode');
      btn.textContent = 'â˜€ï¸ æ—¥é–“æ¨¡å¼';
    }else{
      btn.textContent = 'ğŸŒ™ æ·±å¤œæ¨¡å¼';
    }

    btn.addEventListener('click', async ()=>{
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('tra_theme', isDark ? 'dark' : 'light');
      btn.textContent = isDark ? 'â˜€ï¸ æ—¥é–“æ¨¡å¼' : 'ğŸŒ™ æ·±å¤œæ¨¡å¼';

      // é¡è‰²å¯èƒ½æœƒè·Ÿè‘—æ”¹ï¼ˆè»Šç¨®é¡è‰²ï¼‰ï¼Œé‡æ–°æ¸²æŸ“å¯è¦‹çµæœ
      try{
        if(typeof rerenderVisibleResults === 'function') await rerenderVisibleResults();
      }catch(e){}
    });
  }

function renderHistory(){
    const box=document.getElementById('searchHistory');
    if(!box) return;
    const list=loadHistory();
    box.innerHTML='';
    list.forEach(item=>{
      const chip=document.createElement('div');
      chip.className='history-chip';
      chip.textContent=`${item.s} â†’ ${item.e}`;
      chip.addEventListener('click',()=>{
        document.getElementById('startStation').value=item.s;
        document.getElementById('endStation').value=item.e;
        document.getElementById('acceptTransfers').checked=!!item.t;
        runStartEndSearch();
      });
      box.appendChild(chip);
    });
  }

  // ===== è»Šç¨®ç¯©é¸ Chips =====
  let selectedTrainTypesStartEnd=[];
  let selectedTrainTypesStation=[];
  function buildTrainTypeChips(containerId, onChange){
    const box=document.getElementById(containerId);
    if(!box) return;
    box.innerHTML='';
    const types=new Set(Object.keys(baseSchedule||{}).map(k=>baseSchedule[k]['è»Šç¨®']).filter(Boolean));
    Array.from(types).sort().forEach(type=>{
      const lab=document.createElement('label');
      lab.className='chip-label';
      lab.innerHTML=`<input type="checkbox" value="${type}"><span>${type}</span>`;
      const cb=lab.querySelector('input');
      cb.addEventListener('change',()=>onChange());
      box.appendChild(lab);
    });
  }
  function getSelectedTypes(containerId){
    return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)).map(x=>x.value);
  }

  // ===== è³‡æ–™åˆ·æ–°ï¼šåŒæ™‚æŠ“æŸ¥è©¢æ—¥ + å‰ä¸€å¤©ï¼ˆè£œè·¨æ—¥ç«™åˆ¥ï¼‰ =====
  async function refreshData(dateStr){
    currentQueryDateStr = dateStr || '';

    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('loading-text').textContent = `æ­£åœ¨ç²å– ${dateStr} çœŸå¯¦æ™‚åˆ»è¡¨...`;

    // å…ˆæŠ“ç•¶å¤©ï¼ˆç™¼è»Šæ—¥ = dateStrï¼‰
    await fetchRealData(dateStr);
    baseSchedule = (typeof structuredClone==='function') ? structuredClone(window.trainSchedule) : JSON.parse(JSON.stringify(window.trainSchedule||{}));

    // å†æŠ“å‰ä¸€å¤©ï¼ˆç™¼è»Šæ—¥ = dateStr-1ï¼‰
    const prevDate = addDays(dateStr, -1);
    await fetchRealData(prevDate);
    prevSchedule = (typeof structuredClone==='function') ? structuredClone(window.trainSchedule) : JSON.parse(JSON.stringify(window.trainSchedule||{}));

    // æŠ“å®Œå†æŠ“å›ç•¶å¤©ï¼ˆé¿å… UI å…¶ä»–åŠŸèƒ½èª¤ç”¨åˆ° prevï¼‰
    await fetchRealData(dateStr);
    window.trainSchedule = baseSchedule;

    // åªæœ‰æŸ¥ã€Œä»Šå¤©ã€æ‰æŠ“å³æ™‚èª¤é»ï¼ˆè€Œä¸”åªå°ã€Œä»Šå¤©ç™¼è»Šã€æœ‰æ•ˆï¼‰
    const todayStr = fmtDate(new Date());
    if(dateStr === todayStr) await updateLiveDelay();

    buildStationIndex();

    // å»º train instance listï¼ˆé¿å…åŒè»Šæ¬¡è·¨æ—¥ key è¦†è“‹ï¼‰
    originDateByKey = {};
    scheduleKeyList = [];

    Object.keys(baseSchedule||{}).forEach(trainNo=>{
      const key = `${trainNo}@${dateStr}`;
      originDateByKey[key] = dateStr;
      scheduleKeyList.push({ key, trainNo, originDate: dateStr, data: baseSchedule[trainNo] });
    });
    Object.keys(prevSchedule||{}).forEach(trainNo=>{
      const key = `${trainNo}@${prevDate}`;
      originDateByKey[key] = prevDate;
      scheduleKeyList.push({ key, trainNo, originDate: prevDate, data: prevSchedule[trainNo] });
    });

    fillStationDatalist('');
    fillTrainDatalist('');

    buildTrainTypeChips('trainTypeChipsStartEnd', ()=>{});
    buildTrainTypeChips('trainTypeChipsStation', ()=>{});
    renderHistory();

    document.getElementById('loading-overlay').style.display = 'none';
  }

  // ===== åˆå§‹åŒ– =====
  window.addEventListener('load', async ()=>{
    bindQueryTabs();
    switchQueryPanel('panel-startend');
    initDatePickerWindow();
    setupThemeToggle();

    const dateInput = document.getElementById('mainQueryDate');
    await refreshData(dateInput?.value);

    // ä½ åŸæœ¬çš„æ›´æ–°è³‡æ–™æŒ‰éˆ•ï¼šä¿æŒå­˜åœ¨
    const refreshBtn = document.getElementById('refreshBtn');
    if(refreshBtn){
      refreshBtn.addEventListener('click', async ()=>{
        await refreshData(document.getElementById('mainQueryDate')?.value);
      });
    }

    // åªåœ¨ã€ŒæŸ¥è©¢æ—¥=ä»Šå¤©ã€æ¯åˆ†é˜æ›´æ–°å³æ™‚èª¤é»
    window.rerenderVisibleResults = async function(){
  // ä¾ç…§æœ€å¾Œä¸€æ¬¡æŸ¥è©¢æ¢ä»¶ï¼ŒæŠŠç•«é¢ã€Œç”¨åŒæ¨£æ¢ä»¶ã€é‡è·‘ä¸€æ¬¡
  if(lastStartEndQuery){
    selectedTrainTypesStartEnd = getSelectedTypes('trainTypeChipsStartEnd');
    if(lastStartEndQuery.accept){
      buildTransferList(lastStartEndQuery.st, lastStartEndQuery.ed);
      renderTransferTable();
    }else{
      buildDirectList(lastStartEndQuery.st, lastStartEndQuery.ed);
      renderStartEndTable();
    }
  }

  if(lastStationQuery){
    // ç«™åæŸ¥è©¢æœ¬èº«æœƒè®€ input / dir / chipsï¼Œç›´æ¥å‘¼å«å³å¯
    filterTrainScheduleByStationName();
  }

  if(lastTrainQuery && lastTrainQuery.trainNo){
    filterTrainScheduleByNumber();
  }

  // å¦‚æœ Modal æ­£åœ¨é–‹è‘—ï¼Œä¹Ÿæ›´æ–°å®ƒçš„æ¨™é¡Œç‹€æ…‹ï¼ˆä¸é¡¯ç¤ºå·²éç«™ï¼‰
  if(modalCtx && modal && modal.style.display === 'flex'){
    // é‡æ–°æ¸²æŸ“ä¸€æ¬¡è©³ç´°è³‡è¨Šï¼ˆå®ƒæœƒç”¨åŒä¸€è»Šæ¬¡èˆ‡ originDateï¼‰
    showTrainDetails(modalCtx.trainNo, modalCtx.originDate);
  }
}

// æ¯åˆ†é˜è‡ªå‹•æ›´æ–°ï¼šåªåœ¨ã€ŒæŸ¥ä»Šå¤©ã€æ‰æœ‰æ„ç¾©
setInterval(async ()=>{
  const cur = document.getElementById('mainQueryDate')?.value;
  const todayStr = fmtDate(new Date());
  if(cur !== todayStr) return;

  if(typeof updateLiveDelay === 'function'){
    await updateLiveDelay();      // æŠ“æœ€æ–°å³æ™‚èª¤é»
    await rerenderVisibleResults(); // ç«‹åˆ»æŠŠç•«é¢ç‹€æ…‹æ›´æ–°æˆæœ€æ–°
  }
}, 60000);


    // ç«™åè¼¸å…¥ï¼šfocus å…¨é¡¯ç¤ºï¼›input éæ¿¾ï¼›blur æ­£è¦åŒ–
    bindStationInput('startStation');
    bindStationInput('endStation');
    bindStationInput('stationNameInput');

    // è»Šæ¬¡è¼¸å…¥
    bindTrainInput('trainNumberInput');

    // é»å°é»è¡¨æ ¼æ’åºï¼ˆå‡ºç™¼/æŠµé”/è€—æ™‚ï¼‰
    initStartEndSorting();
  });

  function bindStationInput(inputId){
    const input = document.getElementById(inputId);
    if(!input) return;

    // â˜… æ‰‹æ©Ÿå„ªåŒ–ï¼šdebounce + rAFï¼Œé¿å…æ¯æ¬¡ keypress éƒ½å¤§é‡é‡å»º datalist
    let tmr = null;
    let raf = null;
    const schedule = ()=>{
      if(tmr) clearTimeout(tmr);
      tmr = setTimeout(()=>{
        if(raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(()=>fillStationDatalist(input.value));
      }, 120);
    };

    input.addEventListener('focus', ()=> fillStationDatalist(input.value)); // ç©ºç™½æœƒé¡¯ç¤ºå‰ N ç«™
    input.addEventListener('input', schedule, { passive: true });

    input.addEventListener('blur', ()=>{
      const resolved = extractStationNameFromInput(input.value);
      if(resolved) input.value = resolved;
      if(tmr) clearTimeout(tmr);
      if(raf) cancelAnimationFrame(raf);
      fillStationDatalist('');
    });
  }

  function bindTrainInput(inputId){
    const input = document.getElementById(inputId);
    if(!input) return;

    let tmr = null;
    let raf = null;
    const schedule = ()=>{
      if(tmr) clearTimeout(tmr);
      tmr = setTimeout(()=>{
        if(raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(()=>fillTrainDatalist(input.value));
      }, 120);
    };

    input.addEventListener('focus', ()=> fillTrainDatalist(input.value));
    input.addEventListener('input', schedule, { passive: true });

    input.addEventListener('blur', ()=>{
      const no = extractTrainNoFromInput(input.value);
      if(no) input.value = no;
      if(tmr) clearTimeout(tmr);
      if(raf) cancelAnimationFrame(raf);
      fillTrainDatalist('');
    });
  }

  // ===== é»å°é» / è½‰ä¹˜ =====
  let currentStartEndList=[];
  let currentTransferList=[];

  function runStartEndSearch(){
    const st = extractStationNameFromInput(document.getElementById('startStation').value);
    const ed = extractStationNameFromInput(document.getElementById('endStation').value);
    document.getElementById('startStation').value=st;
    document.getElementById('endStation').value=ed;
    if(!st || !ed) return;

    const accept=document.getElementById('acceptTransfers').checked;
    lastStartEndQuery = { st, ed, accept };
    const h=loadHistory().filter(x=>!(x.s===st && x.e===ed && x.t===accept));
    h.unshift({s:st,e:ed,t:accept});
    saveHistory(h);
    renderHistory();

    selectedTrainTypesStartEnd=getSelectedTypes('trainTypeChipsStartEnd');

    if(accept){
      buildTransferList(st, ed);
      renderTransferTable();
    }else{
      buildDirectList(st, ed);
      renderStartEndTable();
    }
  }

  function buildDirectList(st, ed){
  const list = [];

  Object.keys(baseSchedule||{}).forEach(num=>{
    const t = baseSchedule[num];
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['è»Šç¨®'])) return;

    const arr = t['è»Šç«™æ™‚é–“'] || [];
    const si = arr.findIndex(x=>x[0]===st);
    const ei = arr.findIndex(x=>x[0]===ed);
    if(si<0 || ei<0 || ei<=si) return;

    const abs = buildAbsMinutes(arr);
    const stAbs = abs[si]?.abs;
    const edAbs = abs[ei]?.abs;
    if(stAbs === null || edAbs === null) return;

    const depSched = splitArrDep(arr[si]).dep || '--'; // å‡ºç™¼ï¼šé–‹è»Š
    const arrSched = splitArrDep(arr[ei]).arr || '--'; // æŠµé”ï¼šåˆ°é”

    // â˜…â˜… æ ¸å¿ƒï¼šå¥—ç”¨èª¤é»æ™‚é–“ â˜…â˜…
    const depAdj = getAdjustedTime(num, depSched, currentQueryDateStr);
    const arrAdj = getAdjustedTime(num, arrSched, currentQueryDateStr);

    const travelMin = edAbs - stAbs;
    const travel = `${Math.floor(travelMin/60)}h ${travelMin%60}m`;
    const stopsCount = ei - si - 1;

    const originDate = currentQueryDateStr;
    const status = getTrainStatusLabel(
      num,
      originDate,
      (arr[0]?.[2]||arr[0]?.[1]||''),
      (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||''),
      depSched
    );

    list.push({
      num,
      type: t['è»Šç¨®'],
      range: `${arr[0][0]}â${arr[arr.length-1][0]}`,
      depSched,
      arrSched,
      depHTML: renderTimeWithDelay(num, depSched, currentQueryDateStr, { suppressStrike: status==='å·²éç«™' }),
      arrHTML: renderTimeWithDelay(num, arrSched, currentQueryDateStr, { suppressStrike: (status==='å·²åˆ°çµ‚é»' || status==='å·²éç«™') }),
      depSortMin: depAdj.adjMin ?? 9999, // â˜… æ’åºç”¨ï¼šèª¤é»å¾Œæ™‚é–“
      arrSortMin: arrAdj.adjMin ?? 9999, // â˜… æ’åºç”¨ï¼šèª¤é»å¾ŒæŠµé”æ™‚é–“
      travel,
      travelMin,
      stopsCount,
      status,
      startStation: st,
      endStation: ed
    });
  });

  // â˜… ç”¨ã€Œèª¤é»å¾Œæ™‚é–“ã€æ’åº
  list.sort((a,b)=>a.depSortMin - b.depSortMin);
  currentStartEndList = list;
}


  // ===== å³æ™‚èª¤é»ï¼šå–åˆ†é˜æ•¸ï¼ˆæ™šåˆ°/ææ—©ï¼‰ =====
function getDelayMinutes(trainNo){
  let raw = '';
  try { raw = (typeof getDelayStatus === 'function') ? (getDelayStatus(String(trainNo)) || '') : ''; } catch(e){ raw=''; }
  if(!raw) return 0;

  // å¸¸è¦‹æ ¼å¼ï¼šæ™š 5 åˆ†ã€æ™š5åˆ†
  let m = raw.match(/æ™š\s*([\-]?\d+)\s*åˆ†/);
  if(m) return parseInt(m[1], 10) || 0;

  // ä¹Ÿæ”¯æ´ä½  UI è½‰æˆçš„å­—ä¸²ï¼šèª¤é» 5 åˆ† / ææ—© 3 åˆ†
  m = raw.match(/èª¤é»\s*([\-]?\d+)\s*åˆ†/);
  if(m) return parseInt(m[1], 10) || 0;

  m = raw.match(/ææ—©\s*([\-]?\d+)\s*åˆ†/);
  if(m) return -(parseInt(m[1], 10) || 0);

  return 0;
}

function addMinutesToHHMM(hhmm, deltaMin){
  if(!hhmm || !/^\d{1,2}:\d{2}$/.test(hhmm)) return hhmm;
  const [h, m] = hhmm.split(':').map(x=>parseInt(x,10));
  let t = h*60 + m + deltaMin;
  // å…è¨±è·¨æ—¥ï¼šé™åˆ¶åœ¨ 0..1439 å…§
  t = ((t % 1440) + 1440) % 1440;
  const nh = String(Math.floor(t/60)).padStart(2,'0');
  const nm = String(t%60).padStart(2,'0');
  return `${nh}:${nm}`;
}

// åªåœ¨ã€ŒæŸ¥ä»Šå¤©ã€æ‰å¥—ç”¨èª¤é»æ™‚é–“
function isQueryToday(dateStr){
  const todayStr = fmtDate(new Date());
  return !!dateStr && dateStr === todayStr;
}

// å›å‚³ï¼š{sched, adj, adjMin, hasDelay}
function getAdjustedTime(trainNo, schedHHMM, queryDateStr){
  const sched = schedHHMM || '--';
  if(!isQueryToday(queryDateStr)) {
    return { sched, adj: sched, adjMin: parseTime(sched), hasDelay: false };
  }
  const dmin = getDelayMinutes(trainNo);
  // åªæœ‰ã€ŒçœŸçš„æœ‰èª¤é»/ææ—©ã€æ‰é¡¯ç¤ºé›™æ™‚é–“ï¼›0 å°±ä¿æŒå–®æ™‚é–“
  if(!dmin) return { sched, adj: sched, adjMin: parseTime(sched), hasDelay: false };
  const adj = addMinutesToHHMM(sched, dmin);
  return { sched, adj, adjMin: parseTime(adj), hasDelay: true };
}

// ===== è¨‚ç¥¨å¯ç”¨æ€§åˆ¤æ–·ï¼ˆå°è™Ÿè»Š + é–‹è»Š>=ç¾åœ¨+10åˆ†é˜ï¼‰ =====
function isSpecialCharterTrainNo(trainNo){
  const s = String(trainNo||'').trim();
  return /^6\d{3}$/.test(s); // 6xxx å°ˆè»Š
}

function isNonReservedLocalType(typeStr){
  const t = String(typeStr||'');
  // å€é–“ / å€é–“å¿« ä¸€å¾‹ä¸å¯è¨‚ç¥¨
  return t.includes('å€é–“å¿«') || t.includes('å€é–“');
}

function buildDateTimeFromDateAndHHMM(dateStr, hhmm){
  // dateStr: YYYY-MM-DD, hhmm: HH:MM
  if(!dateStr || !hhmm || hhmm==='--') return null;
  const m = /^\s*(\d{1,2}):(\d{2})\s*$/.exec(hhmm);
  if(!m) return null;
  const [y,mo,d] = String(dateStr).split('-').map(x=>parseInt(x,10));
  const H = parseInt(m[1],10), M = parseInt(m[2],10);
  // ç”¨æœ¬åœ°æ™‚å€ï¼ˆä½ ç’°å¢ƒ +08ï¼‰
  return new Date(y, (mo||1)-1, d||1, H, M, 0, 0);
}

function getBookingEligibilityByRow(r){
  // r: currentStartEndList item
  if(!r) return { ok:false, reason:'ç„¡æ³•å–å¾—åˆ—è»Šè³‡è¨Š' };

  const trainNo = String(r.num||'').trim();
  const typeStr = String(r.type||'');

  if(isSpecialCharterTrainNo(trainNo) || typeStr.includes('å°ˆè»Š')){
    return { ok:false, reason:'å°ˆè»Šä¸æä¾›è¨‚ç¥¨' };
  }
  if(isNonReservedLocalType(typeStr)){
    return { ok:false, reason:'å€é–“/å€é–“å¿«ä¸æä¾›è¨‚ç¥¨' };
  }

  // ä»¥ã€Œèª¤é»å¾Œã€é–‹è»Šæ™‚é–“åˆ¤æ–·æ˜¯å¦>=ç¾åœ¨+10åˆ†é˜
  const tAdj = getAdjustedTime(trainNo, r.depSched, currentQueryDateStr);
  const depHHMM = (tAdj && tAdj.adj) ? tAdj.adj : r.depSched;
  const depDT = buildDateTimeFromDateAndHHMM(currentQueryDateStr, depHHMM);
  if(!depDT) return { ok:false, reason:'é–‹è»Šæ™‚é–“ç„¡æ³•åˆ¤æ–·' };

  const now = new Date();
  const threshold = new Date(now.getTime() + 10*60*1000);
  if(depDT < threshold){
    return { ok:false, reason:'é–‹è»Šæ™‚é–“è·é›¢ç¾åœ¨æœªæ»¿10åˆ†é˜' };
  }

  return { ok:true, reason:'' };
}



// UIï¼šæŠŠæ™‚é–“é¡¯ç¤ºæˆã€ŒåŸæ™‚é–“åˆªç·š + æ–°æ™‚é–“ã€

// UIï¼šæŠŠæ™‚é–“é¡¯ç¤ºæˆã€ŒåŸæ™‚é–“åˆªç·š + æ–°æ™‚é–“ã€
// opts: { suppressStrike?: boolean }  // å·²éç«™æ™‚å¯é—œé–‰åˆªç·šï¼Œåªé¡¯ç¤ºæ›´æ–°å¾Œæ™‚é–“
function renderTimeWithDelay(trainNo, schedHHMM, queryDateStr, opts){
  const t = getAdjustedTime(trainNo, schedHHMM, queryDateStr);
  if(!t.hasDelay) return (schedHHMM || '--');

  const suppress = !!(opts && opts.suppressStrike);
  if(suppress){
    return `<span style="color:var(--text-main);">${t.adj}</span>`;
  }

  // ä¸å‹•ä½ åŸæœ¬ CSSï¼šç”¨ inline style
  return `
    <span style="text-decoration:line-through;color:var(--text-muted);margin-right:6px;">
      ${t.sched}
    </span>
    <span style="font-weight:800;color:var(--text-main);">
      ${t.adj}
    </span>
  `;
}


  function renderStartEndTable(){
    // å‹•æ…‹åˆ‡æ›è¡¨é ­ï¼ˆèµ·è¨–ç«™/ç›´é”æ¨¡å¼ï¼‰
    const table = document.getElementById('scheduleTableByStation');
    const theadTr = table?.querySelector('thead tr');
    if(theadTr){
      theadTr.innerHTML = `
        <th>è»Šæ¬¡</th><th>è»Šç¨® (å€é–“)</th>
        <th>å‡ºç™¼ <span id="sortDepIcon">â†•</span></th>
        <th>æŠµé” <span id="sortArrIcon">â†•</span></th>
        <th>è€—æ™‚ <span id="sortDurIcon">â†•</span></th>
        <th>åœé </th>
        <th>ç‹€æ…‹</th>
        <th style="text-align:center">è¨‚ç¥¨</th>
      `;
      initStartEndSorting();
      updateStartEndSortIcons();
    }

    const tbody = document.querySelector('#scheduleTableByStation tbody');
    if(!tbody) return;
    tbody.innerHTML='';

    // å–®ä¸€äº‹ä»¶ä»£ç†ï¼šåˆ—é»æ“Šé–‹è©³æƒ…ï¼›ç¥¨åˆ¸æŒ‰éˆ•é»æ“Šè·³ APPï¼›åœé å±•é–‹
    tbody.onclick = async (e)=>{
      const ticket = e.target.closest('.ticket-btn');
      if(ticket){
        e.stopPropagation();
        const idx = Number(ticket.dataset.idx);
        const r = currentStartEndList[idx];
        if(!r) return;

        // disabledï¼šé¡¯ç¤ºåŸå› 
        if(ticket.dataset.disabled === '1' || ticket.disabled){
          const reason = ticket.dataset.reason || 'æ­¤ç­æ¬¡ç›®å‰ä¸å¯è¨‚ç¥¨';
          alert(reason);
          return;
        }

        // å†æ¬¡ä¿éšªï¼ˆé¿å…è³‡æ–™æ›´æ–°å¾Œä»å¯é»ï¼‰
        const elig = getBookingEligibilityByRow(r);
        if(!elig.ok){
          alert(elig.reason || 'æ­¤ç­æ¬¡ç›®å‰ä¸å¯è¨‚ç¥¨');
          return;
        }

        try{
          await openTraBookingDeepLink(r.num, r.startStation, r.endStation, currentQueryDateStr);
        }catch(err){
          const msg = String(err && err.message ? err.message : err);
          if(msg.includes('HTTP_429') || msg.includes('429')){
            alert('è¨‚ç¥¨æœå‹™ç›®å‰å¤ªå¤šäººä½¿ç”¨ï¼ˆ429ï¼‰ã€‚\nè«‹ç¨å¾Œç´„ 15 ç§’å†è©¦ä¸€æ¬¡ã€‚');
            return;
          }
          if(msg.includes('TOO_FAST_IN_FLIGHT')){
            alert('è¨‚ç¥¨é€£çµç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™ã€‚');
            return;
          }
          if(msg.includes('TOO_FAST_COOLDOWN')){
            const sec = Math.ceil(Math.max(0, _deeplinkCooldownUntil - Date.now())/1000);
            alert(`è«‹ç¨å€™ ${sec} ç§’å†è©¦ä¸€æ¬¡ã€‚`);
            return;
          }
          console.error(err);
          alert('å–å¾—è¨‚ç¥¨é€£çµå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
        return;
      }

      const arrow = e.target.closest('.toggle-arrow');
      if(arrow){
        e.stopPropagation();
        const tr = arrow.closest('tr');
        const idx = Number(tr?.dataset?.idx);
        const r = currentStartEndList[idx];
        if(!r) return;
        toggleStopsRow(tr, r.startStation, r.endStation, r.num);
        return;
      }

      const tr = e.target.closest('tr');
      if(!tr || tr.parentElement !== tbody) return;
      const idx = Number(tr.dataset.idx);
      const r = currentStartEndList[idx];
      if(!r) return;
      showTrainDetails(r.num, currentQueryDateStr);
    };

    const mins = currentStartEndList.map(r=>r.travelMin).filter(x=>Number.isFinite(x)).sort((a,b)=>a-b);
    const cap = percentile(mins, 0.95); // P95 ç•¶ä¸Šé™ï¼Œæ¥µç«¯å€¼å¡—æ»¿

    currentStartEndList.forEach((r, idx)=>{
      let tr = tbody.insertRow();
      tr.dataset.idx = idx;

      tr.insertCell().innerHTML = String(r.num).includes('A')
        ? `<b>${r.num}</b><span class="badge-sea">æµ·</span>`
        : `<b>${r.num}</b>`;

      tr.insertCell().innerHTML = `${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
      tr.insertCell().innerHTML = r.depHTML;
      tr.insertCell().innerHTML = r.arrHTML;

      const bar = getTravelBarStyle(r.travelMin, cap);
      let cell = tr.insertCell();
      cell.innerHTML = `
        <div style="font-size:.85rem;font-weight:600">
          ${r.travel}${bar.isExtreme ? ' <span style="color:var(--text-muted);font-weight:600">(æ¥µç«¯)</span>' : ''}
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${bar.widthPct.toFixed(1)}%;background:${bar.fillBg};"></div>
        </div>`;

      let stopsCell = tr.insertCell();
      if(r.stopsCount>0){
        stopsCell.innerHTML = `${r.stopsCount}ç«™ <span class="toggle-arrow">â–¼</span>`;
      } else {
        stopsCell.innerHTML = '<span style="color:#16a34a;font-weight:600">ç›´é”</span>';
      }

      tr.insertCell().innerHTML = colorStatus(r.status);

      // è¨‚ç¥¨ï¼šåƒ…èµ·è¨–ç«™ç›´é”æ¨¡å¼æä¾›
      const ticketCell = tr.insertCell();
      ticketCell.style.textAlign = 'center';
      const elig = getBookingEligibilityByRow(r);
      if(elig.ok){
        ticketCell.innerHTML = `<button class="ticket-btn" data-idx="${idx}" title="é–‹å•Ÿå°éµeè¨‚é€šè¨‚ç¥¨">ğŸ«</button>`;
      }else{
        ticketCell.innerHTML = ``;
      }
    });
  };

    const mins = currentStartEndList.map(r=>r.travelMin).filter(x=>Number.isFinite(x)).sort((a,b)=>a-b);
    const cap = percentile(mins, 0.95); // P95 ç•¶ä¸Šé™ï¼Œæ¥µç«¯å€¼å¡—æ»¿

    currentStartEndList.forEach(r=>{
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=String(r.num).includes('A')?`<b>${r.num}</b><span class="badge-sea">æµ·</span>`:`<b>${r.num}</b>`;
      tr.insertCell().innerHTML=`${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
      tr.insertCell().innerHTML = r.depHTML;
      tr.insertCell().innerHTML = r.arrHTML;

      const bar = getTravelBarStyle(r.travelMin, cap);

      let cell=tr.insertCell();
      cell.innerHTML=`
        <div style="font-size:.85rem;font-weight:600">
          ${r.travel}${bar.isExtreme ? ' <span style="color:var(--text-muted);font-weight:600">(æ¥µç«¯)</span>' : ''}
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="
            width:${bar.widthPct.toFixed(1)}%;
            background:${bar.fillBg};
          "></div>
        </div>`;

      let stopsCell=tr.insertCell();
      if(r.stopsCount>0){
        stopsCell.innerHTML=`${r.stopsCount}ç«™ <span class="toggle-arrow">â–¼</span>`;
        stopsCell.querySelector('.toggle-arrow').addEventListener('click',e=>{
          e.stopPropagation();
          toggleStopsRow(tr,r.startStation,r.endStation,r.num);
        });
      } else stopsCell.innerHTML='<span style="color:#16a34a;font-weight:600">ç›´é”</span>';

      tr.insertCell().innerHTML=colorStatus(r.status);
      tr.addEventListener('click',()=>showTrainDetails(r.num, currentQueryDateStr));
    });

  function toggleStopsRow(tr, st, ed, num){
    const next=tr.nextElementSibling;
    if(next && next.classList.contains('stops-row')){
      next.remove();
      return;
    }
    const t=baseSchedule[num]; if(!t) return;
    const arr=t['è»Šç«™æ™‚é–“']||[];
    const si=arr.findIndex(x=>x[0]===st);
    const ei=arr.findIndex(x=>x[0]===ed);
    if(si<0 || ei<0 || ei<=si) return;

    const stops=arr.slice(si+1, ei).map(x=>{
      const dep = splitArrDep(x).dep || '--';
      return `${x[0]}(${dep})`;
    }).join('ã€');

    const row=document.createElement('tr');
    row.className='stops-row';
    const td=document.createElement('td');
    td.colSpan=8;
    td.textContent=stops?`æ²¿é€”åœé ï¼š${stops}`:'ï¼ˆç„¡ä¸­é€”åœé ï¼‰';
    row.appendChild(td);
    tr.parentNode.insertBefore(row, tr.nextSibling);
  }

  // ===== è½‰ä¹˜ï¼ˆä¸­é€”ç«™ï¼šåˆ°é”/é–‹è»Šåˆ†é–‹ï¼‰ =====
  function buildTransferList(st, ed){
  // è½‰ä¹˜æ¨¡å¼ï¼šåŒä¸€å€‹ã€Œå‡ºç™¼ç­æ¬¡ n1ã€åªä¿ç•™ã€Œè€—æ™‚æœ€çŸ­ã€çš„ä¸€å€‹æ–¹æ¡ˆï¼ˆå¯èƒ½æ˜¯ç›´é”ï¼Œä¹Ÿå¯èƒ½æ˜¯è½‰ä¹˜ï¼‰
  // è€—æ™‚è¨ˆç®—ï¼šçµ‚é»åˆ°é”(è½‰ä¹˜å¾Œé‚£ç­è»Šçš„è¿„ç«™åˆ°é”æ™‚é–“) - ç¬¬ä¸€ç­è»Šèµ·ç«™é–‹è»Šæ™‚é–“
  const allNums = Object.keys(baseSchedule||{});
  const plans = []; // {n1, n2?, mid?, isDirect, ...}

  allNums.forEach(n1=>{
    const t1 = baseSchedule[n1];
    if(!t1) return;
    if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t1['è»Šç¨®'])) return;

    const a1 = t1['è»Šç«™æ™‚é–“']||[];
    if(a1.length < 2) return;

    const sIdx = a1.findIndex(x=>x[0]===st);
    if(sIdx < 0) return;

    const abs1 = buildAbsArrDep(a1);

    // âœ… ä»¥ã€ŒæŸ¥è©¢å‡ºç™¼ç«™ stã€çš„é–‹è»Šæ™‚é–“ä½œç‚ºæ–¹æ¡ˆå‡ºç™¼æ™‚é–“èˆ‡è€—æ™‚è¨ˆç®—åŸºæº–ï¼ˆä¸æ˜¯åˆ—è»Šèµ·ç«™ï¼‰
    const originStation = a1[0]?.[0] || '';
    const stDepStr = (splitArrDep(a1[sIdx]||[]).dep || splitArrDep(a1[sIdx]||[]).arr || '--');
    const stDepAbs = abs1.absDep[sIdx] ?? abs1.absArr[sIdx];
    const stDepAdj = getAdjustedTime(n1, stDepStr, currentQueryDateStr);
    if(stDepAbs === null || stDepAbs === undefined) return;

    // è©¦ç®—ã€Œç›´é”æ–¹æ¡ˆã€ï¼ˆn1 æœ¬èº«å¯åˆ°é” ed ä¸” ed åœ¨ st ä¹‹å¾Œï¼‰
    let bestPlan = null;

    const eIdxDirect = a1.findIndex(x=>x[0]===ed);
    if(eIdxDirect >= 0 && eIdxDirect > sIdx){
      const endArrStr = (splitArrDep(a1[eIdxDirect]||[]).arr || splitArrDep(a1[eIdxDirect]||[]).dep || '--'); // è¿„ç«™ã€Œåˆ°é”ã€æ™‚é–“
      const endArrAdj = getAdjustedTime(n1, endArrStr, currentQueryDateStr);

      const endArrAbs = abs1.absArr[eIdxDirect] ?? abs1.absDep[eIdxDirect];
      if(endArrAbs !== null && endArrAbs !== undefined){
        const travelMin = endArrAbs - stDepAbs;
        if(Number.isFinite(travelMin) && travelMin >= 0){
          const status = getTrainStatusLabel(
            n1,
            currentQueryDateStr,
            (a1[0]?.[2]||a1[0]?.[1]||''),
            (a1.slice(-1)[0]?.[1]||a1.slice(-1)[0]?.[2]||''),
            stDepStr
          );

          bestPlan = {
            trainNumber: String(n1),
            n1,
            n2: null,
            type1: t1['è»Šç¨®'],
            type2: null,
            isDirect: true,
            startStation: st,
            endStation: ed,
            transferStation: null,

            originStation,
            stDepStr,
            depSched: stDepStr,
            depHTML: renderTimeWithDelay(n1, stDepStr, currentQueryDateStr, { suppressStrike: status==='å·²éç«™' }),
            startDepAtQueryStation: stDepStr,

            arrSched: endArrStr,
            arrHTML: renderTimeWithDelay(n1, endArrStr, currentQueryDateStr, { suppressStrike: (status==='å·²åˆ°çµ‚é»' || status==='å·²éç«™') }),

            depSortMin: stDepAdj.adjMin ?? 9999,
            arrSortMin: endArrAdj.adjMin ?? 9999,

            travelMin,
            travel: `${Math.floor(travelMin/60)}h ${travelMin%60}m`,
            status
          };
        }
      }
    }

    // è©¦ç®—ã€Œè½‰ä¹˜æ–¹æ¡ˆã€ï¼šn1 (st -> mid) + n2 (mid -> ed)
    allNums.forEach(n2=>{
      if(n2 === n1) return;
      const t2 = baseSchedule[n2];
      if(!t2) return;
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t2['è»Šç¨®'])) return;

      const a2 = t2['è»Šç«™æ™‚é–“']||[];
      if(a2.length < 2) return;

      const midCandidates = a1.slice(sIdx+1).map(x=>x[0]);

      // n2 å¿…é ˆèƒ½åˆ° ed
      const eIdx2 = a2.findIndex(x=>x[0]===ed);
      if(eIdx2 < 0) return;

      const abs2 = buildAbsArrDep(a2);

      // n2 çš„ã€Œè¿„ç«™åˆ°é”æ™‚é–“ã€ï¼ˆç”¨æ–¼è€—æ™‚è¨ˆç®—ï¼‰
      const endArrAbs2 = abs2.absArr[eIdx2] ?? abs2.absDep[eIdx2];
      const endArrStr2 = (splitArrDep(a2[eIdx2]||[]).arr || splitArrDep(a2[eIdx2]||[]).dep || '--'); // è¿„ç«™ã€Œåˆ°é”ã€æ™‚é–“
      if(endArrAbs2 === null || endArrAbs2 === undefined) return;

      // é€ä¸€æ‰¾å¯è½‰ä¹˜çš„ midï¼ˆå–ç¬¬ä¸€å€‹ç¬¦åˆä¸” travel æœ€çŸ­çš„ midï¼‰
      for(let i=sIdx+1;i<a1.length;i++){
        const mid = a1[i][0];

        // n2 å¿…é ˆåœ(æˆ–é€šé) midï¼Œä¸” mid åœ¨ ed ä¹‹å‰
        const midIdx2 = a2.findIndex(x=>x[0]===mid);
        if(midIdx2 < 0) continue;
        if(!(midIdx2 < eIdx2)) continue; // mid å¿…é ˆåœ¨ ed ä¹‹å‰ï¼ˆåŒæ–¹å‘ï¼‰

        // n1 åˆ° mid çš„ã€Œåˆ°é”ã€æ™‚é–“
        const midArrStr = (splitArrDep(a1[i]||[]).arr || splitArrDep(a1[i]||[]).dep || '');
        const midArrAbs = abs1.absArr[i] ?? abs1.absDep[i];
        if(!midArrStr || midArrAbs === null || midArrAbs === undefined) continue;

        // n2 åœ¨ mid çš„ã€Œé–‹è»Šã€æ™‚é–“
        const midDepStr = (splitArrDep(a2[midIdx2]||[]).dep || splitArrDep(a2[midIdx2]||[]).arr || '');
        const midDepAbs = abs2.absDep[midIdx2] ?? abs2.absArr[midIdx2];
        if(!midDepStr || midDepAbs === null || midDepAbs === undefined) continue;

        // è½‰æ¥æ™‚é–“ï¼šn2(midé–‹è»Š) - n1(midåˆ°é”)ï¼ˆç”¨èª¤é»å¾Œæ™‚é–“è¨ˆç®—ï¼‰
        const d1 = isQueryToday(currentQueryDateStr) ? getDelayMinutes(n1) : 0;
        const d2 = isQueryToday(currentQueryDateStr) ? getDelayMinutes(n2) : 0;
        const wait = (midDepAbs + d2) - (midArrAbs + d1);
        if(wait < 3) continue;     // â˜… ä¸å¾—å°æ–¼ 3 åˆ†é˜
        if(wait > 90) continue;    // â˜… é¿å…è¶…é•·ç­‰å¾…

        const travelMin = (endArrAbs2 + (isQueryToday(currentQueryDateStr) ? getDelayMinutes(n2) : 0)) - (stDepAbs + (isQueryToday(currentQueryDateStr) ? getDelayMinutes(n1) : 0));
        if(!Number.isFinite(travelMin) || travelMin < 0) continue;

        const status = getTrainStatusLabel(
          n1,
          currentQueryDateStr,
          (a1[0]?.[2]||a1[0]?.[1]||''),
          (a1.slice(-1)[0]?.[1]||a1.slice(-1)[0]?.[2]||''),
          stDepStr
        );

        const endArrAdj2 = getAdjustedTime(n2, endArrStr2, currentQueryDateStr);

        const plan = {
          trainNumber: `${n1}+${n2}`,
          n1, n2,
          type1: t1['è»Šç¨®'],
          type2: t2['è»Šç¨®'],
          isDirect: false,
          startStation: st,
          endStation: ed,
          transferStation: mid,

          originStation,
          stDepStr,
          depSched: stDepStr,
          depHTML: renderTimeWithDelay(n1, stDepStr, currentQueryDateStr, { suppressStrike: status==='å·²éç«™' }),
          startDepAtQueryStation: stDepStr,

          arrSched: endArrStr2,
          arrHTML: renderTimeWithDelay(n2, endArrStr2, currentQueryDateStr, { suppressStrike: (status==='å·²åˆ°çµ‚é»' || status==='å·²éç«™') }),

          depSortMin: stDepAdj.adjMin ?? 9999,
          arrSortMin: endArrAdj2.adjMin ?? 9999,

          midArr: midArrStr,
          midDep: midDepStr,
          midArrHTML: renderTimeWithDelay(n1, midArrStr, currentQueryDateStr, { suppressStrike: status==='å·²éç«™' }),
          midDepHTML: renderTimeWithDelay(n2, midDepStr, currentQueryDateStr, { suppressStrike: status==='å·²éç«™' }),
          waitMin: wait,

          travelMin,
          travel: `${Math.floor(travelMin/60)}h ${travelMin%60}m`,
          status
        };

        // åªè¦æ‰¾åˆ°ä¸€å€‹ mid å°±å…ˆæ”¶ï¼ˆä¹‹å¾Œæœƒç”¨ã€ŒåŒ n1 æœ€çŸ­è€—æ™‚ã€å†ç¯©ï¼‰
        plans.push(plan);
        break;
      }
    });

    // ä¹ŸæŠŠç›´é”æ–¹æ¡ˆæ”¾é€² plansï¼ˆæ–¹ä¾¿å¾Œé¢ä¸€èµ·æ¯”ï¼‰
    if(bestPlan) plans.push(bestPlan);
  });

  // åŒä¸€å€‹å‡ºç™¼ç­æ¬¡ n1ï¼šåªç•™ã€Œè€—æ™‚æœ€çŸ­ã€çš„ä¸€ç­†
  const bestByN1 = new Map();
  plans.forEach(p=>{
    const key = String(p.n1);
    const cur = bestByN1.get(key);
    if(!cur || p.travelMin < cur.travelMin) bestByN1.set(key, p);
  });

  currentTransferList = Array.from(bestByN1.values());

  // é è¨­ï¼šè½‰ä¹˜æ¨¡å¼ç”¨ã€Œå‡ºç™¼ã€æ’åºï¼ˆâ†‘ï¼‰
  startEndSortState = { key: 'dep', dir: 1 };
  sortStartEndListInPlace(currentTransferList, startEndSortState);
  updateStartEndSortIcons();
}

function renderTransferTable(){
  // å‹•æ…‹åˆ‡æ›è¡¨é ­ï¼ˆè½‰ä¹˜æ¨¡å¼ï¼‰
  const table = document.getElementById('scheduleTableByStation');
  const theadTr = table?.querySelector('thead tr');
  if(theadTr){
    theadTr.innerHTML = `
      <th>è»Šæ¬¡</th>
      <th>è»Šç¨® (å€é–“)</th>
      <th>å‡ºç™¼ <span id="sortDepIcon">â†•</span></th>
      <th>è½‰ä¹˜</th>
      <th>æŠµé” <span id="sortArrIcon">â†•</span></th>
      <th>è€—æ™‚ <span id="sortDurIcon">â†•</span></th>
      <th>ç‹€æ…‹</th>
    `;
    // é‡æ–°ç¶æ’åº iconï¼ˆå› ç‚º thead è¢«é‡ç•«äº†ï¼‰
    initStartEndSorting();
    updateStartEndSortIcons();
  }

  const tbody = table?.querySelector('tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  // å–®ä¸€äº‹ä»¶ä»£ç†ï¼ˆé¿å…æ¯åˆ—ç¶ clickï¼Œæ‰‹æ©Ÿæ•ˆèƒ½æ›´å¥½ï¼‰
  tbody.onclick = (e)=>{
    const tr = e.target.closest('tr');
    if(!tr || tr.parentElement !== tbody) return;
    const idx = Number(tr.dataset.idx);
    if(!Number.isFinite(idx)) return;
    const r = currentTransferList[idx];
    if(!r) return;
    if(r.isDirect) showTrainDetails(r.n1, currentQueryDateStr);
    else showTransferDetails(r);
  };

  const mins = currentTransferList.map(r=>r.travelMin).filter(x=>Number.isFinite(x)).sort((a,b)=>a-b);
  const cap = percentile(mins, 0.95);

  currentTransferList.forEach((r, idx)=>{
    let tr = tbody.insertRow();
    tr.dataset.idx = idx;

    tr.insertCell().innerHTML = String(r.trainNumber).includes('A')
      ? `<b>${r.trainNumber}</b><span class="badge-sea">æµ·</span>` : `<b>${r.trainNumber}</b>`;

    if(r.isDirect){
      tr.insertCell().innerHTML = `${colorType(r.type1)} <span class="train-route">(${r.startStation}â${r.endStation})</span>`;
    }else{
      tr.insertCell().innerHTML =
        `${colorType(r.type1)}<span class="train-route">(${r.startStation}â${r.transferStation})</span><br>`+
        `${colorType(r.type2)}<span class="train-route">(${r.transferStation}â${r.endStation})</span>`;
    }

    tr.insertCell().innerHTML = r.depHTML;

    // è½‰ä¹˜æ¬„
    if(r.isDirect){
      tr.insertCell().innerHTML = `<span style="color:var(--text-muted);">â€”</span>`;
    }else{
      tr.insertCell().innerHTML =
        `<div style="font-weight:700">${r.transferStation}</div>`+
        `<div class="train-route">æŠµé” ${r.midArrHTML||highlightPeak(r.midArr)} / ç™¼è»Š ${r.midDepHTML||highlightPeak(r.midDep)}ï¼ˆç­‰ ${r.waitMin} åˆ†ï¼‰</div>`;
}

    tr.insertCell().innerHTML = r.arrHTML;

    const bar = getTravelBarStyle(r.travelMin, cap);
    let cell = tr.insertCell();
    cell.innerHTML = `
      <div style="font-size:.85rem;font-weight:600">${r.travel}${bar.isExtreme ? ' <span style="color:var(--text-muted);font-weight:600">(æ¥µç«¯)</span>' : ''}</div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${bar.widthPct.toFixed(1)}%;background:${bar.fillBg};"></div>
      </div>
    `;

    tr.insertCell().innerHTML = colorStatus(r.status);
  });
}


  // ===== è»Šç«™æ™‚åˆ»è¡¨ï¼šé †è¡Œ=å¶æ•¸è»Šæ¬¡ / é€†è¡Œ=å¥‡æ•¸è»Šæ¬¡ =====
  function isEvenTrainNo(num){
    const m = String(num).match(/\d+/);
    if(!m) return null;
    const n = parseInt(m[0],10);
    if(!Number.isFinite(n)) return null;
    return (n % 2 === 0);
  }

  // è»Šç«™æ™‚åˆ»è¡¨ï¼šé¡¯ç¤ºæ—¥ = currentQueryDateStr
  // ä½†åˆ—è»Šä¾†æºå¯èƒ½æ˜¯ï¼šç™¼è»Šæ—¥ = currentQueryDateStr æˆ– currentQueryDateStr-1
  function filterTrainScheduleByStationName(){
    const station = extractStationNameFromInput(document.getElementById('stationNameInput').value);
    document.getElementById('stationNameInput').value = station;
    if(!station) return;

    const dir=document.getElementById('directionSelect').value; // even / odd
    lastStationQuery = { station, dir };

    const tbody=document.querySelector('#scheduleTableByStationName tbody');
    tbody.innerHTML='';
  // å–®ä¸€äº‹ä»¶ä»£ç†ï¼ˆé¿å…æ¯åˆ—ç¶ clickï¼Œæ‰‹æ©Ÿæ•ˆèƒ½æ›´å¥½ï¼‰
  tbody.onclick = (e)=>{
    const tr = e.target.closest('tr');
    if(!tr || tr.parentElement !== tbody) return;
    const idx = Number(tr.dataset.idx);
    if(!Number.isFinite(idx)) return;
    const r = currentTransferList[idx];
    if(!r) return;
    if(r.isDirect) showTrainDetails(r.n1, currentQueryDateStr);
    else showTransferDetails(r);
  };

    selectedTrainTypesStation=getSelectedTypes('trainTypeChipsStation');

    const rows = [];
    scheduleKeyList.forEach(item=>{
      const {key, trainNo, originDate, data} = item;
      if(!data) return;
      if(selectedTrainTypesStation.length && !selectedTrainTypesStation.includes(data['è»Šç¨®'])) return;

      const arr = data['è»Šç«™æ™‚é–“']||[];
      const idx = arr.findIndex(s=>s[0]===station);
      if(idx<0) return;

      const ev = isEvenTrainNo(trainNo);
      if(dir === 'even' && ev !== true) return;
      if(dir === 'odd'  && ev !== false) return;

      // æœ¬ç«™ä¸€å¾‹ç”¨ã€Œé–‹è»Šæ™‚é–“ã€
      const dep = splitArrDep(arr[idx]).dep || '--';

      // åˆ¤æ–·é€™ç«™å¯¦éš›æ˜¯å“ªä¸€å¤©ï¼ˆè·¨æ—¥è¦è½åˆ°éš”å¤©ï¼‰
      const abs = buildAbsMinutes(arr);
      const absMin = abs[idx]?.abs;
      if(absMin === null) return;

      const stopDate = getStopDateStr(originDate, absMin);
      if(stopDate !== currentQueryDateStr) return; // åªé¡¯ç¤ºã€Œé¸çš„é‚£å¤©ã€

      const status = getTrainStatusLabel(
        trainNo,
        originDate, // ç‹€æ…‹æ°¸é ç”¨ç™¼è»Šæ—¥
        (arr[0]?.[2]||arr[0]?.[1]||''),
        (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||''),
        dep // ç”¨æœ¬ç«™é–‹è»Šåˆ¤æ–·å·²éç«™
      );

      const depAdj = getAdjustedTime(trainNo, dep, currentQueryDateStr);
      rows.push({
        trainNo, originDate,
        type: data['è»Šç¨®'],
        range: `${arr[0][0]}â${arr.slice(-1)[0][0]}`,
        depHTML: renderTimeWithDelay(trainNo, dep, currentQueryDateStr, { suppressStrike: status==='å·²éç«™' }),
        depMin: depAdj.adjMin ?? 9999,
        status
      });
    });

    rows.sort((a,b)=>a.depMin-b.depMin);

    rows.forEach(r=>{
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=String(r.trainNo).includes('A')?`<b>${r.trainNo}</b><span class="badge-sea">æµ·</span>`:`<b>${r.trainNo}</b>`;
      tr.insertCell().innerHTML=`${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
      tr.insertCell().innerHTML=highlightPeak(r.depHTML);
      tr.insertCell().innerHTML=colorStatus(r.status);
      tr.addEventListener('click',()=>showTrainDetails(r.trainNo, r.originDate));
    });
  }

  // ===== è»Šæ¬¡æŸ¥è©¢ï¼ˆä»¥æŸ¥è©¢æ—¥ currentQueryDateStr çš„ç™¼è»Šè³‡æ–™ç‚ºä¸»ï¼‰ =====
  function filterTrainScheduleByNumber(){
    const num = extractTrainNoFromInput(document.getElementById('trainNumberInput').value);
    lastTrainQuery = { trainNo: num };

    document.getElementById('trainNumberInput').value = num;

    const tbody=document.querySelector('#scheduleTableByNumber tbody');
    tbody.innerHTML='';
  // å–®ä¸€äº‹ä»¶ä»£ç†ï¼ˆé¿å…æ¯åˆ—ç¶ clickï¼Œæ‰‹æ©Ÿæ•ˆèƒ½æ›´å¥½ï¼‰
  tbody.onclick = (e)=>{
    const tr = e.target.closest('tr');
    if(!tr || tr.parentElement !== tbody) return;
    const idx = Number(tr.dataset.idx);
    if(!Number.isFinite(idx)) return;
    const r = currentTransferList[idx];
    if(!r) return;
    if(r.isDirect) showTrainDetails(r.n1, currentQueryDateStr);
    else showTransferDetails(r);
  };
    const t=baseSchedule[num];
    if(!t) return;

    const arr=t['è»Šç«™æ™‚é–“']||[];
    const status = getTrainStatusLabel(
  num,
  currentQueryDateStr,
  (arr[0]?.[2]||arr[0]?.[1]||''),
  (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||'')
);


    let tr=tbody.insertRow();
    tr.insertCell().innerHTML=String(num).includes('A')?`<b>${num}</b><span class="badge-sea">æµ·</span>`:`<b>${num}</b>`;
    tr.insertCell().innerHTML=`${colorType(t['è»Šç¨®'])} <span class="train-route">(${arr[0][0]}â${arr.slice(-1)[0][0]})</span>`;
    tr.insertCell().innerHTML=colorStatus(status);
    tr.addEventListener('click',()=>showTrainDetails(num, currentQueryDateStr));
  }

  // ===== Modal: åˆ—è»Šè©³æƒ…ï¼ˆé¡¯ç¤ºç«™åˆ¥ç”¨é–‹è»Šå„ªå…ˆï¼Œä¸¦ä¸”è·¨æ—¥é¡¯ç¤ºæ­£ç¢ºæ—¥æœŸï¼‰ =====
  const modal=document.getElementById('trainModal');
  const modalClose=document.getElementById('modalClose');

  function closeModal(){
    if(modal) modal.style.display='none';
    modalCtx = null;
  }
  if(modalClose){ modalClose.addEventListener('click', closeModal); }
  if(modal){ modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(); }); }
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && modal && modal.style.display==='flex') closeModal(); });

  function showTrainDetails(trainNo, originDateStr){
    modalCtx = { trainNo, originDate: originDateStr };
    

    const t = (originDateStr === currentQueryDateStr) ? baseSchedule[trainNo] : (prevSchedule[trainNo] || baseSchedule[trainNo]);
    if(!t) return;

    const arr=t['è»Šç«™æ™‚é–“']||[];
    const status = getTrainStatusLabel(
  trainNo,
  originDateStr,
  (arr[0]?.[2]||arr[0]?.[1]||''),
  (arr.slice(-1)[0]?.[1]||arr.slice(-1)[0]?.[2]||'')
);


    document.getElementById('modalTitleMain').textContent=`${trainNo}ï½œ${t['è»Šç¨®']}`;
    document.getElementById('modalTitleSub').innerHTML=`${arr[0]?.[0]||''} â ${arr.slice(-1)[0]?.[0]||''} ï½œç‹€æ…‹ï¼š${colorStatus(status)}`;

    const body=document.getElementById('modalBody');
    body.innerHTML='';
    const timeline=document.createElement('div');
    timeline.className='timeline';

    const abs = buildAbsMinutes(arr);

    const todayStr = fmtDate(new Date());
    const isTodayOrigin = (originDateStr === todayStr);

    // ä¸‹ä¸€ç«™åªåœ¨ã€Œä»Šå¤©ç™¼è»Šã€ä¸”ã€Œä½¿ç”¨è€…æŸ¥ä»Šå¤©ã€æ‰æ¨™ï¼ˆé¿å…èª¤å°ï¼‰
    const isTodayUI = (currentQueryDateStr === todayStr);
    const canNext = isTodayOrigin && isTodayUI;

    const now=new Date();
    const nowMin=now.getHours()*60+now.getMinutes();
    let nextIndex=-1;

    if(canNext){
      for(let i=0;i<arr.length;i++){
        const tStr = (splitArrDep(arr[i]||[]).dep || splitArrDep(arr[i]||[]).arr || '');
        const m=parseTime(tStr);
        if(m!==null && m>=nowMin){ nextIndex=i; break; }
      }
    }

    arr.forEach((s, i)=>{
      const item=document.createElement('div');
      item.className='timeline-item';

      // å·¦å´ï¼šé–‹è»Šæ™‚é–“ï¼ˆæ²’æœ‰å°±ç”¨åˆ°é”ï¼‰
      const ad = splitArrDep(s);
      // å·¦å´ï¼šé–‹è»Šæ™‚é–“ï¼ˆæ²’æœ‰å°±ç”¨åˆ°é”ï¼‰
      const depTime = ad.dep || ad.arr || '--';
      // å³å´ï¼šåˆ°é”æ™‚é–“ï¼ˆå¯èƒ½ç‚ºç©ºï¼›èµ·ç«™é€šå¸¸æ²’æœ‰åˆ°é”ï¼‰
      const arrTime = ad.arr || '';
      const passedHere = canNext && (nextIndex===-1 ? true : i < nextIndex);

      const depHTML = renderTimeWithDelay(trainNo, depTime, currentQueryDateStr, { suppressStrike: passedHere });
      const arrHTML = arrTime ? renderTimeWithDelay(trainNo, arrTime, currentQueryDateStr, { suppressStrike: passedHere }) : '';

      const badgeNext = (canNext && i===nextIndex) ? ` <span class="badge-next">ä¸‹ä¸€ç«™</span>` : '';
      const tag = (i===0) ? 'èµ·ç«™' : (i===arr.length-1 ? 'çµ‚é»' : '');

      item.innerHTML=`
        <div class="tl-time">${depHTML}</div>
        <div class="tl-marker">
          <div class="tl-dot"></div>
          <div class="tl-line"></div>
        </div>
        <div class="tl-content">
          <div class="tl-station"><span>${s[0]}</span>${arrHTML?`<span class="st-arr">${arrHTML}</span>`:""}${badgeNext}</div>
          ${tag ? `<div class="tl-desc">${tag}</div>` : ''}
        </div>
      `;

      if(canNext){
        if(i<nextIndex) item.classList.add('passed');
        if(i===nextIndex) item.classList.add('next');
      }

      timeline.appendChild(item);
    });

    body.appendChild(timeline);
    modal.style.display='flex';
  }


  // ===== é»å°é»è¡¨æ ¼æ’åºï¼ˆå‡ºç™¼/æŠµé”/è€—æ™‚ï¼‰ =====
  let startEndSortState = { key: null, dir: 1 }; // dir: 1=asc, -1=desc

  
  // ===== Modal: è½‰ä¹˜è©³æƒ…ï¼ˆå…©ç­åˆ—è»Šï¼Œæ¨™ç¤ºè½‰ä¹˜ç«™ï¼‰ =====
  function showTransferDetails(plan){
    if(!plan) return;
    const originDateStr = currentQueryDateStr;

    const t1 = baseSchedule[plan.n1];
    const t2 = baseSchedule[plan.n2];
    if(!t1 || !t2) return;

    const arr1All = t1['è»Šç«™æ™‚é–“']||[];
    const arr2All = t2['è»Šç«™æ™‚é–“']||[];

    const pickIndex = (arr, name)=>arr.findIndex(x=>x[0]===name);
    const i1Mid = pickIndex(arr1All, plan.transferStation);
    const i2Mid = pickIndex(arr2All, plan.transferStation);
    const i2End = pickIndex(arr2All, plan.endStation);

    if(i1Mid < 0 || i2Mid < 0 || i2End < 0) return;

    // ç¬¬ä¸€æ®µåªé¡¯ç¤ºåˆ°ã€Œè½‰ä¹˜ç«™ã€ï¼›ç¬¬äºŒæ®µåªé¡¯ç¤ºã€Œè½‰ä¹˜ç«™â†’è¿„ç«™ã€
    const i1Start = pickIndex(arr1All, plan.startStation);
    if(i1Start < 0 || i1Mid <= i1Start) return;
    const arr1 = arr1All.slice(i1Start, i1Mid+1);
    const arr2 = arr2All.slice(i2Mid, i2End+1);

    const seg1Dep = (splitArrDep(arr1[0]||[]).dep || splitArrDep(arr1[0]||[]).arr || '--'); // èµ·ç«™é–‹è»Š
    const seg1Arr = (splitArrDep(arr1[arr1.length-1]||[]).arr || splitArrDep(arr1[arr1.length-1]||[]).dep || '--'); // è½‰ä¹˜ç«™åˆ°é”

    const seg2Dep = (splitArrDep(arr2[0]||[]).dep || splitArrDep(arr2[0]||[]).arr || '--'); // è½‰ä¹˜ç«™é–‹è»Š
    const seg2Arr = (splitArrDep(arr2[arr2.length-1]||[]).arr || splitArrDep(arr2[arr2.length-1]||[]).dep || '--'); // è¿„ç«™åˆ°é”ï¼ˆâ˜…ä¿®æ­£ï¼šä¸æ˜¯é–‹è»Šï¼‰

    // ç‹€æ…‹ï¼šä¸é¡¯ç¤ºã€Œå·²éç«™ã€
    const s1 = getStatusForModal(plan.n1, originDateStr, arr1All);
    const s2 = getStatusForModal(plan.n2, originDateStr, arr2All);

    document.getElementById('modalTitleMain').textContent = `${plan.n1}+${plan.n2}ï½œè½‰ä¹˜`;
    document.getElementById('modalTitleSub').innerHTML = `${plan.startStation} â ${plan.endStation}`;

    const body = document.getElementById('modalBody');
    body.innerHTML = '';

    // ===== é¡¶éƒ¨è³‡è¨Šå¡ï¼ˆå…©ç­è»Š + è½‰ä¹˜é» + ç‹€æ…‹ï¼‰=====
    const top = document.createElement('div');
    top.style.padding = '16px 16px 8px 16px';

    top.innerHTML = `
      <div style="display:grid;gap:10px;">
        <div style="display:flex;align-items:flex-start;gap:10px;background:var(--bg-body);border:1px solid var(--border);border-radius:12px;padding:12px;">
          <div style="font-size:20px;line-height:1">ğŸš†</div>
          <div style="flex:1">
            <div style="font-weight:900">
              ${plan.n1}ï½œ${t1['è»Šç¨®']} <span class="train-route">(${plan.startStation}â${plan.transferStation})</span>
            </div>
            <div class="train-route" style="margin-top:2px;">
              å‡ºç™¼ç«™é–‹è»Š ${renderTimeWithDelay(plan.n1, seg1Dep, originDateStr)} ï½œè½‰ä¹˜ç«™æŠµé” ${renderTimeWithDelay(plan.n1, seg1Arr, originDateStr)}
            </div>
          </div>
          <div>${statusBadge(s1)}</div>
        </div>

        <div class="transfer-banner" style="margin:0;">
          <div style="width:34px;height:34px;border-radius:10px;background:rgba(217,119,6,.12);display:flex;align-items:center;justify-content:center;font-weight:900;color:#b45309;">â‡„</div>
          <div style="flex:1">
            <div style="font-weight:900;color:var(--text-main);">${plan.transferStation} è½‰ä¹˜</div>
            <div class="train-route">
              ç¬¬ä¸€æ®µæŠµé” ${renderTimeWithDelay(plan.n1, seg1Arr, originDateStr)} ï½œç¬¬äºŒæ®µç™¼è»Š ${renderTimeWithDelay(plan.n2, seg2Dep, originDateStr)} ï½œç­‰å¾… <b>${plan.waitMin}</b> åˆ†
            </div>
          </div>
        </div>

        <div style="display:flex;align-items:flex-start;gap:10px;background:var(--bg-body);border:1px solid var(--border);border-radius:12px;padding:12px;">
          <div style="font-size:20px;line-height:1">ğŸš†</div>
          <div style="flex:1">
            <div style="font-weight:900">
              ${plan.n2}ï½œ${t2['è»Šç¨®']} <span class="train-route">(${plan.transferStation}â${plan.endStation})</span>
            </div>
            <div class="train-route" style="margin-top:2px;">
              è½‰ä¹˜ç«™é–‹è»Š ${renderTimeWithDelay(plan.n2, seg2Dep, originDateStr)} ï½œè¿„ç«™æŠµé” ${renderTimeWithDelay(plan.n2, seg2Arr, originDateStr)}
            </div>
          </div>
          <div>${statusBadge(s2)}</div>
        </div>
      </div>
    `;

    body.appendChild(top);

    // ===== ç«™è¡¨ï¼ˆç¬¬ä¸€æ®µåˆ°è½‰ä¹˜ç«™ï¼›ç¬¬äºŒæ®µåˆ°è¿„ç«™ï¼‰=====
    const wrap = document.createElement('div');
    wrap.style.padding = '0 16px 16px 16px';

    const sec1 = document.createElement('div');
    sec1.className = 'transfer-section';
    sec1.innerHTML = `<div class="transfer-sec-title">${plan.n1}ï½œ${t1['è»Šç¨®']} <span class="train-route">(${arr1[0]?.[0]||''}â${arr1.slice(-1)[0]?.[0]||''})</span></div>`;
    sec1.appendChild(buildTimelineForTrain(plan.n1, arr1, plan.transferStation));
    wrap.appendChild(sec1);

    const banner2 = document.createElement('div');
    banner2.className = 'transfer-banner';
    banner2.style.marginTop = '10px';
    banner2.innerHTML = `
      <div style="width:34px;height:34px;border-radius:10px;background:rgba(217,119,6,.12);display:flex;align-items:center;justify-content:center;font-weight:900;color:#b45309;">â‡„</div>
      <div style="flex:1">
        <div style="font-weight:900">${plan.transferStation}</div>
        <div class="train-route">ç­‰å¾… ${plan.waitMin} åˆ†ï¼ˆ${renderTimeWithDelay(plan.n1, seg1Arr, originDateStr)} â†’ ${renderTimeWithDelay(plan.n2, seg2Dep, originDateStr)}ï¼‰</div>
      </div>
    `;
    wrap.appendChild(banner2);

    const sec2 = document.createElement('div');
    sec2.className = 'transfer-section';
    sec2.style.marginTop = '10px';
    sec2.innerHTML = `<div class="transfer-sec-title">${plan.n2}ï½œ${t2['è»Šç¨®']} <span class="train-route">(${arr2[0]?.[0]||''}â${arr2.slice(-1)[0]?.[0]||''})</span></div>`;
    sec2.appendChild(buildTimelineForTrain(plan.n2, arr2, plan.transferStation));
    wrap.appendChild(sec2);

    body.appendChild(wrap);

    modal.style.display = 'flex';
  }


  function buildTimelineForTrain(trainNo, arr, transferStation){
    const timeline = document.createElement('div');
    timeline.className = 'timeline';

    const abs = buildAbsMinutes(arr);

    const todayStr = fmtDate(new Date());
    const isTodayOrigin = (currentQueryDateStr === todayStr); // é€™é æœ¬ä¾†å°±åªé¡¯ç¤ºæŸ¥è©¢æ—¥
    const canNext = isTodayOrigin; // åªæœ‰æŸ¥ä»Šå¤©æ‰é¡¯ç¤ºä¸‹ä¸€ç«™

    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();
    let nextIndex = -1;

    if(canNext){
      for(let i=0;i<arr.length;i++){
        const tStr = (splitArrDep(arr[i]||[]).dep || splitArrDep(arr[i]||[]).arr || '');
        const m = parseTime(tStr);
        if(m!==null && m>=nowMin){ nextIndex=i; break; }
      }
    }

    arr.forEach((s,i)=>{
      const item = document.createElement('div');
      item.className = 'timeline-item';

      const ad = splitArrDep(s);
      const depTime = ad.dep || ad.arr || '--';
      const arrTime = ad.arr || '';
      const passedHere = canNext && (nextIndex===-1 ? true : i < nextIndex);

      const depHTML = renderTimeWithDelay(trainNo, depTime, currentQueryDateStr, { suppressStrike: passedHere });
      const arrHTML = arrTime ? renderTimeWithDelay(trainNo, arrTime, currentQueryDateStr, { suppressStrike: passedHere }) : '';

      const badgeNext = (canNext && i===nextIndex) ? ` <span class="badge-next">ä¸‹ä¸€ç«™</span>` : '';
      const badgeXfer = (transferStation && s[0]===transferStation) ? ` <span class="badge-xfer">è½‰ä¹˜</span>` : '';
      const tag = (i===0) ? 'èµ·ç«™' : (i===arr.length-1 ? 'çµ‚é»' : '');

      item.innerHTML = `
        <div class="tl-time">${depHTML}</div>
        <div class="tl-marker">
          <div class="tl-dot"></div>
          <div class="tl-line"></div>
        </div>
        <div class="tl-content">
          <div class="tl-station"><span>${s[0]}</span>${arrHTML?`<span class="st-arr">${arrHTML}</span>`:""}${badgeXfer}${badgeNext}</div>
          ${tag ? `<div class="tl-desc">${tag}</div>` : ''}
        </div>
      `;

      if(canNext){
        if(i<nextIndex) item.classList.add('passed');
        if(i===nextIndex) item.classList.add('next');
      }
      timeline.appendChild(item);
    });

    return timeline;
  }

function initStartEndSorting(){
    const dep = document.getElementById('sortDepIcon');
    const arr = document.getElementById('sortArrIcon');
    const dur = document.getElementById('sortDurIcon');
    if(!dep || !arr || !dur) return;

    [dep, arr, dur].forEach(el=>{
      el.style.cursor = 'pointer';
      el.title = 'é»æ“Šæ’åº';
    });

    dep.addEventListener('click', ()=>toggleSort('dep'));
    arr.addEventListener('click', ()=>toggleSort('arr'));
    dur.addEventListener('click', ()=>toggleSort('dur'));
  }

  function toggleSort(key){
    if(startEndSortState.key === key){
      startEndSortState.dir *= -1;
    }else{
      startEndSortState.key = key;
      startEndSortState.dir = 1;
    }

    const accept = !!document.getElementById('acceptTransfers')?.checked;

    if(accept){
      sortStartEndListInPlace(currentTransferList, startEndSortState);
      renderTransferTable();
    }else{
      sortStartEndListInPlace(currentStartEndList, startEndSortState);
      renderStartEndTable();
    }

    updateStartEndSortIcons();
  }

  function sortStartEndListInPlace(list, state){
    if(!Array.isArray(list) || !state?.key) return;
    const dir = state.dir || 1;
    const key = state.key;

    const get = (r)=>{
      if(key === 'dep') return (r.depSortMin ?? 9999);
      if(key === 'arr') return (r.arrSortMin ?? 9999);
      if(key === 'dur') return (r.travelMin ?? 999999);
      return 999999;
    };

    list.sort((a,b)=> (get(a) - get(b)) * dir );
  }

  function updateStartEndSortIcons(){
    const dep = document.getElementById('sortDepIcon');
    const arr = document.getElementById('sortArrIcon');
    const dur = document.getElementById('sortDurIcon');
    if(!dep || !arr || !dur) return;

    const icon = (k)=>{
      if(startEndSortState.key !== k) return 'â†•';
      return startEndSortState.dir === 1 ? 'â†‘' : 'â†“';
    };

    dep.textContent = icon('dep');
    arr.textContent = icon('arr');
    dur.textContent = icon('dur');
  }

  // ===== æŸ¥è©¢æ¨¡å¼åˆ‡æ›ï¼ˆäº’æ–¥é¡¯ç¤ºï¼‰ =====
  function switchQueryPanel(panelId){
    const panels = ['panel-startend','panel-station','panel-trainno'];
    panels.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle('hidden', id !== panelId);
    });
    document.querySelectorAll('.query-tab').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.target === panelId);
    });
  }

  function bindQueryTabs(){
    document.querySelectorAll('.query-tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        switchQueryPanel(btn.dataset.target);
      });
    });
  }

  // ===== äº‹ä»¶ç¶å®š =====

  document.getElementById('searchBtn').addEventListener('click', runStartEndSearch);
  document.getElementById('stationSearchBtn').addEventListener('click', filterTrainScheduleByStationName);
  document.getElementById('trainNumberBtn').addEventListener('click', filterTrainScheduleByNumber);

  document.getElementById('swapBtn').addEventListener('click', ()=>{
    const a=document.getElementById('startStation');
    const b=document.getElementById('endStation');
    const t=a.value; a.value=b.value; b.value=t;
  });
</script>


</body>
</html>
