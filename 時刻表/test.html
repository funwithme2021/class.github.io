<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>台鐵時刻表 - TDX 快速訂票版</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
  /* ===== 1. 核心變數與原本樣式保持一致 ===== */
  :root {
    --font-main: 'Inter', 'Noto Sans TC', sans-serif;
    --bg-body: #f8fafc;
    --bg-surface: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --primary: #2563eb; /* 藍色調 */
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background-color: var(--bg-body); font-family: var(--font-main); padding-top: 80px; }

  /* 新增：訂票按鈕 */
  .btn-book {
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.15);
  }
  .btn-book:hover { background-color: #1d4ed8; transform: translateY(-1px); }

  header { position: fixed; top: 0; left: 0; right: 0; height: 64px; background: var(--bg-header); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; z-index: 1000; }
  .logo { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
  .container { max-width: 600px; margin: 0 auto; padding: 0 16px 40px; }
  .card { background: var(--bg-surface); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 24px; overflow: hidden; }
  .station-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 16px; }
  .station-btn { border: 1px solid var(--border); background: var(--bg-surface); padding: 10px 4px; border-radius: 8px; cursor: pointer; }
  .station-btn.active { background: var(--primary); color: white; }
  
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 12px 20px; font-size: 0.75rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
  td { padding: 16px 20px; font-size: 0.9375rem; border-bottom: 1px solid var(--border); cursor: pointer; vertical-align: middle; }

  .detail-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
  .detail-card { background: var(--bg-surface); width: 100%; max-width: 480px; border-radius: 20px; position: relative; padding: 24px; }
  .close-btn { position: absolute; top: 15px; right: 15px; border: none; background: #eee; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
  </style>
</head>
<body>

  <header><div class="logo">台鐵時刻表</div></header>

  <div class="container">
    <div class="card">
      <div class="station-grid">
        <button class="station-btn" onclick="filterTrains('臺北', this)">臺北</button>
        <button class="station-btn" onclick="filterTrains('松山', this)">松山</button>
        <button class="station-btn" onclick="filterTrains('板橋', this)">板橋</button>
        <button class="station-btn" onclick="filterTrains('桃園', this)">桃園</button>
        <button class="station-btn" onclick="filterTrains('新竹', this)">新竹</button>
        <button class="station-btn" onclick="filterTrains('臺中', this)">臺中</button>
        <button class="station-btn" onclick="filterTrains('彰化', this)">彰化</button>
        <button class="station-btn" onclick="filterTrains('臺東', this)">臺東</button>
      </div>
    </div>

    <div class="card">
      <table id="filteredTrainsTable">
        <thead>
          <tr>
            <th>車次</th>
            <th>車種</th>
            <th>時間</th>
            <th style="text-align:right">操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="detailOverlay" class="detail-overlay" onclick="closeDetail()">
    <div class="detail-card" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeDetail()">&times;</button>
      <div id="detailTitleMain" style="font-size:1.2rem; font-weight:700;"></div>
      <div id="detailTitleSub" style="color:var(--text-muted); margin-bottom:15px;"></div>
      <div id="detailBody"></div>
    </div>
  </div>

  <script src="train-schedule.js"></script>

  <script>
  let currentStart = "";

  // 核心功能：使用 TDX DeepLink 進行呼叫
  function callTdxBooking(trainNo, startStation) {
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0]; // 自動生成 2026-01-27
    
    // 從資料中獲取該車次的終點站
    const trainData = trainSchedule[trainNo];
    const stations = trainData['車站時間'];
    const endStation = stations[stations.length - 1][0];

    // 構建請求網址
    const url = `https://tdx.transportdata.tw/api/maas-tra/booking/deeplink/direct/tra?` + 
                `start_station=${encodeURIComponent(startStation)}&` +
                `end_station=${encodeURIComponent(endStation)}&` +
                `train_date=${dateStr}&` +
                `train_number=${trainNo}`;

    window.open(url, '_blank');
  }

  function filterTrains(station, btn) {
    currentStart = station;
    document.querySelectorAll('.station-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderFilteredTrains(station);
  }

  function renderFilteredTrains(selectedStation) {
    const tbody = document.querySelector('#filteredTrainsTable tbody');
    tbody.innerHTML = ''; 

    for (var trainNo in trainSchedule) {
      var stops = trainSchedule[trainNo]['車站時間'];
      var idx = stops.findIndex(s => s[0] === selectedStation);

      if (idx !== -1) {
        var row = tbody.insertRow();
        row.insertCell(0).innerHTML = `<b>${trainNo}</b>`;
        row.insertCell(1).innerHTML = getTrainTypeWithColor(trainSchedule[trainNo]['車種']);
        row.insertCell(2).innerHTML = stops[idx][1];
        
        // 快速訂票按鈕
        var cellAction = row.insertCell(3);
        cellAction.style.textAlign = 'right';
        cellAction.innerHTML = `<button class="btn-book" onclick="event.stopPropagation(); callTdxBooking('${trainNo}', '${selectedStation}')">訂票</button>`;

        row.onclick = (function(n) { return function() { showTrainDetail(n); }; })(trainNo);
      }
    }
  }

  function showTrainDetail(num) {
    const overlay = document.getElementById('detailOverlay');
    overlay.style.display = 'flex';
    const t = trainSchedule[num], arr = t['車站時間'];

    document.getElementById('detailTitleMain').innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span>${num}次 詳情</span>
        <button class="btn-book" onclick="callTdxBooking('${num}', '${currentStart || arr[0][0]}')">立即訂票</button>
      </div>
    `;
    document.getElementById('detailTitleSub').textContent = `${t['車種']} (${arr[0][0]} ➝ ${arr[arr.length-1][0]})`;
    
    // 渲染時間軸 (簡化版)
    let html = `<div style="border-left:2px solid #eee; margin-left:10px; padding-left:20px;">`;
    arr.forEach(s => {
      html += `<div style="margin-bottom:10px;">${s[0]} - ${s[1]}</div>`;
    });
    document.getElementById('detailBody').innerHTML = html + `</div>`;
  }

  function closeDetail() { document.getElementById('detailOverlay').style.display = 'none'; }

  function getTrainTypeWithColor(type) {
    const colors = {'新自強':'#8600FF', '普悠瑪':'#FF1493', '自強號':'red', '莒光號':'orange', '區間快':'green', '區間車':'#0066CC'};
    return `<span style="color:${colors[type] || '#64748b'}; font-weight:700;">${type}</span>`;
  }
  </script>
</body>
</html>