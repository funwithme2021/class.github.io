<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>台鐵時刻表 (真實數據即時版)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style> 
  /* ===== 1. 核心變數與 Reset ===== */
  :root {
    --font-main: 'Inter', 'Noto Sans TC', sans-serif;
    --bg-body: #f8fafc;
    --bg-surface: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --text-light: #94a3b8;
    --border: #e2e8f0;
    --primary: #2563eb;
    --primary-bg: rgba(37, 99, 235, 0.1);
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --radius: 10px;
  }

  body.dark-mode {
    --bg-body: #0f172a;
    --bg-surface: #1e293b;
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --text-light: #64748b;
    --border: #334155;
    --primary: #60a5fa;
    --primary-bg: rgba(96, 165, 250, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    font-family: var(--font-main);
    background: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    padding-bottom: 40px;
  }

  /* ===== 2. 導航列 ===== */
  .navbar {
    position: sticky; top: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.8rem 1.5rem;
    background: var(--bg-header);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  .navbar .brand { font-weight: 700; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
  .nav-links { display: flex; gap: 4px; align-items: center; }
  .nav-links a {
    color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500;
    padding: 6px 12px; border-radius: 6px; transition: 0.2s;
  }
  .nav-links a:hover { background: var(--bg-body); color: var(--primary); }
  .theme-btn {
    border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-main);
    padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;
  }
  .hamburger { display: none; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; }
  .hamburger span { width: 24px; height: 2px; background: var(--text-main); }

  @media(max-width: 900px) {
    .nav-links {
      position: absolute; top: 100%; left: 0; width: 100%;
      background: var(--bg-surface); border-bottom: 1px solid var(--border);
      flex-direction: column; align-items: flex-start; padding: 0;
      max-height: 0; overflow: hidden; opacity: 0; transition: 0.3s;
    }
    .nav-links.open { max-height: 500px; opacity: 1; padding: 1rem; }
    .nav-links a { width: 100%; padding: 10px; }
    .hamburger { display: flex; }
  }

  /* ===== 3. 主要容器 ===== */
  .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
  .grid { display: grid; gap: 24px; }

  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .section-title {
    font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 2px; }

  /* ===== 4. 表單與篩選 ===== */
  .form-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 16px; position: relative; }
  
  .input-group { 
    display: flex; align-items: center; gap: 8px; 
    background: var(--bg-body); padding: 4px 8px; 
    border: 1px solid var(--border); border-radius: 8px; 
    flex: 1; min-width: 120px;
  }
  .input-group label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; white-space: nowrap; }
  input, select {
    border: none; background: transparent; color: var(--text-main); 
    font-size: 0.95rem; padding: 6px; outline: none; width: 100%; 
  }

  /* 互換按鈕 */
  .swap-btn {
    width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--bg-surface); color: var(--primary);
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; transition: 0.2s; font-size: 1.1rem;
  }
  .swap-btn:hover { background: var(--bg-body); transform: rotate(180deg); }

  button.btn-primary {
    background: var(--primary); color: #fff; border: none;
    padding: 8px 16px; border-radius: 8px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }

  /* 歷史紀錄 Chips */
  .history-chips { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .history-chip {
    font-size: 0.8rem; padding: 4px 10px; border-radius: 12px;
    background: var(--bg-body); color: var(--text-muted);
    border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 4px;
  }
  .history-chip:hover { background: var(--primary-bg); color: var(--primary); border-color: var(--primary); }

  /* 標籤式 Checkbox */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .chip-label {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 10px; border-radius: 20px;
    border: 1px solid var(--border); background: var(--bg-surface);
    color: var(--text-muted); font-size: 0.85rem; cursor: pointer;
    user-select: none; transition: 0.2s;
  }
  .chip-label:hover { background: var(--bg-body); }
  .chip-label input { display: none; }
  .chip-label:has(input:checked) {
    background: var(--primary-bg); color: var(--primary); border-color: var(--primary); font-weight: 500;
  }
  .chip-label input:checked + span { color: var(--primary); }

  /* ===== 5. 表格樣式 ===== */
  .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
  
  th {
    background: var(--bg-body); color: var(--text-muted); font-weight: 600; text-align: left;
    padding: 12px 16px; border-bottom: 1px solid var(--border);
  }
  th.sortable { cursor: pointer; }
  td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: var(--bg-body); cursor: pointer; }

  /* 數字對齊 */
  td { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
  
  /* 標籤 Badge */
  .badge-sea { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #0ea5e9; color: #fff; margin-left: 4px; }
  .peak-hour { color: #d97706; font-weight: 700; background: #fef3c7; padding: 2px 6px; border-radius: 4px; }
  body.dark-mode .peak-hour { background: rgba(217, 119, 6, 0.2); color: #fbbf24; }
  
  .train-route { font-size: 0.85rem; color: var(--text-muted); margin-left: 6px; }
  .progress-bar { width: 100px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
  .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; }

  /* ===== 6. Modal (彈窗) & 時間軸 ===== */
  .modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px);
    z-index: 2000; justify-content: center; align-items: center;
    opacity: 0; transition: opacity 0.3s;
  }
  .modal[style*="display: flex"] { opacity: 1; }

  .modal-content {
    background: var(--bg-surface); width: 95%; max-width: 500px; max-height: 85vh;
    border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    overflow: hidden; display: flex; flex-direction: column;
    transform: translateY(20px); transition: transform 0.3s;
  }
  .modal[style*="display: flex"] .modal-content { transform: translateY(0); }

  .modal-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-body);
  }
  .modal-title-main { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
  .modal-title-sub { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }
  .close { font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }

  .modal-body { padding: 0; overflow-y: auto; background: var(--bg-surface); }

  /* 時間軸樣式 */
  .timeline { padding: 10px 20px; }
  .timeline-item { display: flex; position: relative; padding-bottom: 0; }
  
  /* 左側時間 */
  .tl-time {
    width: 50px; text-align: right; font-size: 0.9rem; font-weight: 600; 
    color: var(--text-main); padding-right: 15px; padding-top: 2px;
    font-variant-numeric: tabular-nums;
  }
  
  /* 中間線條與圓點 */
  .tl-marker {
    display: flex; flex-direction: column; align-items: center; width: 20px; position: relative;
  }
  .tl-line {
    width: 2px; background: var(--border); flex-grow: 1; margin-top: 4px; margin-bottom: -4px;
  }
  .timeline-item:last-child .tl-line { display: none; }
  .tl-dot {
    width: 10px; height: 10px; border-radius: 50%; background: var(--border);
    border: 2px solid var(--bg-surface); z-index: 1; flex-shrink: 0; transition: all 0.3s;
  }
  
  /* 右側站名 */
  .tl-content { padding-left: 15px; padding-bottom: 24px; flex-grow: 1; }
  .timeline-item:last-child .tl-content { padding-bottom: 10px; }
  
  .tl-station { font-size: 1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; }
  .tl-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }

  /* --- 狀態樣式 --- */
  .timeline-item.passed .tl-time, 
  .timeline-item.passed .tl-station { opacity: 0.4; filter: grayscale(1); }
  .timeline-item.passed .tl-dot { background: var(--border); }

  .timeline-item.next .tl-dot { 
    background: #22c55e; width: 14px; height: 14px; 
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2); 
    border-color: #fff; 
  }
  .timeline-item.next .tl-station { color: #15803d; font-weight: 700; }
  body.dark-mode .timeline-item.next .tl-station { color: #4ade80; }
  
  .timeline-item.transfer .tl-dot { background: #d97706; width: 12px; height: 12px; }
  .timeline-item.transfer .tl-station { color: #b45309; }

  .badge-next {
    display: inline-flex; align-items: center; gap: 4px;
    background: #22c55e; color: #fff; font-size: 0.7rem; 
    padding: 2px 8px; border-radius: 10px; margin-left: 8px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

  .transfer-banner {
    background: var(--bg-body); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
    padding: 10px 20px; display: flex; align-items: center; gap: 10px; margin: 10px -20px 20px -20px;
  }
  </style>

  <style>
    /* loading overlay（原本就有） */
    #loading-overlay{
      position: fixed; inset: 0; background: rgba(15, 23, 42, 0.35);
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    .spinner{
      width: 44px; height: 44px; border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.35);
      border-top-color: rgba(255,255,255,0.95);
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to{ transform: rotate(360deg);} }

    /* header（原本就有） */
    .header{
      position: sticky; top:0; z-index: 120;
      background: var(--bg-header);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
    }
    .header-content{
      max-width: 1200px; margin: 0 auto;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
    }
    .logo{
      font-weight: 800; letter-spacing: .5px;
      color: var(--primary);
      display:flex; align-items: baseline; gap: 6px;
    }
    .logo span{ font-weight: 600; color: var(--text-muted); font-size: .85rem; }
    .date-picker{ display:flex; align-items:center; gap: 8px; }
    .input-field{
      border:1px solid var(--border);
      background: var(--bg-surface);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 8px;
      outline: none;
      font-family: var(--font-main);
    }

    /* stops 展開箭頭（原本就有） */
    .toggle-arrow{ color: var(--text-muted); margin-left: 6px; font-size: .85rem; cursor:pointer; }
    .stops-row td{ background: var(--bg-body); color: var(--text-muted); font-size: .85rem; }
  </style>

</head>

<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text">正在初始化台鐵真實數據...</div>
</div>

<header class="header">
  <div class="header-content">
    <div class="logo">TRA <span>Real-time</span></div>
    <div class="date-picker">
      <label style="font-size: 0.8em; color: var(--text-muted);">選擇查詢日期：</label>
      <input type="date" id="mainQueryDate" class="input-field" style="width: auto; display: inline-block;">
    </div>
  </div>
</header>

<main class="container">
  <div class="grid">
    <section class="card">
      <div class="section-title">點對點 / 轉乘查詢</div>
      <datalist id="stationList"></datalist>
      <div id="searchHistory" class="history-chips"></div>
      <div class="form-row">
        <div class="input-group">
          <label>出發</label>
          <input list="stationList" id="startStation" placeholder="例如：臺北">
        </div>

        <button class="swap-btn" id="swapBtn" title="互換">⇄</button>

        <div class="input-group">
          <label>到達</label>
          <input list="stationList" id="endStation" placeholder="例如：板橋">
        </div>

        <label class="chip-label" style="flex:0 0 auto;">
          <input type="checkbox" id="acceptTransfers">
          <span>接受轉乘</span>
        </label>

        <button class="btn-primary" id="searchBtn">查詢</button>
      </div>

      <div class="chip-group" id="trainTypeChipsStartEnd"></div>

      <div class="table-wrapper">
        <table id="scheduleTableByStation">
          <thead>
            <tr><th>車次</th><th>車種 (區間)</th><th>出發</th><th>抵達</th><th>耗時</th><th>停靠</th><th>狀態</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-title">車站時刻表</div>
      <div class="form-row">
        <div class="input-group">
          <label>車站</label>
          <input list="stationList" id="stationNameInput" placeholder="例如：松山">
        </div>

        <div class="input-group" style="max-width: 180px;">
          <label>方向</label>
          <select id="directionSelect">
            <option value="north">北上</option>
            <option value="south">南下</option>
          </select>
        </div>

        <button class="btn-primary" id="stationSearchBtn">查詢</button>
      </div>

      <div class="chip-group" id="trainTypeChipsStation"></div>

      <div class="table-wrapper">
        <table id="scheduleTableByStationName">
          <thead>
            <tr><th>車次</th><th>車種 (區間)</th><th>時間</th><th>狀態</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-title">車次查詢</div>
      <div class="form-row">
        <div class="input-group">
          <label>車次</label>
          <input id="trainNumberInput" placeholder="例如：111">
        </div>
        <button class="btn-primary" id="trainNumberBtn">查詢</button>
      </div>

      <div class="table-wrapper">
        <table id="scheduleTableByNumber">
          <thead>
            <tr><th>車次</th><th>車種 (區間)</th><th>狀態</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>
</main>

<!-- Modal -->
<div id="trainModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <div class="modal-title-main" id="modalTitleMain">列車資訊</div>
        <div class="modal-title-sub" id="modalTitleSub">—</div>
      </div>
      <div class="close" id="modalClose">×</div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script src="./train.real-schedule.js"></script>

<script>

  // 1. 初始化與 API 銜接
  window.addEventListener('load', async () => {
    const today = new Date();
    const fmt = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const todayStr = fmt(today);

    initDatePicker();
    const dateInput = document.getElementById('mainQueryDate');
    const selected = dateInput?.value || todayStr;

    await refreshData(selected);

    // 每分鐘更新即時誤點：僅在查詢「今天」時更新
    setInterval(async () => {
      const cur = document.getElementById('mainQueryDate')?.value;
      if (cur === todayStr && typeof updateLiveDelay === 'function') {
        await updateLiveDelay();
      }
    }, 60000);
  });

  async function refreshData(date) {
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('loading-text').textContent = `正在獲取 ${date} 真實時刻表...`;
    
    await fetchRealData(date); // 呼叫 train.real-schedule.js
    await updateLiveDelay();
    
    updateStationDatalists(); // 更新下拉選單
    document.getElementById('loading-overlay').style.display = 'none';
  }

  // 1.5 日期選擇器：限定60日內（含今天），預設今日
  function initDatePicker(){
    const el = document.getElementById('mainQueryDate');
    if(!el) return;
    const today = new Date();
    const fmt = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const max = fmt(today);
    const minD = new Date(today); minD.setDate(minD.getDate()-59);
    const min = fmt(minD);
    el.max = max;
    el.min = min;
    if(!el.value) el.value = max;
    el.addEventListener('change', ()=>refreshData(el.value));
  }

// 2. 更新所有 Station Datalist (從真實數據提取所有車站)
  function updateStationDatalists() {
    const stationList = document.getElementById('stationList');
    stationList.innerHTML = '';
    if(!window.stationMap || !Object.keys(window.stationMap).length) return;

    Object.keys(window.stationMap).forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      stationList.appendChild(option);
    });
  }

  // ===== 工具：時間處理 / 方向 / normalization =====
  function parseTime(t){
    if(!t || !/\d{1,2}:\d{2}/.test(t)) return 9999;
    let [h,m]=t.split(':').map(x=>parseInt(x,10));
    return h*60+m;
  }

  function getTime(num, station){
    const t=trainSchedule[num];
    if(!t) return null;
    const row=t['車站時間'].find(s=>s[0]===station);
    return row?row[1]:null;
  }

  function getDirection(num){
    const t=trainSchedule[num]; if(!t) return 'south';
    const arr=t['車站時間'];
    const a=arr[0]?.[0]||'', b=arr[arr.length-1]?.[0]||'';
    // 粗略判斷（保留原本邏輯）
    if(['基隆','七堵','南港','松山','臺北','板橋','樹林'].includes(a) && ['花蓮','臺東','潮州','枋寮','高雄','左營','新左營'].includes(b)) return 'south';
    if(['花蓮','臺東','潮州','枋寮','高雄','左營','新左營'].includes(a) && ['基隆','七堵','南港','松山','臺北','板橋','樹林'].includes(b)) return 'north';
    return 'south';
  }

  function normalizeStation(st){
    // stationMap 由 train.real-schedule.js 提供，key 是中文站名
    if(window.stationMap && window.stationMap[st]) return st;
    // 嘗試常見別名
    const alias = {
      '台北':'臺北','台中':'臺中','台南':'臺南','台東':'臺東','台鐵':'臺鐵',
      '台':'臺'
    };
    if(alias[st] && window.stationMap && window.stationMap[alias[st]]) return alias[st];
    // 進一步：把「台」替換成「臺」
    const t=st.replace(/台/g,'臺');
    if(window.stationMap && window.stationMap[t]) return t;
    return st;
  }

  // 狀態：未發車 / 準點 / 誤點X分 / 提早X分 / 停駛/取消 / 無即時資訊 / 已到終點
  function getTrainStatusLabel(trainNo, firstTime, lastTime){
    let raw='';
    try{ if(typeof getDelayStatus==='function') raw = getDelayStatus(String(trainNo)) || ''; }catch(e){ raw=''; }

    if(raw){
      if(/停駛|取消|暫停|終止|運轉整理/i.test(raw)) return '停駛/取消';
      if(/準點/.test(raw)) return '準點';
      const m = raw.match(/晚\s*([\-\d]+)\s*分/);
      if(m){
        const d = parseInt(m[1],10);
        if(Number.isFinite(d) && d>0) return `誤點 ${d} 分`;
        if(Number.isFinite(d) && d<0) return `提早 ${Math.abs(d)} 分`;
        return '準點';
      }
      return '即時';
    }

    const now=new Date();
    const nowMin=now.getHours()*60+now.getMinutes();
    const toMin=(t)=>{
      if(!t || !/\d{1,2}:\d{2}/.test(t)) return null;
      const [h,m]=t.split(':').map(x=>parseInt(x,10));
      return h*60+m;
    };
    const f=toMin(firstTime), l=toMin(lastTime);

    if(Number.isFinite(f) && nowMin < f-1) return '未發車';

    if(Number.isFinite(f) && Number.isFinite(l)){
      const crosses = l < f;
      const endMin = crosses ? l+1440 : l;
      const nowAdj = crosses && nowMin < f ? nowMin+1440 : nowMin;
      if(nowAdj > endMin + 10) return '已到終點';
    }

    return '無即時資訊';
  }

  function highlightPeak(t){
    if(!t) return t;
    const h=parseInt(t.split(':')[0],10);
    return ((h>=7&&h<9)||(h>=17&&h<19))?`<span class="peak-hour">${t}</span>`:t;
  }

  function colorType(t){
    const map={
      新自強:'#8600FF',
      普悠瑪:'#db2777',
      '自強號(新)':'#e11d48',
      '自強號':'#e11d48',
      莒光號:'#ea580c',
      區間快:'#16a34a',
      復興號:'#0284c7',
      區間車:document.body.classList.contains('dark-mode')?'#a3a3a3':'#475569',
      加班車:'#0ea5e9'
    };
    const c=map[t]||'#64748b';
    return `<span style="color:${c};font-weight:700">${t}</span>`;
  }

  // ===== UI：搜尋歷史 =====
  const HISTORY_KEY='tra_search_history_v2';
  function loadHistory(){
    try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); }catch(e){ return []; }
  }
  function saveHistory(list){
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,10)));
  }
  function renderHistory(){
    const box=document.getElementById('searchHistory');
    if(!box) return;
    const list=loadHistory();
    box.innerHTML='';
    list.forEach(item=>{
      const chip=document.createElement('div');
      chip.className='history-chip';
      chip.textContent=`${item.s} → ${item.e}`;
      chip.addEventListener('click',()=>{
        document.getElementById('startStation').value=item.s;
        document.getElementById('endStation').value=item.e;
        document.getElementById('acceptTransfers').checked=!!item.t;
        runStartEndSearch();
      });
      box.appendChild(chip);
    });
  }

  // ===== 車種篩選 Chips =====
  let selectedTrainTypesStartEnd=[];
  let selectedTrainTypesStation=[];
  function buildTrainTypeChips(containerId, onChange){
    const box=document.getElementById(containerId);
    if(!box) return;
    box.innerHTML='';
    const types=new Set(Object.keys(trainSchedule||{}).map(k=>trainSchedule[k]['車種']).filter(Boolean));
    Array.from(types).sort().forEach(type=>{
      const lab=document.createElement('label');
      lab.className='chip-label';
      lab.innerHTML=`<input type="checkbox" value="${type}"><span>${type}</span>`;
      const cb=lab.querySelector('input');
      cb.addEventListener('change',()=>onChange());
      box.appendChild(lab);
    });
  }
  function getSelectedTypes(containerId){
    return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)).map(x=>x.value);
  }

  // ===== 點對點 / 轉乘 =====
  let currentStartEndList=[];
  let currentTransferList=[];

  function runStartEndSearch(){
    const st=normalizeStation(document.getElementById('startStation').value.trim());
    const ed=normalizeStation(document.getElementById('endStation').value.trim());
    document.getElementById('startStation').value=st;
    document.getElementById('endStation').value=ed;

    if(!st || !ed) return;

    // history
    const accept=document.getElementById('acceptTransfers').checked;
    const h=loadHistory().filter(x=>!(x.s===st && x.e===ed && x.t===accept));
    h.unshift({s:st,e:ed,t:accept});
    saveHistory(h);
    renderHistory();

    selectedTrainTypesStartEnd=getSelectedTypes('trainTypeChipsStartEnd');

    if(accept){
      buildTransferList(st, ed);
      renderTransferTable();
    }else{
      buildDirectList(st, ed);
      renderStartEndTable();
    }
  }

  function buildDirectList(st, ed){
    const list=[];
    Object.keys(trainSchedule||{}).forEach(num=>{
      const t=trainSchedule[num];
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t['車種'])) return;

      const arr=t['車站時間']||[];
      const si=arr.findIndex(x=>x[0]===st);
      const ei=arr.findIndex(x=>x[0]===ed);
      if(si<0 || ei<0 || ei<=si) return;

      const sTime=arr[si][1]||'--';
      const eTime=arr[ei][1]||'--';
      const travelMin=(parseTime(eTime)-parseTime(sTime))+(parseTime(eTime)<parseTime(sTime)?1440:0);
      const travel=`${Math.floor(travelMin/60)}h ${travelMin%60}m`;
      const stopsCount=ei-si-1;
      const status = getTrainStatusLabel(num, sTime, eTime);
      list.push({
        num,
        type:t['車種'],
        range:`${arr[0][0]}➝${arr[arr.length-1][0]}`,
        sTime,eTime,
        sTimeMin:parseTime(sTime),
        eTimeMin:parseTime(eTime),
        travel,travelMin,
        stopsCount,
        status,
        startStation:st,endStation:ed
      });
    });

    list.sort((a,b)=>a.sTimeMin-b.sTimeMin);
    currentStartEndList=list;
  }

  function renderStartEndTable(){
    const tbody=document.querySelector('#scheduleTableByStation tbody');
    tbody.innerHTML='';
    let maxTravel=Math.max(...currentStartEndList.map(r=>r.travelMin),1);

    currentStartEndList.forEach(r=>{
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=r.num.includes('A')?`<b>${r.num}</b><span class="badge-sea">海</span>`:`<b>${r.num}</b>`;
      tr.insertCell().innerHTML=`${colorType(r.type)} <span class="train-route">(${r.range})</span>`;
      tr.insertCell().innerHTML=highlightPeak(r.sTime);
      tr.insertCell().innerHTML=highlightPeak(r.eTime);

      let cell=tr.insertCell();
      cell.innerHTML=`<div style="font-size:.85rem;font-weight:600">${r.travel}</div><div class="progress-bar"><div class="progress-fill" style="width:${((r.travelMin/maxTravel)*100).toFixed(1)}%"></div></div>`;

      let stopsCell=tr.insertCell();
      if(r.stopsCount>0){
        stopsCell.innerHTML=`${r.stopsCount}站 <span class="toggle-arrow">▼</span>`;
        stopsCell.querySelector('.toggle-arrow').addEventListener('click',e=>{
          e.stopPropagation();
          toggleStopsRow(tr,r.startStation,r.endStation,r.num);
        });
      } else stopsCell.innerHTML='<span style="color:#16a34a;font-weight:600">直達</span>';

      tr.insertCell().innerHTML=r.status;

      tr.addEventListener('click',()=>showTrainDetails(r.num));
    });
  }

  function toggleStopsRow(tr, st, ed, num){
    const next=tr.nextElementSibling;
    if(next && next.classList.contains('stops-row')){
      next.remove();
      return;
    }
    const t=trainSchedule[num]; if(!t) return;
    const arr=t['車站時間']||[];
    const si=arr.findIndex(x=>x[0]===st);
    const ei=arr.findIndex(x=>x[0]===ed);
    if(si<0 || ei<0 || ei<=si) return;

    const stops=arr.slice(si+1, ei).map(x=>`${x[0]}(${x[1]||'--'})`).join('、');
    const row=document.createElement('tr');
    row.className='stops-row';
    const td=document.createElement('td');
    td.colSpan=7;
    td.textContent=stops?`沿途停靠：${stops}`:'（無中途停靠）';
    row.appendChild(td);
    tr.parentNode.insertBefore(row, tr.nextSibling);
  }

  // ===== 轉乘：保留原本演算法 / 修好整體 JS 不會中斷 =====
  function buildTransferList(st, ed){
    const list=[];

    // 直達仍然先計算（後面用來過濾太慢的轉乘）
    buildDirectList(st, ed);
    const bestDirectMin = currentStartEndList.length ? Math.min(...currentStartEndList.map(x=>x.travelMin)) : Infinity;

    // 找所有可能轉乘（單次轉乘）
    const allNums=Object.keys(trainSchedule||{});
    allNums.forEach(n1=>{
      const t1=trainSchedule[n1];
      if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t1['車種'])) return;

      const a1=t1['車站時間']||[];
      const sIdx=a1.findIndex(x=>x[0]===st);
      if(sIdx<0) return;

      allNums.forEach(n2=>{
        const t2=trainSchedule[n2];
        if(selectedTrainTypesStartEnd.length && !selectedTrainTypesStartEnd.includes(t2['車種'])) return;

        const a2=t2['車站時間']||[];
        const eIdx=a2.findIndex(x=>x[0]===ed);
        if(eIdx<0) return;

        // 找共同轉乘站
        for(let i=sIdx+1;i<a1.length;i++){
          const mid=a1[i][0];
          const tArr=a1[i][1];
          if(!tArr) continue;

          const midIdx=a2.findIndex(x=>x[0]===mid);
          if(midIdx<0) continue;
          const tDep=a2[midIdx][1];
          if(!tDep) continue;

          // 等待時間限制：<= 90分鐘（原本規則）
          const wait=(parseTime(tDep)-parseTime(tArr))+(parseTime(tDep)<parseTime(tArr)?1440:0);
          if(wait<0 || wait>90) continue;

          // 第一段必須能從 st 到 mid
          const midIdx1=i;
          if(midIdx1<=sIdx) continue;

          // 第二段必須能從 mid 到 ed
          if(eIdx<=midIdx) continue;

          const sTime=a1[sIdx][1]||'--';
          const eTime=a2[eIdx][1]||'--';

          const travelMin=(parseTime(eTime)-parseTime(sTime))+(parseTime(eTime)<parseTime(sTime)?1440:0);
          if(travelMin>=bestDirectMin) continue; // 有直達更快就不要

          list.push({
            trainNumber:`${n1}+${n2}`,
            n1, n2,
            type1:t1['車種'], type2:t2['車種'],
            startStation:st, endStation:ed,
            transferStation:mid,
            sTime, midArr:tArr, midDep:tDep, eTime,
            travelMin,
            travel:`${Math.floor(travelMin/60)}h ${travelMin%60}m`,
            stopsCount: 0
          });

          break; // 同一組只取第一個可行的轉乘站（保持 UI 簡潔）
        }
      });
    });

    // 同一組車次只留最短耗時（原本規則）
    const bestMap=new Map();
    list.forEach(r=>{
      const key=r.trainNumber;
      if(!bestMap.has(key) || r.travelMin<bestMap.get(key).travelMin){
        bestMap.set(key,r);
      }
    });

    currentTransferList=Array.from(bestMap.values()).sort((a,b)=>a.travelMin-b.travelMin);
  }

  function renderTransferTable(){
    const tbody=document.querySelector('#scheduleTableByStation tbody');
    tbody.innerHTML='';
    let maxTravel=Math.max(...currentTransferList.map(r=>r.travelMin),1);

    currentTransferList.forEach(r=>{
      let tr=tbody.insertRow();

      tr.insertCell().innerHTML=r.trainNumber.includes('A')?`<b>${r.trainNumber}</b><span class="badge-sea">海</span>`:`<b>${r.trainNumber}</b>`;

      tr.insertCell().innerHTML=
        `${colorType(r.type1)}<span class="train-route">(${r.startStation}➝${r.transferStation})</span><br>`+
        `${colorType(r.type2)}<span class="train-route">(${r.transferStation}➝${r.endStation})</span>`;

      tr.insertCell().innerHTML=highlightPeak(r.sTime);

      tr.insertCell().innerHTML=
        `<div style="font-weight:700">${r.transferStation}</div>`+
        `<div class="train-route">抵達 ${highlightPeak(r.midArr)} / 發車 ${highlightPeak(r.midDep)}</div>`+
        `<div class="train-route">${r.n1} → ${r.n2}</div>`;

      tr.insertCell().innerHTML=highlightPeak(r.eTime);

      let cell=tr.insertCell();
      cell.innerHTML=`<div style="font-size:.85rem;font-weight:600">${r.travel}</div><div class="progress-bar"><div class="progress-fill" style="width:${((r.travelMin/maxTravel)*100).toFixed(1)}%"></div></div>`;

      // 「停靠」欄位（轉乘版不顯示原本沿途停靠，保持你原本規則）
      tr.insertCell().innerHTML='—';

      // 狀態（用第一段起訖時間估）
      tr.insertCell().innerHTML=getTrainStatusLabel(r.n1, r.sTime, r.midArr);

      tr.addEventListener('click',()=>showTrainDetails(r.n1));
    });
  }

  // ===== 車站時刻表 =====
  function filterTrainScheduleByStationName(){
    let stationRaw = document.getElementById('stationNameInput').value.trim();
    const station = normalizeStation(stationRaw);
    if(station !== stationRaw) document.getElementById('stationNameInput').value = station;

    const dir=document.getElementById('directionSelect').value;
    const tbody=document.querySelector('#scheduleTableByStationName tbody');
    tbody.innerHTML='';

    Object.keys(trainSchedule).sort((a,b)=>(getTime(a,station)||'99:99').localeCompare(getTime(b,station)||'99:99')).forEach(num=>{
      let t=trainSchedule[num];
      if(selectedTrainTypesStation.length && !selectedTrainTypesStation.includes(t['車種'])) return;
      if(!t['車站時間'].some(s=>s[0]===station)) return;
      if(getDirection(num)!==dir) return;
      let arr=t['車站時間'], idx=arr.findIndex(s=>s[0]===station);
      let tr=tbody.insertRow();
      tr.insertCell().innerHTML=num.includes('A')?`<b>${num}</b><span class="badge-sea">海</span>`:`<b>${num}</b>`;
      tr.insertCell().innerHTML=`${colorType(t['車種'])} <span class="train-route">(${arr[0][0]}➝${arr.slice(-1)[0][0]})</span>`;
      tr.insertCell().innerHTML=highlightPeak(arr[idx][1]||'--');
      tr.insertCell().innerHTML=getTrainStatusLabel(num, arr[0]?.[1]||'', arr.slice(-1)[0]?.[1]||'');
      tr.addEventListener('click',()=>showTrainDetails(num));
    });
  }

  // ===== 車次查詢 =====
  function filterTrainScheduleByNumber(){
    const num=document.getElementById('trainNumberInput').value.trim(), tbody=document.querySelector('#scheduleTableByNumber tbody');
    tbody.innerHTML='';
    const t=trainSchedule[num];
    if(!t) return;
    let arr=t['車站時間'];
    let tr=tbody.insertRow();
    tr.insertCell().innerHTML=num.includes('A')?`<b>${num}</b><span class="badge-sea">海</span>`:`<b>${num}</b>`;
    tr.insertCell().innerHTML=`${colorType(t['車種'])} <span class="train-route">(${arr[0][0]}➝${arr.slice(-1)[0][0]})</span>`;
    tr.insertCell().innerHTML=getTrainStatusLabel(num, arr[0]?.[1]||'', arr.slice(-1)[0]?.[1]||'');
    tr.addEventListener('click',()=>showTrainDetails(num));
  }

  // ===== Modal: 列車詳情 =====
  const modal=document.getElementById('trainModal');
  const modalClose=document.getElementById('modalClose');
  modalClose.addEventListener('click',()=>modal.style.display='none');
  modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.style.display='none'; });

  function showTrainDetails(trainNo){
    const t=trainSchedule[trainNo];
    if(!t) return;

    const arr=t['車站時間']||[];
    document.getElementById('modalTitleMain').textContent=`${trainNo}｜${t['車種']}`;
    document.getElementById('modalTitleSub').textContent=`${arr[0]?.[0]||''} ➝ ${arr.slice(-1)[0]?.[0]||''} ｜狀態：${getTrainStatusLabel(trainNo, arr[0]?.[1]||'', arr.slice(-1)[0]?.[1]||'')}`;

    const body=document.getElementById('modalBody');
    body.innerHTML='';
    const timeline=document.createElement('div');
    timeline.className='timeline';

    // 找下一站（用現在時間比對）
    const now=new Date();
    const nowMin=now.getHours()*60+now.getMinutes();
    let nextIndex=-1;
    for(let i=0;i<arr.length;i++){
      const m=parseTime(arr[i][1]||'');
      if(m>=nowMin){ nextIndex=i; break; }
    }

    arr.forEach((s, i)=>{
      const item=document.createElement('div');
      item.className='timeline-item';
      const time=s[1]||'--';
      item.innerHTML=`
        <div class="tl-time">${time}</div>
        <div class="tl-marker">
          <div class="tl-dot"></div>
          <div class="tl-line"></div>
        </div>
        <div class="tl-content">
          <div class="tl-station">${s[0]}${i===nextIndex?` <span class="badge-next">下一站</span>`:''}</div>
          <div class="tl-desc">${i===0?'起站':(i===arr.length-1?'終點':'')}</div>
        </div>
      `;

      if(i<nextIndex) item.classList.add('passed');
      if(i===nextIndex) item.classList.add('next');
      timeline.appendChild(item);
    });

    body.appendChild(timeline);
    modal.style.display='flex';
  }

  // ===== 事件綁定 =====
  document.getElementById('searchBtn').addEventListener('click', runStartEndSearch);
  document.getElementById('stationSearchBtn').addEventListener('click', ()=>{
    selectedTrainTypesStation=getSelectedTypes('trainTypeChipsStation');
    filterTrainScheduleByStationName();
  });
  document.getElementById('trainNumberBtn').addEventListener('click', filterTrainScheduleByNumber);

  document.getElementById('swapBtn').addEventListener('click', ()=>{
    const a=document.getElementById('startStation');
    const b=document.getElementById('endStation');
    const t=a.value; a.value=b.value; b.value=t;
  });

  // trainType chips：資料 ready 後再建（refreshData 會先 fetchRealData）
  const _origRefreshData = refreshData;
  refreshData = async (date)=>{
    await _origRefreshData(date);
    buildTrainTypeChips('trainTypeChipsStartEnd', ()=>{});
    buildTrainTypeChips('trainTypeChipsStation', ()=>{});
    renderHistory();
  };

  // 修好會讓整個 JS 中斷的「不存在元素」事件（保留但加防呆）
  const hb=document.getElementById('hamburger'), nav=document.getElementById('navLinks');
  if(hb && nav){
    hb.addEventListener('click',()=>nav.classList.toggle('open'));
    nav.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>nav.classList.remove('open')));
  }

</script>

</body>
</html>
